<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ProofRepo &mdash; Compliance ProofPacks in Seconds</title>
  <meta name="description" content="Streamlined evidence collection for SOC 2, ISO 27001, HIPAA, GDPR audits. Send your client a guided upload link, get a structured ProofPack." />
  
  <!-- MAGIC LINK REDIRECT - Must be in head, executes immediately -->
  <script>
    (function() {
      var params = new URLSearchParams(window.location.search);
      var token = params.get('t');
      if (token && token.indexOf('req_') === 0) {
        window.location.replace('https://proofrepo-intake.atucker5.workers.dev/upload?t=' + encodeURIComponent(token));
      }
    })();
  </script>
  
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  
  <!-- Flatpickr Date/Time Picker -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <style>
    :root {
      --bg: #050a14;
      --surface: #0a1628;
      --surface-elevated: #0f1d32;
      --border: #1e3a5f;
      --text: #e2e8f0;
      --text-muted: #94a3b8;
      --primary: #2563eb;
      --primary-hover: #1d4ed8;
      --accent: #10b981;
      --accent-hover: #059669;
      --warning: #f59e0b;
      --error: #ef4444;
      --marquee-height: 48px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
      padding-bottom: var(--marquee-height);
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 24px;
      border-bottom: 1px solid var(--border);
      background: rgba(5, 10, 20, 0.9);
      backdrop-filter: blur(10px);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 700;
      font-size: 1.25rem;
      color: var(--text);
      text-decoration: none;
    }

    .logo-icon {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .header-links {
      display: flex;
      gap: 24px;
      align-items: center;
    }

    .header-links a {
      color: var(--text-muted);
      text-decoration: none;
      font-size: 0.9rem;
      font-weight: 500;
      transition: color 0.2s;
      cursor: pointer;
    }

    .header-links a:hover { color: var(--text); }

    .hero {
      padding: 48px 24px;
      text-align: center;
      background: linear-gradient(180deg, rgba(37, 99, 235, 0.1) 0%, transparent 100%);
    }

    .hero-badge {
      display: inline-block;
      padding: 6px 14px;
      background: rgba(37, 99, 235, 0.2);
      border: 1px solid rgba(37, 99, 235, 0.3);
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      color: #60a5fa;
      margin-bottom: 16px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .hero h1 {
      font-size: clamp(2rem, 5vw, 3rem);
      font-weight: 800;
      line-height: 1.2;
      margin-bottom: 16px;
      background: linear-gradient(135deg, var(--text) 0%, #94a3b8 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .hero p {
      font-size: 1.1rem;
      color: var(--text-muted);
      max-width: 600px;
      margin: 0 auto 12px;
    }

    .hero-features {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 24px;
      margin-top: 32px;
      padding: 0 24px;
    }

    .hero-feature {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .hero-feature svg {
      color: var(--accent);
      flex-shrink: 0;
    }

    .main-container {
      max-width: 900px;
      margin: 0 auto;
      padding: 24px;
    }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .card-header {
      margin-bottom: 20px;
    }

    .card-header h2 {
      font-size: 1.25rem;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .card-header p {
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text);
    }

    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 12px 16px;
      background: var(--surface-elevated);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      font-size: 1rem;
      font-family: inherit;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
    }

    .form-input::placeholder, .form-textarea::placeholder { color: var(--text-muted); }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    .form-textarea {
      min-height: 80px;
      resize: vertical;
    }

    /* Chip Input Styles */
    .chip-input-container {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      background: var(--surface-elevated);
      border: 1px solid var(--border);
      border-radius: 10px;
      min-height: 48px;
      cursor: text;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .chip-input-container:focus-within {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
    }
    .chip-input-container .chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      background: var(--primary);
      color: white;
      border-radius: 16px;
      font-size: 0.85rem;
      font-weight: 500;
      animation: chipIn 0.15s ease-out;
    }
    @keyframes chipIn {
      from { transform: scale(0.8); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    .chip-input-container .chip .chip-remove {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      background: rgba(255,255,255,0.2);
      border: none;
      border-radius: 50%;
      color: white;
      font-size: 12px;
      line-height: 1;
      cursor: pointer;
      transition: background 0.15s;
    }
    .chip-input-container .chip .chip-remove:hover {
      background: rgba(255,255,255,0.4);
    }
    .chip-input-container .chip-text-input {
      flex: 1;
      min-width: 150px;
      border: none;
      background: transparent;
      color: var(--text);
      font-size: 1rem;
      font-family: inherit;
      outline: none;
      padding: 4px 0;
    }
    .chip-input-container .chip-text-input::placeholder {
      color: var(--text-muted);
    }
    .chip-input-hint {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .role-selector {
      margin-bottom: 24px;
    }

    .role-selector select {
      width: 100%;
      padding: 14px 16px;
      background: var(--surface-elevated);
      border: 2px solid var(--border);
      border-radius: 12px;
      color: var(--text);
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .role-selector select:focus {
      outline: none;
      border-color: var(--primary);
    }

    .framework-selector {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 12px;
    }

    .framework-tag {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: var(--surface-elevated);
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      user-select: none;
    }

    .framework-tag:hover {
      border-color: var(--primary);
    }

    .framework-tag.selected {
      background: rgba(37, 99, 235, 0.2);
      border-color: var(--primary);
      color: #60a5fa;
    }

    .framework-tag input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: var(--primary);
    }

    .framework-tag.add-btn {
      border-style: dashed;
      color: var(--text-muted);
    }

    .control-group {
      border: 1px solid var(--border);
      border-radius: 12px;
      margin-bottom: 12px;
      overflow: hidden;
    }

    .control-group.excluded {
      opacity: 0.5;
      border-style: dashed;
    }

    .cg-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 16px;
      background: var(--surface-elevated);
      cursor: pointer;
      transition: background 0.2s;
    }

    .cg-header:hover {
      background: rgba(30, 58, 95, 0.5);
    }

    .cg-title {
      font-weight: 600;
      font-size: 0.95rem;
      flex: 1;
    }

    .cg-status {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .cg-count {
      font-size: 0.8rem;
      color: var(--text-muted);
      background: var(--bg);
      padding: 4px 10px;
      border-radius: 12px;
    }

    .cg-toggle {
      color: var(--text-muted);
      font-size: 0.9rem;
      width: 20px;
      text-align: center;
    }

    .cg-exclude, .cg-include {
      width: 24px;
      height: 24px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      cursor: pointer;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text-muted);
    }

    .cg-exclude:hover {
      background: #7f1d1d;
      border-color: #991b1b;
      color: #fecaca;
    }

    .cg-include:hover {
      background: #166534;
      border-color: #166534;
      color: #86efac;
    }

    .cg-body {
      display: none;
      padding: 12px 16px;
      background: var(--bg);
    }

    .cg-body.open {
      display: block;
    }

    .cg-description {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    /* Old evidence-item styles removed - new styles are in the Enhanced Evidence Items section below */

    .more-toggle {
      margin: 12px 0;
      padding: 10px 14px;
      font-size: 0.9rem;
      color: #7a9bff;
      cursor: pointer;
      background: var(--surface);
      border: 1px dashed var(--border);
      border-radius: 8px;
      text-align: center;
    }

    .more-toggle:hover {
      background: var(--surface-elevated);
      border-color: var(--primary);
    }

    .add-custom-section {
      margin-top: 16px;
      padding: 16px;
      border: 1px dashed var(--border);
      border-radius: 10px;
      background: rgba(0,0,0,0.2);
    }

    .add-custom-section h4 {
      margin: 0 0 12px;
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .custom-form {
      display: grid;
      gap: 10px;
    }

    .custom-form input,
    .custom-form textarea {
      background: var(--bg);
    }

    .global-instructions {
      padding: 16px;
      border-top: 1px solid var(--border);
      margin-top: 12px;
    }

    .global-instructions textarea {
      min-height: 70px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px 24px;
      font-size: 1rem;
      font-weight: 600;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      text-decoration: none;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      background: var(--primary-hover);
      transform: translateY(-1px);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-accent {
      background: var(--accent);
      color: white;
    }

    .btn-accent:hover:not(:disabled) {
      background: var(--accent-hover);
      transform: translateY(-1px);
    }

    .btn-accent:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-outline {
      background: transparent;
      border: 2px solid var(--border);
      color: var(--text);
    }

    .btn-outline:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    .btn-full {
      width: 100%;
    }

    .btn-sm {
      padding: 8px 14px;
      font-size: 0.9rem;
    }

    .btn-xs {
      padding: 4px 10px;
      font-size: 0.75rem;
    }

    /* Credit Alert */
    .credit-alert {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(239, 68, 68, 0.1));
      border: 1px solid rgba(245, 158, 11, 0.4);
      border-radius: 10px;
      padding: 12px 16px;
      margin-bottom: 20px;
      gap: 12px;
    }

    .credit-alert.critical {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(239, 68, 68, 0.1));
      border-color: rgba(239, 68, 68, 0.4);
    }

    .credit-alert-content {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .credit-alert-icon {
      font-size: 1.2rem;
    }

    .credit-alert-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .credit-alert-text strong {
      font-size: 0.9rem;
      color: var(--text);
    }

    .credit-alert-text span {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    @media (max-width: 600px) {
      .credit-alert {
        flex-direction: column;
        align-items: stretch;
        text-align: center;
      }
      .credit-alert-content {
        justify-content: center;
      }
    }

    /* Payment section */
    .payment-section {
      display: none;
      background: var(--surface-elevated);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      margin-top: 24px;
    }

    .payment-section.visible {
      display: block;
    }

    .payment-header {
      text-align: center;
      margin-bottom: 20px;
    }

    .payment-header h3 {
      font-size: 1.1rem;
      margin-bottom: 4px;
    }

    .payment-header p {
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    .code-entry {
      background: var(--bg);
      border-radius: 12px;
      padding: 16px;
    }

    .code-input {
      width: 100%;
      padding: 14px 16px;
      font-size: 1.1rem;
      font-weight: 600;
      letter-spacing: 2px;
      text-transform: uppercase;
      background: var(--surface);
      border: 2px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      text-align: center;
    }

    .code-input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .code-input.valid {
      border-color: var(--accent);
    }

    .code-input.invalid {
      border-color: var(--error);
    }

    .code-status {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-top: 12px;
      font-size: 0.9rem;
      min-height: 24px;
    }

    .code-status.valid { color: var(--accent); }
    .code-status.invalid { color: var(--error); }
    .code-status.checking { color: var(--text-muted); }

    .purchase-section {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
    }

    .purchase-section.hidden {
      display: none;
    }

    .divider-text {
      text-align: center;
      color: var(--text-muted);
      font-size: 0.9rem;
      margin-bottom: 16px;
    }

    .pricing-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }

    .pricing-card {
      background: var(--bg);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .pricing-card:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
    }

    .pricing-card.selected {
      border-color: var(--accent);
      background: rgba(16, 185, 129, 0.1);
    }

    .pricing-card-name {
      font-weight: 600;
      font-size: 0.95rem;
      margin-bottom: 4px;
    }

    .pricing-card-price {
      font-size: 1.4rem;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 4px;
    }

    .pricing-card-desc {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .success-banner {
      display: none;
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(16, 185, 129, 0.1));
      border: 1px solid var(--accent);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 24px;
      text-align: center;
    }

    .success-banner.visible {
      display: block;
    }

    .success-banner h3 {
      color: var(--accent);
      margin-bottom: 8px;
    }

    .success-banner p {
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    .success-banner .code-display {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--accent);
      letter-spacing: 3px;
      font-family: monospace;
      margin: 12px 0;
    }

    .how-section {
      padding: 48px 24px;
      max-width: 900px;
      margin: 0 auto;
    }

    .how-section h2 {
      text-align: center;
      margin-bottom: 32px;
      font-size: 1.5rem;
    }

    .how-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
    }

    .how-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
    }

    .how-card h3 {
      font-size: 1rem;
      margin-bottom: 8px;
    }

    .how-card p {
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    /* ==================== TRUST SECTION ==================== */
    .trust-section {
      padding: 48px 24px;
      background: linear-gradient(180deg, var(--bg) 0%, var(--surface) 50%, var(--bg) 100%);
      border-top: 1px solid var(--border);
      border-bottom: 1px solid var(--border);
    }

    .trust-section .section-inner {
      max-width: 900px;
      margin: 0 auto;
    }

    .trust-section .section-header {
      text-align: center;
      margin-bottom: 32px;
    }

    .trust-section .section-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(16, 185, 129, 0.15);
      border: 1px solid rgba(16, 185, 129, 0.3);
      color: var(--accent);
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }

    .trust-section h2 {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 8px;
    }

    .trust-section .section-subtitle {
      color: var(--text-muted);
      font-size: 1rem;
      max-width: 500px;
      margin: 0 auto;
    }

    .trust-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    .trust-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px 16px;
      text-align: center;
      transition: border-color 0.2s, transform 0.2s;
    }

    .trust-card:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
    }

    .trust-card-icon {
      width: 44px;
      height: 44px;
      margin: 0 auto 12px;
      background: linear-gradient(135deg, var(--primary), #8b5cf6);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .trust-card-icon svg {
      width: 22px;
      height: 22px;
      stroke: white;
      fill: none;
      stroke-width: 2;
    }

    .trust-card h3 {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 4px;
    }

    .trust-card p {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin: 0;
    }

    .trust-footer {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px 24px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
    }

    .trust-footer-text {
      color: var(--text-muted);
      font-size: 0.85rem;
    }

    .trust-links {
      display: flex;
      gap: 20px;
    }

    .trust-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: var(--text-muted);
      text-decoration: none;
      font-size: 0.85rem;
      font-weight: 500;
      transition: color 0.2s;
    }

    .trust-link:hover {
      color: var(--primary);
    }

    .trust-link svg {
      width: 14px;
      height: 14px;
      stroke: currentColor;
      fill: none;
      stroke-width: 2;
    }

    @media (max-width: 768px) {
      .trust-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 480px) {
      .trust-grid {
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }
      .trust-card {
        padding: 16px 12px;
      }
      .trust-links {
        flex-wrap: wrap;
        justify-content: center;
      }
    }

    /* ==================== FOOTER ==================== */
    .footer {
      text-align: center;
      padding: 32px 24px;
      color: var(--text-muted);
      font-size: 0.85rem;
      border-top: 1px solid var(--border);
    }

    .footer-links {
      display: flex;
      justify-content: center;
      gap: 24px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .footer-links a {
      color: var(--text-muted);
      text-decoration: none;
      font-size: 0.85rem;
      transition: color 0.2s;
    }

    .footer-links a:hover {
      color: var(--text);
    }

    .footer p {
      margin: 0;
    }

    /* ==================== AUTH STYLES ==================== */
    .auth-flow {
      margin-bottom: 20px;
    }

    .auth-box {
      background: var(--surface-elevated);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
    }

    .auth-box h3 {
      margin: 0 0 6px;
      font-size: 1.15rem;
    }

    .auth-subtitle {
      color: var(--text-muted);
      font-size: 0.9rem;
      margin-bottom: 16px;
    }

    .auth-options {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
    }

    .auth-option {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 14px 16px;
      background: var(--bg);
      border: 2px solid var(--border);
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .auth-option:hover {
      border-color: var(--primary);
    }

    .auth-option:has(input:checked) {
      border-color: var(--primary);
      background: rgba(37, 99, 235, 0.08);
    }

    .auth-option input[type="radio"] {
      margin-top: 2px;
      accent-color: var(--primary);
    }

    .auth-option-content {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .auth-option-title {
      font-weight: 600;
      font-size: 0.95rem;
    }

    .auth-option-desc {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .auth-section {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
    }

    .auth-status {
      margin-top: 12px;
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 0.9rem;
      display: none;
    }

    .auth-status.visible { display: block; }
    .auth-status.success { background: rgba(16, 185, 129, 0.1); color: var(--accent); border: 1px solid rgba(16, 185, 129, 0.3); }
    .auth-status.error { background: rgba(239, 68, 68, 0.1); color: var(--error); border: 1px solid rgba(239, 68, 68, 0.3); }
    .auth-status.loading { background: rgba(37, 99, 235, 0.1); color: var(--text-muted); border: 1px solid rgba(37, 99, 235, 0.3); }

    .auth-footnote {
      font-size: 0.8rem;
      color: var(--text-muted);
      text-align: center;
      margin-top: 12px;
    }

    .code-style {
      text-transform: uppercase;
      letter-spacing: 2px;
      font-weight: 600;
      text-align: center;
    }

    .success-box {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.3);
      border-radius: 8px;
      margin-bottom: 16px;
      color: var(--accent);
      font-weight: 500;
    }

    .success-icon {
      font-size: 1.1rem;
    }

    .trial-modes {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .trial-mode {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 12px 14px;
      background: var(--bg);
      border: 2px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .trial-mode:hover {
      border-color: var(--accent);
    }

    .trial-mode:has(input:checked) {
      border-color: var(--accent);
      background: rgba(16, 185, 129, 0.08);
    }

    .trial-mode input[type="radio"] {
      margin-top: 3px;
      accent-color: var(--accent);
    }

    .trial-mode-content {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .trial-mode-content strong {
      font-size: 0.9rem;
    }

    .trial-mode-content span {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .info-box {
      padding: 12px 14px;
      background: rgba(37, 99, 235, 0.1);
      border: 1px solid rgba(37, 99, 235, 0.2);
      border-radius: 8px;
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-top: 10px;
    }

    .password-reqs {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    .password-reqs .req {
      font-size: 0.75rem;
      padding: 4px 8px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text-muted);
    }

    .password-reqs .req.valid {
      background: rgba(16, 185, 129, 0.1);
      border-color: rgba(16, 185, 129, 0.4);
      color: var(--accent);
    }

    .login-options {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.85rem;
      color: var(--text-muted);
      cursor: pointer;
    }

    .checkbox-label input {
      accent-color: var(--primary);
    }

    .text-link {
      font-size: 0.85rem;
      color: var(--primary);
      text-decoration: none;
    }

    .text-link:hover {
      text-decoration: underline;
    }

    .logged-in-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: var(--surface-elevated);
      border: 1px solid var(--border);
      border-radius: 10px;
      margin-bottom: 16px;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-email {
      font-size: 0.9rem;
      font-weight: 500;
    }

    .credits-badge {
      padding: 4px 10px;
      background: rgba(16, 185, 129, 0.15);
      border: 1px solid rgba(16, 185, 129, 0.3);
      border-radius: 14px;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--accent);
    }

    .credits-badge.low {
      background: rgba(245, 158, 11, 0.15);
      border-color: rgba(245, 158, 11, 0.3);
      color: var(--warning);
    }

    .credits-badge.empty {
      background: rgba(239, 68, 68, 0.15);
      border-color: rgba(239, 68, 68, 0.3);
      color: var(--error);
    }

    .user-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .template-select {
      padding: 6px 12px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-size: 0.85rem;
      cursor: pointer;
    }

    .template-loader-section {
      margin-bottom: 12px;
    }

    .template-select-inline {
      width: 100%;
      padding: 10px 14px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 0.9rem;
      cursor: pointer;
      transition: border-color 0.2s;
    }

    .template-select-inline:hover {
      border-color: var(--primary);
    }

    .template-select-inline:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
    }

    .template-loaded-notice {
      margin-bottom: 16px;
      padding: 12px 16px;
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.3);
      border-radius: 8px;
    }

    .template-loaded-notice .notice-content {
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }

    .template-loaded-notice .notice-icon {
      color: var(--accent);
      font-size: 1.1rem;
      font-weight: 700;
      flex-shrink: 0;
      margin-top: 2px;
    }

    .template-loaded-notice .notice-text {
      flex: 1;
    }

    .template-loaded-notice .notice-text strong {
      color: var(--accent);
    }

    .template-loaded-notice .notice-text p {
      margin: 4px 0 0;
      font-size: 0.85rem;
      color: var(--text-muted);
      line-height: 1.4;
    }

    .template-loaded-notice .notice-dismiss {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 1.2rem;
      cursor: pointer;
      padding: 0;
      line-height: 1;
      opacity: 0.7;
      transition: opacity 0.2s;
    }

    .template-loaded-notice .notice-dismiss:hover {
      opacity: 1;
    }

    .trial-notice {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 16px;
      background: rgba(37, 99, 235, 0.1);
      border: 1px solid rgba(37, 99, 235, 0.2);
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 0.9rem;
    }

    .trial-badge {
      padding: 2px 8px;
      background: var(--primary);
      color: white;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 700;
      letter-spacing: 0.5px;
    }

    .verification-notice {
      padding: 10px 16px;
      background: rgba(245, 158, 11, 0.1);
      border: 1px solid rgba(245, 158, 11, 0.3);
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 0.9rem;
      color: var(--warning);
    }

    .verification-notice a {
      color: var(--warning);
      font-weight: 600;
    }

    /* Dashboard Styles */
    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 12px;
    }

    .dashboard-title {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--text);
      margin: 0;
    }

    .dashboard-subtitle {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin: 2px 0 0;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 14px 12px;
      text-align: center;
    }

    .stat-card.highlight {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(37, 99, 235, 0.1));
      border-color: rgba(16, 185, 129, 0.3);
    }

    .stat-value {
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--text);
      line-height: 1;
    }

    .stat-card.highlight .stat-value {
      color: var(--accent);
    }

    .stat-label {
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-top: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .request-section {
      margin-bottom: 24px;
    }

    .section-title {
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--text);
      margin: 0 0 16px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border);
    }

    .requests-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .request-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px 16px;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .request-card:hover {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
    }

    .request-card.overdue {
      border-color: rgba(245, 158, 11, 0.5);
      background: linear-gradient(135deg, var(--surface), rgba(245, 158, 11, 0.05));
    }

    .request-card.overdue:hover {
      border-color: var(--warning);
      box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.15);
    }

    .request-overdue-alert {
      background: rgba(245, 158, 11, 0.15);
      border-radius: 6px;
      padding: 8px 12px;
      font-size: 0.8rem;
      color: var(--warning);
      margin-bottom: 10px;
    }

    .request-reminder-status {
      font-size: 0.78rem;
      padding: 6px 10px;
      border-radius: 6px;
      margin: 6px 0 4px;
    }
    .request-reminder-status.scheduled {
      background: rgba(37, 99, 235, 0.1);
      color: #60a5fa;
    }
    .request-reminder-status.imminent {
      background: rgba(245, 158, 11, 0.1);
      color: #f59e0b;
    }
    .request-reminder-status.overdue {
      background: rgba(239, 68, 68, 0.1);
      color: #ef4444;
    }
    .request-reminder-status.complete {
      background: rgba(34, 197, 94, 0.1);
      color: #22c55e;
    }

    .request-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }

    .request-company {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text);
      margin: 0;
    }

    .request-frameworks {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
      margin-top: 3px;
    }

    .request-fw-tag {
      font-size: 0.65rem;
      padding: 2px 6px;
      background: rgba(37, 99, 235, 0.15);
      color: var(--primary);
      border-radius: 3px;
      font-weight: 500;
    }

    .request-status {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 0.8rem;
      font-weight: 500;
    }

    .request-status.pending {
      color: var(--warning);
    }

    .request-status.complete {
      color: var(--accent);
    }

    .request-status.cancelled {
      color: var(--text-muted);
      opacity: 0.7;
    }

    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
    }

    .request-meta {
      display: flex;
      gap: 16px;
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .request-meta-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .request-actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .request-action-btn {
      padding: 5px 10px;
      font-size: 0.75rem;
      border-radius: 5px;
      border: 1px solid var(--border);
      background: var(--bg);
      color: var(--text);
      cursor: pointer;
      transition: all 0.2s;
    }

    .request-action-btn:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    .request-action-btn.primary {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }

    .request-action-btn.primary:hover {
      background: var(--primary-hover);
    }

    .request-action-btn.danger {
      color: var(--error);
    }

    .request-action-btn.danger:hover {
      border-color: var(--error);
      background: rgba(239, 68, 68, 0.1);
    }

    .empty-state {
      text-align: center;
      padding: 24px 16px;
      color: var(--text-muted);
    }

    .empty-state-icon {
      font-size: 2rem;
      margin-bottom: 8px;
      opacity: 0.5;
    }

    .empty-state-text {
      font-size: 0.85rem;
    }

    .loading-placeholder {
      text-align: center;
      padding: 24px 16px;
      color: var(--text-muted);
      font-size: 0.85rem;
    }

    .section-count {
      font-weight: 400;
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    /* Template Cards */
    .templates-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .template-card {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px 16px;
      transition: border-color 0.2s;
    }

    .template-card:hover {
      border-color: var(--primary);
    }

    .template-info {
      flex: 1;
      min-width: 0;
    }

    .template-name {
      font-weight: 600;
      color: var(--text);
      font-size: 0.95rem;
      margin: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .template-meta {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .template-actions {
      display: flex;
      gap: 6px;
      flex-shrink: 0;
      margin-left: 12px;
    }

    .template-action-btn {
      padding: 4px 10px;
      font-size: 0.75rem;
      border-radius: 4px;
      border: 1px solid var(--border);
      background: var(--bg);
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s;
    }

    .template-action-btn:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    .template-action-btn.use {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }

    .template-action-btn.use:hover {
      background: var(--primary-hover);
    }

    .template-action-btn.delete:hover {
      border-color: var(--error);
      color: var(--error);
    }

    .back-link {
      margin-bottom: 16px;
    }

    .back-link a {
      color: var(--text-muted);
      text-decoration: none;
      font-size: 0.9rem;
      transition: color 0.2s;
    }

    .back-link a:hover {
      color: var(--primary);
    }

    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      .dashboard-header {
        flex-direction: column;
        align-items: stretch;
      }
      .dashboard-header button {
        width: 100%;
      }
    }

    @media (max-width: 480px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }
      .request-card-header {
        flex-direction: column;
        gap: 8px;
      }
      .request-meta {
        flex-direction: column;
        gap: 8px;
      }
    }

    /* Save Template Bar */
    .save-template-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: var(--surface-elevated);
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-top: 16px;
    }

    .save-template-bar span {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    @media (max-width: 600px) {
      .logged-in-bar {
        flex-direction: column;
        gap: 12px;
        align-items: stretch;
      }
      .user-actions {
        justify-content: space-between;
      }
      .login-options {
        flex-direction: column;
        gap: 10px;
        align-items: flex-start;
      }
    }

    .marquee-fixed {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      height: var(--marquee-height);
      display: flex;
      align-items: center;
      border-top: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0));
      backdrop-filter: blur(6px);
      z-index: 9999;
      overflow: hidden;
    }

    .marquee {
      white-space: nowrap;
      width: 100%;
      overflow: hidden;
    }

    .marquee > div {
      display: inline-block;
      padding-left: 100%;
      animation: scroll 28s linear infinite;
      color: #b9c6ff;
      opacity: 0.9;
    }

    @keyframes scroll {
      0% { transform: translateX(0); }
      100% { transform: translateX(-100%); }
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }

    .modal-overlay.hidden {
      display: none;
    }

    .modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      max-width: 500px;
      width: 90%;
    }

    .modal h3 {
      margin: 0 0 16px;
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 16px;
    }

    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      display: inline-block;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
      .how-grid { grid-template-columns: 1fr; }
      .pricing-grid { grid-template-columns: 1fr 1fr; }
    }

    @media (max-width: 600px) {
      .hero { padding: 32px 16px; }
      .main-container { padding: 16px; }
      .card { padding: 20px; }
      .form-row { grid-template-columns: 1fr; }
    }

    /* Flatpickr custom styling to match ProofRepo theme */
    .flatpickr-calendar {
      background: var(--surface-elevated) !important;
      border: 1px solid var(--border) !important;
      border-radius: 12px !important;
      box-shadow: 0 20px 40px rgba(0,0,0,0.4) !important;
      font-family: 'Inter', system-ui, sans-serif !important;
    }
    .flatpickr-months {
      background: var(--surface) !important;
      border-radius: 12px 12px 0 0 !important;
      padding: 8px 0 !important;
    }
    .flatpickr-months .flatpickr-month {
      color: var(--text) !important;
      fill: var(--text) !important;
    }
    .flatpickr-current-month {
      color: var(--text) !important;
      font-weight: 600 !important;
    }
    .flatpickr-current-month .flatpickr-monthDropdown-months {
      background: var(--surface) !important;
      color: var(--text) !important;
    }
    .flatpickr-current-month input.cur-year {
      color: var(--text) !important;
    }
    .flatpickr-months .flatpickr-prev-month, 
    .flatpickr-months .flatpickr-next-month {
      fill: var(--text-muted) !important;
      color: var(--text-muted) !important;
    }
    .flatpickr-months .flatpickr-prev-month:hover, 
    .flatpickr-months .flatpickr-next-month:hover {
      fill: var(--accent) !important;
      color: var(--accent) !important;
    }
    .flatpickr-weekdays {
      background: var(--surface) !important;
    }
    span.flatpickr-weekday {
      color: var(--text-muted) !important;
      font-weight: 500 !important;
    }
    .flatpickr-day {
      color: var(--text) !important;
      border-radius: 6px !important;
    }
    .flatpickr-day:hover {
      background: var(--border) !important;
      border-color: var(--border) !important;
    }
    .flatpickr-day.today {
      border-color: var(--accent) !important;
    }
    .flatpickr-day.selected {
      background: var(--accent) !important;
      border-color: var(--accent) !important;
      color: #000 !important;
      font-weight: 600 !important;
    }
    .flatpickr-day.flatpickr-disabled {
      color: var(--text-muted) !important;
      opacity: 0.4 !important;
    }
    .flatpickr-day.prevMonthDay,
    .flatpickr-day.nextMonthDay {
      color: var(--text-muted) !important;
      opacity: 0.5 !important;
    }
    .flatpickr-time {
      background: var(--surface) !important;
      border-top: 1px solid var(--border) !important;
    }
    .flatpickr-time input {
      color: var(--text) !important;
      background: var(--surface-elevated) !important;
      border: 1px solid var(--border) !important;
      border-radius: 6px !important;
    }
    .flatpickr-time input:hover,
    .flatpickr-time input:focus {
      background: var(--surface) !important;
      border-color: var(--accent) !important;
    }
    .flatpickr-time .flatpickr-am-pm {
      color: var(--text) !important;
      background: var(--surface-elevated) !important;
      border: 1px solid var(--border) !important;
      border-radius: 6px !important;
    }
    .flatpickr-time .flatpickr-am-pm:hover {
      background: var(--border) !important;
    }
    .numInputWrapper span {
      border-color: var(--border) !important;
    }
    .numInputWrapper span:hover {
      background: var(--border) !important;
    }
    .numInputWrapper span svg path {
      fill: var(--text-muted) !important;
    }
    
    /* Template Level Selector */
    .template-level-section {
      background: var(--surface-elevated);
      padding: 12px 16px;
      border-radius: 8px;
      border: 1px solid var(--border);
    }
    .template-level-btn {
      padding: 6px 14px;
      font-size: 0.85rem;
      font-weight: 500;
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text-muted);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .template-level-btn:hover {
      border-color: var(--accent);
      color: var(--text);
    }
    .template-level-btn.active {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }
    
    /* Enhanced Evidence Items - Two Zone Layout */
    .evidence-item {
      border: 1px solid var(--border);
      border-radius: 10px;
      margin-bottom: 12px;
      background: var(--surface);
      overflow: hidden;
    }
    .evidence-item.included {
      border-color: var(--accent);
      background: rgba(16, 185, 129, 0.05);
    }
    
    /* === COMPACT EVIDENCE ITEM LAYOUT === */
    .ei-header {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: var(--surface-elevated);
      border-bottom: 1px solid var(--border);
    }
    .ei-header input[type="checkbox"] {
      width: 16px;
      height: 16px;
      cursor: pointer;
      flex-shrink: 0;
    }
    .ei-title {
      font-weight: 600;
      font-size: 0.9rem;
      flex: 1;
    }
    .ei-body {
      display: none;
    }
    .evidence-item.included .ei-body {
      display: flex;
      flex-wrap: wrap;
    }
    
    /* Two-Column Layout: Client Zone + Guidance Side-by-Side */
    .ei-client-zone {
      flex: 1;
      min-width: 280px;
      padding: 10px 12px;
      border-right: 1px solid var(--border);
    }
    .ei-guidance-zone {
      width: 260px;
      flex-shrink: 0;
      padding: 10px 12px;
      background: rgba(0,0,0,0.15);
      font-size: 0.82rem;
    }
    /* Stack on narrow screens */
    @media (max-width: 700px) {
      .evidence-item.included .ei-body {
        flex-direction: column;
      }
      .ei-client-zone {
        border-right: none;
        border-bottom: 1px solid var(--border);
      }
      .ei-guidance-zone {
        width: 100%;
      }
    }
    
    /* Zone Headers - Compact */
    .ei-zone-header {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
      opacity: 0.8;
    }
    .ei-zone-header.client {
      color: var(--accent);
    }
    .ei-zone-header.guidance {
      color: var(--text-muted);
    }
    
    /* Field Labels - Inline */
    .ei-field-label {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 3px;
      display: block;
    }
    
    /* Description Textarea - Compact */
    .ei-description-textarea {
      width: 100%;
      min-height: 48px;
      max-height: 120px;
      padding: 8px 10px;
      background: var(--surface-elevated);
      border: 1px solid var(--border);
      border-radius: 5px;
      color: var(--text);
      font-size: 0.82rem;
      font-family: inherit;
      line-height: 1.45;
      resize: vertical;
    }
    .ei-description-textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
    }
    .ei-description-actions {
      display: flex;
      gap: 6px;
      margin-top: 4px;
      justify-content: flex-end;
    }
    .ei-action-btn {
      font-size: 0.7rem;
      color: var(--text-muted);
      background: none;
      border: none;
      cursor: pointer;
      padding: 2px 5px;
      border-radius: 3px;
      transition: all 0.15s;
    }
    .ei-action-btn:hover {
      color: var(--text);
      background: var(--surface-elevated);
    }
    
    /* Format Chips - Inline Row */
    .ei-formats-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
      flex-wrap: wrap;
    }
    .ei-formats-label {
      font-size: 0.72rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }
    .ei-format-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      align-items: center;
    }
    .ei-format-chip {
      display: inline-flex;
      align-items: center;
      gap: 3px;
      padding: 2px 8px;
      background: rgba(37, 99, 235, 0.15);
      color: #60a5fa;
      border-radius: 10px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    .ei-format-chip .chip-remove {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: rgba(255,255,255,0.2);
      cursor: pointer;
      font-size: 9px;
      line-height: 1;
      transition: background 0.15s;
    }
    .ei-format-chip .chip-remove:hover {
      background: rgba(255,255,255,0.4);
    }
    .ei-add-format {
      display: inline-flex;
      align-items: center;
      gap: 3px;
      padding: 2px 8px;
      background: transparent;
      color: var(--text-muted);
      border: 1px dashed var(--border);
      border-radius: 10px;
      font-size: 0.72rem;
      cursor: pointer;
      transition: all 0.15s;
    }
    .ei-add-format:hover {
      border-color: var(--primary);
      color: var(--primary);
    }
    .ei-format-input {
      width: 80px;
      padding: 2px 6px;
      font-size: 0.75rem;
      background: var(--surface-elevated);
      border: 1px solid var(--primary);
      border-radius: 10px;
      color: var(--text);
      outline: none;
    }
    .ei-formats-reset {
      font-size: 0.68rem;
      color: var(--text-muted);
      background: none;
      border: none;
      cursor: pointer;
      padding: 2px 4px;
      opacity: 0.7;
    }
    .ei-formats-reset:hover {
      opacity: 1;
      text-decoration: underline;
    }
    
    /* Additional Instructions - Compact */
    .ei-instructions-row {
      margin-top: 8px;
    }
    .ei-instructions-textarea {
      width: 100%;
      min-height: 32px;
      max-height: 80px;
      padding: 6px 8px;
      background: var(--surface-elevated);
      border: 1px solid var(--border);
      border-radius: 5px;
      color: var(--text);
      font-size: 0.82rem;
      font-family: inherit;
      line-height: 1.4;
      resize: vertical;
    }
    .ei-instructions-textarea::placeholder {
      color: var(--text-muted);
      font-size: 0.78rem;
    }
    .ei-instructions-textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
    }
    
    /* Guidance Zone - Compact Sidebar */
    .ei-guidance-zone.collapsed {
      padding: 6px 12px;
    }
    .ei-guidance-zone.collapsed .ei-guidance-content {
      display: none;
    }
    .ei-guidance-toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
    }
    .ei-guidance-toggle-btn {
      font-size: 0.68rem;
      color: var(--text-muted);
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
    }
    .ei-guidance-content {
      margin-top: 6px;
    }
    .ei-guidance-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-bottom: 6px;
    }
    .ei-tag {
      padding: 1px 6px;
      border-radius: 3px;
      background: var(--surface);
      color: var(--text-muted);
      font-size: 0.7rem;
    }
    .ei-tag.control {
      background: rgba(16, 185, 129, 0.15);
      color: #34d399;
    }
    .ei-tag.period {
      background: rgba(245, 158, 11, 0.15);
      color: #fbbf24;
    }
    .ei-tag.point {
      background: rgba(139, 92, 246, 0.15);
      color: #a78bfa;
    }
    .ei-tip {
      font-size: 0.78rem;
      color: var(--warning);
      padding: 6px 8px;
      background: rgba(245, 158, 11, 0.08);
      border-radius: 4px;
      border-left: 2px solid var(--warning);
      line-height: 1.35;
    }
    .ei-tip-label {
      font-weight: 600;
      font-size: 0.7rem;
      display: block;
      margin-bottom: 2px;
      opacity: 0.9;
    }
    
    /* Preview Modal */
    .preview-modal-content {
      max-width: 700px;
      max-height: 80vh;
      overflow-y: auto;
    }
    .preview-item {
      padding: 14px;
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 12px;
      background: var(--surface-elevated);
    }
    .preview-item-title {
      font-weight: 600;
      margin-bottom: 8px;
    }
    .preview-item-framework {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 8px;
    }
    .preview-item-description {
      font-size: 0.9rem;
      color: var(--text);
      line-height: 1.5;
      margin-bottom: 8px;
    }
    .preview-item-format {
      display: inline-block;
      padding: 3px 8px;
      background: rgba(37, 99, 235, 0.15);
      color: #60a5fa;
      border-radius: 4px;
      font-size: 0.8rem;
      margin-right: 6px;
      margin-bottom: 4px;
    }
    .preview-item-instructions {
      font-size: 0.85rem;
      color: var(--accent);
      font-style: italic;
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid var(--border);
    }
    
    /* Preview/Send Button Row */
    .action-button-row {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }
    .action-button-row .btn {
      flex: 1;
    }
    .btn-preview {
      background: var(--surface-elevated);
      border: 1px solid var(--border);
      color: var(--text);
    }
    .btn-preview:hover {
      background: var(--border);
    }
    
    /* Audit Period Group */
    .audit-period-group {
      background: var(--surface-elevated);
      padding: 16px;
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    /* Draft Save Indicator */
    .draft-indicator {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      z-index: 999;
      transition: opacity 0.3s;
      pointer-events: none;
      opacity: 0;
      background: #065f46;
      color: #d1fae5;
    }
    .draft-indicator.visible { opacity: 1; }
    .draft-indicator.saving { background: #1e3a5f; color: #bfdbfe; }

    /* Trial Dashboard Feature Badges */
    .feature-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      background: linear-gradient(135deg, #1e3a5f, #0f2440);
      color: #60a5fa;
      border: 1px solid #1e40af33;
      margin-left: 8px;
      vertical-align: middle;
    }

    /* Dashboard Empty State */
    .empty-state {
      text-align: center;
      padding: 32px 20px;
      color: var(--text-muted);
    }
    .empty-state-icon {
      font-size: 32px;
      margin-bottom: 12px;
      opacity: 0.5;
    }
    .empty-state-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 6px;
    }
    .empty-state-desc {
      font-size: 13px;
      line-height: 1.5;
      max-width: 400px;
      margin: 0 auto;
    }

    /* Draft Resume Card */
    .draft-card {
      background: linear-gradient(135deg, #0f2440, #1a1a3e);
      border: 1px solid #2563eb44;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }
    .draft-card-info { flex: 1; }
    .draft-card-info h4 { margin: 0 0 4px; font-size: 15px; color: #93c5fd; }
    .draft-card-info p { margin: 0; font-size: 13px; color: var(--text-muted); }
    .draft-card-actions { display: flex; gap: 8px; flex-shrink: 0; }
  </style>
</head>
<body>
  <header class="header">
    <a href="/" class="logo">
      <div class="logo-icon">
        <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
      </div>
      ProofRepo
    </a>
    <nav class="header-links">
      <a href="#how-it-works">How it works</a>
      <a href="#trust">Security</a>
      <a id="getStartedLink">Get started</a>
    </nav>
  </header>

  <section class="hero">
    <div class="hero-badge">Compliance ProofPacks in Seconds</div>
    <h1>Streamlined evidence collection &mdash; without the chaos</h1>
    <p><strong>Compliance teams:</strong> Define exactly what evidence you need. Send your client a guided upload link.</p>
    <p><strong>Companies:</strong> Upload evidence with clear guidance. No more "wrong file" corrections.</p>
    <div class="hero-features">
      <div class="hero-feature">
        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
        <span><strong>Customized requests:</strong> Specify exactly what you need.</span>
      </div>
      <div class="hero-feature">
        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
        <span><strong>Guided for clients:</strong> Clear checklist shows what to upload.</span>
      </div>
      <div class="hero-feature">
        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
        <span><strong>Structured output:</strong> Files mapped to controls, ready for workpapers.</span>
      </div>
    </div>
  </section>

  <main class="main-container">
    <!-- Success Banner -->
    <div id="successBanner" class="success-banner">
      <h3>&#10003; Payment Successful!</h3>
      <p>Your code is ready to use:</p>
      <div class="code-display" id="successCodeDisplay">&mdash;</div>
      <p style="font-size: 0.85rem;">This code has been auto-filled below. Click "Send Request" when ready.</p>
    </div>

    <div id="mainFormCard" class="card">
      <div class="card-header">
        <h2>Request compliance evidence</h2>
        <p>Build guided evidence request checklists and let ProofRepo handle collection and follow-up.</p>
      </div>

      <div id="roleSelectSection" class="role-selector">
        <label class="form-label">Getting started</label>
        <select id="roleSelect">
          <option value="">Select...</option>
          <option value="new">I'm new to ProofRepo</option>
          <option value="returning">I'm a returning customer</option>
        </select>
      </div>

      <!-- Auth Flow: New User -->
      <div id="newUserFlow" class="auth-flow" style="display: none;">
        <div class="auth-box">
          <h3>Welcome to ProofRepo!</h3>
          <p class="auth-subtitle">Choose how you'd like to get started:</p>
          
          <div class="auth-options">
            <label class="auth-option">
              <input type="radio" name="newUserType" value="trial" checked>
              <span class="auth-option-content">
                <span class="auth-option-title">I have a trial code</span>
                <span class="auth-option-desc">Distributed to select members of the compliance community</span>
              </span>
            </label>
            <label class="auth-option">
              <input type="radio" name="newUserType" value="account">
              <span class="auth-option-content">
                <span class="auth-option-title">Create an account</span>
                <span class="auth-option-desc">Purchase credits and save templates</span>
              </span>
            </label>
          </div>

          <!-- Trial Code Entry -->
          <div id="trialCodeSection" class="auth-section">
            <div class="form-group">
              <label class="form-label">Trial Code</label>
              <input type="text" class="form-input code-style" id="trialCodeInput" placeholder="ENTER TRIAL CODE">
            </div>
            <button class="btn btn-primary btn-full" id="applyTrialBtn">Apply Code</button>
            <div id="trialStatus" class="auth-status"></div>
          </div>

          <!-- Trial Mode Selection (shown after valid trial code) -->
          <div id="trialModeSection" class="auth-section" style="display: none;">
            <div class="success-box">
              <span class="success-icon">&#10003;</span>
              <span>Trial code accepted! 1 free request.</span>
            </div>
            
            <div class="form-group">
              <label class="form-label">Your email</label>
              <input type="email" class="form-input" id="trialUserEmail" placeholder="you@company.com">
              <span class="form-hint">We'll send confirmation and results here</span>
            </div>
            
            <div class="form-group">
              <label class="form-label">Trial mode</label>
              <div class="trial-modes">
                <label class="trial-mode">
                  <input type="radio" name="trialMode" value="live" checked>
                  <span class="trial-mode-content">
                    <strong>Live request</strong>
                    <span>Send to a real client</span>
                  </span>
                </label>
                <label class="trial-mode">
                  <input type="radio" name="trialMode" value="test">
                  <span class="trial-mode-content">
                    <strong>Test mode</strong>
                    <span>Experience the full flow yourself</span>
                  </span>
                </label>
              </div>
              <div id="testModeExplainer" class="info-box" style="display: none;">
                See both sides of ProofRepo: Build your evidence request, receive the client email, upload sample files, then get the collector confirmation with your ProofPack. No real data needed.
              </div>
            </div>
            
            <button class="btn btn-accent btn-full" id="startTrialBtn">Continue to Request Builder</button>
          </div>

          <!-- Account Creation -->
          <div id="accountSection" class="auth-section" style="display: none;">
            <div class="form-group">
              <label class="form-label">Email</label>
              <input type="email" class="form-input" id="signupEmail" placeholder="you@company.com">
            </div>
            <div class="form-group">
              <label class="form-label">Password</label>
              <input type="password" class="form-input" id="signupPassword" placeholder="Create a password">
              <div class="password-reqs">
                <span class="req" data-req="length">8+ characters</span>
                <span class="req" data-req="number">1 number</span>
                <span class="req" data-req="special">1 special character</span>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Confirm Password</label>
              <input type="password" class="form-input" id="signupPasswordConfirm" placeholder="Confirm password">
            </div>
            <button class="btn btn-primary btn-full" id="signupBtn">Create Account</button>
            <p class="auth-footnote">We'll send a verification email to confirm your account.</p>
            <div id="signupStatus" class="auth-status"></div>
          </div>
        </div>
      </div>

      <!-- Auth Flow: Returning User -->
      <div id="returningUserFlow" class="auth-flow" style="display: none;">
        <div class="auth-box">
          <h3>Welcome back!</h3>
          
          <!-- Login Form -->
          <div id="loginSection">
            <div class="form-group">
              <label class="form-label">Email</label>
              <input type="email" class="form-input" id="loginEmail" placeholder="you@company.com">
            </div>
            <div class="form-group">
              <label class="form-label">Password</label>
              <input type="password" class="form-input" id="loginPassword" placeholder="Your password">
            </div>
            <div class="login-options">
              <label class="checkbox-label">
                <input type="checkbox" id="rememberMe" checked>
                <span>Remember me for 30 days</span>
              </label>
              <a href="#" id="forgotPasswordLink" class="text-link">Forgot password?</a>
            </div>
            <button class="btn btn-primary btn-full" id="loginBtn">Sign In</button>
            <div id="loginStatus" class="auth-status"></div>
          </div>

          <!-- Forgot Password -->
          <div id="forgotPasswordSection" style="display: none;">
            <p class="auth-subtitle">Enter your email and we'll send a reset link.</p>
            <div class="form-group">
              <label class="form-label">Email</label>
              <input type="email" class="form-input" id="resetEmail" placeholder="you@company.com">
            </div>
            <button class="btn btn-primary btn-full" id="sendResetBtn">Send Reset Link</button>
            <button class="btn btn-outline btn-full" id="backToLoginBtn" style="margin-top: 8px;">Back to Sign In</button>
            <div id="resetStatus" class="auth-status"></div>
          </div>

          <!-- Reset Password Form (shown when ?reset= token in URL) -->
          <div id="resetPasswordSection" style="display: none;">
            <p class="auth-subtitle">Choose a new password for your account.</p>
            <div class="form-group">
              <label class="form-label">New Password</label>
              <input type="password" class="form-input" id="newPassword" placeholder="Minimum 8 characters">
              <div class="password-requirements" id="resetPwReqs">
                <span id="resetReqLength">X 8+ characters</span>
                <span id="resetReqNumber">X 1 number</span>
                <span id="resetReqSpecial">X 1 special character</span>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Confirm Password</label>
              <input type="password" class="form-input" id="confirmNewPassword" placeholder="Re-enter new password">
            </div>
            <button class="btn btn-primary btn-full" id="resetPasswordBtn">Reset Password</button>
            <div id="resetPasswordStatus" class="auth-status"></div>
          </div>
        </div>
      </div>

      <!-- Logged In Header Bar (shown when authenticated) -->
      <div id="loggedInBar" class="logged-in-bar" style="display: none;">
        <div class="user-info">
          <span class="user-email" id="currentUserEmail"></span>
          <span class="credits-badge" id="creditsDisplay">0 credits</span>
          <button class="btn btn-xs btn-outline" id="buyCreditsHeaderBtn">Buy Credits</button>
        </div>
        <div class="user-actions">
          <button class="btn btn-sm btn-outline" id="logoutBtn">Sign Out</button>
        </div>
      </div>

      <!-- Trial Notice Bar -->
      <div id="trialNoticeBar" class="trial-notice" style="display: none;">
        <span class="trial-badge">TRIAL</span>
        <span>You're using a trial credit. <a href="#" id="createAccountLink">Create an account</a> to save templates.</span>
      </div>

      <!-- Verification Notice -->
      <div id="verificationNotice" class="verification-notice" style="display: none;">
        <span>&#9888; Please verify your email to send requests. <a href="#" id="resendVerifyLink">Resend verification</a></span>
      </div>

      <!-- Dashboard View (shown for logged-in users) -->
      <div id="dashboardView" style="display: none;">
        <div class="dashboard-header">
          <div>
            <h2 class="dashboard-title">Your Evidence Requests</h2>
            <p class="dashboard-subtitle">Manage your compliance evidence collection</p>
          </div>
          <button class="btn btn-accent" id="newRequestBtn">+ New Evidence Request</button>
        </div>
        
        <!-- Draft Resume Card (shown if draft exists) -->
        <div id="draftResumeCard" class="draft-card" style="display: none;">
          <div class="draft-card-info">
            <h4> Unsent Draft</h4>
            <p id="draftResumeDesc">You have an in-progress evidence request.</p>
          </div>
          <div class="draft-card-actions">
            <button class="btn btn-sm btn-primary" id="resumeDraftBtn">Resume</button>
            <button class="btn btn-sm btn-secondary" id="discardDraftBtn" style="font-size:12px;">Discard</button>
          </div>
        </div>
        
        <!-- Low Credit Alert -->
        <div id="creditAlert" class="credit-alert" style="display: none;">
          <div class="credit-alert-content">
            <div class="credit-alert-icon">&#9888;</div>
            <div class="credit-alert-text">
              <strong id="creditAlertTitle">Running low on credits</strong>
              <span id="creditAlertDesc">You have <span id="creditAlertCount">0</span> credit(s) remaining.</span>
            </div>
          </div>
          <button class="btn btn-sm btn-accent" id="buyCreditsAlertBtn">Buy More Credits</button>
        </div>
        
        <!-- Stats Cards -->
        <div class="stats-grid" id="statsGrid">
          <div class="stat-card">
            <div class="stat-value" id="statActive">-</div>
            <div class="stat-label">Active Requests</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statCompleted">-</div>
            <div class="stat-label">Completed</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statEvidence">-</div>
            <div class="stat-label">Evidence Items Collected</div>
          </div>
          <div class="stat-card highlight">
            <div class="stat-value" id="statThisMonth">-</div>
            <div class="stat-label">Requests This Month</div>
          </div>
        </div>
        
        <!-- Active Requests Section -->
        <div class="request-section">
          <h3 class="section-title">Active Requests</h3>
          <div id="activeRequestsList" class="requests-list">
            <div class="loading-placeholder">Loading requests...</div>
          </div>
        </div>
        
        <!-- Completed Requests Section -->
        <div class="request-section">
          <h3 class="section-title">Completed</h3>
          <div id="completedRequestsList" class="requests-list">
            <div class="loading-placeholder">Loading requests...</div>
          </div>
        </div>
        
        <!-- Saved Templates Section -->
        <div class="request-section">
          <h3 class="section-title">
            Saved Templates
            <span class="section-count" id="templateCount">(0)</span>
          </h3>
          <div id="templatesList" class="templates-list">
            <div class="loading-placeholder">Loading templates...</div>
          </div>
        </div>
      </div>

      <div id="auditorFlow" style="display: none;">
        <!-- Back to dashboard link (shown when coming from dashboard) -->
        <div id="backToDashboard" class="back-link" style="display: none;">
          <a href="#" id="backToDashboardLink">&larr; Back to Dashboard</a>
        </div>
        
        <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 20px;">
          Define what evidence you need, then we'll email your client a guided upload link.
        </p>

        <div class="form-group">
          <label class="form-label">Your team's email(s)</label>
          <div class="chip-input-container" id="auditorEmailsContainer" data-placeholder="you@yourcompany.com">
            <input type="text" class="chip-text-input" placeholder="you@yourcompany.com">
          </div>
          <div class="chip-input-hint">Press Enter or comma to add multiple team members</div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Client company</label>
            <input type="text" class="form-input" id="clientCompany" placeholder="Acme Corp">
          </div>
          <div class="form-group">
            <label class="form-label">Client email(s)</label>
            <div class="chip-input-container" id="clientEmailsContainer" data-placeholder="client@company.com">
              <input type="text" class="chip-text-input" placeholder="client@company.com">
            </div>
            <div class="chip-input-hint">Add multiple contacts if needed</div>
          </div>
        </div>

        <!-- Deadline with Calendar Picker -->
        <div class="form-group">
          <label class="form-label">Deadline</label>
          <input type="text" class="form-control" id="deadlinePicker" placeholder="Select date and time..." readonly>
          <small class="form-hint" id="deadlineHint" style="margin-top:6px;display:block;color:var(--text-muted);font-size:12px;"></small>
        </div>

        <!-- Audit Period (Optional) -->
        <div class="form-group audit-period-group">
          <label class="form-label">Audit Period <span style="font-weight:normal;color:var(--text-muted);">(optional)</span></label>
          <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 10px;">
            For period-of-time evidence (logs, reviews, scans), these dates help clients understand what timeframe is required.
          </p>
          <div class="form-row" style="gap: 16px;">
            <div style="flex:1;">
              <label class="form-label" style="font-size:0.8rem;">Start Date</label>
              <input type="text" class="form-control" id="auditPeriodStart" placeholder="e.g., Jan 1, 2025" readonly>
            </div>
            <div style="flex:1;">
              <label class="form-label" style="font-size:0.8rem;">End Date</label>
              <input type="text" class="form-control" id="auditPeriodEnd" placeholder="e.g., Dec 31, 2025" readonly>
            </div>
          </div>
          <small id="auditPeriodHint" style="margin-top:6px;display:block;color:var(--text-muted);font-size:12px;"></small>
        </div>

        <!-- Engagement Reference (Optional) -->
        <div class="form-group">
          <label class="form-label">Engagement Reference <span style="font-weight:normal;color:var(--text-muted);">(optional)</span></label>
          <input type="text" class="form-input" id="engagementRef" placeholder="e.g., Acme SOC 2 FY2025 or WP-ACC-001">
          <small style="margin-top:4px;display:block;color:var(--text-muted);font-size:12px;">Appears on the Evidence Summary PDF. Useful for tying to your workpaper binder.</small>
        </div>

        <div class="form-group">
          <label class="form-label">Evidence Request</label>
          
          <!-- Template Loader (shown when logged in with templates) -->
          <div id="templateLoaderSection" class="template-loader-section" style="display: none;">
            <select id="templateSelect" class="template-select-inline">
              <option value="">Load a saved template...</option>
            </select>
          </div>
          
          <!-- Template Loaded Notification -->
          <div id="templateLoadedNotice" class="template-loaded-notice" style="display: none;">
            <div class="notice-content">
              <span class="notice-icon">&#10003;</span>
              <div class="notice-text">
                <strong>Template loaded:</strong> <span id="loadedTemplateName"></span>
                <p>Frameworks, evidence items, and instructions have been restored. If you make changes, remember to save as a new template below.</p>
              </div>
              <button type="button" class="notice-dismiss" id="dismissTemplateNotice">x</button>
            </div>
          </div>
          
          <!-- Template level now per-framework in composer -->
          
          <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 12px;">
            Check frameworks, then customize what evidence you need. Items with &#10003; are included by default.
          </p>
          <div id="composer"></div>
        </div>

        <!-- Payment Section -->
        <div id="paymentSection" class="payment-section">
          <div class="payment-header">
            <h3>Enter your credit code</h3>
            <p>Each code gives you credits to send evidence requests.</p>
          </div>

          <div class="code-entry">
            <label class="form-label">Credit Code</label>
            <input type="text" class="code-input" id="auditorCode" placeholder="ENTER CODE">
            <div id="codeStatus" class="code-status"></div>
          </div>

          <!-- Purchase section - hidden after checkout return -->
          <div id="purchaseSection" class="purchase-section">
            <p class="divider-text">&mdash; or purchase credits &mdash;</p>
            <div class="pricing-grid">
              <div class="pricing-card" data-tier="single">
                <div class="pricing-card-name">Single</div>
                <div class="pricing-card-price">$59</div>
                <div class="pricing-card-desc">1 credit</div>
              </div>
              <div class="pricing-card" data-tier="pack5">
                <div class="pricing-card-name">5-Pack</div>
                <div class="pricing-card-price">$249</div>
                <div class="pricing-card-desc">$50 each</div>
              </div>
              <div class="pricing-card" data-tier="pack15">
                <div class="pricing-card-name">15-Pack</div>
                <div class="pricing-card-price">$499</div>
                <div class="pricing-card-desc">$33 each</div>
              </div>
              <div class="pricing-card" data-tier="pack50">
                <div class="pricing-card-name">50-Pack</div>
                <div class="pricing-card-price">$1,249</div>
                <div class="pricing-card-desc">$25 each</div>
              </div>
            </div>
            <button class="btn btn-outline btn-full" id="buyCreditsBtn" disabled>
              Select a plan to purchase
            </button>
          </div>
        </div>

        <!-- Action Buttons Row -->
        <div class="action-button-row" style="margin-top: 24px;">
          <button class="btn btn-preview" id="previewClientBtn" style="flex: 0 0 auto; padding: 12px 20px;">
            &#128065; Preview Client View
          </button>
          <button class="btn btn-primary" id="mainActionBtn" style="flex: 1;">
            Continue
          </button>
        </div>
      </div>
    </div>
  </main>

  <section id="how-it-works" class="how-section">
    <h2>How it works</h2>
    <div class="how-grid">
      <div class="how-card">
        <h3>1. Create your request</h3>
        <p>Select frameworks, customize evidence items, add instructions for your client.</p>
      </div>
      <div class="how-card">
        <h3>2. Client uploads</h3>
        <p>Client receives a link with a clear checklist of exactly what to provide.</p>
      </div>
      <div class="how-card">
        <h3>3. ProofPack ready</h3>
        <p>Files organized by control area with a manifest ready for workpapers.</p>
      </div>
    </div>
  </section>

  <!-- TRUST SECTION -->
  <section class="trust-section" id="trust">
    <div class="section-inner">
      <div class="section-header">
        <div class="section-badge">
          <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
            <path d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
          </svg>
          Security First
        </div>
        <h2>Your Data, Protected</h2>
        <p class="section-subtitle">Enterprise-grade security without enterprise complexity. Built on trusted infrastructure.</p>
      </div>

      <div class="trust-grid">
        <div class="trust-card">
          <div class="trust-card-icon">
            <svg viewBox="0 0 24 24">
              <path d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
            </svg>
          </div>
          <h3>AES-256 Encryption</h3>
          <p>Bank-grade encryption at rest</p>
        </div>

        <div class="trust-card">
          <div class="trust-card-icon">
            <svg viewBox="0 0 24 24">
              <path d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
            </svg>
          </div>
          <h3>TLS 1.2+ Transit</h3>
          <p>Encrypted data transfer</p>
        </div>

        <div class="trust-card">
          <div class="trust-card-icon">
            <svg viewBox="0 0 24 24">
              <path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
            </svg>
          </div>
          <h3>90-Day Auto-Delete</h3>
          <p>Automatic data removal</p>
        </div>

        <div class="trust-card">
          <div class="trust-card-icon">
            <svg viewBox="0 0 24 24">
              <path d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
            </svg>
          </div>
          <h3>SOC 2 Infrastructure</h3>
          <p>Built on Cloudflare</p>
        </div>
      </div>

      <div class="trust-footer">
        <span class="trust-footer-text">Learn more:</span>
        <div class="trust-links">
          <a href="/security.html" class="trust-link">
            <svg viewBox="0 0 24 24">
              <path d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
            </svg>
            Security
          </a>
          <a href="/privacy.html" class="trust-link">
            <svg viewBox="0 0 24 24">
              <path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
              <path d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
            </svg>
            Privacy
          </a>
          <a href="/terms.html" class="trust-link">
            <svg viewBox="0 0 24 24">
              <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
            Terms
          </a>
        </div>
      </div>
    </div>
  </section>

  <footer class="footer">
    <div class="footer-links">
      <a href="#how-it-works">How it Works</a>
      <a href="/security.html">Security</a>
      <a href="/privacy.html">Privacy Policy</a>
      <a href="/terms.html">Terms of Service</a>
      <a href="/cdn-cgi/l/email-protection#7605030606190402360604191910041306195815191b">Contact</a>
    </div>
    <p>&copy; <span id="year"></span> ProofRepo. All rights reserved.</p>
  </footer>

  <div class="marquee-fixed">
    <div class="marquee">
      <div>&nbsp;Guided compliance evidence collection  &bull; Built for compliance teams  &bull; SOC 2, ISO 27001, HIPAA, GDPR & more  &bull; Get started with a free trial  &bull;&nbsp;&nbsp;&nbsp;&nbsp;Guided compliance evidence collection  &bull; Built for compliance teams  &bull; SOC 2, ISO 27001, HIPAA, GDPR & more  &bull; Get started with a free trial  &bull;</div>
    </div>
  </div>

  <div id="addFwModal" class="modal-overlay hidden">
    <div class="modal">
      <h3>Add Custom Framework</h3>
      <div class="form-group">
        <label class="form-label">Framework name</label>
        <input type="text" class="form-input" id="customFwName" placeholder="e.g., PCI DSS, FedRAMP, Internal Audit">
      </div>
      <div class="form-group">
        <label class="form-label">Description (optional)</label>
        <input type="text" class="form-input" id="customFwDesc" placeholder="Brief description">
      </div>
      <div class="modal-actions">
        <button type="button" class="btn btn-outline" id="cancelFwBtn">Cancel</button>
        <button type="button" class="btn btn-primary" id="saveFwBtn">Add Framework</button>
      </div>
    </div>
  </div>

  <div id="addGroupModal" class="modal-overlay hidden">
    <div class="modal">
      <h3>Add Control Group</h3>
      <div class="form-group">
        <label class="form-label">Control group name</label>
        <input type="text" class="form-input" id="customGroupName" placeholder="e.g., Network Security, Physical Security">
      </div>
      <div class="form-group">
        <label class="form-label">Description (optional)</label>
        <input type="text" class="form-input" id="customGroupDesc" placeholder="What this control group covers">
      </div>
      <input type="hidden" id="customGroupFwKey" value="">
      <div class="modal-actions">
        <button type="button" class="btn btn-outline" id="cancelGroupBtn">Cancel</button>
        <button type="button" class="btn btn-primary" id="saveGroupBtn">Add Control Group</button>
      </div>
    </div>
  </div>

  <!-- Client Preview Modal -->
  <div id="previewModal" class="modal-overlay hidden">
    <div class="modal preview-modal-content">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <h3 style="margin: 0;">&#128065; Client Preview</h3>
        <button type="button" class="btn btn-sm btn-outline" onclick="closePreviewModal()">&#10005; Close</button>
      </div>
      <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 16px; padding: 10px; background: var(--surface-elevated); border-radius: 6px;">
        This is how your client will see the evidence request checklist. Review to ensure it looks professional before sending.
      </p>
      <div id="previewModalContent">
        <!-- Content injected by showClientPreview() -->
      </div>
      <div class="modal-actions" style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border);">
        <button type="button" class="btn btn-outline" onclick="closePreviewModal()">Close Preview</button>
        <button type="button" class="btn btn-primary" onclick="closePreviewModal(); $('#mainActionBtn').click();">Looks Good &mdash; Send Request</button>
      </div>
    </div>
  </div>

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
const API = 'https://proofrepo-intake.atucker5.workers.dev';
const STORAGE_KEY = 'proofrepo_form_state';


// ENHANCED FRAMEWORK LIBRARY v2.0
// Includes 7 frameworks with enhanced fields:
// - description: Detailed professional description
// - evidenceType: 'point-in-time' or 'period-of-time'
// - expectedFormat: PDF, Excel, Screenshot, etc.
// - controlRef: Control reference (CC6.1, A.8.5, etc.)
// - commonIssue: Common rejection reasons
// - frequency: annual, quarterly, monthly, etc.

const FRAMEWORK_LIBRARY = {
SOC2: {
  label: 'SOC 2',
  description: 'Service Organization Control 2 - Trust Services Criteria',
  defaultOn: true,
  controlGroups: [

    // -------------------------------------------------------------------------
    // CC1: Control Environment
    // -------------------------------------------------------------------------
    {
      id: 'cc1_control_environment',
      title: 'CC1 - Control Environment',
      description: 'Organizational structure, governance, and commitment to integrity and ethics',
      items: [
        {
          id: 'org_chart',
          title: 'Organization Chart',
          common: true,
          hint: 'Current organizational structure showing reporting lines',
          description: 'Provide the current organization chart showing reporting relationships, including security/IT leadership positions and their placement within the organizational hierarchy.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF or Image',
          controlRef: 'CC1.1',
          commonIssue: 'Charts often outdated. Ensure this reflects current structure as of the audit period.',
          frequency: 'annual'
        },
        {
          id: 'info_sec_policy',
          title: 'Information Security Policy',
          common: true,
          hint: 'Current policy document with approval date',
          description: 'Provide the organization\'s Information Security Policy. Document should include version number, effective date, policy owner, and evidence of management approval (signature or documented approval).',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'CC1.1, CC1.4',
          commonIssue: 'Rejected if missing approval signature or effective date. Ensure document shows formal adoption by management.',
          frequency: 'annual'
        },
        {
          id: 'code_of_conduct',
          title: 'Code of Conduct',
          common: true,
          hint: 'Ethics and conduct expectations for personnel',
          description: 'Provide the organization\'s Code of Conduct or Ethics Policy that establishes expectations for employee behavior and integrity. Include evidence that employees acknowledge receipt.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'CC1.1',
          commonIssue: 'Should show it\'s communicated to employees. Pair with acknowledgment records if available.',
          frequency: 'annual'
        },
        {
          id: 'code_of_conduct_ack',
          title: 'Code of Conduct Acknowledgments',
          common: false,
          hint: 'Evidence employees acknowledged the code of conduct',
          description: 'Provide evidence that employees have acknowledged the Code of Conduct during {{auditPeriod}}. This can be a report from HR system, signed acknowledgment forms, or LMS completion records.',
          evidenceType: 'period-of-time',
          expectedFormat: 'Excel or PDF',
          controlRef: 'CC1.1',
          commonIssue: ' Ensure acknowledgments are dated within the audit period. Include new hires if they started during the period.',
          frequency: 'annual'
        },
        {
          id: 'security_roles',
          title: 'Security Roles & Responsibilities',
          common: true,
          hint: 'RACI matrix or documented security ownership',
          description: 'Provide documentation showing who is responsible for security within the organization. This can be a RACI matrix, job descriptions for security roles, or a security responsibility matrix.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF or Excel',
          controlRef: 'CC1.3',
          commonIssue: 'Generic job descriptions often insufficient. Show specific individuals assigned to security responsibilities.',
          frequency: 'annual'
        },
        {
          id: 'board_oversight',
          title: 'Board/Management Oversight',
          common: false,
          hint: 'Minutes or reports showing security governance',
          description: 'Provide evidence of board or senior management oversight of security during {{auditPeriod}}. This includes board meeting minutes, security committee meetings, or management review records where security matters were discussed.',
          evidenceType: 'period-of-time',
          expectedFormat: 'PDF',
          controlRef: 'CC1.2',
          commonIssue: ' Minutes should show security was actually discussed, not just that a meeting occurred.',
          frequency: 'quarterly'
        },
        {
          id: 'hr_policies',
          title: 'HR Security Policies',
          common: false,
          hint: 'Hiring, termination, and personnel security procedures',
          description: 'Provide HR policies covering security aspects of employment including background check requirements, onboarding security procedures, and termination/offboarding processes.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'CC1.4',
          commonIssue: 'Ensure policy covers the complete employee lifecycle from hire to termination.',
          frequency: 'annual'
        }
      ]
    },

    // -------------------------------------------------------------------------
    // CC2: Communication and Information
    // -------------------------------------------------------------------------
    {
      id: 'cc2_communication',
      title: 'CC2 - Communication & Information',
      description: 'How security information is communicated internally and externally',
      items: [
        {
          id: 'security_awareness_program',
          title: 'Security Awareness Program',
          common: true,
          hint: 'Description of awareness training program',
          description: 'Provide documentation describing the security awareness training program including topics covered, delivery method (LMS, in-person, etc.), frequency requirements, and target audience.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'CC2.2',
          commonIssue: 'Should describe the program itself, not just completion records. Pair with training completion evidence.',
          frequency: 'annual'
        },
        {
          id: 'security_training_completion',
          title: 'Security Training Completion Records',
          common: true,
          hint: 'Report showing training completion for audit period',
          description: 'Provide training completion records showing all in-scope employees completed security awareness training during {{auditPeriod}}. Include employee name, training date, and completion status.',
          evidenceType: 'period-of-time',
          expectedFormat: 'Excel or PDF',
          controlRef: 'CC2.2',
          commonIssue: ' Must cover all employees, including new hires. Show training occurred within required timeframe.',
          frequency: 'annual'
        },
        {
          id: 'acceptable_use_policy',
          title: 'Acceptable Use Policy',
          common: true,
          hint: 'Policy governing employee use of IT resources',
          description: 'Provide the Acceptable Use Policy defining permitted and prohibited uses of company IT resources, including computers, network, email, and internet usage.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'CC2.1',
          commonIssue: 'Should be specific about what is/isn\'t allowed. Generic policies may require additional clarification.',
          frequency: 'annual'
        },
        {
          id: 'policy_acknowledgments',
          title: 'Policy Acknowledgment Records',
          common: false,
          hint: 'Evidence employees acknowledged security policies',
          description: 'Provide evidence that employees acknowledged key security policies (acceptable use, information security, etc.) during {{auditPeriod}}. Can be HR system report or signed acknowledgment forms.',
          evidenceType: 'period-of-time',
          expectedFormat: 'Excel or PDF',
          controlRef: 'CC2.2',
          commonIssue: ' Acknowledgments should be dated. Include all employees who were active during the audit period.',
          frequency: 'annual'
        },
        {
          id: 'external_communications',
          title: 'External Security Communications',
          common: false,
          hint: 'How security info is communicated to customers/vendors',
          description: 'Provide examples of how security information is communicated to external parties including customers and vendors. This may include security pages on website, customer-facing security documentation, or security addenda to contracts.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF or Screenshot',
          controlRef: 'CC2.3',
          commonIssue: 'Should show mechanisms for external communication exist, not just internal policies.',
          frequency: 'annual'
        },
        {
          id: 'phishing_testing',
          title: 'Phishing Simulation Results',
          common: false,
          hint: 'Results from simulated phishing campaigns',
          description: 'Provide results from phishing simulation campaigns conducted during {{auditPeriod}}. Include campaign dates, number of employees tested, click rates, and any follow-up training provided.',
          evidenceType: 'period-of-time',
          expectedFormat: 'PDF',
          controlRef: 'CC2.2',
          commonIssue: ' Should show organizational response to failures, not just test results.',
          frequency: 'quarterly'
        }
      ]
    },

    // -------------------------------------------------------------------------
    // CC3: Risk Assessment
    // -------------------------------------------------------------------------
    {
      id: 'cc3_risk_assessment',
      title: 'CC3 - Risk Assessment',
      description: 'How the organization identifies, analyzes, and manages risk',
      items: [
        {
          id: 'risk_assessment',
          title: 'Risk Assessment',
          common: true,
          hint: 'Formal risk assessment with identified risks and ratings',
          description: 'Provide the most recent comprehensive risk assessment conducted for {{auditPeriod}}. Should include identified risks, likelihood and impact ratings, risk owners, and assessment methodology used.',
          evidenceType: 'period-of-time',
          expectedFormat: 'PDF or Excel',
          controlRef: 'CC3.1, CC3.2',
          commonIssue: ' Must be dated within audit period or show annual review. Generic templates without org-specific risks are insufficient.',
          frequency: 'annual'
        },
        {
          id: 'risk_register',
          title: 'Risk Register',
          common: true,
          hint: 'Ongoing list of risks with status and owners',
          description: 'Provide the current risk register showing all identified security risks, their current status, assigned owners, and mitigation status. Include columns for risk description, rating, owner, and treatment.',
          evidenceType: 'point-in-time',
          expectedFormat: 'Excel',
          controlRef: 'CC3.2',
          commonIssue: 'Should show active risk management, not a static document. Include evidence of updates during audit period.',
          frequency: 'annual'
        },
        {
          id: 'risk_treatment_plan',
          title: 'Risk Treatment Plans',
          common: true,
          hint: 'Plans for addressing identified risks',
          description: 'Provide risk treatment plans showing how identified risks are being addressed. Include planned mitigations, responsible parties, target completion dates, and current status.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF or Excel',
          controlRef: 'CC3.2',
          commonIssue: 'Plans should show progress, not just intentions. Include status updates from the audit period.',
          frequency: 'annual'
        },
        {
          id: 'risk_acceptance',
          title: 'Risk Acceptance Documentation',
          common: false,
          hint: 'Formal acceptance of residual risks',
          description: 'Provide documentation showing formal acceptance of any risks that have been consciously accepted rather than mitigated. Include risk description, business justification, approver, and approval date.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'CC3.2',
          commonIssue: 'Acceptances should be signed by appropriate authority level based on risk rating.',
          frequency: 'as-needed'
        },
        {
          id: 'third_party_risk_assessment',
          title: 'Third-Party Risk Assessments',
          common: false,
          hint: 'Risk assessments of critical vendors',
          description: 'Provide risk assessments conducted for critical third-party vendors during {{auditPeriod}}. Include vendor name, assessment methodology, risk findings, and any remediation requirements.',
          evidenceType: 'period-of-time',
          expectedFormat: 'PDF or Excel',
          controlRef: 'CC3.4',
          commonIssue: ' Should cover vendors processing sensitive data or providing critical services.',
          frequency: 'annual'
        }
      ]
    },

    // -------------------------------------------------------------------------
    // CC4: Monitoring Activities
    // -------------------------------------------------------------------------
    {
      id: 'cc4_monitoring',
      title: 'CC4 - Monitoring Activities',
      description: 'Ongoing monitoring and evaluation of controls',
      items: [
        {
          id: 'control_monitoring',
          title: 'Control Monitoring Evidence',
          common: true,
          hint: 'Evidence of ongoing control monitoring',
          description: 'Provide evidence of control monitoring activities during {{auditPeriod}}. This includes security metrics dashboards, control testing results, or continuous monitoring outputs.',
          evidenceType: 'period-of-time',
          expectedFormat: 'PDF or Screenshot',
          controlRef: 'CC4.1',
          commonIssue: ' Should show actual monitoring occurred, not just that capability exists.',
          frequency: 'quarterly'
        },
        {
          id: 'internal_audit',
          title: 'Internal Audit Results',
          common: false,
          hint: 'Internal audit or assessment of security controls',
          description: 'Provide internal audit results for security-related audits conducted during {{auditPeriod}}. Include scope, findings, and management responses to any identified deficiencies.',
          evidenceType: 'period-of-time',
          expectedFormat: 'PDF',
          controlRef: 'CC4.1, CC4.2',
          commonIssue: ' If no internal audit function, provide alternative control assessment evidence.',
          frequency: 'annual'
        },
        {
          id: 'deficiency_tracking',
          title: 'Control Deficiency Tracking',
          common: false,
          hint: 'How control deficiencies are tracked and remediated',
          description: 'Provide evidence of how control deficiencies identified during {{auditPeriod}} are tracked and remediated. Include deficiency log, remediation plans, and closure evidence.',
          evidenceType: 'period-of-time',
          expectedFormat: 'Excel or PDF',
          controlRef: 'CC4.2',
          commonIssue: ' Should show deficiencies are tracked to closure, not just identified.',
          frequency: 'quarterly'
        },
        {
          id: 'kpi_metrics',
          title: 'Security KPIs/Metrics',
          common: false,
          hint: 'Security performance metrics and KPIs',
          description: 'Provide security key performance indicators (KPIs) and metrics tracked during {{auditPeriod}}. Include metric definitions, targets, actual performance, and any trend analysis.',
          evidenceType: 'period-of-time',
          expectedFormat: 'PDF or Excel',
          controlRef: 'CC4.1',
          commonIssue: ' Metrics should show meaningful measures, not vanity statistics.',
          frequency: 'quarterly'
        }
      ]
    },

    // -------------------------------------------------------------------------
    // CC5: Control Activities
    // -------------------------------------------------------------------------
    {
      id: 'cc5_control_activities',
      title: 'CC5 - Control Activities',
      description: 'Policies and procedures that help ensure management directives are carried out',
      items: [
        {
          id: 'it_general_controls',
          title: 'IT General Controls Documentation',
          common: true,
          hint: 'Overview of IT general control framework',
          description: 'Provide documentation describing the IT general controls framework including control objectives for access, change management, and operations.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'CC5.1',
          commonIssue: 'Should describe actual implemented controls, not aspirational statements.',
          frequency: 'annual'
        },
        {
          id: 'segregation_of_duties',
          title: 'Segregation of Duties Matrix',
          common: true,
          hint: 'Matrix showing incompatible duties are separated',
          description: 'Provide a segregation of duties matrix or analysis showing how incompatible duties are separated. Include development vs. production access, and financial system access controls.',
          evidenceType: 'point-in-time',
          expectedFormat: 'Excel or PDF',
          controlRef: 'CC5.1',
          commonIssue: 'Should show actual separation, not just policy. Include evidence of enforcement.',
          frequency: 'annual'
        },
        {
          id: 'system_inventory',
          title: 'System/Application Inventory',
          common: true,
          hint: 'List of in-scope systems and applications',
          description: 'Provide an inventory of systems and applications in scope for the audit. Include system name, description, classification, owner, and hosting location (cloud/on-premise).',
          evidenceType: 'point-in-time',
          expectedFormat: 'Excel',
          controlRef: 'CC5.2',
          commonIssue: 'Must be comprehensive and current. Include production systems that process customer data.',
          frequency: 'annual'
        },
        {
          id: 'data_classification_policy',
          title: 'Data Classification Policy',
          common: false,
          hint: 'Policy defining how data is classified',
          description: 'Provide the data classification policy defining classification levels (e.g., Public, Internal, Confidential, Restricted) and handling requirements for each level.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'CC5.2',
          commonIssue: 'Should include specific handling requirements, not just classification labels.',
          frequency: 'annual'
        }
      ]
    },

    // -------------------------------------------------------------------------
    // CC6: Logical and Physical Access Controls
    // -------------------------------------------------------------------------
    {
      id: 'cc6_access_controls',
      title: 'CC6 - Logical & Physical Access Controls',
      description: 'Controls over logical and physical access to systems and facilities',
      items: [
        {
          id: 'access_control_policy',
          title: 'Access Control Policy',
          common: true,
          hint: 'Policy defining access control principles',
          description: 'Provide the Access Control Policy defining principles for granting, modifying, and revoking access. Should include least privilege, need-to-know, and separation of duties requirements.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'CC6.1',
          commonIssue: 'Should be specific about access principles, not generic statements.',
          frequency: 'annual'
        },
        {
          id: 'user_access_review',
          title: 'User Access Reviews',
          common: true,
          hint: 'Evidence of periodic access reviews with approvals',
          description: 'Provide user access review documentation from {{auditPeriod}}. Include the user list reviewed, reviewer name, review date, and approval/remediation decisions for each user.',
          evidenceType: 'period-of-time',
          expectedFormat: 'Excel or PDF',
          controlRef: 'CC6.2',
          commonIssue: ' Must show actual review decisions, not just that a review occurred. Include evidence of remediation for inappropriate access.',
          frequency: 'quarterly'
        },
        {
          id: 'privileged_access_list',
          title: 'Privileged Access User List',
          common: true,
          hint: 'List of users with elevated/admin access',
          description: 'Provide current list of users with privileged/administrative access to in-scope systems. Include username, access level, business justification, and approver.',
          evidenceType: 'point-in-time',
          expectedFormat: 'Excel',
          controlRef: 'CC6.3',
          commonIssue: 'Should include all admin accounts including service accounts. Include justification for each.',
          frequency: 'quarterly'
        },
        {
          id: 'privileged_access_review',
          title: 'Privileged Access Reviews',
          common: true,
          hint: 'Evidence privileged access is reviewed regularly',
          description: 'Provide privileged access review documentation from {{auditPeriod}}. Show that administrative access was reviewed, with approval decisions and any remediation actions taken.',
          evidenceType: 'period-of-time',
          expectedFormat: 'Excel or PDF',
          controlRef: 'CC6.3',
          commonIssue: ' Privileged access should be reviewed more frequently than standard access (at least quarterly).',
          frequency: 'quarterly'
        },
        {
          id: 'mfa_config',
          title: 'MFA Configuration Evidence',
          common: true,
          hint: 'Screenshot showing MFA is required',
          description: 'Provide screenshot(s) or configuration export showing multi-factor authentication (MFA) is required for in-scope systems, particularly for remote access and administrative access.',
          evidenceType: 'point-in-time',
          expectedFormat: 'Screenshot',
          controlRef: 'CC6.1',
          commonIssue: 'Should show MFA is enforced (required), not just enabled (optional).',
          frequency: 'annual'
        },
        {
          id: 'password_policy_config',
          title: 'Password Policy Configuration',
          common: true,
          hint: 'Screenshot showing password requirements',
          description: 'Provide screenshot(s) or configuration export showing password policy settings in the identity provider or directory services. Include complexity, length, expiration, and lockout settings.',
          evidenceType: 'point-in-time',
          expectedFormat: 'Screenshot',
          controlRef: 'CC6.1',
          commonIssue: 'Settings should match documented policy. Ensure all in-scope systems are covered.',
          frequency: 'annual'
        },
        {
          id: 'onboarding_process',
          title: 'Access Provisioning Process',
          common: true,
          hint: 'Documentation of how access is granted',
          description: 'Provide documentation of the access provisioning process for new employees or role changes. Include request, approval, and implementation steps.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'CC6.2',
          commonIssue: 'Should show approval is required before access is granted.',
          frequency: 'annual'
        },
        {
          id: 'onboarding_samples',
          title: 'Access Provisioning Samples',
          common: false,
          hint: 'Sample access requests with approvals',
          description: 'Provide 2-3 sample access provisioning requests from {{auditPeriod}} showing the complete process including request, approval, and implementation evidence.',
          evidenceType: 'period-of-time',
          expectedFormat: 'PDF or Screenshot',
          controlRef: 'CC6.2',
          commonIssue: ' Samples should show proper approval before access was granted.',
          frequency: 'per-occurrence'
        },
        {
          id: 'offboarding_process',
          title: 'Access Revocation Process',
          common: true,
          hint: 'Documentation of termination access removal',
          description: 'Provide documentation of the access revocation process for terminations and role changes. Include timing requirements and verification steps.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'CC6.2',
          commonIssue: 'Should specify timing (same day, 24 hours, etc.) for access removal.',
          frequency: 'annual'
        },
        {
          id: 'offboarding_samples',
          title: 'Access Revocation Samples',
          common: true,
          hint: 'Sample termination access removal evidence',
          description: 'Provide 2-3 sample termination cases from {{auditPeriod}} showing access was revoked timely. Include termination date, access removal date, and systems affected.',
          evidenceType: 'period-of-time',
          expectedFormat: 'PDF or Screenshot',
          controlRef: 'CC6.2',
          commonIssue: ' Must show access was removed on or before termination date for all systems.',
          frequency: 'per-occurrence'
        },
        {
          id: 'sso_config',
          title: 'SSO Configuration',
          common: false,
          hint: 'Single sign-on configuration and covered applications',
          description: 'Provide evidence of SSO configuration including which applications are integrated with SSO and how authentication is enforced.',
          evidenceType: 'point-in-time',
          expectedFormat: 'Screenshot',
          controlRef: 'CC6.1',
          commonIssue: 'Should show which applications are included in SSO scope.',
          frequency: 'annual'
        },
        {
          id: 'physical_access_policy',
          title: 'Physical Security Policy',
          common: false,
          hint: 'Policy covering physical access controls',
          description: 'Provide the Physical Security Policy covering facility access controls, visitor management, and secure area requirements.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'CC6.4',
          commonIssue: 'May not be applicable if fully cloud-hosted. Document cloud provider responsibility.',
          frequency: 'annual'
        },
        {
          id: 'data_center_soc',
          title: 'Data Center SOC Report',
          common: false,
          hint: 'SOC report for data center or cloud provider',
          description: 'Provide the most recent SOC 2 or SOC 1 report from your data center or primary cloud infrastructure provider (AWS, Azure, GCP, etc.) covering {{auditPeriod}}.',
          evidenceType: 'period-of-time',
          expectedFormat: 'PDF',
          controlRef: 'CC6.4',
          commonIssue: ' Report period should overlap with your audit period. Review bridge letter if gap exists.',
          frequency: 'annual'
        },
        {
          id: 'encryption_at_rest',
          title: 'Encryption at Rest Evidence',
          common: true,
          hint: 'Evidence data is encrypted at rest',
          description: 'Provide evidence that sensitive data is encrypted at rest. Include screenshots of encryption configuration for databases, storage, and backup systems.',
          evidenceType: 'point-in-time',
          expectedFormat: 'Screenshot',
          controlRef: 'CC6.7',
          commonIssue: 'Should cover all locations where sensitive data is stored, including backups.',
          frequency: 'annual'
        },
        {
          id: 'encryption_in_transit',
          title: 'Encryption in Transit Evidence',
          common: true,
          hint: 'Evidence data is encrypted in transit',
          description: 'Provide evidence that data is encrypted in transit. Include TLS configuration screenshots, certificate details, and SSL scan results showing minimum TLS 1.2.',
          evidenceType: 'point-in-time',
          expectedFormat: 'Screenshot or PDF',
          controlRef: 'CC6.7',
          commonIssue: 'TLS 1.0 and 1.1 are deprecated. Ensure minimum TLS 1.2 is enforced.',
          frequency: 'annual'
        },
        {
          id: 'encryption_key_management',
          title: 'Encryption Key Management',
          common: false,
          hint: 'How encryption keys are managed',
          description: 'Provide documentation of encryption key management procedures including key generation, storage, rotation, and destruction processes.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'CC6.7',
          commonIssue: 'Should address key rotation schedule and secure key storage.',
          frequency: 'annual'
        }
      ]
    },

    // -------------------------------------------------------------------------
    // CC7: System Operations
    // -------------------------------------------------------------------------
    {
      id: 'cc7_system_operations',
      title: 'CC7 - System Operations',
      description: 'Security monitoring, vulnerability management, and incident detection',
      items: [
        {
          id: 'vulnerability_scanning',
          title: 'Vulnerability Scan Reports',
          common: true,
          hint: 'Vulnerability scan results from audit period',
          description: 'Provide vulnerability scan reports from {{auditPeriod}}. Include scans for infrastructure, applications, and containers as applicable. Show scan dates, findings, and severity levels.',
          evidenceType: 'period-of-time',
          expectedFormat: 'PDF',
          controlRef: 'CC7.1',
          commonIssue: ' Should show regular scanning (at least quarterly). Include evidence of remediation for critical/high findings.',
          frequency: 'quarterly'
        },
        {
          id: 'vulnerability_remediation',
          title: 'Vulnerability Remediation Evidence',
          common: true,
          hint: 'Evidence vulnerabilities are remediated timely',
          description: 'Provide evidence of vulnerability remediation activities during {{auditPeriod}}. Include tracking of critical/high vulnerabilities from identification to closure.',
          evidenceType: 'period-of-time',
          expectedFormat: 'Excel or PDF',
          controlRef: 'CC7.1',
          commonIssue: ' Should show remediation timelines align with policy (e.g., critical within 7 days).',
          frequency: 'quarterly'
        },
        {
          id: 'penetration_testing',
          title: 'Penetration Test Report',
          common: true,
          hint: 'Annual penetration test results',
          description: 'Provide the most recent penetration test report covering {{auditPeriod}}. Include scope, methodology, findings, and remediation status.',
          evidenceType: 'period-of-time',
          expectedFormat: 'PDF',
          controlRef: 'CC7.1',
          commonIssue: ' Test should be performed by independent party. Ensure scope covers all in-scope systems.',
          frequency: 'annual'
        },
        {
          id: 'pentest_remediation',
          title: 'Penetration Test Remediation',
          common: false,
          hint: 'Evidence pentest findings are remediated',
          description: 'Provide evidence that penetration test findings have been remediated or have documented risk acceptance. Include tracking from finding to closure.',
          evidenceType: 'period-of-time',
          expectedFormat: 'PDF or Excel',
          controlRef: 'CC7.1',
          commonIssue: ' Critical and high findings should be remediated. Any acceptances should be documented.',
          frequency: 'annual'
        },
        {
          id: 'security_monitoring',
          title: 'Security Monitoring Configuration',
          common: true,
          hint: 'How security events are monitored',
          description: 'Provide documentation or screenshots showing security monitoring configuration. Include what events are logged, how they are aggregated (SIEM), and retention periods.',
          evidenceType: 'point-in-time',
          expectedFormat: 'Screenshot or PDF',
          controlRef: 'CC7.2',
          commonIssue: 'Should show what is monitored and how alerts are generated.',
          frequency: 'annual'
        },
        {
          id: 'security_alert_samples',
          title: 'Security Alert Samples',
          common: false,
          hint: 'Sample security alerts and investigation',
          description: 'Provide 2-3 sample security alerts from {{auditPeriod}} showing how alerts were investigated and resolved. Include alert details, investigation steps, and resolution.',
          evidenceType: 'period-of-time',
          expectedFormat: 'PDF or Screenshot',
          controlRef: 'CC7.2',
          commonIssue: ' Alerts should show actual investigation, not just acknowledgment.',
          frequency: 'quarterly'
        },
        {
          id: 'endpoint_protection',
          title: 'Endpoint Protection Evidence',
          common: true,
          hint: 'Evidence of EDR/antivirus deployment',
          description: 'Provide evidence of endpoint protection deployment including coverage report showing all endpoints have EDR/antivirus installed and updated.',
          evidenceType: 'point-in-time',
          expectedFormat: 'Screenshot or PDF',
          controlRef: 'CC7.1',
          commonIssue: 'Should show coverage percentage and last update dates.',
          frequency: 'quarterly'
        },
        {
          id: 'ids_ips_config',
          title: 'IDS/IPS Configuration',
          common: false,
          hint: 'Intrusion detection/prevention configuration',
          description: 'Provide evidence of intrusion detection/prevention system configuration including what is monitored and how alerts are handled.',
          evidenceType: 'point-in-time',
          expectedFormat: 'Screenshot',
          controlRef: 'CC7.2',
          commonIssue: 'Should show IDS/IPS is actively monitoring production environment.',
          frequency: 'annual'
        },
        {
          id: 'waf_config',
          title: 'Web Application Firewall Config',
          common: false,
          hint: 'WAF configuration and rules',
          description: 'Provide evidence of Web Application Firewall (WAF) configuration including what applications are protected and what rules are enabled.',
          evidenceType: 'point-in-time',
          expectedFormat: 'Screenshot',
          controlRef: 'CC7.2',
          commonIssue: 'Should show WAF is in blocking mode, not just detection mode.',
          frequency: 'annual'
        },
        {
          id: 'malware_events',
          title: 'Malware Detection Events',
          common: false,
          hint: 'Report of malware detections if any',
          description: 'Provide malware detection report from {{auditPeriod}} showing any detected threats and how they were handled. If no detections, provide attestation.',
          evidenceType: 'period-of-time',
          expectedFormat: 'PDF',
          controlRef: 'CC7.2',
          commonIssue: ' Zero detections is acceptable. Provide report showing monitoring is active.',
          frequency: 'quarterly'
        }
      ]
    },

    // -------------------------------------------------------------------------
    // CC8: Change Management
    // -------------------------------------------------------------------------
    {
      id: 'cc8_change_management',
      title: 'CC8 - Change Management',
      description: 'Controls over changes to infrastructure and applications',
      items: [
        {
          id: 'change_management_policy',
          title: 'Change Management Policy',
          common: true,
          hint: 'Policy defining change control requirements',
          description: 'Provide the Change Management Policy defining requirements for requesting, approving, testing, and deploying changes to production systems.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'CC8.1',
          commonIssue: 'Should specify approval requirements and testing expectations.',
          frequency: 'annual'
        },
        {
          id: 'change_log',
          title: 'Change Log / Deployment Record',
          common: true,
          hint: 'Record of changes deployed during audit period',
          description: 'Provide a log of changes deployed to production during {{auditPeriod}}. Include change ID, description, requester, approver, and deployment date.',
          evidenceType: 'period-of-time',
          expectedFormat: 'Excel',
          controlRef: 'CC8.1',
          commonIssue: ' Log should be comprehensive. Gaps suggest changes may bypass the process.',
          frequency: 'quarterly'
        },
        {
          id: 'change_samples',
          title: 'Change Request Samples',
          common: true,
          hint: 'Sample change requests with approval evidence',
          description: 'Provide 3-5 sample change requests from {{auditPeriod}} showing the complete change lifecycle including request, approval, testing, and deployment evidence.',
          evidenceType: 'period-of-time',
          expectedFormat: 'PDF or Screenshot',
          controlRef: 'CC8.1',
          commonIssue: ' Samples should show approval BEFORE deployment. Include variety of change types.',
          frequency: 'quarterly'
        },
        {
          id: 'code_review_evidence',
          title: 'Code Review Evidence',
          common: true,
          hint: 'Evidence code is reviewed before deployment',
          description: 'Provide evidence that code changes are reviewed before deployment. Include pull request approvals, branch protection rules, or code review tool screenshots.',
          evidenceType: 'point-in-time',
          expectedFormat: 'Screenshot',
          controlRef: 'CC8.1',
          commonIssue: 'Should show review is enforced (branch protection), not just voluntary.',
          frequency: 'annual'
        },
        {
          id: 'branch_protection',
          title: 'Branch Protection Rules',
          common: true,
          hint: 'Screenshot of branch protection settings',
          description: 'Provide screenshot of branch protection rules for production/main branches showing required reviews, status checks, and merge requirements.',
          evidenceType: 'point-in-time',
          expectedFormat: 'Screenshot',
          controlRef: 'CC8.1',
          commonIssue: 'Should show reviews are required, not optional.',
          frequency: 'annual'
        },
        {
          id: 'deployment_pipeline',
          title: 'CI/CD Pipeline Configuration',
          common: false,
          hint: 'How code is deployed to production',
          description: 'Provide documentation or screenshots of the CI/CD pipeline showing how code moves from development to production including testing stages and approvals.',
          evidenceType: 'point-in-time',
          expectedFormat: 'Screenshot or PDF',
          controlRef: 'CC8.1',
          commonIssue: 'Should show automated testing and controlled deployment process.',
          frequency: 'annual'
        },
        {
          id: 'emergency_change_process',
          title: 'Emergency Change Process',
          common: false,
          hint: 'How emergency changes are handled',
          description: 'Provide documentation of the emergency change process including how urgent changes bypass normal procedures and what retrospective review is required.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'CC8.1',
          commonIssue: 'Emergency changes should still have some controls and retrospective documentation.',
          frequency: 'annual'
        },
        {
          id: 'emergency_change_samples',
          title: 'Emergency Change Samples',
          common: false,
          hint: 'Sample emergency changes if any occurred',
          description: 'If emergency changes occurred during {{auditPeriod}}, provide samples showing the emergency process was followed and retrospective review was completed.',
          evidenceType: 'period-of-time',
          expectedFormat: 'PDF or Screenshot',
          controlRef: 'CC8.1',
          commonIssue: ' If no emergency changes, provide attestation.',
          frequency: 'per-occurrence'
        },
        {
          id: 'separation_dev_prod',
          title: 'Dev/Prod Environment Separation',
          common: false,
          hint: 'Evidence development and production are separated',
          description: 'Provide evidence that development and production environments are logically or physically separated. Include network diagrams or access control differences.',
          evidenceType: 'point-in-time',
          expectedFormat: 'Screenshot or PDF',
          controlRef: 'CC8.1',
          commonIssue: 'Developers should not have direct production access for code deployment.',
          frequency: 'annual'
        }
      ]
    },

    // -------------------------------------------------------------------------
    // CC9: Risk Mitigation
    // -------------------------------------------------------------------------
    {
      id: 'cc9_risk_mitigation',
      title: 'CC9 - Risk Mitigation',
      description: 'Vendor management and business disruption planning',
      items: [
        {
          id: 'vendor_inventory',
          title: 'Vendor Inventory',
          common: true,
          hint: 'List of vendors with risk classifications',
          description: 'Provide current vendor inventory including vendor name, services provided, data access level, and risk classification tier.',
          evidenceType: 'point-in-time',
          expectedFormat: 'Excel',
          controlRef: 'CC9.2',
          commonIssue: 'Should include all vendors with access to systems or data, not just IT vendors.',
          frequency: 'annual'
        },
        {
          id: 'vendor_management_policy',
          title: 'Vendor Management Policy',
          common: true,
          hint: 'Policy for vendor security assessment',
          description: 'Provide the Vendor Management Policy defining requirements for evaluating, selecting, and monitoring third-party vendors from a security perspective.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'CC9.2',
          commonIssue: 'Should specify assessment requirements based on vendor risk level.',
          frequency: 'annual'
        },
        {
          id: 'vendor_assessments',
          title: 'Vendor Security Assessments',
          common: false,
          hint: 'Sample vendor security questionnaires or reviews',
          description: 'Provide sample vendor security assessments from {{auditPeriod}} for high-risk vendors. Include assessment methodology and findings.',
          evidenceType: 'period-of-time',
          expectedFormat: 'PDF',
          controlRef: 'CC9.2',
          commonIssue: ' Assessments should be based on vendor risk level. Critical vendors need more scrutiny.',
          frequency: 'annual'
        },
        {
          id: 'vendor_soc_reports',
          title: 'Critical Vendor SOC Reports',
          common: true,
          hint: 'SOC reports from critical service providers',
          description: 'Provide SOC 2 or equivalent reports from critical vendors (cloud providers, SaaS platforms, etc.) with coverage overlapping {{auditPeriod}}.',
          evidenceType: 'period-of-time',
          expectedFormat: 'PDF',
          controlRef: 'CC9.2',
          commonIssue: ' Review for any exceptions or qualifications that may affect your controls.',
          frequency: 'annual'
        },
        {
          id: 'vendor_contracts',
          title: 'Vendor Contract Security Terms',
          common: false,
          hint: 'Security clauses in vendor agreements',
          description: 'Provide sample vendor contracts or master service agreements showing security requirements, data protection terms, and right-to-audit clauses.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'CC9.2',
          commonIssue: 'Contracts should include security terms appropriate to data sensitivity.',
          frequency: 'annual'
        },
        {
          id: 'bcp_plan',
          title: 'Business Continuity Plan',
          common: true,
          hint: 'BCP document',
          description: 'Provide the Business Continuity Plan including recovery objectives (RTO/RPO), critical business functions, and recovery procedures.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'CC9.1',
          commonIssue: 'Plan should be reviewed annually and include specific recovery procedures.',
          frequency: 'annual'
        },
        {
          id: 'dr_plan',
          title: 'Disaster Recovery Plan',
          common: true,
          hint: 'IT disaster recovery procedures',
          description: 'Provide the Disaster Recovery Plan covering IT system recovery including recovery procedures, priorities, and team responsibilities.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'CC9.1',
          commonIssue: 'Should align with business RTO/RPO requirements.',
          frequency: 'annual'
        },
        {
          id: 'bcp_dr_testing',
          title: 'BCP/DR Test Results',
          common: true,
          hint: 'Evidence of BCP/DR plan testing',
          description: 'Provide evidence of BCP/DR testing conducted during {{auditPeriod}}. Include test date, scope, results, and any lessons learned or improvements identified.',
          evidenceType: 'period-of-time',
          expectedFormat: 'PDF',
          controlRef: 'CC9.1',
          commonIssue: ' Testing should occur at least annually. Document any failures and remediation.',
          frequency: 'annual'
        },
        {
          id: 'backup_config',
          title: 'Backup Configuration',
          common: true,
          hint: 'Backup settings and schedules',
          description: 'Provide evidence of backup configuration including what is backed up, backup frequency, retention periods, and storage locations.',
          evidenceType: 'point-in-time',
          expectedFormat: 'Screenshot',
          controlRef: 'CC9.1',
          commonIssue: 'Should show all critical systems are included in backup scope.',
          frequency: 'annual'
        },
        {
          id: 'backup_monitoring',
          title: 'Backup Success Logs',
          common: false,
          hint: 'Evidence backups complete successfully',
          description: 'Provide backup job logs from {{auditPeriod}} showing successful completion. Include any failures and how they were addressed.',
          evidenceType: 'period-of-time',
          expectedFormat: 'Screenshot or PDF',
          controlRef: 'CC9.1',
          commonIssue: ' Failures should be investigated and resolved. Document root cause.',
          frequency: 'quarterly'
        },
        {
          id: 'backup_restoration_test',
          title: 'Backup Restoration Test',
          common: false,
          hint: 'Evidence backups can be restored',
          description: 'Provide evidence of backup restoration testing during {{auditPeriod}}. Include what was restored, restoration time, and success verification.',
          evidenceType: 'period-of-time',
          expectedFormat: 'PDF',
          controlRef: 'CC9.1',
          commonIssue: ' Testing should verify data can actually be recovered, not just that backup files exist.',
          frequency: 'annual'
        }
      ]
    },

    // -------------------------------------------------------------------------
    // Incident Response (Spans CC7 and CC2)
    // -------------------------------------------------------------------------
    {
      id: 'incident_response',
      title: 'Incident Response',
      description: 'Security incident detection, response, and recovery',
      items: [
        {
          id: 'ir_plan',
          title: 'Incident Response Plan',
          common: true,
          hint: 'IR procedures and escalation paths',
          description: 'Provide the Incident Response Plan including incident classification, roles and responsibilities, escalation procedures, communication plans, and post-incident review requirements.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'CC7.3, CC7.4',
          commonIssue: 'Plan should include specific contact information and clear escalation criteria.',
          frequency: 'annual'
        },
        {
          id: 'ir_team',
          title: 'Incident Response Team',
          common: true,
          hint: 'IR team members and contacts',
          description: 'Provide documentation of the incident response team including team members, roles, and contact information.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF or Excel',
          controlRef: 'CC7.3',
          commonIssue: 'Contact information should be current and include backup contacts.',
          frequency: 'annual'
        },
        {
          id: 'incident_log',
          title: 'Security Incident Log',
          common: true,
          hint: 'Record of security incidents during audit period',
          description: 'Provide the security incident log from {{auditPeriod}}. Include all security incidents regardless of severity. If no incidents occurred, provide attestation.',
          evidenceType: 'period-of-time',
          expectedFormat: 'Excel or PDF',
          controlRef: 'CC7.4',
          commonIssue: ' Zero incidents is acceptable but should be accompanied by attestation of incident-free period.',
          frequency: 'quarterly'
        },
        {
          id: 'incident_samples',
          title: 'Incident Response Samples',
          common: false,
          hint: 'Sample incidents showing response process',
          description: 'If security incidents occurred during {{auditPeriod}}, provide 2-3 samples showing the incident response process including detection, containment, eradication, and lessons learned.',
          evidenceType: 'period-of-time',
          expectedFormat: 'PDF',
          controlRef: 'CC7.4, CC7.5',
          commonIssue: ' Samples should show complete lifecycle. Sensitive details can be redacted.',
          frequency: 'per-occurrence'
        },
        {
          id: 'ir_testing',
          title: 'IR Plan Testing / Tabletop Exercise',
          common: false,
          hint: 'Evidence of incident response testing',
          description: 'Provide evidence of incident response plan testing during {{auditPeriod}}. Include tabletop exercise scenarios, participants, findings, and any plan improvements identified.',
          evidenceType: 'period-of-time',
          expectedFormat: 'PDF',
          controlRef: 'CC7.3',
          commonIssue: ' Testing should include realistic scenarios and document lessons learned.',
          frequency: 'annual'
        },
        {
          id: 'breach_notification',
          title: 'Breach Notification Procedures',
          common: false,
          hint: 'Procedures for notifying affected parties',
          description: 'Provide breach notification procedures including timing requirements, notification templates, and regulatory reporting obligations.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'CC7.5',
          commonIssue: 'Procedures should address different regulatory requirements (GDPR, state breach laws, etc.).',
          frequency: 'annual'
        }
      ]
    },

    // -------------------------------------------------------------------------
    // A1: Availability (Additional TSC)
    // -------------------------------------------------------------------------
    {
      id: 'a1_availability',
      title: 'A1 - Availability',
      description: 'System availability commitments and performance',
      items: [
        {
          id: 'availability_commitment',
          title: 'Availability SLA/Commitment',
          common: true,
          hint: 'Documented availability targets',
          description: 'Provide documentation of availability commitments including uptime targets (SLA), measurement methodology, and how availability is communicated to customers.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'A1.1',
          commonIssue: 'Targets should be measurable and align with customer contracts.',
          frequency: 'annual'
        },
        {
          id: 'uptime_metrics',
          title: 'Uptime/Availability Metrics',
          common: true,
          hint: 'Actual availability performance data',
          description: 'Provide availability metrics from {{auditPeriod}} showing actual uptime performance against targets. Include any downtime incidents and their causes.',
          evidenceType: 'period-of-time',
          expectedFormat: 'PDF or Excel',
          controlRef: 'A1.1',
          commonIssue: ' Should show how targets were measured and any SLA breaches.',
          frequency: 'monthly'
        },
        {
          id: 'capacity_monitoring',
          title: 'Capacity Monitoring',
          common: false,
          hint: 'Evidence of capacity planning and monitoring',
          description: 'Provide evidence of capacity monitoring and planning including current utilization, growth trends, and capacity planning processes.',
          evidenceType: 'point-in-time',
          expectedFormat: 'Screenshot or PDF',
          controlRef: 'A1.2',
          commonIssue: 'Should show proactive monitoring, not reactive capacity management.',
          frequency: 'quarterly'
        },
        {
          id: 'redundancy_architecture',
          title: 'High Availability Architecture',
          common: false,
          hint: 'Documentation of redundancy and failover',
          description: 'Provide architecture documentation showing high availability design including redundancy, failover capabilities, and geographic distribution.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'A1.2',
          commonIssue: 'Architecture should align with availability commitments.',
          frequency: 'annual'
        }
      ]
    },

    // -------------------------------------------------------------------------
    // C1: Confidentiality (Additional TSC)
    // -------------------------------------------------------------------------
    {
      id: 'c1_confidentiality',
      title: 'C1 - Confidentiality',
      description: 'Protection of confidential information',
      items: [
        {
          id: 'confidentiality_policy',
          title: 'Confidentiality/Data Protection Policy',
          common: true,
          hint: 'Policy covering confidential information handling',
          description: 'Provide the Confidentiality or Data Protection Policy defining how confidential information is identified, classified, protected, and retained.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'C1.1',
          commonIssue: 'Should specify what data is considered confidential and handling requirements.',
          frequency: 'annual'
        },
        {
          id: 'nda_samples',
          title: 'NDA/Confidentiality Agreement Samples',
          common: false,
          hint: 'Sample NDAs with employees/contractors',
          description: 'Provide sample Non-Disclosure Agreements or confidentiality agreements signed by employees and contractors.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'C1.1',
          commonIssue: 'Should show NDAs are standard practice for personnel with data access.',
          frequency: 'annual'
        },
        {
          id: 'data_retention_policy',
          title: 'Data Retention Policy',
          common: false,
          hint: 'Policy defining data retention periods',
          description: 'Provide the Data Retention Policy defining retention periods for different data categories and destruction procedures.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'C1.2',
          commonIssue: 'Retention periods should align with legal and regulatory requirements.',
          frequency: 'annual'
        },
        {
          id: 'data_disposal',
          title: 'Data Disposal Evidence',
          common: false,
          hint: 'Evidence of secure data disposal',
          description: 'Provide evidence of secure data disposal practices including certificates of destruction, media sanitization logs, or disposal procedures.',
          evidenceType: 'period-of-time',
          expectedFormat: 'PDF',
          controlRef: 'C1.2',
          commonIssue: ' Disposal methods should be appropriate for data sensitivity.',
          frequency: 'annual'
        }
      ]
    },

    // -------------------------------------------------------------------------
    // PI1: Processing Integrity (Additional TSC)
    // -------------------------------------------------------------------------
    {
      id: 'pi1_processing_integrity',
      title: 'PI1 - Processing Integrity',
      description: 'Accuracy, completeness, and timeliness of processing',
      items: [
        {
          id: 'processing_procedures',
          title: 'Data Processing Procedures',
          common: true,
          hint: 'Documentation of processing controls',
          description: 'Provide documentation of data processing controls ensuring accurate, complete, and timely processing. Include input validation, processing rules, and output verification.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'PI1.1, PI1.2',
          commonIssue: 'Should describe specific controls, not general statements.',
          frequency: 'annual'
        },
        {
          id: 'input_validation',
          title: 'Input Validation Evidence',
          common: false,
          hint: 'Evidence of data validation controls',
          description: 'Provide evidence of input validation controls including data type validation, range checks, and error handling for rejected inputs.',
          evidenceType: 'point-in-time',
          expectedFormat: 'Screenshot or PDF',
          controlRef: 'PI1.2',
          commonIssue: 'Should show validation actually occurs, not just that capability exists.',
          frequency: 'annual'
        },
        {
          id: 'processing_errors',
          title: 'Processing Error Log',
          common: false,
          hint: 'Log of processing errors and resolutions',
          description: 'Provide log of processing errors from {{auditPeriod}} including error type, affected data, and resolution. If no errors, provide attestation.',
          evidenceType: 'period-of-time',
          expectedFormat: 'Excel or PDF',
          controlRef: 'PI1.3',
          commonIssue: ' Errors should be investigated and corrected. Show resolution process.',
          frequency: 'quarterly'
        },
        {
          id: 'reconciliation_reports',
          title: 'Data Reconciliation Reports',
          common: false,
          hint: 'Evidence of data reconciliation processes',
          description: 'Provide data reconciliation reports from {{auditPeriod}} showing input-to-output reconciliation or other validation that processing was complete and accurate.',
          evidenceType: 'period-of-time',
          expectedFormat: 'PDF or Excel',
          controlRef: 'PI1.4',
          commonIssue: ' Reconciliations should be performed by someone independent of processing.',
          frequency: 'monthly'
        }
      ]
    },

    // -------------------------------------------------------------------------
    // P1: Privacy (Additional TSC)
    // -------------------------------------------------------------------------
    {
      id: 'p1_privacy',
      title: 'P1 - Privacy',
      description: 'Privacy notice, consent, and data subject rights',
      items: [
        {
          id: 'privacy_notice',
          title: 'Privacy Notice/Policy',
          common: true,
          hint: 'Public-facing privacy policy',
          description: 'Provide the current public-facing Privacy Notice or Privacy Policy. Should describe data collection, use, sharing, and data subject rights.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF or URL',
          controlRef: 'P1.1',
          commonIssue: 'Should be clear, accessible, and aligned with actual practices.',
          frequency: 'annual'
        },
        {
          id: 'consent_mechanisms',
          title: 'Consent Collection Evidence',
          common: false,
          hint: 'How consent is obtained',
          description: 'Provide evidence of consent collection mechanisms including screenshots of consent forms, checkboxes, or other consent capture methods.',
          evidenceType: 'point-in-time',
          expectedFormat: 'Screenshot',
          controlRef: 'P1.1',
          commonIssue: 'Consent should be clear, specific, and documented.',
          frequency: 'annual'
        },
        {
          id: 'data_subject_rights',
          title: 'Data Subject Rights Process',
          common: false,
          hint: 'Process for handling data subject requests',
          description: 'Provide documentation of the process for handling data subject rights requests (access, deletion, correction, etc.) including intake, fulfillment, and timing requirements.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'P1.1',
          commonIssue: 'Process should address all applicable rights and regulatory timelines.',
          frequency: 'annual'
        },
        {
          id: 'dsr_log',
          title: 'Data Subject Request Log',
          common: false,
          hint: 'Log of data subject requests received',
          description: 'Provide log of data subject requests received during {{auditPeriod}} including request type, date received, and response date. If none received, provide attestation.',
          evidenceType: 'period-of-time',
          expectedFormat: 'Excel or PDF',
          controlRef: 'P1.1',
          commonIssue: ' Responses should meet regulatory timelines (e.g., 30 days for GDPR).',
          frequency: 'quarterly'
        }
      ]
    }
  ]
},
ISO27001: {
  label: 'ISO 27001',
  description: 'Information Security Management System (ISMS)',
  defaultOn: false,
  controlGroups: [

    // -------------------------------------------------------------------------
    // ISMS Core Documentation (Clauses 4-10)
    // -------------------------------------------------------------------------
    {
      id: 'isms_core',
      title: 'ISMS Core Documentation',
      description: 'Mandatory ISMS documentation required by ISO 27001 clauses',
      items: [
        {
          id: 'isms_scope',
          title: 'ISMS Scope Statement',
          common: true,
          hint: 'Boundaries and applicability of the ISMS',
          description: 'Provide the documented ISMS scope defining the boundaries of the information security management system, including locations, assets, and processes covered.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'Clause 4.3',
          commonIssue: 'Scope must be clearly defined. Ambiguous boundaries lead to audit findings.',
          frequency: 'annual'
        },
        {
          id: 'isms_policy',
          title: 'Information Security Policy',
          common: true,
          hint: 'Top-level security policy signed by management',
          description: 'Provide the Information Security Policy including security objectives, commitment to continuous improvement, and evidence of top management approval.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'Clause 5.2',
          commonIssue: 'Must be signed by top management and include commitment to continual improvement.',
          frequency: 'annual'
        },
        {
          id: 'risk_assessment_iso',
          title: 'Risk Assessment',
          common: true,
          hint: 'Information security risk assessment',
          description: 'Provide the risk assessment covering identified information security risks during {{auditPeriod}}. Include risk assessment methodology, criteria, and risk register.',
          evidenceType: 'period-of-time',
          expectedFormat: 'PDF or Excel',
          controlRef: 'Clause 6.1.2',
          commonIssue: ' Must use consistent methodology. Should identify asset-based or scenario-based risks.',
          frequency: 'annual'
        },
        {
          id: 'risk_treatment_plan_iso',
          title: 'Risk Treatment Plan',
          common: true,
          hint: 'Plan for treating identified risks',
          description: 'Provide the risk treatment plan showing how identified risks are being addressed with treatment options (accept, mitigate, transfer, avoid), responsible parties, and timelines.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF or Excel',
          controlRef: 'Clause 6.1.3',
          commonIssue: 'Must show clear linkage between identified risks and treatment decisions.',
          frequency: 'annual'
        },
        {
          id: 'soa',
          title: 'Statement of Applicability (SoA)',
          common: true,
          hint: 'Declaration of which Annex A controls apply',
          description: 'Provide the Statement of Applicability listing all Annex A controls with indication of whether each is applicable or not applicable, with justification for exclusions.',
          evidenceType: 'point-in-time',
          expectedFormat: 'Excel or PDF',
          controlRef: 'Clause 6.1.3 d)',
          commonIssue: 'Every exclusion must be justified. Most controls cannot be excluded without strong rationale.',
          frequency: 'annual'
        },
        {
          id: 'isms_objectives',
          title: 'ISMS Objectives',
          common: true,
          hint: 'Measurable information security objectives',
          description: 'Provide documented information security objectives that are measurable and aligned with the security policy. Include targets and measurement methods.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'Clause 6.2',
          commonIssue: 'Objectives must be measurable. Vague objectives lead to audit findings.',
          frequency: 'annual'
        },
        {
          id: 'competence_records',
          title: 'Competence Records',
          common: true,
          hint: 'Evidence of security competence for relevant roles',
          description: 'Provide evidence of competence for personnel in security-related roles. Include training records, certifications, and qualification evidence.',
          evidenceType: 'period-of-time',
          expectedFormat: 'PDF or Excel',
          controlRef: 'Clause 7.2',
          commonIssue: ' Must demonstrate competence for specific roles, not just generic training.',
          frequency: 'annual'
        },
        {
          id: 'internal_audit_results',
          title: 'Internal Audit Results',
          common: true,
          hint: 'Results of ISMS internal audits',
          description: 'Provide internal audit reports from {{auditPeriod}} covering the ISMS. Include audit plan, findings, and corrective actions.',
          evidenceType: 'period-of-time',
          expectedFormat: 'PDF',
          controlRef: 'Clause 9.2',
          commonIssue: ' Audit must cover full ISMS scope. Auditors must be independent of audited areas.',
          frequency: 'annual'
        },
        {
          id: 'management_review',
          title: 'Management Review Records',
          common: true,
          hint: 'Minutes of management review meetings',
          description: 'Provide management review meeting records from {{auditPeriod}}. Include required inputs (audit results, metrics, incidents, risks) and outputs (decisions, actions).',
          evidenceType: 'period-of-time',
          expectedFormat: 'PDF',
          controlRef: 'Clause 9.3',
          commonIssue: ' Must address all required inputs per Clause 9.3. Annual review minimum.',
          frequency: 'annual'
        },
        {
          id: 'nonconformity_log',
          title: 'Nonconformity and Corrective Action Log',
          common: true,
          hint: 'Tracking of nonconformities and corrective actions',
          description: 'Provide the log of nonconformities identified and corrective actions taken during {{auditPeriod}}. Include root cause analysis and effectiveness verification.',
          evidenceType: 'period-of-time',
          expectedFormat: 'Excel or PDF',
          controlRef: 'Clause 10.1',
          commonIssue: ' Must show root cause analysis and verification of corrective action effectiveness.',
          frequency: 'quarterly'
        }
      ]
    },

    // -------------------------------------------------------------------------
    // A.5: Organizational Controls
    // -------------------------------------------------------------------------
    {
      id: 'a5_organizational',
      title: 'A.5 - Organizational Controls',
      description: 'Policies, roles, and organizational security measures',
      items: [
        {
          id: 'security_policy_set',
          title: 'Information Security Policies',
          common: true,
          hint: 'Set of information security policies',
          description: 'Provide the set of information security policies covering key domains (access control, acceptable use, data classification, etc.). Include evidence of approval and communication.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'A.5.1',
          commonIssue: 'Policies should be comprehensive and cover all significant security areas.',
          frequency: 'annual'
        },
        {
          id: 'roles_responsibilities',
          title: 'Security Roles and Responsibilities',
          common: true,
          hint: 'Documented security responsibilities',
          description: 'Provide documentation of security roles and responsibilities including job descriptions, RACI matrices, or responsibility assignments for security functions.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF or Excel',
          controlRef: 'A.5.2',
          commonIssue: 'Must show clear assignment of security responsibilities to specific individuals.',
          frequency: 'annual'
        },
        {
          id: 'segregation_duties_iso',
          title: 'Segregation of Duties',
          common: true,
          hint: 'Evidence of duty segregation',
          description: 'Provide evidence of segregation of duties for conflicting tasks. Include segregation matrix or analysis of key control areas.',
          evidenceType: 'point-in-time',
          expectedFormat: 'Excel or PDF',
          controlRef: 'A.5.3',
          commonIssue: 'Focus on critical segregations: development/production, financial approvals, access administration.',
          frequency: 'annual'
        },
        {
          id: 'contact_authorities',
          title: 'Contact with Authorities',
          common: false,
          hint: 'Documented contacts for security authorities',
          description: 'Provide documentation of contacts with relevant authorities (regulators, law enforcement, security agencies) including contact procedures.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'A.5.5',
          commonIssue: 'Should include when and how to contact authorities for incidents.',
          frequency: 'annual'
        },
        {
          id: 'threat_intelligence',
          title: 'Threat Intelligence',
          common: false,
          hint: 'Evidence of threat intelligence gathering',
          description: 'Provide evidence of threat intelligence gathering and analysis during {{auditPeriod}}. Include sources used, how intelligence is processed, and actions taken.',
          evidenceType: 'period-of-time',
          expectedFormat: 'PDF',
          controlRef: 'A.5.7',
          commonIssue: ' Should show active collection and use of threat intelligence, not just subscription.',
          frequency: 'quarterly'
        },
        {
          id: 'project_security',
          title: 'Project Security Integration',
          common: false,
          hint: 'How security is integrated into projects',
          description: 'Provide evidence of information security integration in project management. Include project security assessment templates or sample project security reviews.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'A.5.8',
          commonIssue: 'Should show security is considered throughout project lifecycle.',
          frequency: 'annual'
        },
        {
          id: 'asset_inventory_iso',
          title: 'Asset Inventory',
          common: true,
          hint: 'Inventory of information assets',
          description: 'Provide the information asset inventory including asset name, type, owner, classification, and location. Cover hardware, software, data, and services.',
          evidenceType: 'point-in-time',
          expectedFormat: 'Excel',
          controlRef: 'A.5.9',
          commonIssue: 'Must be comprehensive and maintained current. Include data assets, not just IT hardware.',
          frequency: 'annual'
        },
        {
          id: 'acceptable_use_iso',
          title: 'Acceptable Use of Assets',
          common: true,
          hint: 'Rules for acceptable use',
          description: 'Provide the acceptable use policy and evidence it is communicated to users. Include rules for use of information and information processing assets.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'A.5.10',
          commonIssue: 'Must be specific and communicated to all users.',
          frequency: 'annual'
        },
        {
          id: 'asset_return',
          title: 'Return of Assets Process',
          common: false,
          hint: 'Process for returning assets at termination',
          description: 'Provide documentation of the asset return process upon termination or role change. Include termination checklist showing asset return verification.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'A.5.11',
          commonIssue: 'Should include all information assets, not just physical equipment.',
          frequency: 'annual'
        },
        {
          id: 'classification_scheme',
          title: 'Information Classification Scheme',
          common: true,
          hint: 'Data classification framework',
          description: 'Provide the information classification scheme including classification levels, labeling requirements, and handling procedures for each level.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'A.5.12, A.5.13',
          commonIssue: 'Levels should be clearly defined with specific handling requirements.',
          frequency: 'annual'
        },
        {
          id: 'supplier_policy',
          title: 'Supplier Security Policy',
          common: true,
          hint: 'Policy for managing supplier security',
          description: 'Provide the supplier security policy defining requirements for assessing and managing information security risks related to suppliers.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'A.5.19, A.5.20',
          commonIssue: 'Should specify assessment requirements based on supplier access level.',
          frequency: 'annual'
        },
        {
          id: 'supplier_agreements',
          title: 'Supplier Security Agreements',
          common: false,
          hint: 'Security terms in supplier contracts',
          description: 'Provide sample supplier agreements showing security requirements including confidentiality, access controls, and incident notification clauses.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'A.5.20',
          commonIssue: 'Agreements should include security terms proportional to risk.',
          frequency: 'annual'
        },
        {
          id: 'supplier_monitoring',
          title: 'Supplier Monitoring Evidence',
          common: false,
          hint: 'Evidence of ongoing supplier monitoring',
          description: 'Provide evidence of supplier security monitoring during {{auditPeriod}}. Include supplier security reviews, SOC report reviews, or compliance assessments.',
          evidenceType: 'period-of-time',
          expectedFormat: 'PDF',
          controlRef: 'A.5.22',
          commonIssue: ' Should demonstrate ongoing monitoring, not just initial assessment.',
          frequency: 'annual'
        },
        {
          id: 'cloud_security',
          title: 'Cloud Services Security',
          common: true,
          hint: 'Security requirements for cloud services',
          description: 'Provide documentation of security requirements for cloud services including selection criteria, security controls required, and exit/portability provisions.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'A.5.23',
          commonIssue: 'Should address shared responsibility model and specific cloud risks.',
          frequency: 'annual'
        },
        {
          id: 'incident_management_iso',
          title: 'Incident Management Procedure',
          common: true,
          hint: 'Security incident handling procedures',
          description: 'Provide the incident management procedure including incident classification, response procedures, escalation, and post-incident activities.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'A.5.24-A.5.28',
          commonIssue: 'Must cover the complete incident lifecycle from detection to lessons learned.',
          frequency: 'annual'
        },
        {
          id: 'incident_log_iso',
          title: 'Incident Log',
          common: true,
          hint: 'Record of security incidents',
          description: 'Provide the security incident log from {{auditPeriod}}. Include incident details, classification, response actions, and resolution.',
          evidenceType: 'period-of-time',
          expectedFormat: 'Excel or PDF',
          controlRef: 'A.5.25',
          commonIssue: ' Zero incidents requires attestation. Show evidence of active monitoring.',
          frequency: 'quarterly'
        },
        {
          id: 'bcp_framework',
          title: 'Business Continuity Framework',
          common: true,
          hint: 'BCM framework and policy',
          description: 'Provide the business continuity management framework including policy, continuity plans, and recovery procedures for in-scope processes.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'A.5.29, A.5.30',
          commonIssue: 'Must address information security requirements during disruptions.',
          frequency: 'annual'
        },
        {
          id: 'bcp_testing_iso',
          title: 'Business Continuity Testing',
          common: true,
          hint: 'Evidence of BCP/DR testing',
          description: 'Provide evidence of business continuity testing during {{auditPeriod}}. Include test scenarios, results, and identified improvements.',
          evidenceType: 'period-of-time',
          expectedFormat: 'PDF',
          controlRef: 'A.5.30',
          commonIssue: ' Testing should verify plans are effective and actionable.',
          frequency: 'annual'
        },
        {
          id: 'legal_requirements',
          title: 'Legal/Regulatory Requirements Register',
          common: false,
          hint: 'Register of applicable legal requirements',
          description: 'Provide the register of legal, statutory, regulatory, and contractual requirements related to information security, with compliance status.',
          evidenceType: 'point-in-time',
          expectedFormat: 'Excel',
          controlRef: 'A.5.31',
          commonIssue: 'Should include all applicable requirements and how compliance is achieved.',
          frequency: 'annual'
        },
        {
          id: 'privacy_requirements',
          title: 'Privacy Requirements',
          common: false,
          hint: 'Protection of PII',
          description: 'Provide documentation of how personally identifiable information (PII) is protected in accordance with applicable privacy regulations.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'A.5.34',
          commonIssue: 'Should address all applicable privacy regulations (GDPR, local laws, etc.).',
          frequency: 'annual'
        }
      ]
    },

    // -------------------------------------------------------------------------
    // A.6: People Controls
    // -------------------------------------------------------------------------
    {
      id: 'a6_people',
      title: 'A.6 - People Controls',
      description: 'Human resources security controls',
      items: [
        {
          id: 'screening',
          title: 'Background Screening',
          common: true,
          hint: 'Pre-employment screening procedures',
          description: 'Provide documentation of background screening procedures for personnel. Include what checks are performed and when.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'A.6.1',
          commonIssue: 'Screening level should be proportional to role sensitivity.',
          frequency: 'annual'
        },
        {
          id: 'screening_evidence',
          title: 'Screening Evidence Samples',
          common: false,
          hint: 'Sample background check completions',
          description: 'Provide sample evidence of background screening completion for new hires during {{auditPeriod}}. Redact personal details as needed.',
          evidenceType: 'period-of-time',
          expectedFormat: 'PDF',
          controlRef: 'A.6.1',
          commonIssue: ' Should show screening completed before or shortly after start date.',
          frequency: 'quarterly'
        },
        {
          id: 'employment_terms',
          title: 'Employment Terms and Conditions',
          common: true,
          hint: 'Security terms in employment contracts',
          description: 'Provide sample employment contract or offer letter showing security responsibilities and confidentiality terms.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'A.6.2',
          commonIssue: 'Must include confidentiality and security responsibilities.',
          frequency: 'annual'
        },
        {
          id: 'security_awareness_iso',
          title: 'Security Awareness Program',
          common: true,
          hint: 'Awareness and training program',
          description: 'Provide documentation of the security awareness and training program including topics, delivery method, and frequency requirements.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'A.6.3',
          commonIssue: 'Must be appropriate for roles and include regular updates.',
          frequency: 'annual'
        },
        {
          id: 'training_records_iso',
          title: 'Training Completion Records',
          common: true,
          hint: 'Evidence of training completion',
          description: 'Provide training completion records from {{auditPeriod}} showing personnel completed required security awareness training.',
          evidenceType: 'period-of-time',
          expectedFormat: 'Excel or PDF',
          controlRef: 'A.6.3',
          commonIssue: ' Must cover all personnel including contractors.',
          frequency: 'annual'
        },
        {
          id: 'disciplinary_process',
          title: 'Disciplinary Process',
          common: false,
          hint: 'Process for security policy violations',
          description: 'Provide documentation of the disciplinary process for security policy violations.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'A.6.4',
          commonIssue: 'Process should be documented and communicated.',
          frequency: 'annual'
        },
        {
          id: 'termination_process',
          title: 'Termination/Change Process',
          common: true,
          hint: 'Process for termination and role changes',
          description: 'Provide documentation of the process for handling terminations and role changes including security responsibilities (access removal, asset return, etc.).',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'A.6.5',
          commonIssue: 'Must address both voluntary and involuntary terminations.',
          frequency: 'annual'
        },
        {
          id: 'termination_samples_iso',
          title: 'Termination Process Samples',
          common: false,
          hint: 'Sample termination checklists',
          description: 'Provide 2-3 sample termination cases from {{auditPeriod}} showing the process was followed including access revocation timing.',
          evidenceType: 'period-of-time',
          expectedFormat: 'PDF',
          controlRef: 'A.6.5',
          commonIssue: ' Show access was removed on or before last day.',
          frequency: 'quarterly'
        },
        {
          id: 'confidentiality_agreements',
          title: 'Confidentiality/NDA Agreements',
          common: true,
          hint: 'Signed confidentiality agreements',
          description: 'Provide sample confidentiality or non-disclosure agreements signed by employees and contractors.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'A.6.6',
          commonIssue: 'Should cover information learned during and after employment.',
          frequency: 'annual'
        },
        {
          id: 'remote_working',
          title: 'Remote Working Security',
          common: false,
          hint: 'Security controls for remote work',
          description: 'Provide documentation of security controls for remote working including technical controls and policy requirements.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'A.6.7',
          commonIssue: 'Should address device security, network security, and physical environment.',
          frequency: 'annual'
        },
        {
          id: 'security_event_reporting',
          title: 'Security Event Reporting',
          common: true,
          hint: 'Process for reporting security events',
          description: 'Provide documentation of how personnel report security events including reporting channels and what should be reported.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'A.6.8',
          commonIssue: 'Process should be simple and well-communicated.',
          frequency: 'annual'
        }
      ]
    },

    // -------------------------------------------------------------------------
    // A.7: Physical Controls
    // -------------------------------------------------------------------------
    {
      id: 'a7_physical',
      title: 'A.7 - Physical Controls',
      description: 'Physical and environmental security controls',
      items: [
        {
          id: 'physical_perimeter',
          title: 'Physical Security Perimeters',
          common: false,
          hint: 'Definition of secure areas',
          description: 'Provide documentation defining physical security perimeters and secure areas including office locations, data centers, and restricted areas.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'A.7.1',
          commonIssue: 'May not apply if fully cloud-hosted. Document what is applicable.',
          frequency: 'annual'
        },
        {
          id: 'physical_entry',
          title: 'Physical Entry Controls',
          common: false,
          hint: 'Entry controls for secure areas',
          description: 'Provide evidence of physical entry controls including badge access, visitor management, and security personnel.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF or Screenshot',
          controlRef: 'A.7.2',
          commonIssue: 'Should match the risk level of assets in the area.',
          frequency: 'annual'
        },
        {
          id: 'physical_access_log',
          title: 'Physical Access Logs',
          common: false,
          hint: 'Logs of physical access',
          description: 'Provide physical access logs from {{auditPeriod}} for secure areas (server rooms, data centers, etc.).',
          evidenceType: 'period-of-time',
          expectedFormat: 'PDF or Excel',
          controlRef: 'A.7.2',
          commonIssue: ' Logs should be retained per policy and reviewed periodically.',
          frequency: 'quarterly'
        },
        {
          id: 'office_security',
          title: 'Office Security',
          common: false,
          hint: 'Security measures for offices',
          description: 'Provide documentation of security measures for offices and rooms including clean desk policy and screen lock requirements.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'A.7.3',
          commonIssue: 'Should address both physical and information security.',
          frequency: 'annual'
        },
        {
          id: 'physical_monitoring',
          title: 'Physical Security Monitoring',
          common: false,
          hint: 'Monitoring of premises',
          description: 'Provide evidence of physical security monitoring including CCTV coverage, alarm systems, or security patrols.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF or Screenshot',
          controlRef: 'A.7.4',
          commonIssue: 'Should cover critical areas and have defined response procedures.',
          frequency: 'annual'
        },
        {
          id: 'environmental_threats',
          title: 'Environmental Threat Protection',
          common: false,
          hint: 'Protection against environmental threats',
          description: 'Provide documentation of protection against environmental threats including fire suppression, flood detection, and climate control for data centers or server rooms.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'A.7.5',
          commonIssue: 'If using cloud providers, reference their environmental controls.',
          frequency: 'annual'
        },
        {
          id: 'equipment_security',
          title: 'Equipment Security',
          common: false,
          hint: 'Security of equipment',
          description: 'Provide documentation of equipment security measures including secure mounting, cable protection, and equipment maintenance.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'A.7.8',
          commonIssue: 'Should address both fixed and portable equipment.',
          frequency: 'annual'
        },
        {
          id: 'offsite_equipment',
          title: 'Off-site Equipment Security',
          common: false,
          hint: 'Security for equipment off-premises',
          description: 'Provide documentation of security requirements for equipment used outside the organization (laptops, mobile devices).',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'A.7.9',
          commonIssue: 'Should include encryption, remote wipe, and physical security.',
          frequency: 'annual'
        },
        {
          id: 'storage_media',
          title: 'Storage Media Management',
          common: false,
          hint: 'Management of storage media',
          description: 'Provide documentation of storage media management including handling, transport, and disposal procedures.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'A.7.10',
          commonIssue: 'Disposal should ensure data cannot be recovered.',
          frequency: 'annual'
        },
        {
          id: 'utilities',
          title: 'Supporting Utilities',
          common: false,
          hint: 'Power and communications protection',
          description: 'Provide documentation of protection for supporting utilities including UPS, redundant power, and backup communications.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'A.7.11',
          commonIssue: 'Should align with availability requirements.',
          frequency: 'annual'
        },
        {
          id: 'cabling_security',
          title: 'Cabling Security',
          common: false,
          hint: 'Security of network cabling',
          description: 'Provide documentation of cabling security measures including physical protection and labeling.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'A.7.12',
          commonIssue: 'May not apply for cloud-only environments.',
          frequency: 'annual'
        },
        {
          id: 'equipment_maintenance',
          title: 'Equipment Maintenance',
          common: false,
          hint: 'Equipment maintenance procedures',
          description: 'Provide documentation of equipment maintenance procedures including authorized maintenance personnel and data handling during maintenance.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'A.7.13',
          commonIssue: 'Should address data protection during maintenance activities.',
          frequency: 'annual'
        },
        {
          id: 'equipment_disposal',
          title: 'Secure Disposal/Re-use',
          common: true,
          hint: 'Procedures for equipment disposal',
          description: 'Provide documentation of secure disposal and re-use procedures for equipment containing storage media. Include certificates of destruction if applicable.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'A.7.14',
          commonIssue: 'Disposal should be verified and documented.',
          frequency: 'annual'
        }
      ]
    },

    // -------------------------------------------------------------------------
    // A.8: Technological Controls
    // -------------------------------------------------------------------------
    {
      id: 'a8_technological',
      title: 'A.8 - Technological Controls',
      description: 'Technical security controls for systems and data',
      items: [
        {
          id: 'endpoint_devices',
          title: 'User Endpoint Devices',
          common: true,
          hint: 'Security configuration for endpoints',
          description: 'Provide evidence of security configuration for user endpoint devices including encryption, antimalware, and configuration standards.',
          evidenceType: 'point-in-time',
          expectedFormat: 'Screenshot or PDF',
          controlRef: 'A.8.1',
          commonIssue: 'Should show configuration is enforced, not just documented.',
          frequency: 'annual'
        },
        {
          id: 'privileged_access_iso',
          title: 'Privileged Access Rights',
          common: true,
          hint: 'Management of privileged access',
          description: 'Provide evidence of privileged access management including privileged user list, approval process, and periodic reviews.',
          evidenceType: 'point-in-time',
          expectedFormat: 'Excel or PDF',
          controlRef: 'A.8.2',
          commonIssue: 'Privileged access should be minimized and regularly reviewed.',
          frequency: 'quarterly'
        },
        {
          id: 'access_restriction_iso',
          title: 'Information Access Restriction',
          common: true,
          hint: 'Access control implementation',
          description: 'Provide evidence of access restriction implementation showing how access is limited based on role and need-to-know.',
          evidenceType: 'point-in-time',
          expectedFormat: 'Screenshot or PDF',
          controlRef: 'A.8.3',
          commonIssue: 'Should demonstrate least privilege principle.',
          frequency: 'annual'
        },
        {
          id: 'source_code_access',
          title: 'Source Code Access',
          common: false,
          hint: 'Access control for source code',
          description: 'Provide evidence of access control for source code repositories including who has access and approval process.',
          evidenceType: 'point-in-time',
          expectedFormat: 'Screenshot',
          controlRef: 'A.8.4',
          commonIssue: 'Access should be limited to authorized developers.',
          frequency: 'annual'
        },
        {
          id: 'secure_authentication_iso',
          title: 'Secure Authentication',
          common: true,
          hint: 'Authentication controls',
          description: 'Provide evidence of secure authentication controls including MFA configuration, password policy, and authentication logs.',
          evidenceType: 'point-in-time',
          expectedFormat: 'Screenshot',
          controlRef: 'A.8.5',
          commonIssue: 'MFA should be required for sensitive access.',
          frequency: 'annual'
        },
        {
          id: 'capacity_management_iso',
          title: 'Capacity Management',
          common: false,
          hint: 'Capacity monitoring and planning',
          description: 'Provide evidence of capacity management including current utilization monitoring and capacity planning.',
          evidenceType: 'point-in-time',
          expectedFormat: 'Screenshot or PDF',
          controlRef: 'A.8.6',
          commonIssue: 'Should show proactive monitoring and planning.',
          frequency: 'quarterly'
        },
        {
          id: 'malware_protection_iso',
          title: 'Protection Against Malware',
          common: true,
          hint: 'Anti-malware controls',
          description: 'Provide evidence of malware protection including antivirus/EDR deployment, configuration, and update status.',
          evidenceType: 'point-in-time',
          expectedFormat: 'Screenshot',
          controlRef: 'A.8.7',
          commonIssue: 'Should show coverage of all endpoints and current signatures.',
          frequency: 'quarterly'
        },
        {
          id: 'vulnerability_management_iso',
          title: 'Technical Vulnerability Management',
          common: true,
          hint: 'Vulnerability scanning and remediation',
          description: 'Provide vulnerability scan reports and remediation evidence from {{auditPeriod}}. Include scan frequency, findings, and remediation timelines.',
          evidenceType: 'period-of-time',
          expectedFormat: 'PDF',
          controlRef: 'A.8.8',
          commonIssue: ' Should show regular scanning and timely remediation of critical vulnerabilities.',
          frequency: 'quarterly'
        },
        {
          id: 'config_management_iso',
          title: 'Configuration Management',
          common: true,
          hint: 'System configuration standards',
          description: 'Provide documentation of configuration management including hardening standards, baseline configurations, and configuration monitoring.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'A.8.9',
          commonIssue: 'Should include evidence configuration is enforced and monitored.',
          frequency: 'annual'
        },
        {
          id: 'data_deletion_iso',
          title: 'Information Deletion',
          common: false,
          hint: 'Procedures for secure deletion',
          description: 'Provide documentation of information deletion procedures and evidence of execution including data retention schedules and deletion confirmations.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'A.8.10',
          commonIssue: 'Deletion should be verifiable and aligned with retention requirements.',
          frequency: 'annual'
        },
        {
          id: 'data_masking',
          title: 'Data Masking',
          common: false,
          hint: 'Use of data masking techniques',
          description: 'Provide documentation of data masking/anonymization techniques used for non-production environments or specific use cases.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'A.8.11',
          commonIssue: 'Should protect sensitive data in non-production environments.',
          frequency: 'annual'
        },
        {
          id: 'data_leakage_prevention',
          title: 'Data Leakage Prevention',
          common: false,
          hint: 'DLP controls',
          description: 'Provide evidence of data leakage prevention controls including DLP tool configuration, monitoring, and incident handling.',
          evidenceType: 'point-in-time',
          expectedFormat: 'Screenshot or PDF',
          controlRef: 'A.8.12',
          commonIssue: 'Should cover key data exfiltration channels.',
          frequency: 'annual'
        },
        {
          id: 'backup_iso',
          title: 'Information Backup',
          common: true,
          hint: 'Backup procedures and testing',
          description: 'Provide evidence of backup procedures including backup configuration, completion logs from {{auditPeriod}}, and restoration testing.',
          evidenceType: 'period-of-time',
          expectedFormat: 'Screenshot or PDF',
          controlRef: 'A.8.13',
          commonIssue: ' Should include restoration testing evidence.',
          frequency: 'quarterly'
        },
        {
          id: 'redundancy',
          title: 'Redundancy of Information Processing',
          common: false,
          hint: 'System redundancy',
          description: 'Provide documentation of redundancy measures for critical systems including high availability architecture and failover testing.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'A.8.14',
          commonIssue: 'Should align with availability requirements.',
          frequency: 'annual'
        },
        {
          id: 'logging_iso',
          title: 'Logging',
          common: true,
          hint: 'Security event logging',
          description: 'Provide evidence of security logging including what events are logged, log retention, and log protection.',
          evidenceType: 'point-in-time',
          expectedFormat: 'Screenshot or PDF',
          controlRef: 'A.8.15',
          commonIssue: 'Should cover authentication, access, and security events.',
          frequency: 'annual'
        },
        {
          id: 'monitoring_iso',
          title: 'Monitoring Activities',
          common: true,
          hint: 'Security monitoring',
          description: 'Provide evidence of security monitoring including what is monitored, alerting configuration, and sample alerts from {{auditPeriod}}.',
          evidenceType: 'period-of-time',
          expectedFormat: 'Screenshot or PDF',
          controlRef: 'A.8.16',
          commonIssue: ' Should show active monitoring and response to alerts.',
          frequency: 'quarterly'
        },
        {
          id: 'clock_sync',
          title: 'Clock Synchronization',
          common: false,
          hint: 'Time synchronization configuration',
          description: 'Provide evidence of clock synchronization across systems including NTP configuration.',
          evidenceType: 'point-in-time',
          expectedFormat: 'Screenshot',
          controlRef: 'A.8.17',
          commonIssue: 'Critical for log correlation and investigation.',
          frequency: 'annual'
        },
        {
          id: 'privileged_utilities',
          title: 'Use of Privileged Utility Programs',
          common: false,
          hint: 'Control of system utilities',
          description: 'Provide documentation of controls over privileged utility programs including access restrictions and logging.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'A.8.18',
          commonIssue: 'Should restrict access to utilities that could bypass controls.',
          frequency: 'annual'
        },
        {
          id: 'software_installation',
          title: 'Installation of Software',
          common: false,
          hint: 'Controls over software installation',
          description: 'Provide documentation of controls over software installation including authorized software lists and installation restrictions.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'A.8.19',
          commonIssue: 'Should prevent unauthorized software installation.',
          frequency: 'annual'
        },
        {
          id: 'network_security_iso',
          title: 'Networks Security',
          common: true,
          hint: 'Network security controls',
          description: 'Provide documentation of network security controls including network architecture, segmentation, and perimeter security.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'A.8.20',
          commonIssue: 'Should include network diagram and security zones.',
          frequency: 'annual'
        },
        {
          id: 'network_services',
          title: 'Security of Network Services',
          common: false,
          hint: 'Security for network services',
          description: 'Provide documentation of security requirements for network services including SLAs and security terms with network service providers.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'A.8.21',
          commonIssue: 'Should address security of outsourced network services.',
          frequency: 'annual'
        },
        {
          id: 'network_segregation',
          title: 'Segregation of Networks',
          common: false,
          hint: 'Network segmentation',
          description: 'Provide evidence of network segmentation including network diagrams showing security zones and access controls between segments.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF or Screenshot',
          controlRef: 'A.8.22',
          commonIssue: 'Should separate systems based on security requirements.',
          frequency: 'annual'
        },
        {
          id: 'web_filtering',
          title: 'Web Filtering',
          common: false,
          hint: 'Web content filtering',
          description: 'Provide evidence of web content filtering controls including configuration and blocked categories.',
          evidenceType: 'point-in-time',
          expectedFormat: 'Screenshot',
          controlRef: 'A.8.23',
          commonIssue: 'Should protect against malicious websites.',
          frequency: 'annual'
        },
        {
          id: 'cryptography_iso',
          title: 'Use of Cryptography',
          common: true,
          hint: 'Encryption controls',
          description: 'Provide documentation of cryptography use including encryption standards, key management, and implementation evidence.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'A.8.24',
          commonIssue: 'Should address data at rest and in transit.',
          frequency: 'annual'
        },
        {
          id: 'sdlc',
          title: 'Secure Development Life Cycle',
          common: true,
          hint: 'SDLC documentation',
          description: 'Provide documentation of the secure development life cycle including security requirements, secure coding practices, and security testing.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'A.8.25',
          commonIssue: 'Should integrate security throughout development.',
          frequency: 'annual'
        },
        {
          id: 'security_requirements',
          title: 'Application Security Requirements',
          common: false,
          hint: 'Security requirements for applications',
          description: 'Provide documentation of security requirements for applications including input validation, authentication, and session management.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'A.8.26',
          commonIssue: 'Should address OWASP Top 10 risks.',
          frequency: 'annual'
        },
        {
          id: 'secure_architecture',
          title: 'Secure System Architecture',
          common: false,
          hint: 'System architecture principles',
          description: 'Provide documentation of secure system architecture principles including defense in depth, least privilege, and fail-secure design.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'A.8.27',
          commonIssue: 'Should show how security is built into architecture.',
          frequency: 'annual'
        },
        {
          id: 'secure_coding',
          title: 'Secure Coding',
          common: false,
          hint: 'Secure coding practices',
          description: 'Provide documentation of secure coding practices including coding standards, static analysis, and security review processes.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'A.8.28',
          commonIssue: 'Should include evidence of enforcement (code review, SAST).',
          frequency: 'annual'
        },
        {
          id: 'security_testing_dev',
          title: 'Security Testing in Development',
          common: true,
          hint: 'Security testing during development',
          description: 'Provide evidence of security testing during development including SAST, DAST, and security code review.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF or Screenshot',
          controlRef: 'A.8.29',
          commonIssue: 'Should be integrated into development pipeline.',
          frequency: 'annual'
        },
        {
          id: 'outsourced_dev',
          title: 'Outsourced Development',
          common: false,
          hint: 'Security for outsourced development',
          description: 'Provide documentation of security requirements for outsourced development including security terms and oversight.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'A.8.30',
          commonIssue: 'Should ensure outsourced code meets security requirements.',
          frequency: 'annual'
        },
        {
          id: 'dev_test_prod',
          title: 'Separation of Environments',
          common: true,
          hint: 'Separation of dev/test/prod',
          description: 'Provide evidence of separation between development, testing, and production environments including access controls and data protection.',
          evidenceType: 'point-in-time',
          expectedFormat: 'Screenshot or PDF',
          controlRef: 'A.8.31',
          commonIssue: 'Production data should not be used in dev/test without masking.',
          frequency: 'annual'
        },
        {
          id: 'change_management_iso',
          title: 'Change Management',
          common: true,
          hint: 'Change control procedures',
          description: 'Provide documentation of change management procedures and sample change requests from {{auditPeriod}} showing approval and testing.',
          evidenceType: 'period-of-time',
          expectedFormat: 'PDF',
          controlRef: 'A.8.32',
          commonIssue: ' Should show changes are approved before implementation.',
          frequency: 'quarterly'
        },
        {
          id: 'test_data',
          title: 'Test Information',
          common: false,
          hint: 'Protection of test data',
          description: 'Provide documentation of how test data is protected including use of masked or synthetic data.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'A.8.33',
          commonIssue: 'Production data should be masked if used for testing.',
          frequency: 'annual'
        },
        {
          id: 'audit_test_protection',
          title: 'Audit Test System Protection',
          common: false,
          hint: 'Protection during audits/tests',
          description: 'Provide documentation of how audit and test activities are controlled to minimize impact on production systems.',
          evidenceType: 'point-in-time',
          expectedFormat: 'PDF',
          controlRef: 'A.8.34',
          commonIssue: 'Should prevent testing from impacting production.',
          frequency: 'annual'
        }
      ]
    }
  ]
},
SOC1: {
  label: 'SOC 1',
  description: 'Service Organization Control 1 (SSAE 18) - Controls relevant to user entities\' ICFR',
  defaultOn: false,
  controlGroups: [
    {
      id: 'soc1_control_environment',
      title: 'Control Environment',
      description: 'Organizational structure, integrity, ethics, and human resources',
      items: [
        { id: 'soc1_org_structure', title: 'Organization Chart', common: true, hint: 'Organization chart and reporting lines', description: 'Provide the current organization chart showing key positions related to processing activities, including finance, IT, and operations management.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'COSO: Control Environment', commonIssue: 'Should show positions relevant to financial processing.', frequency: 'annual' },
        { id: 'soc1_hr_policies', title: 'HR Policies and Procedures', common: true, hint: 'Hiring, background checks, termination', description: 'Provide HR policies covering hiring procedures, background check requirements, and termination processes for personnel involved in financial processing.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'COSO: Control Environment', commonIssue: 'Should address personnel involved in transaction processing.', frequency: 'annual' },
        { id: 'soc1_background_checks', title: 'Background Check Evidence', common: true, hint: 'Sample background checks for relevant personnel', description: 'Provide evidence of background check completion for new hires during {{auditPeriod}} who are involved in financial transaction processing or have access to financial systems.', evidenceType: 'period-of-time', expectedFormat: 'PDF', controlRef: 'COSO: Control Environment', commonIssue: ' Focus on roles with access to financial data or transaction processing.', frequency: 'quarterly' },
        { id: 'soc1_code_of_conduct', title: 'Code of Conduct', common: true, hint: 'Ethics and conduct expectations', description: 'Provide the Code of Conduct or Ethics Policy establishing expectations for employee integrity and ethical behavior.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'COSO: Control Environment', commonIssue: ' Should address ethical behavior related to financial processing.', frequency: 'annual' },
        { id: 'soc1_training', title: 'Training Program & Records', common: true, hint: 'Job-specific training for processing personnel', description: 'Provide training program documentation and completion records from {{auditPeriod}} for personnel involved in financial transaction processing.', evidenceType: 'period-of-time', expectedFormat: 'PDF or Excel', controlRef: 'COSO: Control Environment', commonIssue: ' Training should be specific to job functions and systems used.', frequency: 'annual' }
      ]
    },
    {
      id: 'soc1_logical_access',
      title: 'Logical Access Controls',
      description: 'Controls over system access and authentication',
      items: [
        { id: 'soc1_access_policy', title: 'Logical Access Policy', common: true, hint: 'Policy governing system access', description: 'Provide the Logical Access Policy defining requirements for requesting, approving, and reviewing access to financial systems.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'CC6.1, CC6.2', commonIssue: 'Should cover all in-scope financial systems.', frequency: 'annual' },
        { id: 'soc1_user_list', title: 'User Access Listing', common: true, hint: 'Current list of users with system access', description: 'Provide current user access listings for in-scope financial systems showing username, access level, and department.', evidenceType: 'point-in-time', expectedFormat: 'Excel', controlRef: 'CC6.2', commonIssue: 'Should include all systems that process financial transactions.', frequency: 'quarterly' },
        { id: 'soc1_access_request_samples', title: 'Access Request Samples', common: true, hint: 'Sample access requests with approvals', description: 'Provide 3-5 sample access requests from {{auditPeriod}} showing the request, manager approval, and implementation evidence for financial systems.', evidenceType: 'period-of-time', expectedFormat: 'PDF', controlRef: 'CC6.2', commonIssue: ' Approval must occur before access is granted.', frequency: 'quarterly' },
        { id: 'soc1_access_review', title: 'User Access Reviews', common: true, hint: 'Periodic access review documentation', description: 'Provide user access review documentation from {{auditPeriod}} showing all users with access to financial systems were reviewed.', evidenceType: 'period-of-time', expectedFormat: 'PDF or Excel', controlRef: 'CC6.2', commonIssue: ' Should show action taken for inappropriate access.', frequency: 'quarterly' },
        { id: 'soc1_termination_samples', title: 'Termination Access Removal', common: true, hint: 'Sample terminations showing access removal', description: 'Provide 2-3 sample termination cases from {{auditPeriod}} showing access to financial systems was removed timely.', evidenceType: 'period-of-time', expectedFormat: 'PDF', controlRef: 'CC6.2', commonIssue: ' Access removal date must be on or before termination date.', frequency: 'quarterly' },
        { id: 'soc1_privileged_users', title: 'Privileged User List', common: true, hint: 'Users with administrative access', description: 'Provide list of users with privileged/administrative access to financial systems including justification.', evidenceType: 'point-in-time', expectedFormat: 'Excel', controlRef: 'CC6.3', commonIssue: ' Privileged access should be limited and justified.', frequency: 'quarterly' },
        { id: 'soc1_password_mfa', title: 'Password & MFA Configuration', common: true, hint: 'Authentication controls', description: 'Provide screenshots showing password configuration and MFA requirements for financial systems.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot', controlRef: 'CC6.1', commonIssue: 'MFA should be required for sensitive access.', frequency: 'annual' },
        { id: 'soc1_system_parameters', title: 'System Security Parameters', common: true, hint: 'Password and security settings', description: 'Provide screenshots of system security parameters for applications processing user data. Include password policies and session settings.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot', controlRef: 'CC6.1', commonIssue: 'Settings should meet policy requirements.', frequency: 'annual' },
        { id: 'soc1_remote_access', title: 'Remote Access Controls', common: true, hint: 'Remote access to processing systems', description: 'Provide documentation of remote access controls for systems that process user data. Include VPN and MFA configuration.', evidenceType: 'point-in-time', expectedFormat: 'PDF or Screenshot', controlRef: 'CC6.1', commonIssue: 'Remote access should require strong authentication.', frequency: 'annual' },
        { id: 'soc1_access_logs', title: 'Access Log Samples', common: true, hint: 'System access logs', description: 'Provide sample access logs from processing systems from {{auditPeriod}} showing user logins and access events.', evidenceType: 'period-of-time', expectedFormat: 'PDF', controlRef: 'CC7.2', commonIssue: ' Logs should capture authentication events.', frequency: 'quarterly' }
      ]
    },
    {
      id: 'soc1_change_management',
      title: 'Change Management',
      description: 'Controls over changes to systems and applications',
      items: [
        { id: 'soc1_change_policy', title: 'Change Management Policy', common: true, hint: 'Policy for change control', description: 'Provide the Change Management Policy defining requirements for requesting, approving, testing, and implementing changes to financial systems.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'CC8.1', commonIssue: 'Should address both application and infrastructure changes.', frequency: 'annual' },
        { id: 'soc1_change_log', title: 'Change Log', common: true, hint: 'Log of changes to financial systems', description: 'Provide log of changes made to financial systems during {{auditPeriod}} including change description, requester, approver, and implementation date.', evidenceType: 'period-of-time', expectedFormat: 'Excel', controlRef: 'CC8.1', commonIssue: ' Log should be comprehensive.', frequency: 'quarterly' },
        { id: 'soc1_change_samples', title: 'Change Request Samples', common: true, hint: 'Sample change tickets with approvals', description: 'Provide 3-5 sample change requests from {{auditPeriod}} showing testing evidence and approval before implementation.', evidenceType: 'period-of-time', expectedFormat: 'PDF', controlRef: 'CC8.1', commonIssue: ' Approval must occur before deployment.', frequency: 'quarterly' },
        { id: 'soc1_segregation', title: 'Segregation of Duties Matrix', common: true, hint: 'Separation of incompatible duties', description: 'Provide segregation of duties matrix showing separation of development, testing, approval, and deployment.', evidenceType: 'point-in-time', expectedFormat: 'Excel', controlRef: 'CC8.1, CC5.1', commonIssue: ' Critical for SOC 1: developer cannot approve and deploy own code.', frequency: 'annual' },
        { id: 'soc1_dev_prod_separation', title: 'Development/Production Separation', common: true, hint: 'Evidence of environment separation', description: 'Provide evidence that development and production environments are separated.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot or PDF', controlRef: 'CC8.1', commonIssue: 'Developers should not have production deployment access.', frequency: 'annual' },
        { id: 'soc1_version_control', title: 'Version Control Evidence', common: true, hint: 'Source code/config version control', description: 'Provide evidence of version control for applications and configurations. Include repository settings and sample commits.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot', controlRef: 'CC8.1', commonIssue: 'All production code should be version controlled.', frequency: 'annual' },
        { id: 'soc1_release_management', title: 'Release Management Procedures', common: true, hint: 'Production release procedures', description: 'Provide procedures for releasing changes to production including approval, testing, and rollback requirements.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'CC8.1', commonIssue: 'Releases should be tested and approved.', frequency: 'annual' }
      ]
    },
    {
      id: 'soc1_computer_operations',
      title: 'Computer Operations',
      description: 'Job scheduling, backups, and system monitoring',
      items: [
        { id: 'soc1_job_schedule', title: 'Job Scheduling Documentation', common: true, hint: 'Documentation of automated jobs', description: 'Provide documentation of scheduled jobs that process financial data including job name, schedule, and dependencies.', evidenceType: 'point-in-time', expectedFormat: 'PDF or Excel', controlRef: 'CC7.1', commonIssue: 'Should cover all batch jobs that process financial transactions.', frequency: 'annual' },
        { id: 'soc1_job_monitoring', title: 'Job Completion Monitoring', common: true, hint: 'Evidence jobs are monitored', description: 'Provide evidence that scheduled jobs are monitored for successful completion from {{auditPeriod}}.', evidenceType: 'period-of-time', expectedFormat: 'Screenshot or PDF', controlRef: 'CC7.1', commonIssue: ' Should show how job failures are identified and resolved.', frequency: 'quarterly' },
        { id: 'soc1_backup_config', title: 'Backup Configuration', common: true, hint: 'Backup settings for financial systems', description: 'Provide backup configuration for financial systems including frequency, retention, and storage location.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot or PDF', controlRef: 'CC9.1', commonIssue: ' Should cover all systems containing financial data.', frequency: 'annual' },
        { id: 'soc1_backup_logs', title: 'Backup Completion Logs', common: true, hint: 'Evidence backups completed', description: 'Provide backup completion logs from {{auditPeriod}} showing backups completed successfully.', evidenceType: 'period-of-time', expectedFormat: 'Screenshot or PDF', controlRef: 'CC9.1', commonIssue: ' Should show how failures are resolved.', frequency: 'quarterly' },
        { id: 'soc1_backup_restore', title: 'Backup Restoration Testing', common: true, hint: 'Evidence backups can be restored', description: 'Provide evidence of backup restoration testing during {{auditPeriod}}.', evidenceType: 'period-of-time', expectedFormat: 'PDF', controlRef: 'CC9.1', commonIssue: ' Should test actual restoration.', frequency: 'annual' },
        { id: 'soc1_incident_log', title: 'System Incident Log', common: true, hint: 'Log of system incidents', description: 'Provide log of system incidents affecting financial processing during {{auditPeriod}}.', evidenceType: 'period-of-time', expectedFormat: 'Excel or PDF', controlRef: 'CC7.4', commonIssue: ' Zero incidents requires attestation.', frequency: 'quarterly' }
      ]
    },
    {
      id: 'soc1_data_processing',
      title: 'Data Processing Integrity',
      description: 'Controls ensuring accurate, complete, and timely processing',
      items: [
        { id: 'soc1_processing_procedures', title: 'Transaction Processing Procedures', common: true, hint: 'Procedures for processing transactions', description: 'Provide documented procedures for processing financial transactions including input, processing, and output controls.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'PI1.1, PI1.2', commonIssue: 'Should cover the complete transaction lifecycle.', frequency: 'annual' },
        { id: 'soc1_input_validation', title: 'Input Validation Controls', common: true, hint: 'Evidence of data validation', description: 'Provide evidence of input validation controls ensuring accurate data entry.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot or PDF', controlRef: 'PI1.2', commonIssue: 'Should show validation occurs before processing.', frequency: 'annual' },
        { id: 'soc1_reconciliations', title: 'Reconciliation Reports', common: true, hint: 'Input/output reconciliations', description: 'Provide reconciliation reports from {{auditPeriod}} showing processing completeness and accuracy.', evidenceType: 'period-of-time', expectedFormat: 'PDF or Excel', controlRef: 'PI1.4', commonIssue: ' Reconciliations should be performed independently.', frequency: 'monthly' },
        { id: 'soc1_exception_handling', title: 'Exception Handling', common: true, hint: 'How processing exceptions are handled', description: 'Provide documentation of exception handling and exception report samples from {{auditPeriod}}.', evidenceType: 'period-of-time', expectedFormat: 'PDF', controlRef: 'PI1.3', commonIssue: ' Exceptions should be investigated timely.', frequency: 'quarterly' },
        { id: 'soc1_ipe_testing', title: 'IPE Testing Evidence', common: true, hint: 'Testing of system reports', description: 'Provide evidence of testing Information Produced by the Entity (IPE) used in control operation.', evidenceType: 'period-of-time', expectedFormat: 'PDF', controlRef: 'PI1.4', commonIssue: ' Critical for SOC 1: reports must be reliable.', frequency: 'annual' },
        { id: 'soc1_output_controls', title: 'Output Distribution Controls', common: true, hint: 'Control report distribution', description: 'Provide documentation of controls over output/report distribution including authorization and security requirements.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'PI1.5', commonIssue: 'Outputs should be distributed only to authorized recipients.', frequency: 'annual' },
        { id: 'soc1_error_correction', title: 'Error Correction Procedures', common: true, hint: 'Handling processing errors', description: 'Provide procedures for identifying and correcting processing errors. Include error logs from {{auditPeriod}} showing resolution.', evidenceType: 'period-of-time', expectedFormat: 'PDF', controlRef: 'PI1.3', commonIssue: ' Errors should be tracked and resolved timely.', frequency: 'quarterly' }
      ]
    },
    {
      id: 'soc1_subservice',
      title: 'Subservice Organizations',
      description: 'Controls over outsourced services',
      items: [
        { id: 'soc1_subservice_list', title: 'Subservice Organization Inventory', common: true, hint: 'List of subservice organizations', description: 'Provide list of subservice organizations used in service delivery.', evidenceType: 'point-in-time', expectedFormat: 'Excel', controlRef: 'CC9.2', commonIssue: 'Should include all subservice organizations.', frequency: 'annual' },
        { id: 'soc1_subservice_soc', title: 'Subservice Organization SOC Reports', common: true, hint: 'SOC reports from subservice orgs', description: 'Provide SOC reports from subservice organizations with coverage overlapping {{auditPeriod}}.', evidenceType: 'period-of-time', expectedFormat: 'PDF', controlRef: 'CC9.2', commonIssue: ' Review for exceptions affecting your controls.', frequency: 'annual' },
        { id: 'soc1_datacenter_soc', title: 'Data Center SOC Report', common: true, hint: 'SOC report from hosting provider', description: 'Provide SOC report from data center or cloud provider with coverage overlapping {{auditPeriod}}.', evidenceType: 'period-of-time', expectedFormat: 'PDF', controlRef: 'CC6.4', commonIssue: ' Review for any relevant exceptions.', frequency: 'annual' }
      ]
    }
  ]
},
NISTCSF: {
  label: 'NIST CSF',
  description: 'NIST Cybersecurity Framework 2.0',
  defaultOn: false,
  controlGroups: [
    {
      id: 'nist_govern',
      title: 'GOVERN',
      description: 'Organizational context, risk management strategy, roles, policies, and oversight',
      items: [
        { id: 'nist_org_context', title: 'Organizational Context', common: true, hint: 'Mission, stakeholders, and dependencies', description: 'Provide documentation of organizational context including mission, key stakeholders, legal/regulatory requirements, and critical dependencies.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'GV.OC', commonIssue: 'Should identify critical assets and processes.', frequency: 'annual' },
        { id: 'nist_risk_strategy', title: 'Risk Management Strategy', common: true, hint: 'Risk tolerance and strategy', description: 'Provide documentation of cybersecurity risk management strategy including risk tolerance levels and integration with enterprise risk management.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'GV.RM', commonIssue: 'Strategy should be approved by leadership.', frequency: 'annual' },
        { id: 'nist_roles', title: 'Cybersecurity Roles & Responsibilities', common: true, hint: 'Assignment of responsibilities', description: 'Provide documentation of cybersecurity roles and responsibilities including accountability assignments.', evidenceType: 'point-in-time', expectedFormat: 'PDF or Excel', controlRef: 'GV.RR', commonIssue: 'Should clearly assign accountability.', frequency: 'annual' },
        { id: 'nist_policies', title: 'Cybersecurity Policies', common: true, hint: 'Set of cybersecurity policies', description: 'Provide cybersecurity policies covering key security domains with evidence of approval and communication.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'GV.PO', commonIssue: 'Policies should be approved and communicated.', frequency: 'annual' },
        { id: 'nist_oversight', title: 'Governance & Oversight', common: true, hint: 'Evidence of leadership oversight', description: 'Provide evidence of governance activities during {{auditPeriod}} including board/executive updates or security committee meetings.', evidenceType: 'period-of-time', expectedFormat: 'PDF', controlRef: 'GV.OV', commonIssue: ' Should show cybersecurity addressed at governance level.', frequency: 'quarterly' },
        { id: 'nist_supply_chain', title: 'Supply Chain Risk Management', common: false, hint: 'Third-party risk management', description: 'Provide documentation of supply chain risk management program including supplier requirements and ongoing monitoring.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'GV.SC', commonIssue: ' Should address risks from suppliers and partners.', frequency: 'annual' },
        { id: 'nist_cybersecurity_program', title: 'Cybersecurity Program Documentation', common: true, hint: 'Formal cybersecurity program', description: 'Provide documentation of the organization\'s cybersecurity program including mission, scope, and objectives.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'GV.OC', commonIssue: 'Program should align with business objectives.', frequency: 'annual' },
        { id: 'nist_risk_appetite', title: 'Risk Appetite Statement', common: true, hint: 'Organizational risk tolerance', description: 'Provide documentation of the organization\'s risk appetite for cybersecurity risks. Include risk tolerance thresholds.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'GV.RM', commonIssue: 'Risk appetite should guide security decisions.', frequency: 'annual' },
        { id: 'nist_legal_regulatory', title: 'Legal & Regulatory Requirements', common: true, hint: 'Compliance obligations', description: 'Provide documentation of legal, regulatory, and contractual cybersecurity requirements applicable to the organization.', evidenceType: 'point-in-time', expectedFormat: 'Excel', controlRef: 'GV.OC', commonIssue: 'Should be comprehensive and current.', frequency: 'annual' },
        { id: 'nist_supply_chain_policy', title: 'Supply Chain Risk Management Policy', common: true, hint: 'SCRM policy', description: 'Provide policy for managing cybersecurity risks in the supply chain including vendor assessment requirements.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'GV.SC', commonIssue: 'Policy should address third-party risk management.', frequency: 'annual' }
      ]
    },
    {
      id: 'nist_identify',
      title: 'IDENTIFY',
      description: 'Asset management, risk assessment, and improvement',
      items: [
        { id: 'nist_asset_inventory', title: 'Asset Inventory', common: true, hint: 'Inventory of assets', description: 'Provide comprehensive asset inventory including hardware, software, data, and services with classification and owner.', evidenceType: 'point-in-time', expectedFormat: 'Excel', controlRef: 'ID.AM', commonIssue: 'Must include all asset types.', frequency: 'annual' },
        { id: 'nist_network_diagram', title: 'Network Architecture Diagram', common: true, hint: 'Diagram of network architecture', description: 'Provide network architecture diagram showing network zones, critical systems, and data flows.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'ID.AM', commonIssue: 'Should show security zones.', frequency: 'annual' },
        { id: 'nist_risk_assessment', title: 'Risk Assessment', common: true, hint: 'Cybersecurity risk assessment', description: 'Provide cybersecurity risk assessment from {{auditPeriod}} including methodology, identified risks, and treatment decisions.', evidenceType: 'period-of-time', expectedFormat: 'PDF or Excel', controlRef: 'ID.RA', commonIssue: ' Should use consistent methodology.', frequency: 'annual' },
        { id: 'nist_data_flow_diagram', title: 'Data Flow Diagram', common: true, hint: 'How data moves through systems', description: 'Provide data flow diagram showing how sensitive data moves through organizational systems and boundaries.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'ID.AM', commonIssue: 'Should show all data storage and transmission points.', frequency: 'annual' },
        { id: 'nist_business_impact', title: 'Business Impact Analysis', common: true, hint: 'Impact of security incidents', description: 'Provide business impact analysis documenting potential impact of security incidents on business operations.', evidenceType: 'point-in-time', expectedFormat: 'PDF or Excel', controlRef: 'ID.RA', commonIssue: 'BIA should inform recovery priorities.', frequency: 'annual' },
        { id: 'nist_threat_assessment', title: 'Threat Assessment', common: true, hint: 'Threat landscape analysis', description: 'Provide assessment of threats relevant to the organization including threat actors, vectors, and potential impacts.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'ID.RA', commonIssue: 'Should be updated based on threat intelligence.', frequency: 'annual' },
        { id: 'nist_supply_chain_risk', title: 'Supply Chain Risk Assessment', common: true, hint: 'Third-party risk assessment', description: 'Provide assessment of cybersecurity risks from third-party suppliers and vendors.', evidenceType: 'point-in-time', expectedFormat: 'Excel or PDF', controlRef: 'ID.SC', commonIssue: 'Should cover all critical vendors.', frequency: 'annual' }
      ]
    },
    {
      id: 'nist_protect',
      title: 'PROTECT',
      description: 'Access control, awareness, data security, and resilience',
      items: [
        { id: 'nist_access_management', title: 'Identity & Access Management', common: true, hint: 'Access control implementation', description: 'Provide documentation of identity and access management including policy, provisioning, and access review.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'PR.AA', commonIssue: 'Should cover full access lifecycle.', frequency: 'annual' },
        { id: 'nist_mfa', title: 'Multi-Factor Authentication', common: true, hint: 'MFA implementation', description: 'Provide evidence of MFA configuration for sensitive systems and remote access.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot', controlRef: 'PR.AA', commonIssue: 'MFA should be required for sensitive access.', frequency: 'annual' },
        { id: 'nist_access_reviews', title: 'Access Reviews', common: true, hint: 'Periodic access review', description: 'Provide access review documentation from {{auditPeriod}} showing inappropriate access was remediated.', evidenceType: 'period-of-time', expectedFormat: 'PDF or Excel', controlRef: 'PR.AA', commonIssue: ' Should show actual remediation.', frequency: 'quarterly' },
        { id: 'nist_awareness', title: 'Security Awareness & Training', common: true, hint: 'Awareness program', description: 'Provide security awareness program documentation and training completion records from {{auditPeriod}}.', evidenceType: 'period-of-time', expectedFormat: 'PDF or Excel', controlRef: 'PR.AT', commonIssue: ' Training should cover all personnel.', frequency: 'annual' },
        { id: 'nist_encryption', title: 'Data Protection & Encryption', common: true, hint: 'Encryption controls', description: 'Provide evidence of encryption at rest and in transit.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot or PDF', controlRef: 'PR.DS', commonIssue: ' Should cover all sensitive data locations.', frequency: 'annual' },
        { id: 'nist_endpoint', title: 'Endpoint Protection', common: true, hint: 'EDR/antivirus deployment', description: 'Provide evidence of endpoint protection deployment and coverage.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot or PDF', controlRef: 'PR.PS', commonIssue: 'Should show all endpoints protected.', frequency: 'quarterly' },
        { id: 'nist_backup', title: 'Backup & Recovery', common: true, hint: 'Backup configuration and testing', description: 'Provide backup configuration and evidence of restoration testing from {{auditPeriod}}.', evidenceType: 'period-of-time', expectedFormat: 'Screenshot or PDF', controlRef: 'PR.IR', commonIssue: ' Should include restoration testing.', frequency: 'quarterly' },
        { id: 'nist_data_protection', title: 'Data Protection Controls', common: true, hint: 'Controls protecting sensitive data', description: 'Provide documentation of data protection controls including classification, encryption, and DLP.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'PR.DS', commonIssue: 'Controls should match data classification levels.', frequency: 'annual' },
        { id: 'nist_platform_security', title: 'Platform Security Configuration', common: true, hint: 'Secure configuration baselines', description: 'Provide evidence of secure configuration baselines for platforms and systems. Include hardening standards used.', evidenceType: 'point-in-time', expectedFormat: 'PDF or Screenshot', controlRef: 'PR.PS', commonIssue: 'Configurations should align with CIS or similar benchmarks.', frequency: 'annual' },
        { id: 'nist_change_management', title: 'Change Management Process', common: true, hint: 'Controlled changes', description: 'Provide documentation of change management process including approval, testing, and rollback procedures.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'PR.PS', commonIssue: 'All changes should be approved and tested.', frequency: 'annual' },
        { id: 'nist_secure_development', title: 'Secure Development Practices', common: false, hint: 'SDLC security', description: 'If developing software, provide documentation of secure development practices including code review and security testing.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'PR.PS', commonIssue: 'Security should be integrated into development lifecycle.', frequency: 'annual' },
        { id: 'nist_physical_security', title: 'Physical Security Controls', common: true, hint: 'Physical access controls', description: 'Provide documentation of physical security controls for facilities containing sensitive systems.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'PR.AC', commonIssue: 'Physical security complements logical security.', frequency: 'annual' },
        { id: 'nist_remote_access', title: 'Remote Access Security', common: true, hint: 'Secure remote access', description: 'Provide documentation of remote access security controls including VPN, MFA, and access policies.', evidenceType: 'point-in-time', expectedFormat: 'PDF or Screenshot', controlRef: 'PR.AC', commonIssue: 'Remote access should require strong authentication.', frequency: 'annual' }
      ]
    },
    {
      id: 'nist_detect',
      title: 'DETECT',
      description: 'Continuous monitoring and adverse event analysis',
      items: [
        { id: 'nist_monitoring', title: 'Continuous Monitoring', common: true, hint: 'Security monitoring implementation', description: 'Provide documentation of continuous monitoring including what is monitored and alerting configuration.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot or PDF', controlRef: 'DE.CM', commonIssue: 'Should show what events generate alerts.', frequency: 'annual' },
        { id: 'nist_logging', title: 'Security Logging', common: true, hint: 'Log configuration and retention', description: 'Provide evidence of security logging configuration including retention periods and log protection.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot or PDF', controlRef: 'DE.CM', commonIssue: 'Should cover authentication and security events.', frequency: 'annual' },
        { id: 'nist_vuln_scanning', title: 'Vulnerability Scanning', common: true, hint: 'Vulnerability scan results', description: 'Provide vulnerability scan reports from {{auditPeriod}} including findings and remediation status.', evidenceType: 'period-of-time', expectedFormat: 'PDF', controlRef: 'DE.CM', commonIssue: ' Should show regular scanning and remediation.', frequency: 'quarterly' },
        { id: 'nist_alert_analysis', title: 'Security Alert Analysis', common: true, hint: 'How alerts are analyzed', description: 'Provide evidence of security alert analysis from {{auditPeriod}} including investigation documentation.', evidenceType: 'period-of-time', expectedFormat: 'PDF', controlRef: 'DE.AE', commonIssue: ' Should show alerts are investigated.', frequency: 'quarterly' },
        { id: 'nist_anomaly_detection', title: 'Anomaly Detection', common: true, hint: 'Detect anomalous behavior', description: 'Provide evidence of anomaly detection capabilities including baseline behavior and alerting thresholds.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot or PDF', controlRef: 'DE.AE', commonIssue: 'Baselines should be established and monitored.', frequency: 'annual' },
        { id: 'nist_continuous_monitoring', title: 'Continuous Monitoring Strategy', common: true, hint: 'Ongoing security monitoring', description: 'Provide documentation of continuous monitoring strategy including tools, frequency, and responsibilities.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'DE.CM', commonIssue: 'Monitoring should be continuous, not periodic.', frequency: 'annual' },
        { id: 'nist_adverse_events', title: 'Adverse Event Analysis', common: true, hint: 'Analysis of detected events', description: 'Provide evidence of analysis of detected events from {{auditPeriod}}. Include investigation procedures and outcomes.', evidenceType: 'period-of-time', expectedFormat: 'PDF or Excel', controlRef: 'DE.AE', commonIssue: ' All alerts should be investigated.', frequency: 'quarterly' }
      ]
    },
    {
      id: 'nist_respond',
      title: 'RESPOND',
      description: 'Incident management, analysis, and mitigation',
      items: [
        { id: 'nist_ir_plan', title: 'Incident Response Plan', common: true, hint: 'IR procedures and team', description: 'Provide the Incident Response Plan including classification, response procedures, and escalation paths.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'RS.MA', commonIssue: 'Plan should be detailed enough to be actionable.', frequency: 'annual' },
        { id: 'nist_incident_log', title: 'Incident Log', common: true, hint: 'Record of security incidents', description: 'Provide security incident log from {{auditPeriod}}. If none, provide attestation.', evidenceType: 'period-of-time', expectedFormat: 'Excel or PDF', controlRef: 'RS.AN', commonIssue: ' Zero incidents requires attestation.', frequency: 'quarterly' },
        { id: 'nist_ir_testing', title: 'IR Plan Testing', common: false, hint: 'Tabletop exercises', description: 'Provide evidence of incident response testing during {{auditPeriod}}.', evidenceType: 'period-of-time', expectedFormat: 'PDF', controlRef: 'RS.MA', commonIssue: ' Testing should include realistic scenarios.', frequency: 'annual' },
        { id: 'nist_ir_communications', title: 'IR Communications Plan', common: true, hint: 'Incident communications', description: 'Provide incident response communications plan including internal and external notification procedures.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'RS.CO', commonIssue: 'Plan should include regulatory notification requirements.', frequency: 'annual' },
        { id: 'nist_ir_improvements', title: 'IR Improvements & Lessons Learned', common: true, hint: 'Post-incident improvements', description: 'Provide evidence of improvements made based on incident response activities from {{auditPeriod}}.', evidenceType: 'period-of-time', expectedFormat: 'PDF', controlRef: 'RS.IM', commonIssue: ' Lessons learned should drive program improvements.', frequency: 'annual' }
      ]
    },
    {
      id: 'nist_recover',
      title: 'RECOVER',
      description: 'Incident recovery planning and communication',
      items: [
        { id: 'nist_dr_plan', title: 'Disaster Recovery Plan', common: true, hint: 'IT recovery procedures', description: 'Provide the Disaster Recovery Plan including recovery objectives (RTO/RPO) and recovery procedures.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'RC.RP', commonIssue: 'RTO/RPO should align with business requirements.', frequency: 'annual' },
        { id: 'nist_dr_testing', title: 'DR Testing', common: true, hint: 'DR plan testing evidence', description: 'Provide evidence of disaster recovery testing during {{auditPeriod}}.', evidenceType: 'period-of-time', expectedFormat: 'PDF', controlRef: 'RC.RP', commonIssue: ' Testing should verify recovery objectives.', frequency: 'annual' }
      ]
    }
  ]
},
CMMC: {
  label: 'CMMC Level 2',
  description: 'Cybersecurity Maturity Model Certification - 110 Practices from NIST 800-171',
  defaultOn: false,
  controlGroups: [
    {
      id: 'cmmc_core_docs',
      title: 'Core Required Documents',
      description: 'Mandatory documentation for CMMC certification',
      items: [
        { id: 'cmmc_ssp', title: 'System Security Plan (SSP)', common: true, hint: 'Documents all 110 practices', description: 'Provide the System Security Plan documenting how each of the 110 NIST 800-171 practices is implemented in your environment covering the CUI boundary.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'CA.L2-3.12.4', commonIssue: 'Must address each of 110 practices with specific details. Generic templates are insufficient.', frequency: 'annual' },
        { id: 'cmmc_poam', title: 'Plan of Action & Milestones (POA&M)', common: true, hint: 'Tracks unmet practices', description: 'Provide the POA&M listing practices not fully implemented with remediation actions and target dates.', evidenceType: 'point-in-time', expectedFormat: 'Excel or PDF', controlRef: 'CA.L2-3.12.2', commonIssue: 'POA&M entries must have realistic milestones.', frequency: 'quarterly' },
        { id: 'cmmc_cui_inventory', title: 'CUI Inventory', common: true, hint: 'Inventory of CUI', description: 'Provide inventory of CUI handled including category, location, handling requirements, and authorized personnel.', evidenceType: 'point-in-time', expectedFormat: 'Excel', controlRef: 'MP.L2-3.8.1', commonIssue: 'Must identify all CUI types and locations.', frequency: 'annual' },
        { id: 'cmmc_boundary_diagram', title: 'CUI Boundary Diagram', common: true, hint: 'Network diagram showing CUI enclave', description: 'Provide network diagram showing the CUI boundary including systems and security controls at boundary points.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'SC.L2-3.13.5', commonIssue: 'Must clearly show what is inside/outside CUI boundary.', frequency: 'annual' }
      ]
    },
    {
      id: 'cmmc_access_control',
      title: 'AC - Access Control',
      description: '22 practices covering access to CUI systems',
      items: [
        { id: 'cmmc_access_policy', title: 'Access Control Policy', common: true, hint: 'Policy governing CUI access', description: 'Provide Access Control Policy defining who can access CUI systems and access restrictions.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'AC.L2-3.1.1', commonIssue: 'Must specifically address CUI system access.', frequency: 'annual' },
        { id: 'cmmc_user_listing', title: 'CUI System User Listing', common: true, hint: 'Authorized users for CUI', description: 'Provide current listing of users authorized to access CUI systems.', evidenceType: 'point-in-time', expectedFormat: 'Excel', controlRef: 'AC.L2-3.1.1', commonIssue: 'Should be limited to personnel with need-to-know.', frequency: 'quarterly' },
        { id: 'cmmc_privileged_users', title: 'Privileged User Listing', common: true, hint: 'Admin access to CUI systems', description: 'Provide listing of users with privileged access to CUI systems with justification.', evidenceType: 'point-in-time', expectedFormat: 'Excel', controlRef: 'AC.L2-3.1.5', commonIssue: 'Privileged accounts must be minimized.', frequency: 'quarterly' },
        { id: 'cmmc_remote_access', title: 'Remote Access Controls', common: true, hint: 'Remote access configuration', description: 'Provide documentation of remote access controls for CUI systems including VPN and MFA.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot or PDF', controlRef: 'AC.L2-3.1.12', commonIssue: 'Remote access must be encrypted with MFA.', frequency: 'annual' },
        { id: 'cmmc_portable_storage', title: 'Portable Storage Controls', common: true, hint: 'Removable media controls', description: 'Provide documentation of controls over portable storage devices with CUI.', evidenceType: 'point-in-time', expectedFormat: 'PDF or Screenshot', controlRef: 'AC.L2-3.1.21', commonIssue: 'USB/removable media should be restricted or encrypted.', frequency: 'annual' },
        { id: 'cmmc_ac_flow_control', title: 'Information Flow Enforcement', common: true, hint: 'Controls on information flow between systems', description: 'Provide documentation showing how information flow is controlled within CUI systems and between system boundaries. Include firewall rules, DLP configurations, or network segmentation evidence.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot or PDF', controlRef: 'AC.L2-3.1.3', commonIssue: 'Must show flow controls are enforced, not just documented.', frequency: 'annual' },
        { id: 'cmmc_ac_separation', title: 'Separation of Duties', common: true, hint: 'Documented separation of duties', description: 'Provide documentation showing separation of duties for CUI system functions. Include role definitions showing no single individual can perform conflicting duties.', evidenceType: 'point-in-time', expectedFormat: 'PDF or Excel', controlRef: 'AC.L2-3.1.4', commonIssue: 'Matrix should show specific incompatible functions, not generic statements.', frequency: 'annual' },
        { id: 'cmmc_ac_failed_logins', title: 'Unsuccessful Logon Handling', common: true, hint: 'Account lockout after failed attempts', description: 'Provide screenshot of system configuration showing automatic lockout after unsuccessful logon attempts to CUI systems.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot', controlRef: 'AC.L2-3.1.8', commonIssue: 'Must show specific lockout threshold and duration configured.', frequency: 'annual' },
        { id: 'cmmc_ac_notice', title: 'System Use Notification', common: true, hint: 'Login banner/warning', description: 'Provide screenshot of system use notification (login banner) displayed before granting access to CUI systems.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot', controlRef: 'AC.L2-3.1.9', commonIssue: 'Banner must include required warnings about unauthorized use and monitoring.', frequency: 'annual' },
        { id: 'cmmc_ac_session_lock', title: 'Session Lock', common: true, hint: 'Automatic screen lock', description: 'Provide screenshot of session lock configuration showing automatic lock after period of inactivity for CUI systems.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot', controlRef: 'AC.L2-3.1.10', commonIssue: 'Must show inactivity timeout is enforced (typically 15 minutes or less).', frequency: 'annual' },
        { id: 'cmmc_ac_session_term', title: 'Session Termination', common: false, hint: 'Automatic session termination', description: 'Provide evidence of automatic session termination after defined conditions (e.g., time limit, inactivity) for CUI system sessions.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot', controlRef: 'AC.L2-3.1.11', commonIssue: 'Session limits should be appropriate for the data sensitivity.', frequency: 'annual' },
        { id: 'cmmc_ac_wireless', title: 'Wireless Access Control', common: true, hint: 'Wireless network security', description: 'Provide documentation of wireless access controls for networks that may access CUI. Include authentication requirements and encryption standards.', evidenceType: 'point-in-time', expectedFormat: 'PDF or Screenshot', controlRef: 'AC.L2-3.1.16', commonIssue: 'Wireless must use WPA2/WPA3 Enterprise with certificate or RADIUS authentication.', frequency: 'annual' },
        { id: 'cmmc_ac_mobile', title: 'Mobile Device Control', common: true, hint: 'Mobile device management', description: 'Provide documentation of mobile device controls for devices accessing CUI. Include MDM policies, encryption requirements, and remote wipe capability.', evidenceType: 'point-in-time', expectedFormat: 'PDF or Screenshot', controlRef: 'AC.L2-3.1.18', commonIssue: 'Must show CUI access from mobile devices is controlled and encrypted.', frequency: 'annual' },
        { id: 'cmmc_ac_external', title: 'External System Connections', common: true, hint: 'External system access controls', description: 'Provide documentation of controls over external system connections to CUI environment. Include interconnection security agreements or external system policies.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'AC.L2-3.1.20', commonIssue: 'Must verify external systems meet CUI protection requirements.', frequency: 'annual' },
        { id: 'cmmc_ac_public_systems', title: 'Publicly Accessible System Separation', common: false, hint: 'Public vs CUI system separation', description: 'Provide evidence that publicly accessible systems are separated from CUI systems. Include network diagrams showing separation.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'AC.L2-3.1.22', commonIssue: 'CUI must not reside on publicly accessible systems.', frequency: 'annual' },
        { id: 'cmmc_ac_access_reviews', title: 'CUI Access Reviews', common: true, hint: 'Periodic review of CUI access', description: 'Provide evidence of periodic reviews of user access to CUI systems during {{auditPeriod}}. Include review documentation with approvals.', evidenceType: 'period-of-time', expectedFormat: 'Excel or PDF', controlRef: 'AC.L2-3.1.7', commonIssue: ' Reviews should be conducted at least quarterly for CUI systems.', frequency: 'quarterly' },
        { id: 'cmmc_ac_termination', title: 'CUI Access Termination', common: true, hint: 'Access removal upon departure', description: 'Provide evidence of timely access termination for personnel departing from CUI-related duties during {{auditPeriod}}. Include termination samples.', evidenceType: 'period-of-time', expectedFormat: 'Excel or PDF', controlRef: 'AC.L2-3.1.7', commonIssue: ' Access should be removed within 24 hours of departure or role change.', frequency: 'quarterly' },
        { id: 'cmmc_ac_network_control', title: 'Network Access Control', common: true, hint: 'Control network connections', description: 'Provide evidence of network access control for CUI systems. Include 802.1X configuration, NAC policies, or similar controls.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot or PDF', controlRef: 'AC.L2-3.1.13', commonIssue: 'Unauthorized devices should not be able to connect to CUI network.', frequency: 'annual' },
        { id: 'cmmc_ac_routing', title: 'Network Routing Control', common: false, hint: 'Route CUI traffic appropriately', description: 'Provide evidence that network routing controls direct CUI traffic through controlled access points.', evidenceType: 'point-in-time', expectedFormat: 'PDF or Screenshot', controlRef: 'AC.L2-3.1.14', commonIssue: 'CUI traffic should not bypass security controls.', frequency: 'annual' }
      ]
    },
    {
      id: 'cmmc_awareness_training',
      title: 'AT - Awareness & Training',
      description: '3 practices for security awareness and role-based training',
      items: [
        { id: 'cmmc_at_awareness', title: 'Security Awareness Training', common: true, hint: 'Basic security awareness for all users', description: 'Provide evidence that all users of CUI systems receive security awareness training. Include training content and completion records from {{auditPeriod}}.', evidenceType: 'period-of-time', expectedFormat: 'PDF', controlRef: 'AT.L2-3.2.1', commonIssue: ' Training must be completed by all personnel with CUI access.', frequency: 'annual' },
        { id: 'cmmc_at_role_based', title: 'Role-Based Training', common: true, hint: 'Specialized training for security roles', description: 'Provide evidence that personnel with security roles receive role-based security training. Include training specific to their CUI protection responsibilities.', evidenceType: 'period-of-time', expectedFormat: 'PDF', controlRef: 'AT.L2-3.2.2', commonIssue: ' Admins, developers, and security personnel need role-specific training.', frequency: 'annual' },
        { id: 'cmmc_at_insider', title: 'Insider Threat Awareness', common: true, hint: 'Insider threat recognition training', description: 'Provide evidence of insider threat awareness training covering recognition and reporting of potential insider threats to CUI.', evidenceType: 'period-of-time', expectedFormat: 'PDF', controlRef: 'AT.L2-3.2.3', commonIssue: ' Must include indicators and reporting procedures.', frequency: 'annual' },
        { id: 'cmmc_at_training_records', title: 'Training Completion Records', common: true, hint: 'Evidence of training completion', description: 'Provide training completion records for all personnel with CUI system access from {{auditPeriod}}. Include names, dates, and courses completed.', evidenceType: 'period-of-time', expectedFormat: 'Excel', controlRef: 'AT.L2-3.2.1', commonIssue: ' Records should show 100% completion for CUI personnel.', frequency: 'annual' },
        { id: 'cmmc_at_program', title: 'Training Program Documentation', common: true, hint: 'Training program description', description: 'Provide documentation describing the security training program including curriculum, delivery method, frequency, and target audiences.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'AT.L2-3.2.1', commonIssue: 'Program should address CUI-specific training requirements.', frequency: 'annual' }
      ]
    },
    {
      id: 'cmmc_identification_auth',
      title: 'IA - Identification & Authentication',
      description: '11 practices for authenticating users and devices',
      items: [
        { id: 'cmmc_user_identification', title: 'User Identification', common: true, hint: 'Unique identification', description: 'Provide evidence that all users accessing CUI systems are uniquely identified (no shared accounts).', evidenceType: 'point-in-time', expectedFormat: 'Screenshot', controlRef: 'IA.L2-3.5.1', commonIssue: 'No shared or generic accounts for CUI access.', frequency: 'annual' },
        { id: 'cmmc_mfa', title: 'Multi-Factor Authentication', common: true, hint: 'MFA for CUI access', description: 'Provide evidence of MFA configuration for CUI system access.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot', controlRef: 'IA.L2-3.5.3', commonIssue: 'MFA required for privileged and remote access.', frequency: 'annual' },
        { id: 'cmmc_password', title: 'Password Complexity', common: true, hint: 'Password requirements', description: 'Provide screenshot of password policy configuration for CUI systems.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot', controlRef: 'IA.L2-3.5.7', commonIssue: 'Must meet NIST 800-171 requirements.', frequency: 'annual' },
        { id: 'cmmc_ia_device_id', title: 'Device Identification', common: true, hint: 'Identify devices before network access', description: 'Provide evidence that devices are identified and authenticated before network access to CUI systems. Include certificate-based auth, MAC registration, or NAC evidence.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot or PDF', controlRef: 'IA.L2-3.5.2', commonIssue: 'Device authentication should be required, not just user authentication.', frequency: 'annual' },
        { id: 'cmmc_ia_replay_resistant', title: 'Replay-Resistant Authentication', common: false, hint: 'Protection against replay attacks', description: 'Provide evidence that authentication mechanisms for CUI systems are resistant to replay attacks. Include MFA, time-based tokens, or challenge-response evidence.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot or PDF', controlRef: 'IA.L2-3.5.4', commonIssue: 'Kerberos, certificates, or TOTP provide replay resistance.', frequency: 'annual' },
        { id: 'cmmc_ia_reuse_prevention', title: 'Identifier Reuse Prevention', common: true, hint: 'Prevent reuse of user IDs', description: 'Provide documentation showing controls that prevent reuse of user identifiers for CUI systems.', evidenceType: 'point-in-time', expectedFormat: 'PDF or Screenshot', controlRef: 'IA.L2-3.5.5', commonIssue: 'User IDs should never be reassigned to different users.', frequency: 'annual' },
        { id: 'cmmc_ia_inactivity', title: 'Identifier Inactivity', common: true, hint: 'Disable inactive accounts', description: 'Provide evidence that identifiers are disabled after a defined period of inactivity. Include policy and system configuration for inactive account handling.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot', controlRef: 'IA.L2-3.5.6', commonIssue: 'Accounts should be disabled after 90 days of inactivity (or less).', frequency: 'annual' },
        { id: 'cmmc_ia_feedback', title: 'Obscure Authentication Feedback', common: false, hint: 'Hide authentication info during entry', description: 'Provide evidence that authentication feedback is obscured during the authentication process (e.g., masked passwords).', evidenceType: 'point-in-time', expectedFormat: 'Screenshot', controlRef: 'IA.L2-3.5.11', commonIssue: 'Passwords must be masked during entry.', frequency: 'annual' },
        { id: 'cmmc_ia_crypto_auth', title: 'Cryptographic Authentication', common: true, hint: 'Crypto modules for authentication', description: 'Provide evidence that cryptographic authentication is used for CUI systems where required. Include certificate configuration or PKI evidence.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot or PDF', controlRef: 'IA.L2-3.5.9', commonIssue: 'Network and remote access should use cryptographic authentication.', frequency: 'annual' },
        { id: 'cmmc_ia_management', title: 'Authenticator Management', common: true, hint: 'Password and credential management', description: 'Provide documentation of authenticator management procedures for CUI systems. Include initial distribution, lost credential handling, and reset procedures.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'IA.L2-3.5.10', commonIssue: 'Must cover entire authenticator lifecycle.', frequency: 'annual' },
        { id: 'cmmc_ia_default_auth', title: 'Default Authenticator Changes', common: true, hint: 'Change default passwords', description: 'Provide evidence that default authenticators (passwords, keys) are changed on CUI systems before deployment.', evidenceType: 'point-in-time', expectedFormat: 'PDF or Screenshot', controlRef: 'IA.L2-3.5.7', commonIssue: 'Default passwords must be changed - provide process evidence.', frequency: 'annual' }
      ]
    },
    {
      id: 'cmmc_config_management',
      title: 'CM - Configuration Management',
      description: '9 practices for system configuration control',
      items: [
        { id: 'cmmc_baseline', title: 'Baseline Configurations', common: true, hint: 'Security baselines', description: 'Provide documentation of baseline security configurations for CUI systems.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'CM.L2-3.4.1', commonIssue: 'Baselines should address all CUI system types.', frequency: 'annual' },
        { id: 'cmmc_change_control', title: 'Configuration Change Control', common: true, hint: 'Change management', description: 'Provide change control documentation and sample changes from {{auditPeriod}} for CUI systems.', evidenceType: 'period-of-time', expectedFormat: 'PDF', controlRef: 'CM.L2-3.4.3', commonIssue: ' Changes must be approved before implementation.', frequency: 'quarterly' },
        { id: 'cmmc_least_functionality', title: 'Least Functionality', common: true, hint: 'Unnecessary functions disabled', description: 'Provide evidence that CUI systems are configured with least functionality.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot or PDF', controlRef: 'CM.L2-3.4.6', commonIssue: ' Should show unnecessary services disabled.', frequency: 'annual' },
        { id: 'cmmc_cm_security_settings', title: 'Security Configuration Settings', common: true, hint: 'Documented security settings', description: 'Provide documentation of security configuration settings for CUI systems. Include hardening guides or configuration standards used.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'CM.L2-3.4.2', commonIssue: 'Settings should align with CIS benchmarks or DISA STIGs.', frequency: 'annual' },
        { id: 'cmmc_cm_impact_analysis', title: 'Security Impact Analysis', common: true, hint: 'Change impact assessment', description: 'Provide evidence that security impact analysis is performed before changes to CUI systems. Include sample change records showing security review.', evidenceType: 'period-of-time', expectedFormat: 'PDF', controlRef: 'CM.L2-3.4.4', commonIssue: ' Changes must be assessed for security impact before implementation.', frequency: 'quarterly' },
        { id: 'cmmc_cm_access_restrictions', title: 'Change Access Restrictions', common: true, hint: 'Control who can make changes', description: 'Provide evidence that access to change CUI systems is restricted to authorized personnel. Include access lists and approval requirements.', evidenceType: 'point-in-time', expectedFormat: 'Excel or Screenshot', controlRef: 'CM.L2-3.4.5', commonIssue: 'Only authorized personnel should have ability to modify systems.', frequency: 'annual' },
        { id: 'cmmc_cm_inventory', title: 'System Component Inventory', common: true, hint: 'Hardware/software inventory', description: 'Provide current inventory of system components (hardware, software, firmware) in the CUI environment.', evidenceType: 'point-in-time', expectedFormat: 'Excel', controlRef: 'CM.L2-3.4.7', commonIssue: 'Inventory must be complete and current.', frequency: 'quarterly' },
        { id: 'cmmc_cm_unauthorized', title: 'Software Restriction', common: true, hint: 'Control unauthorized software', description: 'Provide evidence of controls preventing or detecting unauthorized software on CUI systems. Include application whitelisting or software inventory controls.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot or PDF', controlRef: 'CM.L2-3.4.8', commonIssue: 'Should have active controls, not just policy.', frequency: 'annual' },
        { id: 'cmmc_cm_user_software', title: 'User-Installed Software Control', common: false, hint: 'Control user software installation', description: 'Provide evidence that user-installed software on CUI systems is controlled and monitored.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot', controlRef: 'CM.L2-3.4.9', commonIssue: 'Users should not have admin rights to install software.', frequency: 'annual' }
      ]
    },
    {
      id: 'cmmc_audit',
      title: 'AU - Audit & Accountability',
      description: '9 practices for logging and audit trails',
      items: [
        { id: 'cmmc_audit_events', title: 'Audit Events Configuration', common: true, hint: 'What is logged', description: 'Provide documentation of audit events configured for CUI systems.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot or PDF', controlRef: 'AU.L2-3.3.1', commonIssue: 'Must log user actions and access to CUI.', frequency: 'annual' },
        { id: 'cmmc_audit_review', title: 'Audit Log Review', common: true, hint: 'Review of audit logs', description: 'Provide evidence of audit log review activities during {{auditPeriod}}.', evidenceType: 'period-of-time', expectedFormat: 'PDF', controlRef: 'AU.L2-3.3.5', commonIssue: ' Logs should be reviewed regularly.', frequency: 'quarterly' },
        { id: 'cmmc_audit_protection', title: 'Audit Log Protection', common: true, hint: 'Protection of logs', description: 'Provide evidence that audit logs are protected from unauthorized access/modification.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot or PDF', controlRef: 'AU.L2-3.3.8', commonIssue: ' Logs must be immutable and access-controlled.', frequency: 'annual' },
        { id: 'cmmc_au_content', title: 'Audit Record Content', common: true, hint: 'What information is captured in logs', description: 'Provide documentation showing what information is captured in audit records for CUI systems. Include sample log entries showing required fields.', evidenceType: 'point-in-time', expectedFormat: 'PDF or Screenshot', controlRef: 'AU.L2-3.3.2', commonIssue: 'Logs must capture who, what, when, where, and outcome.', frequency: 'annual' },
        { id: 'cmmc_au_capacity', title: 'Audit Storage Capacity', common: false, hint: 'Log storage management', description: 'Provide evidence of audit log storage capacity management for CUI systems. Show capacity planning and alerting configuration.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot', controlRef: 'AU.L2-3.3.3', commonIssue: 'Storage must be sufficient to retain logs for required period.', frequency: 'annual' },
        { id: 'cmmc_au_failure', title: 'Audit Failure Response', common: false, hint: 'Response to audit system failures', description: 'Provide documentation of procedures for responding to audit system failures. Include alerting configuration and response procedures.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'AU.L2-3.3.4', commonIssue: 'System should alert on audit failures and have recovery procedures.', frequency: 'annual' },
        { id: 'cmmc_au_correlation', title: 'Audit Correlation', common: true, hint: 'Correlation of audit records', description: 'Provide evidence that audit records from CUI systems are correlated for analysis. Include SIEM configuration or log aggregation evidence.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot or PDF', controlRef: 'AU.L2-3.3.6', commonIssue: 'Logs from multiple sources should be correlated for threat detection.', frequency: 'annual' },
        { id: 'cmmc_au_reduction', title: 'Audit Reduction & Reporting', common: false, hint: 'Audit analysis tools', description: 'Provide evidence of audit reduction and reporting capabilities. Include dashboards or reports used for log analysis.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot', controlRef: 'AU.L2-3.3.7', commonIssue: 'Should have tools to filter and analyze large volumes of logs.', frequency: 'annual' },
        { id: 'cmmc_au_timestamps', title: 'Time Stamps & Synchronization', common: true, hint: 'NTP/time sync configuration', description: 'Provide evidence that CUI systems use synchronized time stamps. Include NTP configuration showing authoritative time source.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot', controlRef: 'AU.L2-3.3.9', commonIssue: 'All CUI systems must sync to authoritative time source.', frequency: 'annual' }
      ]
    },
    {
      id: 'cmmc_incident_response',
      title: 'IR - Incident Response',
      description: '3 practices for handling security incidents',
      items: [
        { id: 'cmmc_ir_plan', title: 'Incident Response Capability', common: true, hint: 'IR plan and team', description: 'Provide Incident Response Plan covering incidents affecting CUI.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'IR.L2-3.6.1', commonIssue: 'Must address CUI incidents specifically.', frequency: 'annual' },
        { id: 'cmmc_incident_log', title: 'Incident Tracking', common: true, hint: 'Log of incidents', description: 'Provide incident tracking log from {{auditPeriod}}. If none, provide attestation.', evidenceType: 'period-of-time', expectedFormat: 'Excel or PDF', controlRef: 'IR.L2-3.6.2', commonIssue: ' Must track all incidents.', frequency: 'quarterly' },
        { id: 'cmmc_ir_testing', title: 'IR Testing', common: true, hint: 'IR plan testing', description: 'Provide evidence of incident response testing during {{auditPeriod}}.', evidenceType: 'period-of-time', expectedFormat: 'PDF', controlRef: 'IR.L2-3.6.3', commonIssue: ' Testing should be performed annually.', frequency: 'annual' }
      ]
    },

    {
      id: 'cmmc_maintenance',
      title: 'MA - Maintenance',
      description: '6 practices for system maintenance controls',
      items: [
        { id: 'cmmc_ma_controlled', title: 'Controlled Maintenance', common: true, hint: 'Maintenance procedures', description: 'Provide documentation of maintenance procedures for CUI systems. Include scheduling, approval, and supervision requirements.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'MA.L2-3.7.1', commonIssue: 'Maintenance must be scheduled, approved, and documented.', frequency: 'annual' },
        { id: 'cmmc_ma_tools', title: 'Maintenance Tools Control', common: true, hint: 'Control over maintenance tools', description: 'Provide evidence of controls over maintenance tools used on CUI systems. Include tool inventory and authorization requirements.', evidenceType: 'point-in-time', expectedFormat: 'PDF or Excel', controlRef: 'MA.L2-3.7.2', commonIssue: 'Only approved tools should be used for maintenance.', frequency: 'annual' },
        { id: 'cmmc_ma_media', title: 'Maintenance Media Inspection', common: false, hint: 'Check media containing diagnostic programs', description: 'Provide documentation showing that media containing diagnostic and test programs is checked for malicious code before use on CUI systems.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'MA.L2-3.7.4', commonIssue: 'Scan maintenance media before connecting to CUI systems.', frequency: 'annual' },
        { id: 'cmmc_ma_remote', title: 'Remote Maintenance', common: true, hint: 'Remote maintenance controls', description: 'Provide documentation of remote maintenance procedures for CUI systems. Include approval, monitoring, and session termination requirements.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'MA.L2-3.7.5', commonIssue: 'Remote maintenance must be approved, logged, and monitored.', frequency: 'annual' },
        { id: 'cmmc_ma_personnel', title: 'Maintenance Personnel', common: true, hint: 'Supervise maintenance personnel', description: 'Provide evidence that maintenance personnel without proper authorization are supervised when performing maintenance on CUI systems.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'MA.L2-3.7.6', commonIssue: 'Unauthorized personnel must be escorted and supervised.', frequency: 'annual' },
        { id: 'cmmc_ma_records', title: 'Maintenance Records', common: true, hint: 'Log of maintenance activities', description: 'Provide maintenance records for CUI systems from {{auditPeriod}}. Include date, personnel, description of work, and systems affected.', evidenceType: 'period-of-time', expectedFormat: 'Excel or PDF', controlRef: 'MA.L2-3.7.1', commonIssue: ' All maintenance should be documented.', frequency: 'quarterly' }
      ]
    },
    {
      id: 'cmmc_physical_protection',
      title: 'PE - Physical Protection',
      description: '6 practices for physical access and protection',
      items: [
        { id: 'cmmc_pe_access_auth', title: 'Physical Access Authorization', common: true, hint: 'Authorized physical access list', description: 'Provide list of personnel authorized for physical access to CUI processing facilities. Include authorization documentation.', evidenceType: 'point-in-time', expectedFormat: 'Excel', controlRef: 'PE.L2-3.10.1', commonIssue: 'Only personnel with need should have physical access.', frequency: 'quarterly' },
        { id: 'cmmc_pe_monitoring', title: 'Physical Access Monitoring', common: true, hint: 'Monitor physical access', description: 'Provide evidence of physical access monitoring for CUI facilities. Include camera coverage, badge system, or guard procedures.', evidenceType: 'point-in-time', expectedFormat: 'PDF or Screenshot', controlRef: 'PE.L2-3.10.2', commonIssue: 'Monitoring should be continuous for CUI areas.', frequency: 'annual' },
        { id: 'cmmc_pe_visitors', title: 'Visitor Management', common: true, hint: 'Control visitor access', description: 'Provide documentation of visitor control procedures for CUI areas. Include sign-in, escort, and badge requirements.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'PE.L2-3.10.3', commonIssue: 'Visitors must be logged, escorted, and badged differently.', frequency: 'annual' },
        { id: 'cmmc_pe_logs', title: 'Physical Access Logs', common: true, hint: 'Maintain access logs', description: 'Provide physical access logs for CUI facilities from {{auditPeriod}}. Include badge swipe logs or sign-in sheets.', evidenceType: 'period-of-time', expectedFormat: 'Excel or PDF', controlRef: 'PE.L2-3.10.4', commonIssue: ' Logs should be retained for required period.', frequency: 'quarterly' },
        { id: 'cmmc_pe_devices', title: 'Physical Access Device Control', common: false, hint: 'Control keys, badges, cards', description: 'Provide documentation of controls over physical access devices (keys, badges, access cards) for CUI facilities.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'PE.L2-3.10.5', commonIssue: 'Lost badges should be deactivated immediately.', frequency: 'annual' },
        { id: 'cmmc_pe_alternate', title: 'Alternate Work Site Controls', common: true, hint: 'Controls for remote work with CUI', description: 'Provide documentation of security controls for alternate work sites (telework) where CUI is accessed. Include home office security requirements.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'PE.L2-3.10.6', commonIssue: 'Remote locations must have appropriate security controls.', frequency: 'annual' }
      ]
    },
    {
      id: 'cmmc_personnel_security',
      title: 'PS - Personnel Security',
      description: '2 practices for personnel screening and handling',
      items: [
        { id: 'cmmc_ps_screening', title: 'Personnel Screening', common: true, hint: 'Background screening for CUI access', description: 'Provide documentation of personnel screening procedures for individuals with CUI access. Include background check policy and sample completion evidence.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'PS.L2-3.9.1', commonIssue: 'Screening must be completed before granting CUI access.', frequency: 'annual' },
        { id: 'cmmc_ps_actions', title: 'Personnel Actions', common: true, hint: 'CUI protection during personnel changes', description: 'Provide documentation showing how CUI is protected during personnel actions (terminations, transfers). Include evidence of timely access revocation from {{auditPeriod}}.', evidenceType: 'period-of-time', expectedFormat: 'PDF or Excel', controlRef: 'PS.L2-3.9.2', commonIssue: ' Access must be revoked same day as departure.', frequency: 'quarterly' }
      ]
    },
    {
      id: 'cmmc_risk_assessment',
      title: 'RA - Risk Assessment',
      description: '3 practices for risk assessment and vulnerability management',
      items: [
        { id: 'cmmc_ra_assessment', title: 'Risk Assessment', common: true, hint: 'Periodic risk assessment for CUI', description: 'Provide the most recent risk assessment for CUI systems. Should identify threats, vulnerabilities, and potential impacts to CUI.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'RA.L2-3.11.1', commonIssue: 'Risk assessment should specifically address CUI protection.', frequency: 'annual' },
        { id: 'cmmc_ra_vuln_scan', title: 'Vulnerability Scanning', common: true, hint: 'Regular vulnerability scans', description: 'Provide vulnerability scan reports for CUI systems from {{auditPeriod}}. Include scans of both internal and external-facing systems.', evidenceType: 'period-of-time', expectedFormat: 'PDF', controlRef: 'RA.L2-3.11.2', commonIssue: ' Scans should be performed at least quarterly.', frequency: 'quarterly' },
        { id: 'cmmc_ra_vuln_remediation', title: 'Vulnerability Remediation', common: true, hint: 'Fix identified vulnerabilities', description: 'Provide evidence of vulnerability remediation for CUI systems from {{auditPeriod}}. Include remediation timelines and closure evidence.', evidenceType: 'period-of-time', expectedFormat: 'Excel or PDF', controlRef: 'RA.L2-3.11.3', commonIssue: ' Critical vulnerabilities must be remediated within defined timeframes.', frequency: 'quarterly' }
      ]
    },
    {
      id: 'cmmc_system_integrity',
      title: 'SI - System & Information Integrity',
      description: '7 practices for maintaining system and information integrity',
      items: [
        { id: 'cmmc_si_flaw_remediation', title: 'Flaw Remediation', common: true, hint: 'Patch management', description: 'Provide evidence of flaw remediation (patching) for CUI systems from {{auditPeriod}}. Include patch status reports and remediation timelines.', evidenceType: 'period-of-time', expectedFormat: 'PDF or Excel', controlRef: 'SI.L2-3.14.1', commonIssue: ' Critical patches must be applied within defined timeframes.', frequency: 'monthly' },
        { id: 'cmmc_si_malicious_code', title: 'Malicious Code Protection', common: true, hint: 'Antivirus/anti-malware', description: 'Provide evidence of malicious code protection for CUI systems. Include antivirus/EDR deployment and current signature status.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot', controlRef: 'SI.L2-3.14.2', commonIssue: 'All CUI endpoints must have current malware protection.', frequency: 'annual' },
        { id: 'cmmc_si_alerts', title: 'Security Alerts', common: true, hint: 'Monitor security advisories', description: 'Provide evidence that security alerts, advisories, and directives are received and acted upon. Include subscription evidence and response actions.', evidenceType: 'period-of-time', expectedFormat: 'PDF', controlRef: 'SI.L2-3.14.3', commonIssue: ' Should subscribe to relevant security advisory sources.', frequency: 'quarterly' },
        { id: 'cmmc_si_updates', title: 'Malware Protection Updates', common: true, hint: 'Keep malware protection current', description: 'Provide evidence that malicious code protection mechanisms are updated promptly. Include update logs or configuration showing automatic updates.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot', controlRef: 'SI.L2-3.14.4', commonIssue: 'Signatures should update automatically at least daily.', frequency: 'annual' },
        { id: 'cmmc_si_spam', title: 'Spam Protection', common: false, hint: 'Email spam filtering', description: 'Provide evidence of spam protection for CUI system email. Include spam filter configuration and effectiveness metrics.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot or PDF', controlRef: 'SI.L2-3.14.5', commonIssue: 'Email to CUI users should be filtered for spam/phishing.', frequency: 'annual' },
        { id: 'cmmc_si_monitoring', title: 'System Monitoring', common: true, hint: 'Monitor for attacks', description: 'Provide evidence of system monitoring for CUI systems. Include IDS/IPS configuration, SIEM alerts, or security monitoring dashboards.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot or PDF', controlRef: 'SI.L2-3.14.6', commonIssue: 'CUI systems must be monitored for attacks and anomalies.', frequency: 'annual' },
        { id: 'cmmc_si_inbound_outbound', title: 'Communications Monitoring', common: true, hint: 'Monitor network communications', description: 'Provide evidence of monitoring for unauthorized connections and communications to/from CUI systems.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot or PDF', controlRef: 'SI.L2-3.14.7', commonIssue: 'Network traffic to CUI systems should be monitored.', frequency: 'annual' }
      ]
    },    {
      id: 'cmmc_system_comms',
      title: 'SC - System & Communications Protection',
      description: '16 practices for system and communications security',
      items: [
        { id: 'cmmc_boundary', title: 'Boundary Protection', common: true, hint: 'Network boundary controls', description: 'Provide documentation of boundary protection for the CUI enclave including firewall and monitoring.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot or PDF', controlRef: 'SC.L2-3.13.1', commonIssue: 'Must clearly protect CUI boundary.', frequency: 'annual' },
        { id: 'cmmc_fips', title: 'FIPS-Validated Encryption', common: true, hint: 'FIPS 140-2 cryptography', description: 'Provide evidence that FIPS 140-2 validated cryptographic modules are used to protect CUI.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'SC.L2-3.13.11', commonIssue: 'Non-FIPS encryption is not acceptable for CUI.', frequency: 'annual' },
        { id: 'cmmc_transit_encryption', title: 'CUI Transmission Encryption', common: true, hint: 'Encryption in transit', description: 'Provide evidence that CUI is encrypted during transmission using FIPS-validated cryptography.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot or PDF', controlRef: 'SC.L2-3.13.8', commonIssue: 'Must use FIPS encryption for CUI transmission.', frequency: 'annual' },
        { id: 'cmmc_sc_subnets', title: 'Subnetwork Separation', common: true, hint: 'Separate publicly accessible components', description: 'Provide evidence of subnetwork separation for publicly accessible system components from internal CUI systems.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'SC.L2-3.13.2', commonIssue: 'Public-facing systems must be in a DMZ, separate from CUI.', frequency: 'annual' },
        { id: 'cmmc_sc_engineering', title: 'Security Engineering Principles', common: false, hint: 'Apply security engineering', description: 'Provide documentation showing security engineering principles are applied in system design. Include security architecture documentation.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'SC.L2-3.13.3', commonIssue: 'Security should be designed in, not bolted on.', frequency: 'annual' },
        { id: 'cmmc_sc_function_separation', title: 'Function Separation', common: true, hint: 'Separate user and system functions', description: 'Provide evidence that user functionality is separated from system management functionality in CUI systems.', evidenceType: 'point-in-time', expectedFormat: 'PDF or Screenshot', controlRef: 'SC.L2-3.13.4', commonIssue: 'Admin consoles should be separate from user interfaces.', frequency: 'annual' },
        { id: 'cmmc_sc_dos', title: 'Denial of Service Protection', common: true, hint: 'DoS/DDoS protection', description: 'Provide evidence of denial of service protection for CUI systems. Include DDoS mitigation, rate limiting, or CDN protection.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot or PDF', controlRef: 'SC.L2-3.13.6', commonIssue: 'External-facing CUI systems need DoS protection.', frequency: 'annual' },
        { id: 'cmmc_sc_remote_device', title: 'Remote Device Protection', common: true, hint: 'Protect CUI on mobile devices', description: 'Provide evidence of cryptographic protection for CUI on organizational devices used remotely.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot or PDF', controlRef: 'SC.L2-3.13.7', commonIssue: 'Full disk encryption required for devices with CUI.', frequency: 'annual' },
        { id: 'cmmc_sc_mobile_code', title: 'Mobile Code Control', common: false, hint: 'Control mobile code execution', description: 'Provide documentation of controls over mobile code (JavaScript, ActiveX, etc.) in CUI systems. Include browser settings or application controls.', evidenceType: 'point-in-time', expectedFormat: 'PDF or Screenshot', controlRef: 'SC.L2-3.13.8', commonIssue: 'Mobile code should be controlled to prevent malicious execution.', frequency: 'annual' },
        { id: 'cmmc_sc_voip', title: 'VoIP Security', common: false, hint: 'Protect voice communications', description: 'If VoIP is used for CUI communications, provide evidence of security controls. Include encryption and access controls.', evidenceType: 'point-in-time', expectedFormat: 'PDF or Screenshot', controlRef: 'SC.L2-3.13.9', commonIssue: 'VoIP carrying CUI must be encrypted.', frequency: 'annual' },
        { id: 'cmmc_sc_key_mgmt', title: 'Cryptographic Key Management', common: true, hint: 'Manage encryption keys', description: 'Provide documentation of cryptographic key management for CUI systems. Include key generation, distribution, storage, and destruction procedures.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'SC.L2-3.13.10', commonIssue: 'Key management must cover entire lifecycle.', frequency: 'annual' },
        { id: 'cmmc_sc_crypto_use', title: 'Cryptography Employment', common: true, hint: 'Use of cryptography for CUI', description: 'Provide evidence of cryptographic protections employed for CUI at rest and in transit. Include encryption configurations and FIPS validation.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot or PDF', controlRef: 'SC.L2-3.13.11', commonIssue: 'Must use FIPS 140-2 validated cryptography.', frequency: 'annual' },
        { id: 'cmmc_sc_collaborative', title: 'Collaborative Computing', common: false, hint: 'Control collaborative tools', description: 'Provide documentation of controls over collaborative computing devices (video conferencing, screen sharing) used with CUI.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'SC.L2-3.13.12', commonIssue: 'Collaborative tools must be approved for CUI use.', frequency: 'annual' },
        { id: 'cmmc_sc_authenticity', title: 'Data Authenticity', common: false, hint: 'Protect data integrity', description: 'Provide evidence of mechanisms to protect the authenticity of CUI communications. Include digital signatures or hashing.', evidenceType: 'point-in-time', expectedFormat: 'PDF or Screenshot', controlRef: 'SC.L2-3.13.14', commonIssue: 'CUI communications should have integrity protection.', frequency: 'annual' },
        { id: 'cmmc_sc_sessions', title: 'Session Authenticity', common: false, hint: 'Protect session authenticity', description: 'Provide evidence of session authenticity protection for CUI system communications.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot', controlRef: 'SC.L2-3.13.15', commonIssue: 'Session tokens should be protected against hijacking.', frequency: 'annual' }
      ]
    },
    {
      id: 'cmmc_media',
      title: 'MP - Media Protection',
      description: '9 practices for protecting media containing CUI',
      items: [
        { id: 'cmmc_media_policy', title: 'Media Protection Policy', common: true, hint: 'Policy for CUI media', description: 'Provide Media Protection Policy covering marking, handling, transport, and destruction of CUI media.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'MP.L2-3.8.1', commonIssue: 'Must address both digital and physical media.', frequency: 'annual' },
        { id: 'cmmc_media_marking', title: 'Media Marking', common: true, hint: 'How CUI media is marked', description: 'Provide evidence of how CUI media is marked per DoD requirements.', evidenceType: 'point-in-time', expectedFormat: 'PDF or Screenshot', controlRef: 'MP.L2-3.8.4', commonIssue: 'CUI must be marked per DoD requirements.', frequency: 'annual' },
        { id: 'cmmc_sanitization', title: 'Media Sanitization', common: true, hint: 'Media disposal procedures', description: 'Provide media sanitization procedures and evidence from {{auditPeriod}}.', evidenceType: 'period-of-time', expectedFormat: 'PDF', controlRef: 'MP.L2-3.8.3', commonIssue: ' Must meet NIST SP 800-88 guidelines.', frequency: 'annual' }
      ]
    },
    {
      id: 'cmmc_security_assessment',
      title: 'CA - Security Assessment',
      description: '4 practices for assessing security controls',
      items: [
        { id: 'cmmc_control_assessment', title: 'Security Control Assessment', common: true, hint: 'Periodic assessment', description: 'Provide evidence of security control assessments during {{auditPeriod}}.', evidenceType: 'period-of-time', expectedFormat: 'PDF', controlRef: 'CA.L2-3.12.1', commonIssue: ' Assessment should be conducted annually.', frequency: 'annual' },
        { id: 'cmmc_vuln_assessment', title: 'Vulnerability Assessments', common: true, hint: 'Vulnerability scanning', description: 'Provide vulnerability assessment reports for CUI systems from {{auditPeriod}}.', evidenceType: 'period-of-time', expectedFormat: 'PDF', controlRef: 'CA.L2-3.12.3', commonIssue: ' Scanning should be performed regularly.', frequency: 'quarterly' }
      ]
    }
  ]
},
HIPAA: {
  label: 'HIPAA',
  description: 'Health Insurance Portability and Accountability Act - Security Rule',
  defaultOn: false,
  controlGroups: [
    {
      id: 'hipaa_administrative',
      title: 'Administrative Safeguards',
      description: 'Security management, workforce security, and contingency planning',
      items: [
        { id: 'hipaa_risk_analysis', title: 'Security Risk Analysis', common: true, hint: 'HIPAA risk assessment', description: 'Provide risk analysis covering ePHI as required by HIPAA. Include identified risks, ratings, and treatment decisions.', evidenceType: 'period-of-time', expectedFormat: 'PDF or Excel', controlRef: '&sect;164.308(a)(1)(ii)(A)', commonIssue: ' Must specifically address ePHI risks. Generic IT assessments are insufficient.', frequency: 'annual' },
        { id: 'hipaa_risk_management', title: 'Risk Management Plan', common: true, hint: 'Managing identified risks', description: 'Provide documentation showing how identified ePHI risks are managed.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: '&sect;164.308(a)(1)(ii)(B)', commonIssue: ' Should show how each risk is addressed.', frequency: 'annual' },
        { id: 'hipaa_sanction_policy', title: 'Sanction Policy', common: true, hint: 'Consequences for violations', description: 'Provide the Sanction Policy defining consequences for security policy violations.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: '&sect;164.308(a)(1)(ii)(C)', commonIssue: 'Must be documented and communicated.', frequency: 'annual' },
        { id: 'hipaa_activity_review', title: 'Information System Activity Review', common: true, hint: 'Review of audit logs', description: 'Provide evidence of regular system activity review during {{auditPeriod}} for systems containing ePHI.', evidenceType: 'period-of-time', expectedFormat: 'PDF', controlRef: '&sect;164.308(a)(1)(ii)(D)', commonIssue: ' Should show regular, documented review.', frequency: 'quarterly' },
        { id: 'hipaa_security_officer', title: 'Security Officer Designation', common: true, hint: 'Assigned security responsibility', description: 'Provide documentation showing a Security Officer has been designated for HIPAA compliance.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: '&sect;164.308(a)(2)', commonIssue: ' Must be a specific, named individual.', frequency: 'annual' },
        { id: 'hipaa_workforce_authorization', title: 'Workforce Authorization', common: true, hint: 'How ePHI access is authorized', description: 'Provide documentation of workforce authorization procedures for ePHI access.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: '&sect;164.308(a)(3)', commonIssue: 'Access should be based on job functions.', frequency: 'annual' },
        { id: 'hipaa_termination', title: 'Termination Procedures', common: true, hint: 'Access removal upon termination', description: 'Provide termination procedures and sample termination cases from {{auditPeriod}}.', evidenceType: 'period-of-time', expectedFormat: 'PDF', controlRef: '&sect;164.308(a)(3)(ii)(C)', commonIssue: ' Access must be removed timely.', frequency: 'quarterly' },
        { id: 'hipaa_training', title: 'Security Awareness Training', common: true, hint: 'HIPAA training', description: 'Provide training program documentation and completion records from {{auditPeriod}}.', evidenceType: 'period-of-time', expectedFormat: 'PDF or Excel', controlRef: '&sect;164.308(a)(5)', commonIssue: ' Training must address HIPAA requirements.', frequency: 'annual' },
        { id: 'hipaa_malware', title: 'Protection from Malicious Software', common: true, hint: 'Anti-malware controls', description: 'Provide evidence of malware protection on systems containing ePHI.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot or PDF', controlRef: '&sect;164.308(a)(5)(ii)(B)', commonIssue: ' All ePHI systems should have current protection.', frequency: 'quarterly' },
        { id: 'hipaa_login_monitoring', title: 'Log-in Monitoring', common: true, hint: 'Monitoring of logins', description: 'Provide evidence of login monitoring for ePHI systems.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot or PDF', controlRef: '&sect;164.308(a)(5)(ii)(C)', commonIssue: 'Should detect failed login attempts.', frequency: 'annual' },
        { id: 'hipaa_password', title: 'Password Management', common: true, hint: 'Password procedures', description: 'Provide password management procedures and configuration for ePHI systems.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot or PDF', controlRef: '&sect;164.308(a)(5)(ii)(D)', commonIssue: 'Should include complexity and expiration.', frequency: 'annual' },
        { id: 'hipaa_incident', title: 'Security Incident Procedures', common: true, hint: 'Incident handling', description: 'Provide Security Incident Response Procedures covering incidents involving ePHI.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: '&sect;164.308(a)(6)', commonIssue: 'Must address breach notification.', frequency: 'annual' },
        { id: 'hipaa_incident_log', title: 'Security Incident Log', common: true, hint: 'Log of incidents', description: 'Provide security incident log from {{auditPeriod}}. If none, provide attestation.', evidenceType: 'period-of-time', expectedFormat: 'Excel or PDF', controlRef: '&sect;164.308(a)(6)(ii)', commonIssue: ' All incidents must be documented.', frequency: 'quarterly' },
        { id: 'hipaa_contingency', title: 'Contingency Plan', common: true, hint: 'Emergency operations plan', description: 'Provide the Contingency Plan covering data backup, disaster recovery, and emergency operations for ePHI.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: '&sect;164.308(a)(7)', commonIssue: ' Must address ePHI availability in emergencies.', frequency: 'annual' },
        { id: 'hipaa_backup', title: 'Data Backup Plan', common: true, hint: 'Backup procedures', description: 'Provide data backup plan and evidence of backup completion from {{auditPeriod}}.', evidenceType: 'period-of-time', expectedFormat: 'PDF or Screenshot', controlRef: '&sect;164.308(a)(7)(ii)(A)', commonIssue: ' Backups must be retrievable exact copies.', frequency: 'quarterly' },
        { id: 'hipaa_dr', title: 'Disaster Recovery Plan', common: true, hint: 'Recovery procedures', description: 'Provide the Disaster Recovery Plan for ePHI systems.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: '&sect;164.308(a)(7)(ii)(B)', commonIssue: ' Should include specific procedures.', frequency: 'annual' },
        { id: 'hipaa_contingency_testing', title: 'Contingency Plan Testing', common: true, hint: 'Testing of backup/recovery', description: 'Provide evidence of contingency plan testing during {{auditPeriod}}.', evidenceType: 'period-of-time', expectedFormat: 'PDF', controlRef: '&sect;164.308(a)(7)(ii)(D)', commonIssue: ' Testing should verify plans work.', frequency: 'annual' },
        { id: 'hipaa_evaluation', title: 'Periodic Evaluation', common: true, hint: 'Periodic evaluation', description: 'Provide evidence of periodic evaluation during {{auditPeriod}} assessing HIPAA compliance.', evidenceType: 'period-of-time', expectedFormat: 'PDF', controlRef: '&sect;164.308(a)(8)', commonIssue: ' Should be performed after changes.', frequency: 'annual' },
        { id: 'hipaa_baa_inventory', title: 'Business Associate Inventory', common: true, hint: 'List of BAs', description: 'Provide inventory of Business Associates with ePHI access including BAA status.', evidenceType: 'point-in-time', expectedFormat: 'Excel', controlRef: '&sect;164.308(b)', commonIssue: ' Must have BAA with all entities accessing ePHI.', frequency: 'annual' },
        { id: 'hipaa_baa_samples', title: 'Business Associate Agreement Samples', common: true, hint: 'Sample BAAs', description: 'Provide sample Business Associate Agreements showing required provisions.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: '&sect;164.308(b)(4)', commonIssue: 'BAAs must contain all required provisions.', frequency: 'annual' },
        { id: 'hipaa_workforce_security_policy', title: 'Workforce Security Policy', common: true, hint: 'Policies for workforce access to ePHI', description: 'Provide workforce security policies ensuring appropriate access to ePHI based on role. Include access authorization and supervision procedures.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: '164.308(a)(3)', commonIssue: 'Policy should define access levels based on job functions.', frequency: 'annual' },
        { id: 'hipaa_workforce_clearance', title: 'Workforce Clearance Procedures', common: true, hint: 'Verify workforce member clearance', description: 'Provide procedures for determining workforce members have appropriate access to ePHI. Include authorization documentation from {{auditPeriod}}.', evidenceType: 'period-of-time', expectedFormat: 'PDF', controlRef: '164.308(a)(3)(ii)(B)', commonIssue: ' Clearance should be verified before access is granted.', frequency: 'quarterly' },
        { id: 'hipaa_access_establishment', title: 'Access Establishment & Modification', common: true, hint: 'Procedures for granting and modifying ePHI access', description: 'Provide procedures for establishing and modifying ePHI access. Include access request and modification samples from {{auditPeriod}}.', evidenceType: 'period-of-time', expectedFormat: 'PDF or Excel', controlRef: '164.308(a)(4)(ii)(C)', commonIssue: ' All access changes should be documented and approved.', frequency: 'quarterly' },
        { id: 'hipaa_security_awareness_program', title: 'Security Awareness Program', common: true, hint: 'Comprehensive security training program', description: 'Provide documentation of the security awareness and training program. Include program description, topics covered, and delivery methods.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: '164.308(a)(5)', commonIssue: 'Program must address all HIPAA security requirements.', frequency: 'annual' },
        { id: 'hipaa_security_reminders', title: 'Security Reminders', common: true, hint: 'Periodic security reminders', description: 'Provide evidence of periodic security reminders provided to workforce during {{auditPeriod}}. Include email communications, newsletters, or awareness messages.', evidenceType: 'period-of-time', expectedFormat: 'PDF', controlRef: '164.308(a)(5)(ii)(A)', commonIssue: ' Reminders should be sent regularly, not just annually.', frequency: 'quarterly' },
        { id: 'hipaa_login_monitoring_policy', title: 'Log-in Monitoring Policy', common: true, hint: 'Procedures for monitoring login activity', description: 'Provide policy and procedures for monitoring login attempts to systems containing ePHI. Include review process and escalation procedures.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: '164.308(a)(5)(ii)(C)', commonIssue: 'Must include both successful and failed login monitoring.', frequency: 'annual' },
        { id: 'hipaa_password_management_proc', title: 'Password Management Procedures', common: true, hint: 'Password creation and management rules', description: 'Provide password management procedures for systems containing ePHI. Include complexity requirements, change intervals, and reset procedures.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: '164.308(a)(5)(ii)(D)', commonIssue: 'Procedures should address strong passwords and secure distribution.', frequency: 'annual' },
        { id: 'hipaa_security_incident_proc', title: 'Security Incident Procedures Policy', common: true, hint: 'Incident response procedures', description: 'Provide security incident procedures for identifying, responding to, and documenting security incidents involving ePHI.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: '164.308(a)(6)', commonIssue: 'Must include breach notification triggers and timeline.', frequency: 'annual' },
        { id: 'hipaa_response_reporting', title: 'Response and Reporting', common: true, hint: 'Incident response and reporting', description: 'Provide evidence of incident response and reporting activities from {{auditPeriod}}. Include incident reports and resolution documentation.', evidenceType: 'period-of-time', expectedFormat: 'PDF or Excel', controlRef: '164.308(a)(6)(ii)', commonIssue: ' All incidents should be documented, even minor ones.', frequency: 'quarterly' },
        { id: 'hipaa_contingency_procedures', title: 'Contingency Procedures', common: true, hint: 'Emergency mode operations', description: 'Provide procedures for operating in emergency mode to protect ePHI during emergencies. Include manual backup procedures.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: '164.308(a)(7)(ii)(C)', commonIssue: 'Should address both natural disasters and system failures.', frequency: 'annual' },
        { id: 'hipaa_applications_criticality', title: 'Applications & Data Criticality', common: true, hint: 'Critical application assessment', description: 'Provide assessment of applications and data containing ePHI with criticality ratings. Include business impact analysis.', evidenceType: 'point-in-time', expectedFormat: 'Excel', controlRef: '164.308(a)(7)(ii)(E)', commonIssue: 'Criticality should drive backup and recovery priorities.', frequency: 'annual' },
        { id: 'hipaa_testing_revision', title: 'Testing and Revision Procedures', common: true, hint: 'Contingency plan testing', description: 'Provide evidence of contingency plan testing and revision from {{auditPeriod}}. Include test results and plan updates.', evidenceType: 'period-of-time', expectedFormat: 'PDF', controlRef: '164.308(a)(7)(ii)(D)', commonIssue: ' Plans should be tested at least annually.', frequency: 'annual' },
        { id: 'hipaa_periodic_evaluation', title: 'Periodic Technical Evaluation', common: true, hint: 'Periodic security evaluation', description: 'Provide evidence of periodic technical and non-technical evaluation of security controls. Include evaluation reports from {{auditPeriod}}.', evidenceType: 'period-of-time', expectedFormat: 'PDF', controlRef: '164.308(a)(8)', commonIssue: ' Evaluation should occur after any significant change.', frequency: 'annual' },
        { id: 'hipaa_baa_policy', title: 'BAA Policy & Procedures', common: true, hint: 'Business Associate Agreement policy', description: 'Provide policy and procedures for managing Business Associate Agreements. Include BAA requirements and review process.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: '164.308(b)(1)', commonIssue: 'Policy should define when BAAs are required.', frequency: 'annual' },
        { id: 'hipaa_baa_requirements', title: 'BAA Required Provisions', common: true, hint: 'BAA template with required provisions', description: 'Provide BAA template showing required provisions per HIPAA. Include sample executed BAA demonstrating compliance.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: '164.314(a)(2)', commonIssue: 'BAA must include all HIPAA-required provisions.', frequency: 'annual' },
        { id: 'hipaa_subcontractor_baa', title: 'Subcontractor BAA Documentation', common: true, hint: 'BAAs with subcontractors', description: 'Provide listing of subcontractors with access to ePHI and their BAAs. Include evidence BAAs are in place.', evidenceType: 'point-in-time', expectedFormat: 'Excel', controlRef: '164.314(a)(2)(i)(B)', commonIssue: 'All subcontractors with ePHI access need BAAs.', frequency: 'annual' },
        { id: 'hipaa_risk_analysis_report', title: 'Risk Analysis Report', common: true, hint: 'Comprehensive ePHI risk analysis', description: 'Provide comprehensive risk analysis identifying all ePHI, threats, vulnerabilities, and risk levels. Include methodology and findings.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: '164.308(a)(1)(ii)(A)', commonIssue: 'Must be comprehensive and address all ePHI locations.', frequency: 'annual' },
        { id: 'hipaa_risk_management_plan', title: 'Risk Management Plan', common: true, hint: 'Plan to address identified risks', description: 'Provide risk management plan showing how identified risks are being addressed. Include remediation actions, owners, and timelines.', evidenceType: 'point-in-time', expectedFormat: 'Excel or PDF', controlRef: '164.308(a)(1)(ii)(B)', commonIssue: 'All identified risks should have remediation plans.', frequency: 'annual' },
        { id: 'hipaa_workforce_sanctions', title: 'Workforce Sanctions', common: true, hint: 'Sanction policy and application', description: 'Provide sanction policy for workforce members who violate security policies. Include evidence of policy communication and any sanctions applied.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: '164.308(a)(1)(ii)(C)', commonIssue: 'Sanctions must be applied consistently.', frequency: 'annual' },
        { id: 'hipaa_ba_compliance_review', title: 'BA Compliance Review', common: true, hint: 'Review BA compliance', description: 'Provide evidence of periodic review of Business Associate compliance with security requirements.', evidenceType: 'period-of-time', expectedFormat: 'PDF or Excel', controlRef: '164.314(a)(2)', commonIssue: ' BAs should be reviewed at least annually.', frequency: 'annual' }
      ]
    },
    {
      id: 'hipaa_physical',
      title: 'Physical Safeguards',
      description: 'Physical access controls and device security',
      items: [
        { id: 'hipaa_facility', title: 'Facility Access Controls', common: true, hint: 'Physical access to ePHI locations', description: 'Provide documentation of facility access controls for ePHI locations.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: '&sect;164.310(a)', commonIssue: 'May rely on cloud provider. Document responsibility.', frequency: 'annual' },
        { id: 'hipaa_workstation_use', title: 'Workstation Use Policy', common: true, hint: 'Workstation security policies', description: 'Provide Workstation Use Policy for workstations accessing ePHI.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: '&sect;164.310(b)', commonIssue: 'Should address physical and logical security.', frequency: 'annual' },
        { id: 'hipaa_workstation_security', title: 'Workstation Security', common: true, hint: 'Workstation controls', description: 'Provide evidence of workstation security measures including encryption and screen locks.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot or PDF', controlRef: '&sect;164.310(c)', commonIssue: 'All workstations with ePHI access should be secured.', frequency: 'annual' },
        { id: 'hipaa_device_media', title: 'Device and Media Controls', common: true, hint: 'Hardware and media policies', description: 'Provide documentation of controls over devices and media containing ePHI.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: '&sect;164.310(d)', commonIssue: 'Must address entire lifecycle.', frequency: 'annual' },
        { id: 'hipaa_contingency_operations', title: 'Contingency Operations Access', common: false, hint: 'Physical access during contingency', description: 'Provide procedures for physical access to ePHI facilities during contingency operations.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: '164.310(a)(2)(i)', commonIssue: 'Must address emergency access to critical systems.', frequency: 'annual' },
        { id: 'hipaa_facility_security_plan', title: 'Facility Security Plan', common: true, hint: 'Physical security plan', description: 'Provide facility security plan documenting physical safeguards for facilities containing ePHI.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: '164.310(a)(2)(ii)', commonIssue: 'Plan should address all physical access points.', frequency: 'annual' },
        { id: 'hipaa_access_control_validation', title: 'Access Control & Validation', common: true, hint: 'Physical access control procedures', description: 'Provide procedures for controlling and validating physical access to ePHI systems. Include visitor management and access verification.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: '164.310(a)(2)(iii)', commonIssue: 'Must validate access rights before granting entry.', frequency: 'annual' },
        { id: 'hipaa_maintenance_records', title: 'Maintenance Records', common: true, hint: 'Facility maintenance records', description: 'Provide documentation of repairs and modifications to physical security of ePHI facilities from {{auditPeriod}}.', evidenceType: 'period-of-time', expectedFormat: 'PDF or Excel', controlRef: '164.310(a)(2)(iv)', commonIssue: ' All modifications should be documented.', frequency: 'annual' },
        { id: 'hipaa_workstation_function', title: 'Workstation Function & Location', common: true, hint: 'Workstation security policies', description: 'Provide policies specifying proper functions and physical attributes of workstations accessing ePHI.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: '164.310(b)', commonIssue: 'Should address screen positioning and access restrictions.', frequency: 'annual' },
        { id: 'hipaa_device_disposal', title: 'Device & Media Disposal', common: true, hint: 'ePHI media disposal procedures', description: 'Provide procedures and evidence for disposal of devices and media containing ePHI. Include disposal certificates from {{auditPeriod}}.', evidenceType: 'period-of-time', expectedFormat: 'PDF', controlRef: '164.310(d)(2)(i)', commonIssue: ' All disposed media must be sanitized or destroyed.', frequency: 'annual' },
        { id: 'hipaa_media_reuse', title: 'Media Re-use', common: true, hint: 'Procedures for reusing media', description: 'Provide procedures for removing ePHI from media before re-use. Include sanitization verification.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: '164.310(d)(2)(ii)', commonIssue: 'Media must be completely sanitized before re-use.', frequency: 'annual' },
        { id: 'hipaa_accountability', title: 'Media Accountability', common: false, hint: 'Track media containing ePHI', description: 'Provide records tracking movements of hardware and electronic media containing ePHI.', evidenceType: 'period-of-time', expectedFormat: 'Excel', controlRef: '164.310(d)(2)(iii)', commonIssue: ' All ePHI media should be inventoried and tracked.', frequency: 'quarterly' }
      ]
    },
    {
      id: 'hipaa_technical',
      title: 'Technical Safeguards',
      description: 'Access control, audit controls, integrity, and transmission security',
      items: [
        { id: 'hipaa_access_control', title: 'Access Control Configuration', common: true, hint: 'Technical access controls', description: 'Provide evidence of access control configuration for ePHI systems.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot', controlRef: '&sect;164.312(a)(1)', commonIssue: 'Must ensure only authorized access.', frequency: 'annual' },
        { id: 'hipaa_unique_user', title: 'Unique User Identification', common: true, hint: 'Unique identification', description: 'Provide evidence that all users accessing ePHI are uniquely identified (no shared accounts).', evidenceType: 'point-in-time', expectedFormat: 'Screenshot', controlRef: '&sect;164.312(a)(2)(i)', commonIssue: 'Shared accounts are not permitted.', frequency: 'annual' },
        { id: 'hipaa_automatic_logoff', title: 'Automatic Logoff', common: true, hint: 'Session timeout', description: 'Provide evidence of automatic logoff configuration for ePHI systems.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot', controlRef: '&sect;164.312(a)(2)(iii)', commonIssue: 'Timeout should be appropriate for environment.', frequency: 'annual' },
        { id: 'hipaa_encryption_rest', title: 'Encryption at Rest', common: true, hint: 'ePHI encryption at rest', description: 'Provide evidence of encryption for ePHI at rest.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot', controlRef: '&sect;164.312(a)(2)(iv)', commonIssue: 'Must cover all ePHI storage locations.', frequency: 'annual' },
        { id: 'hipaa_audit_controls', title: 'Audit Controls', common: true, hint: 'Audit logging', description: 'Provide evidence of audit controls for ePHI systems including configuration and samples.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot or PDF', controlRef: '&sect;164.312(b)', commonIssue: 'Must log ePHI access.', frequency: 'annual' },
        { id: 'hipaa_audit_samples', title: 'Audit Log Samples', common: true, hint: 'Sample audit logs', description: 'Provide sample audit logs from {{auditPeriod}} showing ePHI access logging.', evidenceType: 'period-of-time', expectedFormat: 'Screenshot or PDF', controlRef: '&sect;164.312(b)', commonIssue: ' Logs should contain sufficient detail.', frequency: 'quarterly' },
        { id: 'hipaa_integrity', title: 'Integrity Controls', common: true, hint: 'ePHI integrity controls', description: 'Provide evidence of integrity controls for ePHI to detect unauthorized alteration.', evidenceType: 'point-in-time', expectedFormat: 'PDF or Screenshot', controlRef: '&sect;164.312(c)', commonIssue: ' Should protect against alteration.', frequency: 'annual' },
        { id: 'hipaa_authentication', title: 'Person or Entity Authentication', common: true, hint: 'Identity verification', description: 'Provide evidence of authentication methods for verifying identity before ePHI access.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot or PDF', controlRef: '&sect;164.312(d)', commonIssue: 'Should include MFA where appropriate.', frequency: 'annual' },
        { id: 'hipaa_transmission', title: 'Transmission Security', common: true, hint: 'ePHI in transit', description: 'Provide evidence of transmission security controls including encryption of ePHI in transit.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot or PDF', controlRef: '&sect;164.312(e)', commonIssue: 'Must protect against unauthorized access.', frequency: 'annual' },
        { id: 'hipaa_emergency_access', title: 'Emergency Access Procedure', common: true, hint: 'Emergency access to ePHI', description: 'Provide procedures for obtaining emergency access to ePHI. Include break-glass procedures and audit trail requirements.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: '164.312(a)(2)(ii)', commonIssue: 'Emergency access must still be logged and reviewed.', frequency: 'annual' },
        { id: 'hipaa_entity_authentication', title: 'Person/Entity Authentication', common: true, hint: 'Verify identity before access', description: 'Provide documentation of procedures to verify identity of persons or entities seeking ePHI access.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: '164.312(d)', commonIssue: 'Must authenticate before granting access.', frequency: 'annual' },
        { id: 'hipaa_integrity_mechanism', title: 'ePHI Integrity Mechanism', common: true, hint: 'Protect ePHI from alteration', description: 'Provide evidence of mechanisms to authenticate ePHI and protect against improper alteration or destruction.', evidenceType: 'point-in-time', expectedFormat: 'PDF or Screenshot', controlRef: '164.312(c)(2)', commonIssue: 'Should include hash verification or digital signatures.', frequency: 'annual' },
        { id: 'hipaa_session_config', title: 'Session Timeout Configuration', common: true, hint: 'Automatic logoff settings', description: 'Provide screenshots showing automatic logoff configuration for systems containing ePHI.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot', controlRef: '164.312(a)(2)(iii)', commonIssue: 'Sessions should timeout after 15 minutes or less.', frequency: 'annual' },
        { id: 'hipaa_encryption_mechanism', title: 'Encryption Mechanism', common: true, hint: 'Encryption configuration', description: 'Provide evidence of encryption mechanisms for ePHI at rest. Include encryption configuration and key management.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot or PDF', controlRef: '164.312(a)(2)(iv)', commonIssue: 'Must use NIST-approved encryption algorithms.', frequency: 'annual' },
        { id: 'hipaa_hardware_software_records', title: 'Hardware/Software Maintenance', common: true, hint: 'System maintenance records', description: 'Provide records of maintenance to hardware and software containing ePHI from {{auditPeriod}}.', evidenceType: 'period-of-time', expectedFormat: 'Excel or PDF', controlRef: '164.312(c)(1)', commonIssue: ' Maintenance may affect ePHI integrity.', frequency: 'quarterly' },
        { id: 'hipaa_audit_log_samples', title: 'Audit Log Samples', common: true, hint: 'Sample audit logs', description: 'Provide sample audit logs from systems containing ePHI from {{auditPeriod}}. Show login, access, and modification events.', evidenceType: 'period-of-time', expectedFormat: 'PDF', controlRef: '164.312(b)', commonIssue: ' Logs should capture who accessed what ePHI.', frequency: 'quarterly' },
        { id: 'hipaa_transmission_integrity', title: 'Transmission Integrity Controls', common: true, hint: 'Protect ePHI in transit', description: 'Provide evidence of integrity controls for ePHI transmitted over networks. Include TLS configuration and secure transfer procedures.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot or PDF', controlRef: '164.312(e)(2)(i)', commonIssue: 'All ePHI transmission should be encrypted.', frequency: 'annual' }
      ]
    }
  ]
},
GDPR: {
  label: 'GDPR (Supplementary)',
  description: 'General Data Protection Regulation - Privacy Controls',
  defaultOn: false,
  controlGroups: [
    {
      id: 'gdpr_core',
      title: 'Core Requirements',
      description: 'Fundamental GDPR compliance documentation',
      items: [
        { id: 'gdpr_ropa', title: 'Record of Processing Activities (ROPA)', common: true, hint: 'Article 30 records', description: 'Provide the Record of Processing Activities as required by Article 30. Include processing purpose, data categories, recipients, transfers, and retention periods.', evidenceType: 'point-in-time', expectedFormat: 'Excel', controlRef: 'Article 30', commonIssue: 'Must include all required fields per Article 30(1).', frequency: 'annual' },
        { id: 'gdpr_privacy_notice', title: 'Privacy Notice', common: true, hint: 'Public privacy policy', description: 'Provide the current Privacy Notice/Policy informing data subjects about data processing.', evidenceType: 'point-in-time', expectedFormat: 'PDF or URL', controlRef: 'Articles 13, 14', commonIssue: 'Must be clear and include all required information.', frequency: 'annual' },
        { id: 'gdpr_lawful_basis', title: 'Lawful Basis Documentation', common: true, hint: 'Legal basis for processing', description: 'Provide documentation showing the lawful basis for each processing activity.', evidenceType: 'point-in-time', expectedFormat: 'PDF or Excel', controlRef: 'Article 6', commonIssue: 'Each processing activity must have documented lawful basis.', frequency: 'annual' },
        { id: 'gdpr_dpia', title: 'Data Protection Impact Assessments', common: false, hint: 'DPIAs for high-risk processing', description: 'Provide DPIAs for processing activities likely to result in high risk to individuals.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'Article 35', commonIssue: 'Required for high-risk processing.', frequency: 'annual' },
        { id: 'gdpr_records_processing', title: 'Records of Processing Activities', common: true, hint: 'Article 30 processing records', description: 'Provide Records of Processing Activities (ROPA) as required by GDPR Article 30. Include all processing activities involving personal data.', evidenceType: 'point-in-time', expectedFormat: 'Excel', controlRef: 'Article 30', commonIssue: 'ROPA must include all required fields per Article 30.', frequency: 'annual' },
        { id: 'gdpr_dpo_appointment', title: 'DPO Appointment Documentation', common: false, hint: 'Data Protection Officer', description: 'If required, provide documentation of Data Protection Officer appointment including contact details and independence evidence.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'Article 37', commonIssue: 'DPO must be independent and have adequate resources.', frequency: 'annual' },
        { id: 'gdpr_cross_border', title: 'Cross-Border Transfer Mechanisms', common: true, hint: 'International data transfers', description: 'Provide documentation of mechanisms used for cross-border personal data transfers (SCCs, adequacy decisions, BCRs).', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'Chapter V', commonIssue: 'All international transfers must have legal basis.', frequency: 'annual' }
      ]
    },
    {
      id: 'gdpr_rights',
      title: 'Data Subject Rights',
      description: 'Procedures for handling data subject requests',
      items: [
        { id: 'gdpr_dsar', title: 'DSAR Process', common: true, hint: 'Data subject request process', description: 'Provide documentation of the Data Subject Access Request process including intake, verification, and fulfillment.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'Articles 15-22', commonIssue: 'Must be able to respond within 30 days.', frequency: 'annual' },
        { id: 'gdpr_dsar_log', title: 'DSAR Log', common: false, hint: 'Log of data subject requests', description: 'Provide log of Data Subject Requests from {{auditPeriod}}. If none, provide attestation.', evidenceType: 'period-of-time', expectedFormat: 'Excel or PDF', controlRef: 'Articles 15-22', commonIssue: ' Response times must meet GDPR requirements.', frequency: 'quarterly' },
        { id: 'gdpr_consent', title: 'Consent Records', common: false, hint: 'Evidence of consent collection', description: 'Where consent is the lawful basis, provide evidence of consent collection mechanisms.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot or PDF', controlRef: 'Article 7', commonIssue: ' Consent must be freely given, specific, informed, and unambiguous.', frequency: 'annual' }
      ]
    },
    {
      id: 'gdpr_processors',
      title: 'Processors & Transfers',
      description: 'Third-party processors and international transfers',
      items: [
        { id: 'gdpr_processor_list', title: 'Processor Inventory', common: true, hint: 'List of data processors', description: 'Provide inventory of data processors including services provided and data accessed.', evidenceType: 'point-in-time', expectedFormat: 'Excel', controlRef: 'Article 28', commonIssue: 'Must have appropriate agreements with all processors.', frequency: 'annual' },
        { id: 'gdpr_dpa', title: 'Data Processing Agreements', common: true, hint: 'Sample DPAs', description: 'Provide sample Data Processing Agreements showing required Article 28 provisions.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'Article 28(3)', commonIssue: 'DPAs must include all Article 28(3) requirements.', frequency: 'annual' },
        { id: 'gdpr_transfers', title: 'International Transfer Mechanisms', common: false, hint: 'Legal basis for transfers', description: 'If transferring data outside the EEA, provide documentation of transfer mechanisms used.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'Articles 44-49', commonIssue: 'Must have valid transfer mechanism for each non-EEA transfer.', frequency: 'annual' }
      ]
    },
    {
      id: 'gdpr_security',
      title: 'Security & Breach Response',
      description: 'Security measures and breach notification',
      items: [
        { id: 'gdpr_security_measures', title: 'Security Measures Documentation', common: true, hint: 'Technical and organizational measures', description: 'Provide documentation of technical and organizational security measures (TOMs).', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'Article 32', commonIssue: 'Should address confidentiality, integrity, availability, and resilience.', frequency: 'annual' },
        { id: 'gdpr_breach_procedure', title: 'Breach Notification Procedure', common: true, hint: 'Breach notification process', description: 'Provide the breach notification procedure including 72-hour supervisory authority notification.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'Articles 33, 34', commonIssue: 'Must enable 72-hour notification.', frequency: 'annual' },
        { id: 'gdpr_breach_log', title: 'Breach Register', common: false, hint: 'Log of breaches', description: 'Provide the breach register from {{auditPeriod}}. If none, provide attestation.', evidenceType: 'period-of-time', expectedFormat: 'Excel or PDF', controlRef: 'Article 33(5)', commonIssue: ' Must document all breaches.', frequency: 'quarterly' }
      ]
    }
  ]
}
};
let composerState = {};
let customFrameworks = [];
let state = { 
  role: '', 
  code: '', 
  codeValid: false, 
  codeCredits: 0, 
  selectedTier: null, 
  paymentVisible: false,
  isCheckoutReturn: false,
  // Auth state
  isLoggedIn: false,
  isTrialUser: false,
  user: null,         // { id, email, credits, verified, templates }
  authToken: null,
  trialMode: 'live',  // 'live' or 'test'
  trialEmail: '',
  trialCode: ''
};

const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
const esc = s => String(s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');

// ==================== CHIP INPUT FUNCTIONS ====================

function initChipInput(containerId) {
  const container = document.getElementById(containerId);
  if (!container) return;
  
  const input = container.querySelector('.chip-text-input');
  if (!input) return;
  
  container._emails = [];
  
  container.addEventListener('click', (e) => {
    if (e.target === container) input.focus();
  });
  
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' || e.key === ',') {
      e.preventDefault();
      addChipFromInput(container, input);
    } else if (e.key === 'Backspace' && input.value === '' && container._emails.length > 0) {
      removeChip(container, container._emails.length - 1);
    }
  });
  
  input.addEventListener('blur', () => {
    if (input.value.trim()) addChipFromInput(container, input);
  });
  
  input.addEventListener('paste', (e) => {
    const pasted = (e.clipboardData || window.clipboardData).getData('text');
    if (pasted.includes(',') || pasted.includes(';') || pasted.includes(' ')) {
      e.preventDefault();
      const emails = pasted.split(/[,;\s]+/).filter(em => em.includes('@'));
      emails.forEach(email => addChip(container, email.trim()));
      input.value = '';
    }
  });
}

function addChipFromInput(container, input) {
  const email = input.value.trim().replace(/,+$/, '');
  if (addChip(container, email)) input.value = '';
}

function addChip(container, email) {
  if (!email || !email.includes('@') || !email.includes('.')) return false;
  if (container._emails.includes(email.toLowerCase())) return false;
  
  container._emails.push(email.toLowerCase());
  
  const chip = document.createElement('span');
  chip.className = 'chip';
  chip.innerHTML = esc(email) + '<button type="button" class="chip-remove" aria-label="Remove">&times;</button>';
  
  const inp = container.querySelector('.chip-text-input');
  container.insertBefore(chip, inp);
  
  chip.querySelector('.chip-remove').addEventListener('click', () => {
    const idx = container._emails.indexOf(email.toLowerCase());
    if (idx > -1) removeChip(container, idx);
  });
  
  updateChipPlaceholder(container);
  saveFormState();
  return true;
}

function removeChip(container, index) {
  if (index < 0 || index >= container._emails.length) return;
  container._emails.splice(index, 1);
  const chips = container.querySelectorAll('.chip');
  if (chips[index]) chips[index].remove();
  updateChipPlaceholder(container);
  saveFormState();
}

function updateChipPlaceholder(container) {
  const inp = container.querySelector('.chip-text-input');
  if (!inp) return;
  inp.placeholder = container._emails.length === 0 
    ? (container.dataset.placeholder || 'Add email...') 
    : 'Add another...';
}

function getChipEmails(containerId) {
  const container = document.getElementById(containerId);
  return container?._emails || [];
}

function setChipEmails(containerId, emails) {
  const container = document.getElementById(containerId);
  if (!container) return;
  container._emails = [];
  container.querySelectorAll('.chip').forEach(c => c.remove());
  (emails || []).forEach(email => addChip(container, email));
}

// ==================== LOCAL STORAGE + SERVER DRAFT SAVE ====================

let _draftSaveTimer = null;
let _lastDraftJson = '';
let _currentDraftSaving = false;

function getDraftPayload() {
  return {
    auditorEmails: getChipEmails('auditorEmailsContainer'),
    clientCompany: $('#clientCompany')?.value || '',
    clientEmails: getChipEmails('clientEmailsContainer'),
    deadlineISO: deadlinePicker?.selectedDates[0]?.toISOString() || null,
    globalInstructions: $('#globalInstructions')?.value || '',
    composerState: composerState,
    customFrameworks: customFrameworks,
    auditPeriodStart: $('#auditPeriodStart')?.value || null,
    auditPeriodEnd: $('#auditPeriodEnd')?.value || null,
    engagementRef: $('#engagementRef')?.value || '',
  };
}

function saveFormState() {
  try {
    const data = {
      role: $('#roleSelect')?.value || '',
      ...getDraftPayload(),
      appliedCode: state.code || '',
      savedAt: Date.now()
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  } catch (e) { console.warn('Could not save form state:', e); }
  // Debounce server save
  scheduleDraftServerSave();
}

function scheduleDraftServerSave() {
  if (_draftSaveTimer) clearTimeout(_draftSaveTimer);
  _draftSaveTimer = setTimeout(saveDraftToServer, 5000);
}

async function saveDraftToServer() {
  if (_currentDraftSaving) return;
  const payload = getDraftPayload();
  const snap = JSON.stringify(payload);
  if (snap === _lastDraftJson) return; // no changes

  _currentDraftSaving = true;
  showDraftIndicator('saving');

  try {
    if (state.isLoggedIn && state.authToken) {
      const res = await fetch(API + '/auth/drafts', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + state.authToken },
        body: JSON.stringify(payload),
      });
      if (res.ok) {
        _lastDraftJson = snap;
        showDraftIndicator('saved');
      }
    } else if (state.isTrialUser && state.trialCode && state.trialEmail) {
      const res = await fetch(API + '/draft/save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ...payload, email: state.trialEmail, code: state.trialCode, trialMode: state.trialMode }),
      });
      if (res.ok) {
        _lastDraftJson = snap;
        showDraftIndicator('saved');
      }
    }
  } catch (e) {
    console.warn('Draft server save failed:', e);
  }
  _currentDraftSaving = false;
}

async function loadDraftFromServer() {
  try {
    if (state.isLoggedIn && state.authToken) {
      const res = await fetch(API + '/auth/drafts', {
        headers: { 'Authorization': 'Bearer ' + state.authToken },
      });
      if (res.ok) {
        const data = await res.json();
        return data.draft || null;
      }
    } else if (state.isTrialUser && state.trialCode && state.trialEmail) {
      const res = await fetch(API + '/draft/load?code=' + encodeURIComponent(state.trialCode) + '&email=' + encodeURIComponent(state.trialEmail));
      if (res.ok) {
        const data = await res.json();
        return data.draft || null;
      }
    }
  } catch (e) {
    console.warn('Draft server load failed:', e);
  }
  return null;
}

async function deleteDraftFromServer() {
  try {
    if (state.isLoggedIn && state.authToken) {
      await fetch(API + '/auth/drafts', {
        method: 'DELETE',
        headers: { 'Authorization': 'Bearer ' + state.authToken },
      });
    }
    // Trial drafts auto-expire via TTL, no explicit delete needed
  } catch (e) {
    console.warn('Draft delete failed:', e);
  }
}

function showDraftIndicator(status) {
  const el = $('#draftIndicator');
  const inlineEl = $('#draftStatusText');
  if (status === 'saving') {
    if (el) { el.textContent = 'Saving draft...'; el.className = 'draft-indicator visible saving'; }
    if (inlineEl) inlineEl.textContent = 'Saving...';
  } else if (status === 'saved') {
    const now = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    if (el) { el.textContent = '\u2713 Draft saved'; el.className = 'draft-indicator visible'; setTimeout(() => { el.className = 'draft-indicator'; }, 2500); }
    if (inlineEl) inlineEl.textContent = '\u2713 Draft saved at ' + now;
  }
}

function restoreDraftData(draft) {
  if (!draft) return false;
  if (draft.auditorEmails?.length) setChipEmails('auditorEmailsContainer', draft.auditorEmails);
  if (draft.clientCompany) $('#clientCompany').value = draft.clientCompany;
  if (draft.clientEmails?.length) setChipEmails('clientEmailsContainer', draft.clientEmails);
  if (draft.deadlineISO) setDeadlineFromISO(draft.deadlineISO);
  if (draft.globalInstructions && $('#globalInstructions')) $('#globalInstructions').value = draft.globalInstructions;
  if (draft.engagementRef && $('#engagementRef')) $('#engagementRef').value = draft.engagementRef;
  if (draft.composerState && Object.keys(draft.composerState).length) composerState = draft.composerState;
  if (draft.customFrameworks?.length) customFrameworks = draft.customFrameworks;
  _lastDraftJson = JSON.stringify(getDraftPayload());
  return true;
}

function loadFormState() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return null;
    const data = JSON.parse(raw);
    // Extended to 14 days to match server TTL
    if (data.savedAt && (Date.now() - data.savedAt) > 14 * 24 * 60 * 60 * 1000) {
      localStorage.removeItem(STORAGE_KEY);
      return null;
    }
    return data;
  } catch (e) { return null; }
}

function restoreFormState(data) {
  if (!data) return false;
  if (data.role) $('#roleSelect').value = data.role;
  if (data.auditorEmails && data.auditorEmails.length) {
    setChipEmails('auditorEmailsContainer', data.auditorEmails);
  } else if (data.auditorEmail) {
    setChipEmails('auditorEmailsContainer', [data.auditorEmail]);
  }
  if (data.clientCompany) $('#clientCompany').value = data.clientCompany;
  if (data.clientEmails && data.clientEmails.length) {
    setChipEmails('clientEmailsContainer', data.clientEmails);
  } else if (data.clientEmail) {
    setChipEmails('clientEmailsContainer', [data.clientEmail]);
  }
  if (data.deadlineISO) {
    setDeadlineFromISO(data.deadlineISO);
  }
  if (data.appliedCode) { 
    state.code = data.appliedCode; 
    if ($('#auditorCode')) $('#auditorCode').value = data.appliedCode; 
  }
  if (data.composerState && Object.keys(data.composerState).length) composerState = data.composerState;
  if (data.customFrameworks && data.customFrameworks.length) customFrameworks = data.customFrameworks;
  return true;
}

function clearFormState() { 
  try { localStorage.removeItem(STORAGE_KEY); } catch (e) {}
  deleteDraftFromServer();
}

function setupAutoSave() {
  ['roleSelect', 'clientCompany'].forEach(id => {
    const el = $(`#${id}`);
    if (el) { 
      el.addEventListener('change', saveFormState); 
      el.addEventListener('input', saveFormState); 
    }
  });
  // Periodic server save every 60s as safety net
  setInterval(() => { if (state.isLoggedIn || state.isTrialUser) saveDraftToServer(); }, 60000);
}

// ==================== DEADLINE LOGIC (FLATPICKR CALENDAR) ====================

let deadlinePicker = null;

function initDeadlinePicker() {
  const defaultDate = new Date();
  defaultDate.setDate(defaultDate.getDate() + 5); // Default: 5 days from now
  defaultDate.setHours(17, 0, 0, 0); // Default: 5:00 PM
  
  deadlinePicker = flatpickr('#deadlinePicker', {
    enableTime: true,
    dateFormat: 'F j, Y at h:i K', // "January 30, 2026 at 5:00 PM"
    altInput: true,
    altFormat: 'F j, Y at h:i K',
    minDate: 'today',
    maxDate: new Date().fp_incr(90), // Max 90 days out
    defaultDate: defaultDate,
    time_24hr: false,
    minuteIncrement: 15,
    disableMobile: false,
    theme: 'dark',
    onReady: function(selectedDates, dateStr, instance) {
      updateDeadlineHint(selectedDates[0]);
      // Style the input to match our theme
      instance.altInput.style.backgroundColor = 'var(--surface)';
      instance.altInput.style.border = '1px solid var(--border)';
      instance.altInput.style.color = 'var(--text)';
      instance.altInput.style.borderRadius = '8px';
      instance.altInput.style.padding = '12px 14px';
      instance.altInput.style.fontSize = '14px';
      instance.altInput.style.cursor = 'pointer';
    },
    onChange: function(selectedDates, dateStr, instance) {
      updateDeadlineHint(selectedDates[0]);
      saveFormState();
    }
  });
  
  // Initialize audit period pickers
  initAuditPeriodPickers();
}

let auditPeriodStartPicker, auditPeriodEndPicker;

function initAuditPeriodPickers() {
  const commonOpts = {
    enableTime: false,
    dateFormat: 'F j, Y', // "January 1, 2025"
    altInput: true,
    altFormat: 'F j, Y',
    disableMobile: false,
    theme: 'dark',
    onReady: function(selectedDates, dateStr, instance) {
      instance.altInput.style.backgroundColor = 'var(--surface)';
      instance.altInput.style.border = '1px solid var(--border)';
      instance.altInput.style.color = 'var(--text)';
      instance.altInput.style.borderRadius = '8px';
      instance.altInput.style.padding = '12px 14px';
      instance.altInput.style.fontSize = '14px';
      instance.altInput.style.cursor = 'pointer';
    },
    onChange: function() {
      updateAuditPeriodHint();
      saveFormState();
    }
  };
  
  // Default: start of current year
  const defaultStart = new Date();
  defaultStart.setMonth(0, 1);
  defaultStart.setHours(0, 0, 0, 0);
  
  // Default: end of current year (or today if past Dec 31)
  const defaultEnd = new Date();
  defaultEnd.setMonth(11, 31);
  defaultEnd.setHours(0, 0, 0, 0);
  
  auditPeriodStartPicker = flatpickr('#auditPeriodStart', {
    ...commonOpts,
    maxDate: new Date().fp_incr(365), // Up to 1 year from now
    onChange: function(selectedDates) {
      if (selectedDates[0] && auditPeriodEndPicker) {
        auditPeriodEndPicker.set('minDate', selectedDates[0]);
      }
      updateAuditPeriodHint();
      saveFormState();
    }
  });
  
  auditPeriodEndPicker = flatpickr('#auditPeriodEnd', {
    ...commonOpts,
    maxDate: new Date().fp_incr(365),
    onChange: function(selectedDates) {
      if (selectedDates[0] && auditPeriodStartPicker) {
        auditPeriodStartPicker.set('maxDate', selectedDates[0]);
      }
      updateAuditPeriodHint();
      saveFormState();
    }
  });
}

function updateAuditPeriodHint() {
  const hint = $('#auditPeriodHint');
  if (!hint) return;
  
  const startDate = auditPeriodStartPicker?.selectedDates[0];
  const endDate = auditPeriodEndPicker?.selectedDates[0];
  
  if (startDate && endDate) {
    const months = Math.round((endDate - startDate) / (1000 * 60 * 60 * 24 * 30));
    hint.textContent = ` ${months} month audit period &mdash; date range will be included in period-based evidence requests`;
    hint.style.color = 'var(--accent)';
  } else if (startDate || endDate) {
    hint.textContent = `&#9888; Please set both start and end dates for the audit period`;
    hint.style.color = 'var(--warning)';
  } else {
    hint.textContent = '';
  }
}

function getAuditPeriodString() {
  const startDate = auditPeriodStartPicker?.selectedDates[0];
  const endDate = auditPeriodEndPicker?.selectedDates[0];
  
  if (startDate && endDate) {
    const opts = { year: 'numeric', month: 'short', day: 'numeric' };
    return `${startDate.toLocaleDateString('en-US', opts)} - ${endDate.toLocaleDateString('en-US', opts)}`;
  }
  return null;
}

function updateDeadlineHint(date) {
  const hint = $('#deadlineHint');
  if (!hint || !date) return;
  
  const now = new Date();
  const diff = date - now;
  const hours = Math.round(diff / (1000 * 60 * 60));
  const days = Math.round(diff / (1000 * 60 * 60 * 24));
  
  if (hours < 24) {
    hint.textContent = ` ${hours} hours from now`;
    hint.style.color = '#f59e0b'; // Warning orange
  } else if (days === 1) {
    hint.textContent = ` Tomorrow`;
    hint.style.color = 'var(--text-muted)';
  } else if (days < 7) {
    hint.textContent = ` ${days} days from now`;
    hint.style.color = 'var(--text-muted)';
  } else if (days < 14) {
    hint.textContent = ` About 1 week from now`;
    hint.style.color = 'var(--text-muted)';
  } else if (days < 30) {
    hint.textContent = ` ${Math.round(days / 7)} weeks from now`;
    hint.style.color = 'var(--text-muted)';
  } else {
    hint.textContent = ` About ${Math.round(days / 30)} month(s) from now`;
    hint.style.color = 'var(--text-muted)';
  }
}

function calculateDeadline() {
  if (deadlinePicker && deadlinePicker.selectedDates.length > 0) {
    return deadlinePicker.selectedDates[0];
  }
  // Fallback: 5 days from now
  const fallback = new Date();
  fallback.setDate(fallback.getDate() + 5);
  fallback.setHours(17, 0, 0, 0);
  return fallback;
}

function setDeadlineFromISO(isoString) {
  if (deadlinePicker && isoString) {
    try {
      const date = new Date(isoString);
      if (!isNaN(date.getTime())) {
        deadlinePicker.setDate(date, true);
        updateDeadlineHint(date);
      }
    } catch (e) {
      console.warn('Invalid deadline ISO:', isoString);
    }
  }
}

// ==================== FRAMEWORK HELPERS ====================

function getAllFrameworks() {
  const all = { ...FRAMEWORK_LIBRARY };
  customFrameworks.forEach(f => { all[f.id] = f; });
  return all;
}

function initComposerState() {
  composerState = {};
  const allFw = getAllFrameworks();
  for (const [fwKey, fw] of Object.entries(allFw)) {
    composerState[fwKey] = { enabled: fw.defaultOn || false, groups: {} };
    for (const g of (fw.controlGroups || [])) {
      composerState[fwKey].groups[g.id] = { expanded: false, showMore: false, excluded: false, items: {} };
      for (const item of (g.items || [])) {
        composerState[fwKey].groups[g.id].items[item.id] = { 
          included: item.common, 
          instructions: '',
          // New editable fields - null means use default from library
          editedDescription: null,
          editedFormats: null,
          guidanceCollapsed: false
        };
      }
    }
  }
}

// TEMPLATE_LEVELS - Defines which levels are available for each framework
// Only show levels that have different item counts
const TEMPLATE_LEVELS = {
  SOC2:     { levels: ['quickStart', 'standard', 'thorough'], labels: ['Quick (20)', 'Standard (36)', 'Thorough (67)'] },
  ISO27001: { levels: ['quickStart', 'standard', 'thorough'], labels: ['Quick (22)', 'Standard (38)', 'Thorough (63)'] },
  SOC1:     { levels: ['quickStart', 'standard', 'thorough'], labels: ['Quick (18)', 'Standard (32)', 'Thorough (44)'] },
  NISTCSF:  { levels: ['quickStart', 'standard', 'thorough'], labels: ['Quick (15)', 'Standard (30)', 'Thorough (50)'] },
  CMMC:     { levels: ['quickStart', 'standard', 'thorough'], labels: ['Quick (25)', 'Standard (55)', 'Thorough (119)'] },
  HIPAA:    { levels: ['quickStart', 'standard', 'thorough'], labels: ['Quick (20)', 'Standard (45)', 'Thorough (72)'] },
  GDPR:     { levels: ['quickStart', 'standard', 'thorough'], labels: ['Quick (10)', 'Standard (15)', 'Thorough (20)'] }
};

// ==================== COMPOSER RENDERING ====================

function renderComposer() {
  const c = $('#composer');
  if (!c) return;
  const allFw = getAllFrameworks();
  let html = '<div class="framework-selector">';
  for (const [fwKey, fw] of Object.entries(allFw)) {
    const on = composerState[fwKey]?.enabled;
    const tplLevels = TEMPLATE_LEVELS[fwKey] || { levels: ['standard'], labels: ['Standard'] };
    const currentLevel = composerState[fwKey]?.templateLevel || 'standard';
    let tplOptions = '';
    tplLevels.levels.forEach((lvl, i) => {
      tplOptions += `<option value="${lvl}" ${currentLevel === lvl ? 'selected' : ''}>${tplLevels.labels[i]}</option>`;
    });
    html += `<div class="framework-tag-wrapper ${on ? 'selected' : ''}">
      <label class="framework-tag ${on ? 'selected' : ''}"><input type="checkbox" ${on ? 'checked' : ''} data-fw-toggle="${esc(fwKey)}">${on ? '&#10003;' : ''} ${esc(fw.label)}</label>
      ${on ? `<select class="fw-template-select" data-fw-template="${esc(fwKey)}">${tplOptions}</select>` : ''}
    </div>`;
  }
  html += '<button type="button" class="framework-tag add-btn" id="addFwChip">+ Add framework</button></div>';
  for (const [fwKey, fw] of Object.entries(allFw)) {
    if (!composerState[fwKey]?.enabled) continue;
    html += renderFwBody(fwKey, fw);
  }
  const savedGlobalInstr = $('#globalInstructions')?.value || '';
  html += `<div class="global-instructions"><label class="form-label">Overall instructions for client</label><textarea class="form-textarea" id="globalInstructions" placeholder="Example: Please provide evidence covering Jan &ndash; Dec 2025. Screenshots acceptable. Redact any secrets or credentials.">${esc(savedGlobalInstr)}</textarea><p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 6px;">Shown prominently to your client above the checklist.</p></div>`;
  
  // Save template bar (only show when logged in or trial user who might want to save)
  html += `<div class="save-template-bar" id="saveTemplateBar">
    <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;width:100%;">
      <span style="flex:1;min-width:200px;">
        <span id="draftStatusText" style="font-size:12px;color:var(--text-muted);">Your progress is auto-saved.</span>
      </span>
      <div style="display:flex;gap:8px;">
        <button type="button" class="btn btn-sm btn-outline" id="saveDraftNowBtn" style="font-size:12px;">Save Draft Now</button>
        <button type="button" class="btn btn-sm btn-outline" id="saveTemplateBtn">Save as Template</button>
      </div>
    </div>
  </div>`;
  
  c.innerHTML = html;
  wireComposer();
  const gi = $('#globalInstructions');
  if (gi) gi.addEventListener('input', saveFormState);
  
  // Wire save draft now button
  const saveDraftBtn = $('#saveDraftNowBtn');
  if (saveDraftBtn) {
    saveDraftBtn.addEventListener('click', async () => {
      saveDraftBtn.textContent = 'Saving...';
      saveDraftBtn.disabled = true;
      saveFormState();
      await saveDraftToServer();
      const statusEl = $('#draftStatusText');
      if (statusEl) statusEl.textContent = '\u2713 Draft saved just now';
      saveDraftBtn.textContent = 'Save Draft Now';
      saveDraftBtn.disabled = false;
    });
  }

  // Wire save template button
  const saveBtn = $('#saveTemplateBtn');
  if (saveBtn) {
    saveBtn.addEventListener('click', () => {
      if (!state.isLoggedIn) {
        if (confirm('Create an account to save templates. Go to account creation?')) {
          $('#roleSelect').value = 'new';
          handleRoleChange('new');
          showNewUserSection('account');
          if (state.trialEmail) $('#signupEmail').value = state.trialEmail;
        }
      } else {
        saveAsTemplate();
      }
    });
  }
}

function renderFwBody(fwKey, fw) {
  let html = `<div style="margin-top: 16px; margin-bottom: 8px;"><strong>${esc(fw.label)}</strong>${fw.description ? ` <span style="color: var(--text-muted);">&mdash; ${esc(fw.description)}</span>` : ''}</div>`;
  for (const g of (fw.controlGroups || [])) html += renderGroup(fwKey, g);
  html += `<button type="button" class="btn btn-sm btn-outline" style="width: 100%; margin-top: 8px; border-style: dashed;" data-add-group-btn="${esc(fwKey)}">+ Add control group</button>`;
  return html;
}

function renderGroup(fwKey, g) {
  const gs = composerState[fwKey]?.groups?.[g.id];
  const exp = gs?.expanded, more = gs?.showMore, excluded = gs?.excluded;
  const common = (g.items || []).filter(i => i.common), extra = (g.items || []).filter(i => !i.common);
  const includedCount = (g.items || []).filter(i => gs?.items?.[i.id]?.included && !excluded).length;
  const totalCount = (g.items || []).length;
  let html = `<div class="control-group ${excluded ? 'excluded' : ''}" data-fw="${esc(fwKey)}" data-group="${esc(g.id)}"><div class="cg-header"><span class="cg-title">${esc(g.title)}</span><div class="cg-status">${excluded ? `<span style="color: var(--text-muted); font-size: 0.8rem;">Excluded</span><button type="button" class="cg-include" data-include-group="${esc(fwKey)}-${esc(g.id)}" title="Include">+</button>` : `<span class="cg-count">${includedCount}/${totalCount}</span><button type="button" class="cg-exclude" data-exclude-group="${esc(fwKey)}-${esc(g.id)}" title="Exclude">x</button>`}<span class="cg-toggle">${exp ? 'v' : '>'}</span></div></div><div class="cg-body ${exp ? 'open' : ''}">`;
  if (excluded) {
    html += `<p style="color: var(--text-muted); text-align: center; padding: 12px;">This control group is excluded from the request.</p>`;
  } else {
    if (g.description) html += `<p class="cg-description">${esc(g.description)}</p>`;
    for (const item of common) html += renderItem(fwKey, g.id, item, gs);
    if (extra.length) {
      html += `<div class="extra-items" style="display: ${more ? 'block' : 'none'};">`;
      for (const item of extra) html += renderItem(fwKey, g.id, item, gs);
      html += '</div>';
      html += `<div class="more-toggle" data-fw="${esc(fwKey)}" data-group="${esc(g.id)}">${more ? '- Show fewer options' : `+ Show ${extra.length} more options`}</div>`;
    }
    html += `<div class="add-custom-section"><h4>Add custom request to "${esc(g.title)}"</h4><div class="custom-form"><input class="form-input" placeholder="e.g., Network Diagram, Encryption Key Rotation Log" data-custom-name="${esc(fwKey)}-${esc(g.id)}"><textarea class="form-textarea" placeholder="Instructions for client (describe what you need, date ranges, format...)" data-custom-instr="${esc(fwKey)}-${esc(g.id)}" style="min-height: 50px;"></textarea><button type="button" class="btn btn-sm btn-outline" data-add-item="${esc(fwKey)}" data-group="${esc(g.id)}">+ Add request</button></div></div>`;
  }
  html += '</div></div>';
  return html;
}

function renderItem(fwKey, gid, item, gs) {
  const st = gs?.items?.[item.id];
  const inc = st?.included ?? item.common;
  const instr = st?.instructions || '';
  const guidanceCollapsed = st?.guidanceCollapsed ?? false;
  
  // Get current description (edited or default with audit period injected)
  const auditPeriod = getAuditPeriodString();
  let defaultDescription = item.description || item.hint || '';
  if (auditPeriod && item.evidenceType === 'period-of-time' && defaultDescription.includes('{{auditPeriod}}')) {
    defaultDescription = defaultDescription.replace(/\{\{auditPeriod\}\}/g, auditPeriod);
  }
  const currentDescription = st?.editedDescription !== null ? st.editedDescription : defaultDescription;
  
  // Get current formats (edited or default)
  const defaultFormats = item.expectedFormat ? item.expectedFormat.split(/,\s*|or\s+|\s+or\s+/).map(f => f.trim()).filter(Boolean) : [];
  const currentFormats = st?.editedFormats !== null ? st.editedFormats : defaultFormats;
  
  // Build format chips HTML
  let formatChipsHtml = '';
  currentFormats.forEach((fmt, idx) => {
    formatChipsHtml += `<span class="ei-format-chip" data-format-chip="${esc(fwKey)}-${esc(gid)}-${esc(item.id)}-${idx}"> ${esc(fmt)}<span class="chip-remove" data-remove-format="${esc(fwKey)}-${esc(gid)}-${esc(item.id)}-${idx}">x</span></span>`;
  });
  formatChipsHtml += `<span class="ei-add-format" data-add-format="${esc(fwKey)}-${esc(gid)}-${esc(item.id)}">+ Add format</span>`;
  
  // Build guidance meta tags
  let guidanceMetaHtml = '';
  if (item.controlRef) {
    guidanceMetaHtml += `<span class="ei-tag control">${esc(item.controlRef)}</span>`;
  }
  if (item.evidenceType === 'period-of-time') {
    guidanceMetaHtml += '<span class="ei-tag period"> Period-of-time</span>';
  } else if (item.evidenceType === 'point-in-time') {
    guidanceMetaHtml += '<span class="ei-tag point"> Point-in-time</span>';
  }
  
  // Build common issue tip
  const tipHtml = item.commonIssue ? `<div class="ei-tip"><span class="ei-tip-label"> Tip</span>${esc(item.commonIssue)}</div>` : '';
  
  // Check if description was edited (to show reset button)
  const descriptionEdited = st?.editedDescription !== null;
  const formatsEdited = st?.editedFormats !== null;
  
  return `<div class="evidence-item ${inc ? 'included' : ''}" data-fw="${esc(fwKey)}" data-group="${esc(gid)}" data-item="${esc(item.id)}">
    <div class="ei-header">
      <input type="checkbox" ${inc ? 'checked' : ''} title="Include this item in request">
      <div class="ei-title">${esc(item.title)}</div>
    </div>
    <div class="ei-body">
      <!-- Client-Facing Zone -->
      <div class="ei-client-zone">
        <div class="ei-zone-header client">
          <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
          Client sees
        </div>
        
        <label class="ei-field-label">Guidance for client:</label>
        <textarea class="ei-description-textarea" data-desc-edit="${esc(fwKey)}-${esc(gid)}-${esc(item.id)}" placeholder="Describe what evidence the client should provide...">${esc(currentDescription)}</textarea>
        <div class="ei-description-actions">
          <button type="button" class="ei-action-btn" data-desc-clear="${esc(fwKey)}-${esc(gid)}-${esc(item.id)}">Clear</button>
          ${descriptionEdited ? `<button type="button" class="ei-action-btn" data-desc-reset="${esc(fwKey)}-${esc(gid)}-${esc(item.id)}">&#8634; Reset</button>` : ''}
        </div>
        
        <div class="ei-formats-row">
          <span class="ei-formats-label">Format:</span>
          <div class="ei-format-chips" data-formats-container="${esc(fwKey)}-${esc(gid)}-${esc(item.id)}">
            ${formatChipsHtml}
          </div>
          ${formatsEdited ? `<button type="button" class="ei-formats-reset" data-formats-reset="${esc(fwKey)}-${esc(gid)}-${esc(item.id)}">&#8634; reset</button>` : ''}
        </div>
        
        <div class="ei-instructions-row">
          <textarea class="ei-instructions-textarea" data-item-instr="${esc(fwKey)}-${esc(gid)}-${esc(item.id)}" placeholder="+ Add extra instructions for client...">${esc(instr)}</textarea>
        </div>
      </div>
      
      <!-- ProofRepo Guidance Zone (sidebar) -->
      <div class="ei-guidance-zone ${guidanceCollapsed ? 'collapsed' : ''}" data-guidance-zone="${esc(fwKey)}-${esc(gid)}-${esc(item.id)}">
        <div class="ei-guidance-toggle" data-guidance-toggle="${esc(fwKey)}-${esc(gid)}-${esc(item.id)}">
          <div class="ei-zone-header guidance">
            <svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
            Your reference
          </div>
          <button type="button" class="ei-guidance-toggle-btn">${guidanceCollapsed ? '>' : 'v'}</button>
        </div>
        <div class="ei-guidance-content">
          ${guidanceMetaHtml ? `<div class="ei-guidance-meta">${guidanceMetaHtml}</div>` : ''}
          ${tipHtml}
        </div>
      </div>
    </div>
  </div>`;
}

function wireComposer() {
  const allFw = getAllFrameworks();
  
  // Framework toggles
  $$('[data-fw-toggle]').forEach(cb => {
    cb.addEventListener('change', e => {
      const k = e.target.dataset.fwToggle;
      if (!composerState[k]) composerState[k] = { enabled: false, groups: {}, templateLevel: 'standard' };
      composerState[k].enabled = e.target.checked;
      const fw = allFw[k];
      if (fw && composerState[k].enabled) {
        // Initialize groups
        for (const g of (fw.controlGroups || [])) {
          if (!composerState[k].groups[g.id]) {
            composerState[k].groups[g.id] = { expanded: false, showMore: false, excluded: false, items: {} };
            for (const item of (g.items || [])) {
              composerState[k].groups[g.id].items[item.id] = { 
                included: false, 
                instructions: '',
                editedDescription: null,
                editedFormats: null,
                guidanceCollapsed: false
              };
            }
          }
        }
        // Apply template level for this framework
        const level = composerState[k].templateLevel || 'standard';
        composerState[k].templateLevel = level;
        applyTemplateLevelForFramework(k, level);
        return; // applyTemplateLevelForFramework calls renderComposer
      }
      renderComposer();
      saveFormState();
    });
  });
  
  // Control group headers (expand/collapse)
  $$('.cg-header').forEach(h => {
    h.addEventListener('click', e => {
      if (e.target.closest('.cg-exclude') || e.target.closest('.cg-include')) return;
      const g = h.closest('.control-group');
      const fk = g.dataset.fw, gid = g.dataset.group;
      composerState[fk].groups[gid].expanded = !composerState[fk].groups[gid].expanded;
      renderComposer();
    });
  });
  
  // Exclude/include group buttons
  $$('[data-exclude-group]').forEach(btn => {
    btn.addEventListener('click', e => { e.stopPropagation(); const [fk, gid] = btn.dataset.excludeGroup.split('-'); composerState[fk].groups[gid].excluded = true; renderComposer(); saveFormState(); });
  });
  $$('[data-include-group]').forEach(btn => {
    btn.addEventListener('click', e => { e.stopPropagation(); const [fk, gid] = btn.dataset.includeGroup.split('-'); composerState[fk].groups[gid].excluded = false; renderComposer(); saveFormState(); });
  });
  
  // Show more toggle
  $$('.more-toggle').forEach(t => {
    t.addEventListener('click', e => { e.stopPropagation(); const fk = t.dataset.fw, gid = t.dataset.group; composerState[fk].groups[gid].showMore = !composerState[fk].groups[gid].showMore; renderComposer(); });
  });
  
  // Evidence item checkboxes
  $$('.evidence-item input[type="checkbox"]').forEach(cb => {
    cb.addEventListener('change', e => { 
      const el = e.target.closest('.evidence-item'); 
      const { fw, group, item } = el.dataset; 
      composerState[fw].groups[group].items[item].included = e.target.checked; 
      renderComposer(); 
      saveFormState(); 
    });
  });
  
  // Description textarea edits
  $$('[data-desc-edit]').forEach(ta => {
    ta.addEventListener('input', e => {
      const parts = ta.dataset.descEdit.split('-');
      const [fw, group] = [parts[0], parts[1]];
      const item = parts.slice(2).join('-');
      if (composerState[fw]?.groups?.[group]?.items?.[item]) {
        composerState[fw].groups[group].items[item].editedDescription = e.target.value;
        saveFormState();
      }
    });
  });
  
  // Description clear button
  $$('[data-desc-clear]').forEach(btn => {
    btn.addEventListener('click', () => {
      const parts = btn.dataset.descClear.split('-');
      const [fw, group] = [parts[0], parts[1]];
      const item = parts.slice(2).join('-');
      if (composerState[fw]?.groups?.[group]?.items?.[item]) {
        composerState[fw].groups[group].items[item].editedDescription = '';
        renderComposer();
        saveFormState();
      }
    });
  });
  
  // Description reset button
  $$('[data-desc-reset]').forEach(btn => {
    btn.addEventListener('click', () => {
      const parts = btn.dataset.descReset.split('-');
      const [fw, group] = [parts[0], parts[1]];
      const item = parts.slice(2).join('-');
      if (composerState[fw]?.groups?.[group]?.items?.[item]) {
        composerState[fw].groups[group].items[item].editedDescription = null;
        renderComposer();
        saveFormState();
      }
    });
  });
  
  // Format chip remove
  $$('[data-remove-format]').forEach(btn => {
    btn.addEventListener('click', e => {
      e.stopPropagation();
      const parts = btn.dataset.removeFormat.split('-');
      const [fw, group] = [parts[0], parts[1]];
      const itemId = parts.slice(2, -1).join('-');
      const formatIdx = parseInt(parts[parts.length - 1], 10);
      
      const itemState = composerState[fw]?.groups?.[group]?.items?.[itemId];
      if (itemState) {
        // Get library item for default formats
        const fwObj = allFw[fw];
        const grpObj = fwObj?.controlGroups?.find(g => g.id === group);
        const libItem = grpObj?.items?.find(i => i.id === itemId);
        const defaultFormats = libItem?.expectedFormat ? libItem.expectedFormat.split(/,\s*|or\s+|\s+or\s+/).map(f => f.trim()).filter(Boolean) : [];
        
        // Get current formats
        let currentFormats = itemState.editedFormats !== null ? [...itemState.editedFormats] : [...defaultFormats];
        currentFormats.splice(formatIdx, 1);
        itemState.editedFormats = currentFormats;
        
        renderComposer();
        saveFormState();
      }
    });
  });
  
  // Add format button
  $$('[data-add-format]').forEach(btn => {
    btn.addEventListener('click', e => {
      e.stopPropagation();
      const parts = btn.dataset.addFormat.split('-');
      const [fw, group] = [parts[0], parts[1]];
      const itemId = parts.slice(2).join('-');
      
      // Replace button with input
      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'ei-format-input';
      input.placeholder = 'e.g., CSV';
      btn.replaceWith(input);
      input.focus();
      
      const addFormat = (val) => {
        const fmt = val.trim();
        if (fmt) {
          const itemState = composerState[fw]?.groups?.[group]?.items?.[itemId];
          if (itemState) {
            const fwObj = allFw[fw];
            const grpObj = fwObj?.controlGroups?.find(g => g.id === group);
            const libItem = grpObj?.items?.find(i => i.id === itemId);
            const defaultFormats = libItem?.expectedFormat ? libItem.expectedFormat.split(/,\s*|or\s+|\s+or\s+/).map(f => f.trim()).filter(Boolean) : [];
            
            let currentFormats = itemState.editedFormats !== null ? [...itemState.editedFormats] : [...defaultFormats];
            if (!currentFormats.includes(fmt)) {
              currentFormats.push(fmt);
              itemState.editedFormats = currentFormats;
            }
          }
        }
        renderComposer();
        saveFormState();
      };
      
      input.addEventListener('keydown', e => {
        if (e.key === 'Enter') { addFormat(input.value); }
        if (e.key === 'Escape') { renderComposer(); }
      });
      input.addEventListener('blur', () => { addFormat(input.value); });
    });
  });
  
  // Reset formats button
  $$('[data-formats-reset]').forEach(btn => {
    btn.addEventListener('click', () => {
      const parts = btn.dataset.formatsReset.split('-');
      const [fw, group] = [parts[0], parts[1]];
      const item = parts.slice(2).join('-');
      if (composerState[fw]?.groups?.[group]?.items?.[item]) {
        composerState[fw].groups[group].items[item].editedFormats = null;
        renderComposer();
        saveFormState();
      }
    });
  });
  
  // Additional instructions textarea
  $$('[data-item-instr]').forEach(ta => {
    ta.addEventListener('input', e => { 
      const parts = ta.dataset.itemInstr.split('-'); 
      const [fw, group] = [parts[0], parts[1]]; 
      const item = parts.slice(2).join('-'); 
      if (composerState[fw]?.groups?.[group]?.items?.[item]) {
        composerState[fw].groups[group].items[item].instructions = e.target.value; 
        saveFormState();
      }
    });
  });
  
  // Guidance zone toggle
  $$('[data-guidance-toggle]').forEach(toggle => {
    toggle.addEventListener('click', () => {
      const parts = toggle.dataset.guidanceToggle.split('-');
      const [fw, group] = [parts[0], parts[1]];
      const item = parts.slice(2).join('-');
      if (composerState[fw]?.groups?.[group]?.items?.[item]) {
        composerState[fw].groups[group].items[item].guidanceCollapsed = !composerState[fw].groups[group].items[item].guidanceCollapsed;
        renderComposer();
      }
    });
  });
  
  // Add custom item
  $$('[data-add-item]').forEach(btn => {
    btn.addEventListener('click', () => {
      const fk = btn.dataset.addItem, gid = btn.dataset.group;
      const nameInput = document.querySelector(`[data-custom-name="${fk}-${gid}"]`);
      const instrInput = document.querySelector(`[data-custom-instr="${fk}-${gid}"]`);
      const title = (nameInput?.value || '').trim(), instructions = (instrInput?.value || '').trim();
      if (!title) { alert('Please enter a request name.'); return; }
      const cid = 'c_' + Math.random().toString(36).slice(2, 8);
      const fw = allFw[fk], grp = fw?.controlGroups?.find(g => g.id === gid);
      if (grp) { 
        grp.items.push({ id: cid, title, common: true, hint: '' }); 
        composerState[fk].groups[gid].items[cid] = { 
          included: true, 
          instructions,
          editedDescription: null,
          editedFormats: null,
          guidanceCollapsed: false
        }; 
      }
      nameInput.value = ''; instrInput.value = '';
      renderComposer(); saveFormState();
    });
  });
  
  // Add framework modal
  $('#addFwChip')?.addEventListener('click', () => { $('#addFwModal').classList.remove('hidden'); });
  
  // Add group modal
  $$('[data-add-group-btn]').forEach(btn => {
    btn.addEventListener('click', () => { $('#customGroupFwKey').value = btn.dataset.addGroupBtn; $('#addGroupModal').classList.remove('hidden'); });
  });
  
  // Per-framework template level dropdowns
  $$('.fw-template-select').forEach(sel => {
    sel.addEventListener('change', () => {
      const fwKey = sel.dataset.fwTemplate;
      const level = sel.value;
      if (composerState[fwKey]) {
        composerState[fwKey].templateLevel = level;
        applyTemplateLevelForFramework(fwKey, level);
      }
    });
  });
  
  // Preview button
  $('#previewClientBtn')?.addEventListener('click', showClientPreview);
}

// DEFAULT_TEMPLATES - Curated item selections for Quick/Standard/Thorough levels
const DEFAULT_TEMPLATES = {
  SOC2: {
    quickStart: [
      'org_chart', 'info_sec_policy', 'security_roles',
      'security_training_completion', 'acceptable_use_policy',
      'risk_assessment', 'risk_register',
      'access_control_policy', 'user_access_review', 'privileged_access_list', 'mfa_config', 'offboarding_samples',
      'vulnerability_scanning', 'security_monitoring', 'endpoint_protection',
      'change_management_policy', 'change_samples', 'branch_protection',
      'vendor_inventory', 'backup_config'
    ],
    standard: [
      'org_chart', 'info_sec_policy', 'code_of_conduct', 'security_roles', 'hr_policies',
      'security_awareness_program', 'security_training_completion', 'acceptable_use_policy', 'policy_acknowledgments',
      'risk_assessment', 'risk_register', 'risk_treatment_plan',
      'control_monitoring', 'kpi_metrics',
      'it_general_controls', 'segregation_of_duties', 'system_inventory',
      'access_control_policy', 'user_access_review', 'privileged_access_list', 'privileged_access_review',
      'mfa_config', 'password_policy_config', 'offboarding_samples', 'encryption_at_rest',
      'vulnerability_scanning', 'vulnerability_remediation', 'penetration_testing', 'endpoint_protection',
      'change_management_policy', 'change_log', 'change_samples',
      'vendor_inventory', 'vendor_management_policy', 'bcp_plan', 'backup_config'
    ],
    thorough: [
      'org_chart', 'info_sec_policy', 'code_of_conduct', 'code_of_conduct_ack', 'security_roles', 'board_oversight', 'hr_policies',
      'security_awareness_program', 'security_training_completion', 'acceptable_use_policy', 'policy_acknowledgments', 'external_communications', 'phishing_testing',
      'risk_assessment', 'risk_register', 'risk_treatment_plan', 'risk_acceptance', 'third_party_risk_assessment',
      'control_monitoring', 'internal_audit', 'deficiency_tracking', 'kpi_metrics',
      'it_general_controls', 'segregation_of_duties', 'system_inventory', 'data_classification_policy',
      'access_control_policy', 'user_access_review', 'privileged_access_list', 'privileged_access_review',
      'mfa_config', 'password_policy_config', 'onboarding_process', 'onboarding_samples', 'offboarding_process', 'offboarding_samples',
      'encryption_at_rest', 'encryption_in_transit', 'encryption_key_management',
      'vulnerability_scanning', 'vulnerability_remediation', 'penetration_testing', 'pentest_remediation',
      'security_monitoring', 'security_alert_samples', 'endpoint_protection', 'ids_ips_config',
      'change_management_policy', 'change_log', 'change_samples', 'code_review_evidence', 'branch_protection', 'deployment_pipeline',
      'vendor_inventory', 'vendor_management_policy', 'vendor_assessments', 'vendor_soc_reports',
      'bcp_plan', 'dr_plan', 'bcp_dr_testing', 'backup_config', 'backup_monitoring', 'backup_restoration_test',
      'ir_plan', 'ir_team', 'incident_log', 'ir_testing'
    ]
  },
  ISO27001: {
    quickStart: [
      'isms_scope', 'isms_policy', 'risk_assessment_iso', 'risk_treatment_plan_iso', 'soa', 'internal_audit_results', 'management_review',
      'security_policy_set', 'roles_responsibilities', 'asset_inventory_iso', 'acceptable_use_iso', 'cloud_security',
      'screening', 'employment_terms', 'security_awareness_iso', 'confidentiality_agreements',
      'endpoint_devices', 'secure_authentication_iso', 'malware_protection_iso', 'backup_iso', 'logging_iso', 'change_management_iso'
    ],
    standard: [
      'isms_scope', 'isms_policy', 'risk_assessment_iso', 'risk_treatment_plan_iso', 'soa', 'isms_objectives',
      'competence_records', 'internal_audit_results', 'management_review', 'nonconformity_log',
      'security_policy_set', 'roles_responsibilities', 'segregation_duties_iso', 'asset_inventory_iso',
      'acceptable_use_iso', 'classification_scheme', 'supplier_policy', 'cloud_security', 'incident_management_iso', 'incident_log_iso',
      'screening', 'employment_terms', 'security_awareness_iso', 'training_records_iso', 'termination_process', 'confidentiality_agreements',
      'endpoint_devices', 'privileged_access_iso', 'access_restriction_iso', 'secure_authentication_iso',
      'malware_protection_iso', 'vulnerability_management_iso', 'config_management_iso', 'backup_iso',
      'logging_iso', 'monitoring_iso', 'network_security_iso', 'cryptography_iso'
    ],
    thorough: [
      'isms_scope', 'isms_policy', 'risk_assessment_iso', 'risk_treatment_plan_iso', 'soa', 'isms_objectives',
      'competence_records', 'internal_audit_results', 'management_review', 'nonconformity_log',
      'security_policy_set', 'roles_responsibilities', 'segregation_duties_iso', 'contact_authorities', 'threat_intelligence',
      'project_security', 'asset_inventory_iso', 'acceptable_use_iso', 'asset_return', 'classification_scheme',
      'supplier_policy', 'supplier_agreements', 'supplier_monitoring', 'cloud_security',
      'incident_management_iso', 'incident_log_iso', 'bcp_framework', 'bcp_testing_iso', 'legal_requirements',
      'screening', 'screening_evidence', 'employment_terms', 'security_awareness_iso', 'training_records_iso',
      'disciplinary_process', 'termination_process', 'termination_samples_iso', 'confidentiality_agreements', 'security_event_reporting',
      'physical_entry', 'equipment_security', 'equipment_disposal',
      'endpoint_devices', 'privileged_access_iso', 'access_restriction_iso', 'source_code_access',
      'secure_authentication_iso', 'capacity_management_iso', 'malware_protection_iso', 'vulnerability_management_iso',
      'config_management_iso', 'data_deletion_iso', 'data_leakage_prevention', 'backup_iso',
      'logging_iso', 'monitoring_iso', 'network_security_iso', 'network_segregation', 'cryptography_iso',
      'sdlc', 'security_testing_dev', 'dev_test_prod', 'change_management_iso'
    ]
  },
  SOC1: {
    quickStart: [
      'soc1_org_structure', 'soc1_hr_policies', 'soc1_code_of_conduct',
      'soc1_access_policy', 'soc1_user_list', 'soc1_access_review', 'soc1_password_mfa',
      'soc1_change_policy', 'soc1_change_samples', 'soc1_segregation',
      'soc1_job_schedule', 'soc1_backup_config',
      'soc1_processing_procedures', 'soc1_reconciliations',
      'soc1_subservice_list', 'soc1_datacenter_soc',
      'soc1_governance_structure', 'soc1_risk_assessment'
    ],
    standard: [
      'soc1_org_structure', 'soc1_hr_policies', 'soc1_background_checks', 'soc1_code_of_conduct', 'soc1_training',
      'soc1_governance_structure', 'soc1_board_oversight', 'soc1_risk_assessment',
      'soc1_access_policy', 'soc1_user_list', 'soc1_access_request_samples', 'soc1_access_review',
      'soc1_termination_samples', 'soc1_privileged_users', 'soc1_password_mfa',
      'soc1_system_parameters', 'soc1_remote_access', 'soc1_access_logs',
      'soc1_change_policy', 'soc1_change_log', 'soc1_change_samples', 'soc1_segregation', 'soc1_dev_prod_separation',
      'soc1_version_control', 'soc1_release_management',
      'soc1_job_schedule', 'soc1_job_monitoring', 'soc1_backup_config', 'soc1_backup_logs', 'soc1_incident_log',
      'soc1_processing_procedures', 'soc1_input_validation', 'soc1_reconciliations', 'soc1_exception_handling',
      'soc1_subservice_list', 'soc1_subservice_soc', 'soc1_datacenter_soc'
    ],
    thorough: [
      'soc1_org_structure', 'soc1_hr_policies', 'soc1_background_checks', 'soc1_code_of_conduct', 'soc1_training',
      'soc1_governance_structure', 'soc1_board_oversight', 'soc1_risk_assessment',
      'soc1_access_policy', 'soc1_user_list', 'soc1_access_request_samples', 'soc1_access_review',
      'soc1_termination_samples', 'soc1_privileged_users', 'soc1_password_mfa',
      'soc1_system_parameters', 'soc1_remote_access', 'soc1_access_logs',
      'soc1_change_policy', 'soc1_change_log', 'soc1_change_samples', 'soc1_segregation', 'soc1_dev_prod_separation',
      'soc1_version_control', 'soc1_release_management',
      'soc1_job_schedule', 'soc1_job_monitoring', 'soc1_backup_config', 'soc1_backup_logs', 'soc1_backup_restore', 'soc1_incident_log',
      'soc1_capacity_planning', 'soc1_monitoring_tools', 'soc1_environmental_controls',
      'soc1_processing_procedures', 'soc1_input_validation', 'soc1_reconciliations', 'soc1_exception_handling', 'soc1_ipe_testing',
      'soc1_output_controls', 'soc1_error_correction',
      'soc1_subservice_list', 'soc1_subservice_soc', 'soc1_datacenter_soc'
    ]
  },
  NISTCSF: {
    quickStart: [
      'nist_org_context', 'nist_risk_strategy', 'nist_policies',
      'nist_asset_inventory', 'nist_risk_assessment',
      'nist_access_management', 'nist_awareness', 'nist_encryption',
      'nist_monitoring', 'nist_logging',
      'nist_ir_plan',
      'nist_dr_plan',
      'nist_cybersecurity_program', 'nist_risk_appetite', 'nist_data_flow_diagram'
    ],
    standard: [
      'nist_org_context', 'nist_risk_strategy', 'nist_roles', 'nist_policies', 'nist_oversight', 'nist_supply_chain',
      'nist_cybersecurity_program', 'nist_risk_appetite', 'nist_legal_regulatory', 'nist_supply_chain_policy',
      'nist_asset_inventory', 'nist_network_diagram', 'nist_risk_assessment',
      'nist_data_flow_diagram', 'nist_business_impact', 'nist_threat_assessment', 'nist_supply_chain_risk',
      'nist_access_management', 'nist_mfa', 'nist_access_reviews', 'nist_awareness', 'nist_encryption', 'nist_endpoint', 'nist_backup',
      'nist_data_protection', 'nist_platform_security', 'nist_change_management',
      'nist_monitoring', 'nist_logging', 'nist_vuln_scanning', 'nist_alert_analysis',
      'nist_ir_plan', 'nist_incident_log', 'nist_ir_testing',
      'nist_dr_plan', 'nist_dr_testing'
    ],
    thorough: [
      'nist_org_context', 'nist_risk_strategy', 'nist_roles', 'nist_policies', 'nist_oversight', 'nist_supply_chain',
      'nist_cybersecurity_program', 'nist_risk_appetite', 'nist_legal_regulatory', 'nist_supply_chain_policy',
      'nist_asset_inventory', 'nist_network_diagram', 'nist_risk_assessment',
      'nist_data_flow_diagram', 'nist_business_impact', 'nist_threat_assessment', 'nist_supply_chain_risk',
      'nist_access_management', 'nist_mfa', 'nist_access_reviews', 'nist_awareness', 'nist_encryption', 'nist_endpoint', 'nist_backup',
      'nist_data_protection', 'nist_platform_security', 'nist_change_management', 'nist_secure_development', 'nist_physical_security', 'nist_remote_access',
      'nist_monitoring', 'nist_logging', 'nist_vuln_scanning', 'nist_alert_analysis',
      'nist_anomaly_detection', 'nist_continuous_monitoring', 'nist_adverse_events',
      'nist_ir_plan', 'nist_incident_log', 'nist_ir_testing',
      'nist_ir_communications', 'nist_ir_improvements',
      'nist_dr_plan', 'nist_dr_testing'
    ]
  },
  CMMC: {
    quickStart: [
      'cmmc_ssp', 'cmmc_poam', 'cmmc_cui_inventory', 'cmmc_boundary_diagram',
      'cmmc_access_policy', 'cmmc_user_listing', 'cmmc_privileged_users',
      'cmmc_user_identification', 'cmmc_mfa', 'cmmc_password',
      'cmmc_baseline', 'cmmc_change_control',
      'cmmc_audit_events', 'cmmc_audit_review',
      'cmmc_ir_plan',
      'cmmc_boundary', 'cmmc_fips', 'cmmc_transit_encryption',
      'cmmc_media_policy',
      'cmmc_control_assessment',
      'cmmc_at_awareness', 'cmmc_si_malicious_code', 'cmmc_ra_assessment',
      'cmmc_ps_screening', 'cmmc_pe_access_auth'
    ],
    standard: [
      'cmmc_ssp', 'cmmc_poam', 'cmmc_cui_inventory', 'cmmc_boundary_diagram',
      'cmmc_access_policy', 'cmmc_user_listing', 'cmmc_privileged_users', 'cmmc_remote_access', 'cmmc_portable_storage',
      'cmmc_ac_flow_control', 'cmmc_ac_separation', 'cmmc_ac_failed_logins', 'cmmc_ac_session_lock',
      'cmmc_ac_wireless', 'cmmc_ac_mobile', 'cmmc_ac_access_reviews', 'cmmc_ac_termination',
      'cmmc_at_awareness', 'cmmc_at_role_based', 'cmmc_at_insider', 'cmmc_at_training_records', 'cmmc_at_program',
      'cmmc_user_identification', 'cmmc_mfa', 'cmmc_password',
      'cmmc_ia_device_id', 'cmmc_ia_reuse_prevention', 'cmmc_ia_inactivity', 'cmmc_ia_management',
      'cmmc_baseline', 'cmmc_change_control', 'cmmc_least_functionality',
      'cmmc_cm_security_settings', 'cmmc_cm_impact_analysis', 'cmmc_cm_inventory',
      'cmmc_audit_events', 'cmmc_audit_review', 'cmmc_audit_protection',
      'cmmc_au_content', 'cmmc_au_correlation', 'cmmc_au_timestamps',
      'cmmc_ir_plan', 'cmmc_incident_log', 'cmmc_ir_testing',
      'cmmc_ma_controlled', 'cmmc_ma_tools', 'cmmc_ma_remote', 'cmmc_ma_records',
      'cmmc_pe_access_auth', 'cmmc_pe_monitoring', 'cmmc_pe_visitors', 'cmmc_pe_logs', 'cmmc_pe_alternate',
      'cmmc_ps_screening', 'cmmc_ps_actions',
      'cmmc_ra_assessment', 'cmmc_ra_vuln_scan', 'cmmc_ra_vuln_remediation',
      'cmmc_si_flaw_remediation', 'cmmc_si_malicious_code', 'cmmc_si_alerts', 'cmmc_si_updates', 'cmmc_si_monitoring',
      'cmmc_boundary', 'cmmc_fips', 'cmmc_transit_encryption',
      'cmmc_sc_subnets', 'cmmc_sc_function_separation', 'cmmc_sc_key_mgmt', 'cmmc_sc_crypto_use',
      'cmmc_media_policy', 'cmmc_media_marking', 'cmmc_sanitization',
      'cmmc_control_assessment', 'cmmc_vuln_assessment'
    ],
    thorough: [
      'cmmc_ssp', 'cmmc_poam', 'cmmc_cui_inventory', 'cmmc_boundary_diagram',
      'cmmc_access_policy', 'cmmc_user_listing', 'cmmc_privileged_users', 'cmmc_remote_access', 'cmmc_portable_storage',
      'cmmc_ac_flow_control', 'cmmc_ac_separation', 'cmmc_ac_failed_logins', 'cmmc_ac_notice', 'cmmc_ac_session_lock', 'cmmc_ac_session_term',
      'cmmc_ac_wireless', 'cmmc_ac_mobile', 'cmmc_ac_external', 'cmmc_ac_public_systems',
      'cmmc_ac_access_reviews', 'cmmc_ac_termination', 'cmmc_ac_network_control', 'cmmc_ac_routing',
      'cmmc_at_awareness', 'cmmc_at_role_based', 'cmmc_at_insider', 'cmmc_at_training_records', 'cmmc_at_program',
      'cmmc_user_identification', 'cmmc_mfa', 'cmmc_password',
      'cmmc_ia_device_id', 'cmmc_ia_replay_resistant', 'cmmc_ia_reuse_prevention', 'cmmc_ia_inactivity',
      'cmmc_ia_feedback', 'cmmc_ia_crypto_auth', 'cmmc_ia_management', 'cmmc_ia_default_auth',
      'cmmc_baseline', 'cmmc_change_control', 'cmmc_least_functionality',
      'cmmc_cm_security_settings', 'cmmc_cm_impact_analysis', 'cmmc_cm_access_restrictions',
      'cmmc_cm_inventory', 'cmmc_cm_unauthorized', 'cmmc_cm_user_software',
      'cmmc_audit_events', 'cmmc_audit_review', 'cmmc_audit_protection',
      'cmmc_au_content', 'cmmc_au_capacity', 'cmmc_au_failure', 'cmmc_au_correlation', 'cmmc_au_reduction', 'cmmc_au_timestamps',
      'cmmc_ir_plan', 'cmmc_incident_log', 'cmmc_ir_testing',
      'cmmc_ma_controlled', 'cmmc_ma_tools', 'cmmc_ma_media', 'cmmc_ma_remote', 'cmmc_ma_personnel', 'cmmc_ma_records',
      'cmmc_pe_access_auth', 'cmmc_pe_monitoring', 'cmmc_pe_visitors', 'cmmc_pe_logs', 'cmmc_pe_devices', 'cmmc_pe_alternate',
      'cmmc_ps_screening', 'cmmc_ps_actions',
      'cmmc_ra_assessment', 'cmmc_ra_vuln_scan', 'cmmc_ra_vuln_remediation',
      'cmmc_si_flaw_remediation', 'cmmc_si_malicious_code', 'cmmc_si_alerts', 'cmmc_si_updates',
      'cmmc_si_spam', 'cmmc_si_monitoring', 'cmmc_si_inbound_outbound',
      'cmmc_boundary', 'cmmc_fips', 'cmmc_transit_encryption',
      'cmmc_sc_subnets', 'cmmc_sc_engineering', 'cmmc_sc_function_separation', 'cmmc_sc_dos', 'cmmc_sc_remote_device',
      'cmmc_sc_mobile_code', 'cmmc_sc_voip', 'cmmc_sc_key_mgmt', 'cmmc_sc_crypto_use',
      'cmmc_sc_collaborative', 'cmmc_sc_authenticity', 'cmmc_sc_sessions',
      'cmmc_media_policy', 'cmmc_media_marking', 'cmmc_sanitization',
      'cmmc_mp_access', 'cmmc_mp_disposal', 'cmmc_mp_transport', 'cmmc_mp_storage', 'cmmc_mp_removable_control',
      'cmmc_control_assessment', 'cmmc_vuln_assessment',
      'cmmc_ca_monitoring', 'cmmc_ca_connections'
    ]
  },
  HIPAA: {
    quickStart: [
      'hipaa_risk_analysis', 'hipaa_sanction_policy', 'hipaa_security_officer',
      'hipaa_workforce_authorization', 'hipaa_training', 'hipaa_incident', 'hipaa_contingency', 'hipaa_baa_inventory', 'hipaa_baa_samples',
      'hipaa_workstation_use', 'hipaa_device_media',
      'hipaa_access_control', 'hipaa_unique_user', 'hipaa_encryption_rest', 'hipaa_audit_controls', 'hipaa_authentication', 'hipaa_transmission',
      'hipaa_risk_analysis_report', 'hipaa_security_awareness_program', 'hipaa_facility_security_plan'
    ],
    standard: [
      'hipaa_risk_analysis', 'hipaa_sanction_policy', 'hipaa_activity_review',
      'hipaa_security_officer', 'hipaa_workforce_authorization', 'hipaa_termination', 'hipaa_training',
      'hipaa_malware', 'hipaa_login_monitoring', 'hipaa_password', 'hipaa_incident', 'hipaa_incident_log',
      'hipaa_contingency', 'hipaa_backup', 'hipaa_dr', 'hipaa_contingency_testing', 'hipaa_evaluation',
      'hipaa_baa_inventory', 'hipaa_baa_samples',
      'hipaa_workforce_security_policy', 'hipaa_workforce_clearance', 'hipaa_access_establishment',
      'hipaa_security_awareness_program', 'hipaa_security_reminders', 'hipaa_login_monitoring_policy',
      'hipaa_security_incident_proc', 'hipaa_response_reporting', 'hipaa_contingency_procedures',
      'hipaa_applications_criticality', 'hipaa_baa_policy', 'hipaa_risk_analysis_report', 'hipaa_risk_management_plan',
      'hipaa_facility', 'hipaa_workstation_use', 'hipaa_workstation_security', 'hipaa_device_media',
      'hipaa_facility_security_plan', 'hipaa_access_control_validation', 'hipaa_device_disposal', 'hipaa_media_reuse',
      'hipaa_access_control', 'hipaa_unique_user', 'hipaa_automatic_logoff', 'hipaa_encryption_rest',
      'hipaa_audit_controls', 'hipaa_audit_samples', 'hipaa_integrity', 'hipaa_authentication', 'hipaa_transmission',
      'hipaa_emergency_access', 'hipaa_entity_authentication', 'hipaa_integrity_mechanism', 'hipaa_session_config'
    ],
    thorough: [
      'hipaa_risk_analysis', 'hipaa_risk_management', 'hipaa_sanction_policy', 'hipaa_activity_review',
      'hipaa_security_officer', 'hipaa_workforce_authorization', 'hipaa_termination', 'hipaa_training',
      'hipaa_malware', 'hipaa_login_monitoring', 'hipaa_password', 'hipaa_incident', 'hipaa_incident_log',
      'hipaa_contingency', 'hipaa_backup', 'hipaa_dr', 'hipaa_contingency_testing', 'hipaa_evaluation',
      'hipaa_baa_inventory', 'hipaa_baa_samples',
      'hipaa_workforce_security_policy', 'hipaa_workforce_clearance', 'hipaa_access_establishment',
      'hipaa_security_awareness_program', 'hipaa_security_reminders', 'hipaa_login_monitoring_policy',
      'hipaa_password_management_proc', 'hipaa_security_incident_proc', 'hipaa_response_reporting',
      'hipaa_contingency_procedures', 'hipaa_applications_criticality', 'hipaa_testing_revision',
      'hipaa_periodic_evaluation', 'hipaa_baa_policy', 'hipaa_baa_requirements', 'hipaa_subcontractor_baa',
      'hipaa_risk_analysis_report', 'hipaa_risk_management_plan', 'hipaa_workforce_sanctions', 'hipaa_ba_compliance_review',
      'hipaa_facility', 'hipaa_workstation_use', 'hipaa_workstation_security', 'hipaa_device_media',
      'hipaa_contingency_operations', 'hipaa_facility_security_plan', 'hipaa_access_control_validation',
      'hipaa_maintenance_records', 'hipaa_workstation_function', 'hipaa_device_disposal', 'hipaa_media_reuse', 'hipaa_accountability',
      'hipaa_access_control', 'hipaa_unique_user', 'hipaa_automatic_logoff', 'hipaa_encryption_rest',
      'hipaa_audit_controls', 'hipaa_audit_samples', 'hipaa_integrity', 'hipaa_authentication', 'hipaa_transmission',
      'hipaa_emergency_access', 'hipaa_entity_authentication', 'hipaa_integrity_mechanism',
      'hipaa_session_config', 'hipaa_encryption_mechanism', 'hipaa_hardware_software_records',
      'hipaa_audit_log_samples', 'hipaa_transmission_integrity'
    ]
  },
  GDPR: {
    quickStart: [
      'gdpr_ropa', 'gdpr_privacy_notice', 'gdpr_lawful_basis',
      'gdpr_dsar',
      'gdpr_processor_list', 'gdpr_dpa',
      'gdpr_security_measures', 'gdpr_breach_procedure',
      'gdpr_records_processing', 'gdpr_cross_border'
    ],
    standard: [
      'gdpr_ropa', 'gdpr_privacy_notice', 'gdpr_lawful_basis', 'gdpr_dpia',
      'gdpr_records_processing', 'gdpr_dpo_appointment', 'gdpr_cross_border',
      'gdpr_dsar', 'gdpr_dsar_log', 'gdpr_consent',
      'gdpr_processor_list', 'gdpr_dpa', 'gdpr_transfers',
      'gdpr_security_measures', 'gdpr_breach_procedure', 'gdpr_breach_log'
    ],
    thorough: [
      'gdpr_ropa', 'gdpr_privacy_notice', 'gdpr_lawful_basis', 'gdpr_dpia',
      'gdpr_records_processing', 'gdpr_dpo_appointment', 'gdpr_cross_border',
      'gdpr_dsar', 'gdpr_dsar_log', 'gdpr_consent',
      'gdpr_processor_list', 'gdpr_dpa', 'gdpr_transfers',
      'gdpr_security_measures', 'gdpr_breach_procedure', 'gdpr_breach_log'
    ]
  }
};


// TEMPLATE_LEVELS - Defines which levels are available for each framework
// Only show levels that have different item counts
// Apply template level for a single framework
function applyTemplateLevelForFramework(fwKey, level) {
  const allFw = getAllFrameworks();
  const fw = allFw[fwKey];
  if (!fw || !composerState[fwKey]?.enabled) return;
  
  const templateItems = DEFAULT_TEMPLATES[fwKey]?.[level] || [];
  const templateSet = new Set(templateItems);
  
  for (const g of (fw.controlGroups || [])) {
    if (!composerState[fwKey].groups[g.id]) continue;
    
    for (const item of (g.items || [])) {
      if (!composerState[fwKey].groups[g.id].items[item.id]) {
        composerState[fwKey].groups[g.id].items[item.id] = { 
          included: false, 
          instructions: '',
          editedDescription: null,
          editedFormats: null,
          guidanceCollapsed: false
        };
      }
      
      let shouldInclude = false;
      if (templateItems.length > 0) {
        shouldInclude = templateSet.has(item.id);
      } else {
        // Fallback for custom frameworks
        if (level === 'thorough') {
          shouldInclude = true;
        } else {
          shouldInclude = item.common === true;
        }
      }
      
      composerState[fwKey].groups[g.id].items[item.id].included = shouldInclude;
    }
  }
  
  renderComposer();
  saveFormState();
}

// Apply template level to all enabled frameworks (used on initial load)
function applyTemplateLevel(level) {
  const allFw = getAllFrameworks();
  for (const fwKey of Object.keys(allFw)) {
    if (composerState[fwKey]?.enabled) {
      composerState[fwKey].templateLevel = level;
      applyTemplateLevelForFramework(fwKey, level);
    }
  }
}

function getPayload() {
  const result = [];
  const allFw = getAllFrameworks();
  const auditPeriod = getAuditPeriodString();
  
  for (const [fk, fs] of Object.entries(composerState)) {
    if (!fs.enabled) continue;
    const fw = allFw[fk];
    if (!fw) continue;
    for (const g of (fw.controlGroups || [])) {
      const gs = fs.groups?.[g.id];
      if (!gs || gs.excluded) continue;
      for (const item of (g.items || [])) {
        const is = gs.items?.[item.id];
        if (!is?.included) continue;
        
        // Get description - use edited if available, otherwise default with audit period injection
        let description;
        if (is.editedDescription !== null) {
          // Use the auditor's edited version
          description = is.editedDescription;
        } else {
          // Use default with audit period injection for period-of-time items
          description = item.description || item.hint || '';
          if (auditPeriod && item.evidenceType === 'period-of-time' && description.includes('{{auditPeriod}}')) {
            description = description.replace(/\{\{auditPeriod\}\}/g, auditPeriod);
          }
        }
        
        // Get formats - use edited if available, otherwise default
        let expectedFormats;
        if (is.editedFormats !== null) {
          expectedFormats = is.editedFormats;
        } else {
          expectedFormats = item.expectedFormat ? item.expectedFormat.split(/,\s*|or\s+|\s+or\s+/).map(f => f.trim()).filter(Boolean) : [];
        }
        
        result.push({ 
          id: item.id, 
          framework: fw.label || fk, 
          group: g.title, 
          title: item.title, 
          instructions: is.instructions || '',
          // Client-facing fields (edited or defaults)
          description: description,
          expectedFormats: expectedFormats, // Now an array
          // Auditor-only fields (for reference, not shown to client)
          evidenceType: item.evidenceType || 'point-in-time',
          controlRef: item.controlRef || null,
          commonIssue: item.commonIssue || null
        });
      }
    }
  }
  return result;
}

// Show preview of what client will see
function showClientPreview() {
  const payload = getPayload();
  const company = $('#clientCompany')?.value || 'Your Client';
  const globalInstr = $('#globalInstructions')?.value || '';
  
  if (payload.length === 0) {
    alert('No evidence items selected. Please select at least one item to preview.');
    return;
  }
  
  // Group by framework
  const grouped = {};
  for (const item of payload) {
    const key = item.framework || 'General';
    if (!grouped[key]) grouped[key] = [];
    grouped[key].push(item);
  }
  
  let previewHtml = `
    <div style="margin-bottom: 16px;">
      <h4 style="margin: 0 0 8px;">Evidence Request for ${esc(company)}</h4>
      <p style="color: var(--text-muted); font-size: 0.9rem; margin: 0;">${payload.length} item${payload.length !== 1 ? 's' : ''} requested</p>
    </div>
  `;
  
  if (globalInstr) {
    previewHtml += `
      <div style="padding: 12px; background: rgba(16, 185, 129, 0.1); border-radius: 8px; margin-bottom: 16px; border-left: 3px solid var(--accent);">
        <strong style="font-size: 0.85rem;">Instructions from auditor:</strong>
        <p style="margin: 6px 0 0; font-size: 0.9rem;">${esc(globalInstr)}</p>
      </div>
    `;
  }
  
  for (const [framework, items] of Object.entries(grouped)) {
    previewHtml += `<div style="margin-bottom: 16px;"><h5 style="margin: 0 0 10px; color: var(--text-muted); font-size: 0.85rem; text-transform: uppercase;">${esc(framework)}</h5>`;
    
    for (const item of items) {
      let formatsHtml = '';
      if (item.expectedFormats && item.expectedFormats.length > 0) {
        formatsHtml = item.expectedFormats.map(f => `<span class="preview-item-format"> ${esc(f)}</span>`).join('');
      }
      
      previewHtml += `
        <div class="preview-item">
          <div class="preview-item-title">${esc(item.title)}</div>
          ${item.description ? `<div class="preview-item-description">${esc(item.description)}</div>` : ''}
          ${formatsHtml ? `<div style="margin-top: 8px;">${formatsHtml}</div>` : ''}
          ${item.instructions ? `<div class="preview-item-instructions"> ${esc(item.instructions)}</div>` : ''}
        </div>
      `;
    }
    
    previewHtml += '</div>';
  }
  
  // Show modal
  const modal = $('#previewModal');
  const content = $('#previewModalContent');
  if (modal && content) {
    content.innerHTML = previewHtml;
    modal.classList.remove('hidden');
  }
}

function closePreviewModal() {
  const modal = $('#previewModal');
  if (modal) modal.classList.add('hidden');
}

// ==================== CODE VALIDATION ====================

async function validateCode(code) {
  if (!code) return { valid: false, error: 'No code entered' };
  
  try {
    const res = await fetch(`${API}/check-code?code=${encodeURIComponent(code)}`);
    const data = await res.json();
    
    if (data.ok && data.remaining > 0) {
      return { 
        valid: true, 
        credits: data.remaining,
        message: data.remaining >= 9999 ? 'Unlimited credits' : `${data.remaining} credit${data.remaining !== 1 ? 's' : ''} remaining`
      };
    } else if (data.remaining === 0) {
      return { valid: false, error: 'No credits remaining on this code' };
    } else {
      return { valid: false, error: 'Invalid code' };
    }
  } catch (e) {
    return { valid: false, error: 'Error checking code' };
  }
}

function updateCodeUI(result) {
  const codeInput = $('#auditorCode');
  const codeStatus = $('#codeStatus');
  
  if (!codeInput || !codeStatus) return;
  
  if (result.valid) {
    codeInput.classList.remove('invalid');
    codeInput.classList.add('valid');
    codeStatus.className = 'code-status valid';
    codeStatus.textContent = `&#10003; Valid &mdash; ${result.message}`;
    state.codeValid = true;
    state.codeCredits = result.credits;
  } else if (result.error) {
    codeInput.classList.remove('valid');
    codeInput.classList.add('invalid');
    codeStatus.className = 'code-status invalid';
    codeStatus.textContent = `X ${result.error}`;
    state.codeValid = false;
  } else {
    codeInput.classList.remove('valid', 'invalid');
    codeStatus.className = 'code-status';
    codeStatus.textContent = '';
    state.codeValid = false;
  }
}

// ==================== CHECKOUT RETURN ====================

async function checkCheckoutReturn() {
  const url = new URL(location.href);
  const sessionId = url.searchParams.get('session_id');
  if (!sessionId) return false;
  
  state.isCheckoutReturn = true;
  
  // Clear URL
  url.searchParams.delete('session_id');
  window.history.replaceState({}, '', url.toString());
  
  // Check for existing session first (user might still be logged in)
  const hasSession = await checkExistingSession();
  
  // Restore saved form state
  const savedState = loadFormState();
  if (savedState) {
    restoreFormState(savedState);
  }
  
  // If logged in, show dashboard &mdash; polling will update credits
  if (hasSession || state.isLoggedIn) {
    showDashboard();
  } else {
    // Legacy: not logged in, show code-based flow
    if (savedState?.role === 'auditor') {
      handleRoleChange('auditor');
    } else {
      $('#roleSelect').value = 'auditor';
      handleRoleChange('auditor');
    }
    showPaymentSection();
    $('#purchaseSection').classList.add('hidden');
  }
  
  // Show success banner
  const successBanner = $('#successBanner');
  const successCodeDisplay = $('#successCodeDisplay');
  successBanner.classList.add('visible');
  successCodeDisplay.textContent = 'Loading...';
  
  const codeInput = $('#auditorCode');
  const codeStatus = $('#codeStatus');
  
  // Aggressive polling - keep trying every second for 90 seconds
  let code = null;
  let creditsText = '';
  let accountCredited = false;
  
  for (let attempt = 0; attempt < 90; attempt++) {
    try {
      const res = await fetch(`${API}/checkout/session?session_id=${sessionId}`);
      const data = await res.json();
      
      console.log(`Attempt ${attempt + 1}:`, data);
      
      // v6: Account-based credit return
      if (data.ok && data.accountCredit) {
        accountCredited = true;
        
        // Update local state with new credit balance
        if (state.user) {
          state.user.credits = typeof data.credits === 'number' ? data.credits : state.user.credits;
        }
        
        // Refresh session to get latest account state
        await checkExistingSession();
        
        successCodeDisplay.textContent = `+${data.creditsAdded} credits added!`;
        successBanner.querySelector('p:last-of-type').textContent = `Your account now has ${data.creditsDisplay}. You're ready to send requests.`;
        
        // Hide code input section since account users don't need codes
        if (codeInput) codeInput.closest('.form-group')?.classList.add('hidden');
        if (codeStatus) codeStatus.textContent = '';
        
        // Hide the entire payment section &mdash; user has credits now
        const paymentSec = $('#paymentSection');
        if (paymentSec) paymentSec.classList.remove('visible');
        state.paymentVisible = false;
        
        // Show dashboard with credits visible
        showDashboard();
        break;
      }
      
      // Legacy: code-based return
      if (data.ok && data.code) {
        code = data.code;
        state.code = code;
        state.codeValid = true;
        state.codeCredits = data.credits;
        creditsText = data.creditsDisplay || `${data.credits} credit${data.credits !== 1 ? 's' : ''} remaining`;
        break;
      }
      
      // Keep trying
      if (codeStatus) {
        codeStatus.innerHTML = `<span class="spinner"></span> Processing your purchase... (${attempt + 1}s)`;
      }
      
    } catch (e) {
      console.error('Checkout check error:', e);
    }
    
    await new Promise(r => setTimeout(r, 1000));
  }
  
  if (!accountCredited) {
    if (code) {
      // Legacy success - show the code
      successCodeDisplay.textContent = code;
      if (codeInput) {
        codeInput.value = code;
        codeInput.placeholder = 'ENTER CODE';
        codeInput.classList.add('valid');
      }
      if (codeStatus) {
        codeStatus.className = 'code-status valid';
        codeStatus.textContent = `&#10003; Valid &mdash; ${creditsText}`;
      }
      saveFormState();
    } else {
      // Fallback - tell them to check email
      successCodeDisplay.textContent = 'Check your email';
      successBanner.querySelector('p:last-of-type').textContent = 'Your code should arrive shortly. Enter it below when you receive it.';
      if (codeInput) {
        codeInput.value = '';
        codeInput.placeholder = 'ENTER CODE';
      }
      if (codeStatus) {
        codeStatus.className = 'code-status';
        codeStatus.textContent = 'Enter the code from your email';
      }
    }
  }
  
  updateMainButton();
  return true;
}

// ==================== UI STATE ====================

function handleRoleChange(role) {
  state.role = role;
  
  // Hide all flows first
  $('#newUserFlow').style.display = 'none';
  $('#returningUserFlow').style.display = 'none';
  $('#auditorFlow').style.display = 'none';
  $('#loggedInBar').style.display = 'none';
  $('#trialNoticeBar').style.display = 'none';
  $('#verificationNotice').style.display = 'none';
  
  if (role === 'new') {
    $('#newUserFlow').style.display = 'block';
    showNewUserSection('trial'); // Default to trial
  } else if (role === 'returning') {
    $('#returningUserFlow').style.display = 'block';
    showLoginSection();
  }
  // Note: 'auditor' role is set internally after auth
}

function showNewUserSection(type) {
  $('#trialCodeSection').style.display = type === 'trial' ? 'block' : 'none';
  $('#trialModeSection').style.display = 'none';
  $('#accountSection').style.display = type === 'account' ? 'block' : 'none';
}

function showLoginSection() {
  $('#loginSection').style.display = 'block';
  $('#forgotPasswordSection').style.display = 'none';
}

function showForgotPassword() {
  $('#loginSection').style.display = 'none';
  $('#forgotPasswordSection').style.display = 'block';
}

// ==================== DASHBOARD FUNCTIONS ====================

async function showDashboard() {
  // Hide auth flows and role selector
  $('#newUserFlow').style.display = 'none';
  $('#returningUserFlow').style.display = 'none';
  $('#auditorFlow').style.display = 'none';
  $('#roleSelectSection').style.display = 'none';
  
  // Show logged in bar
  $('#loggedInBar').style.display = 'flex';
  updateLoggedInBar();
  
  // Show verification notice if not verified
  if (state.user && !state.user.verified) {
    $('#verificationNotice').style.display = 'block';
  }
  
  // Show dashboard
  $('#dashboardView').style.display = 'block';
  
  // Reset dashboard title (in case it was changed by trial view)
  const title = $('#dashboardView').querySelector('.dashboard-title');
  const subtitle = $('#dashboardView').querySelector('.dashboard-subtitle');
  if (title) title.textContent = 'Your Evidence Requests';
  if (subtitle) subtitle.textContent = 'Manage your compliance evidence collection';
  
  // Reset "New Request" button
  const newReqBtn = $('#newRequestBtn');
  if (newReqBtn) newReqBtn.textContent = '+ New Evidence Request';
  
  // Remove any trial feature badges
  $('#dashboardView').querySelectorAll('.feature-badge').forEach(b => b.remove());
  
  // Fetch and render dashboard data
  await fetchAndRenderDashboard();
  
  // Check for saved draft
  const serverDraft = await loadDraftFromServer();
  const draftCard = $('#draftResumeCard');
  if (serverDraft && draftCard) {
    const company = serverDraft.clientCompany || 'Untitled';
    const savedDate = serverDraft.savedAt ? new Date(serverDraft.savedAt).toLocaleDateString() : '';
    const desc = $('#draftResumeDesc');
    if (desc) desc.textContent = (company !== '' ? company : 'Untitled request') + (savedDate ? ' \u2014 saved ' + savedDate : '');
    draftCard.style.display = 'flex';
    
    // Remove old listeners by replacing elements
    const resumeBtn = $('#resumeDraftBtn');
    const discardBtn = $('#discardDraftBtn');
    if (resumeBtn) {
      const newResume = resumeBtn.cloneNode(true);
      resumeBtn.parentNode.replaceChild(newResume, resumeBtn);
      newResume.id = 'resumeDraftBtn';
      newResume.addEventListener('click', () => {
        restoreDraftData(serverDraft);
        draftCard.style.display = 'none';
        showAuditorFlowFromDashboard();
        if (Object.keys(composerState).length === 0) initComposerState();
        renderComposer();
      });
    }
    if (discardBtn) {
      const newDiscard = discardBtn.cloneNode(true);
      discardBtn.parentNode.replaceChild(newDiscard, discardBtn);
      newDiscard.id = 'discardDraftBtn';
      newDiscard.addEventListener('click', () => {
        draftCard.style.display = 'none';
        deleteDraftFromServer();
      });
    }
  } else if (draftCard) {
    draftCard.style.display = 'none';
  }
  
  // Scroll to top
  $('#dashboardView').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function showAuditorFlowFromDashboard() {
  $('#dashboardView').style.display = 'none';
  $('#auditorFlow').style.display = 'block';
  $('#backToDashboard').style.display = 'block';
  if (Object.keys(composerState).length === 0) initComposerState();
  renderComposer();
}

async function fetchAndRenderDashboard() {
  if (!state.authToken) {
    renderDashboardError('Not authenticated');
    return;
  }
  
  // Show loading state
  $('#activeRequestsList').innerHTML = '<div class="loading-placeholder">Loading requests...</div>';
  $('#completedRequestsList').innerHTML = '<div class="loading-placeholder">Loading...</div>';
  
  let retries = 2;
  while (retries >= 0) {
    try {
      const res = await fetch(`${API}/auth/requests`, {
        headers: { 'Authorization': `Bearer ${state.authToken}` }
      });
      
      if (!res.ok) {
        throw new Error(`HTTP ${res.status}`);
      }
      
      const data = await res.json();
      
      if (data.ok) {
        renderDashboard(data.requests || [], data.stats || {});
        return; // Success - exit
      } else {
        throw new Error(data.error || 'Failed to load');
      }
    } catch (e) {
      console.error('Dashboard fetch error (retries left: ' + retries + '):', e);
      retries--;
      if (retries >= 0) {
        await new Promise(r => setTimeout(r, 500)); // Wait 500ms before retry
      }
    }
  }
  
  // All retries failed
  renderDashboardError('Error loading dashboard. Please refresh the page.');
}

function renderDashboard(requests, stats) {
  // Update stats
  $('#statActive').textContent = stats.activeRequests || 0;
  $('#statCompleted').textContent = stats.completedRequests || 0;
  $('#statEvidence').textContent = stats.totalEvidenceCollected || 0;
  $('#statThisMonth').textContent = stats.requestsThisMonth || 0;
  
  // Show/hide credit alert based on credit balance
  const credits = state.user?.credits || 0;
  const creditAlert = $('#creditAlert');
  if (credits <= 2) {
    creditAlert.style.display = 'flex';
    $('#creditAlertCount').textContent = credits;
    
    if (credits === 0) {
      creditAlert.classList.add('critical');
      $('#creditAlertTitle').textContent = 'No credits remaining';
      $('#creditAlertDesc').innerHTML = 'You need to <strong>purchase credits</strong> to send new evidence requests.';
    } else {
      creditAlert.classList.remove('critical');
      $('#creditAlertTitle').textContent = credits === 1 ? 'Last credit remaining' : 'Running low on credits';
      $('#creditAlertDesc').innerHTML = `You have <strong>${credits}</strong> credit${credits !== 1 ? 's' : ''} remaining.`;
    }
  } else {
    creditAlert.style.display = 'none';
  }
  
  // Split requests into active, completed, and cancelled
  const active = requests.filter(r => r.status === 'pending');
  const completed = requests.filter(r => r.status === 'complete');
  const cancelled = requests.filter(r => r.status === 'cancelled');
  
  // Render active requests
  const activeList = $('#activeRequestsList');
  if (active.length === 0) {
    activeList.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">/div>
        <div class="empty-state-text">No active requests. Click "New Evidence Request" to get started.</div>
      </div>
    `;
  } else {
    activeList.innerHTML = active.map(r => renderRequestCard(r, 'active')).join('');
  }
  
  // Render completed requests (include cancelled at the bottom)
  const completedList = $('#completedRequestsList');
  const allDone = [...completed, ...cancelled];
  if (allDone.length === 0) {
    completedList.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">&#10003;</div>
        <div class="empty-state-text">No completed requests yet.</div>
      </div>
    `;
  } else {
    completedList.innerHTML = allDone.map(r => renderRequestCard(r, r.status === 'cancelled' ? 'cancelled' : 'completed')).join('');
  }
  
  // Render templates
  renderTemplatesSection();
  
  // Wire up action buttons
  wireRequestActions();
  wireTemplateActions();
}

function renderTemplatesSection() {
  const templates = state.user?.templates || [];
  const templatesList = $('#templatesList');
  const templateCount = $('#templateCount');
  
  templateCount.textContent = `(${templates.length})`;
  
  if (templates.length === 0) {
    templatesList.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">/div>
        <div class="empty-state-text">No saved templates. Create a request and save it as a template for reuse.</div>
      </div>
    `;
  } else {
    templatesList.innerHTML = templates.map(t => renderTemplateCard(t)).join('');
  }
}

function renderTemplateCard(template) {
  const created = new Date(template.createdAt);
  const createdStr = created.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
  
  // Count frameworks enabled
  const fwCount = Object.values(template.composerState || {}).filter(fw => fw.enabled).length;
  
  // Count total items
  let itemCount = 0;
  for (const fwKey in template.composerState || {}) {
    const fw = template.composerState[fwKey];
    if (!fw.enabled) continue;
    for (const gKey in fw.groups || {}) {
      const g = fw.groups[gKey];
      if (g.excluded) continue;
      for (const iKey in g.items || {}) {
        if (g.items[iKey].included) itemCount++;
      }
    }
  }
  
  return `
    <div class="template-card" data-template-id="${esc(template.id)}">
      <div class="template-info">
        <h4 class="template-name">${esc(template.name)}</h4>
        <div class="template-meta">${fwCount} framework${fwCount !== 1 ? 's' : ''} - ${itemCount} items - Created ${createdStr}</div>
      </div>
      <div class="template-actions">
        <button class="template-action-btn use" data-action="use-template" data-id="${esc(template.id)}">Use</button>
        <button class="template-action-btn" data-action="duplicate-template" data-id="${esc(template.id)}">Duplicate</button>
        <button class="template-action-btn delete" data-action="delete-template" data-id="${esc(template.id)}">Delete</button>
      </div>
    </div>
  `;
}

function wireTemplateActions() {
  // Use template
  $$('[data-action="use-template"]').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.dataset.id;
      useTemplateFromDashboard(id);
    });
  });
  
  // Duplicate template
  $$('[data-action="duplicate-template"]').forEach(btn => {
    btn.addEventListener('click', async () => {
      const id = btn.dataset.id;
      await duplicateTemplate(id);
    });
  });
  
  // Delete template
  $$('[data-action="delete-template"]').forEach(btn => {
    btn.addEventListener('click', async () => {
      const id = btn.dataset.id;
      await deleteTemplateFromDashboard(id);
    });
  });
}

function useTemplateFromDashboard(templateId) {
  const template = state.user?.templates?.find(t => t.id === templateId);
  if (!template) return;
  
  // Hide dashboard, show composer
  $('#dashboardView').style.display = 'none';
  $('#backToDashboard').style.display = 'block';
  
  // Reset form first
  resetComposerForm();
  
  // Load template
  loadTemplate(templateId);
  
  // Show auditor flow
  $('#auditorFlow').style.display = 'block';
  
  // Set auditor email
  if (state.user?.email) {
    setChipEmails('auditorEmailsContainer', [state.user.email]);
  }
  
  $('#auditorFlow').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

async function duplicateTemplate(templateId) {
  const template = state.user?.templates?.find(t => t.id === templateId);
  if (!template) return;
  
  const newName = prompt('Enter name for duplicated template:', template.name + ' (Copy)');
  if (!newName || !newName.trim()) return;
  
  try {
    const res = await fetch(`${API}/auth/templates`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${state.authToken}`
      },
      body: JSON.stringify({
        name: newName.trim(),
        composerState: template.composerState,
        customFrameworks: template.customFrameworks,
        globalInstructions: template.globalInstructions || ''
      })
    });
    
    const data = await res.json();
    
    if (data.ok && data.template) {
      state.user.templates = state.user.templates || [];
      state.user.templates.push(data.template);
      renderTemplatesSection();
      wireTemplateActions();
    } else {
      alert(data.error || 'Error duplicating template');
    }
  } catch (e) {
    alert('Error duplicating template');
  }
}

async function deleteTemplateFromDashboard(templateId) {
  const template = state.user?.templates?.find(t => t.id === templateId);
  if (!template) return;
  
  if (!confirm(`Delete template "${template.name}"? This cannot be undone.`)) return;
  
  try {
    const res = await fetch(`${API}/auth/templates?id=${templateId}`, {
      method: 'DELETE',
      headers: { 'Authorization': `Bearer ${state.authToken}` }
    });
    
    const data = await res.json();
    
    if (data.ok) {
      state.user.templates = state.user.templates.filter(t => t.id !== templateId);
      renderTemplatesSection();
      wireTemplateActions();
      updateLoggedInBar(); // Update template dropdown in composer if visible
    } else {
      alert(data.error || 'Error deleting template');
    }
  } catch (e) {
    alert('Error deleting template');
  }
}

function renderRequestCard(req, type) {
  const deadline = req.deadlineISO ? new Date(req.deadlineISO) : null;
  const created = new Date(req.createdAt);
  const now = new Date();
  
  // Format dates
  const deadlineStr = deadline ? deadline.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'No deadline';
  const createdStr = created.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  
  // Check if overdue
  const isOverdue = deadline && deadline < now && req.status === 'pending';
  
  // Calculate days overdue
  const daysOverdue = isOverdue ? Math.floor((now - deadline) / (1000 * 60 * 60 * 24)) : 0;
  
  // Status display
  let statusHtml = '';
  if (req.status === 'cancelled') {
    const cancelDate = req.cancelledAt ? new Date(req.cancelledAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '';
    statusHtml = `<div class="request-status cancelled"><span class="status-dot"></span> Cancelled${cancelDate ? ` ${cancelDate}` : ''}</div>`;
  } else if (req.status === 'pending') {
    if (isOverdue) {
      statusHtml = `<div class="request-status pending"><span class="status-dot"></span> Overdue ${daysOverdue > 0 ? `(${daysOverdue}d)` : ''}</div>`;
    } else {
      statusHtml = '<div class="request-status pending"><span class="status-dot"></span> Waiting for upload</div>';
    }
  } else {
    const submittedDate = req.submittedAt ? new Date(req.submittedAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '';
    statusHtml = `<div class="request-status complete"><span class="status-dot"></span> Completed${submittedDate ? ` ${submittedDate}` : ''}</div>`;
  }
  
  // Framework tags
  const fwTags = (req.frameworks || []).map(fw => `<span class="request-fw-tag">${esc(fw)}</span>`).join('');
  
  // Client link URL
  const clientLink = `${location.origin}?t=${req.token}`;
  
  // Actions based on type and status
  let actionsHtml = '';
  if (type === 'active') {
    actionsHtml = `
      <button class="request-action-btn" data-action="copy-link" data-token="${esc(req.token)}">Copy Client Link</button>
      <button class="request-action-btn" data-action="resend" data-token="${esc(req.token)}">Resend Email</button>
      <button class="request-action-btn danger" data-action="cancel-request" data-token="${esc(req.token)}" data-company="${esc(req.company || '')}">Cancel</button>
    `;
    // Add extend deadline for overdue requests
    if (isOverdue && req.extendToken) {
      actionsHtml += `
        <button class="request-action-btn primary" data-action="extend" data-extend-token="${esc(req.extendToken)}" data-company="${esc(req.company || '')}">Extend Deadline</button>
      `;
    }
  } else if (type === 'cancelled') {
    actionsHtml = `
      <span style="font-size:0.8rem;color:var(--text-muted);opacity:0.6;">Credit refunded</span>
    `;
  } else {
    actionsHtml = `
      <button class="request-action-btn primary" data-action="view-pack" data-token="${esc(req.token)}">View ProofPack</button>
      <button class="request-action-btn" data-action="copy-link" data-token="${esc(req.token)}">Copy Client Link</button>
    `;
  }
  
  // Add overdue alert banner for overdue requests
  let overdueAlertHtml = '';
  if (isOverdue) {
    overdueAlertHtml = `
      <div class="request-overdue-alert">
        &#9888; Deadline passed ${daysOverdue > 0 ? `${daysOverdue} day${daysOverdue !== 1 ? 's' : ''} ago` : 'today'}. Client can still upload late, or you can extend the deadline.
      </div>
    `;
  }

  // Reminder status indicator
  let reminderHtml = '';
  if (req.reminderStatus) {
    const rs = req.reminderStatus;
    if (rs.state === 'scheduled') {
      const nextDate = new Date(rs.nextAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
      reminderHtml = '<div class="request-reminder-status scheduled">&#128276; Reminder scheduled: ' + nextDate + '</div>';
    } else if (rs.state === 'imminent') {
      reminderHtml = '<div class="request-reminder-status imminent">&#128276; Reminder sending soon</div>';
    } else if (rs.state === 'overdue') {
      reminderHtml = '<div class="request-reminder-status overdue">&#9888; Deadline-passed notifications sent</div>';
    } else if (rs.state === 'cancelled') {
      reminderHtml = '<div class="request-reminder-status complete">&#10003; Submitted &mdash; reminders cancelled</div>';
    }
  }
  
  return `
    <div class="request-card ${isOverdue ? 'overdue' : ''}" data-token="${esc(req.token)}">
      ${overdueAlertHtml}
      <div class="request-card-header">
        <div>
          <h4 class="request-company">${esc(req.company || 'Unnamed Request')}</h4>
          <div class="request-frameworks">${fwTags}</div>
        </div>
        ${statusHtml}
      </div>
      <div class="request-meta">
        <div class="request-meta-item">
          &#9993; ${esc(req.clientEmail || 'No client email')}
        </div>
        <div class="request-meta-item">
          &#128197; Due: ${deadlineStr}
        </div>
        <div class="request-meta-item">
          &#128196; ${req.totalItems || 0} evidence items
        </div>
      </div>
      ${reminderHtml}
      <div class="request-actions">
        ${actionsHtml}
      </div>
    </div>
  `;
}

function wireRequestActions() {
  // Copy link buttons
  $$('[data-action="copy-link"]').forEach(btn => {
    btn.addEventListener('click', async () => {
      const token = btn.dataset.token;
      const link = `${location.origin}?t=${token}`;
      try {
        await navigator.clipboard.writeText(link);
        const originalText = btn.textContent;
        btn.textContent = 'Copied!';
        setTimeout(() => btn.textContent = originalText, 2000);
      } catch (e) {
        alert('Link: ' + link);
      }
    });
  });
  
  // Resend email buttons
  $$('[data-action="resend"]').forEach(btn => {
    btn.addEventListener('click', async () => {
      const token = btn.dataset.token;
      // For now, just copy the link - full resend would need a new endpoint
      const link = `${location.origin}?t=${token}`;
      try {
        await navigator.clipboard.writeText(link);
        btn.textContent = 'Link Copied!';
        setTimeout(() => btn.textContent = 'Resend Email', 2000);
      } catch (e) {
        alert('Share this link with your client: ' + link);
      }
    });
  });
  
  // View pack buttons
  $$('[data-action="view-pack"]').forEach(btn => {
    btn.addEventListener('click', () => {
      const token = btn.dataset.token;
      // Open the viewer - this will show the pack if available
      window.open(`${API}/d?t=${token}`, '_blank');
    });
  });
  
  // Extend deadline buttons
  $$('[data-action="extend"]').forEach(btn => {
    btn.addEventListener('click', async () => {
      const extendToken = btn.dataset.extendToken;
      const company = btn.dataset.company || 'this request';
      
      const days = prompt(`Extend deadline for "${company}" by how many days?`, '7');
      if (!days || isNaN(parseInt(days))) return;
      
      btn.disabled = true;
      btn.textContent = 'Extending...';
      
      try {
        const res = await fetch(`${API}/extend?t=${extendToken}&days=${parseInt(days)}`);
        const data = await res.json();
        
        if (data.ok) {
          alert(`Deadline extended by ${days} days. New deadline: ${new Date(data.deadlineISO).toLocaleDateString()}`);
          // Refresh dashboard to show updated deadline
          await fetchAndRenderDashboard();
        } else {
          alert('Error extending deadline: ' + (data.error || 'Unknown error'));
          btn.disabled = false;
          btn.textContent = 'Extend Deadline';
        }
      } catch (e) {
        alert('Error extending deadline: ' + e.message);
        btn.disabled = false;
        btn.textContent = 'Extend Deadline';
      }
    });
  });

  // Cancel request buttons
  $$('[data-action="cancel-request"]').forEach(btn => {
    btn.addEventListener('click', async () => {
      const token = btn.dataset.token;
      const company = btn.dataset.company || 'this request';
      
      const confirmed = confirm(`Cancel the evidence request for "${company}"?\n\nThis will:\n Deactivate the client upload link\n Cancel any pending reminder emails\n The request cannot be reopened\n\nAre you sure?`);
      if (!confirmed) return;
      
      btn.disabled = true;
      btn.textContent = 'Cancelling...';
      
      try {
        const res = await fetch(`${API}/request/cancel`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${state.session?.token || ''}` },
          body: JSON.stringify({ token }),
        });
        const data = await res.json();
        
        if (data.ok) {
          // Refresh dashboard
          await fetchAndRenderDashboard();
        } else {
          alert('Error cancelling request: ' + (data.error || 'Unknown error'));
          btn.disabled = false;
          btn.textContent = 'Cancel';
        }
      } catch (e) {
        alert('Error cancelling request: ' + e.message);
        btn.disabled = false;
        btn.textContent = 'Cancel';
      }
    });
  });
}

function renderDashboardError(message) {
  $('#activeRequestsList').innerHTML = `<div class="empty-state"><div class="empty-state-text">${esc(message)}</div></div>`;
  $('#completedRequestsList').innerHTML = '';
}

function showComposerFromDashboard() {
  // Hide dashboard
  $('#dashboardView').style.display = 'none';
  
  // Show back link
  $('#backToDashboard').style.display = 'block';
  
  // Reset form for new request
  resetComposerForm();
  
  // Show auditor flow
  $('#auditorFlow').style.display = 'block';
  if (Object.keys(composerState).length === 0) initComposerState();
  renderComposer();
  
  // Set auditor email to current user
  if (state.user?.email) {
    setChipEmails('auditorEmailsContainer', [state.user.email]);
  }
  
  // Scroll to form
  $('#auditorFlow').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function resetComposerForm() {
  // Clear client info
  const clientCompany = $('#clientCompany');
  if (clientCompany) clientCompany.value = '';
  
  // Clear client emails
  setChipEmails('clientEmailsContainer', []);
  
  // Reset deadline to 5 days from now
  const picker = $('#deadlinePicker');
  if (picker && picker._flatpickr) {
    const defaultDeadline = new Date();
    defaultDeadline.setDate(defaultDeadline.getDate() + 5);
    defaultDeadline.setHours(17, 0, 0, 0);
    picker._flatpickr.setDate(defaultDeadline);
  }
  
  // Reset composer state
  composerState = {};
  customFrameworks = [];
  initComposerState();
  
  // Hide template loaded notice
  const notice = $('#templateLoadedNotice');
  if (notice) notice.style.display = 'none';
}

function backToDashboard() {
  // Hide composer
  $('#auditorFlow').style.display = 'none';
  $('#backToDashboard').style.display = 'none';
  
  // Show dashboard
  showDashboard();
}

// ==================== END DASHBOARD FUNCTIONS ====================

function showAuditorFlow() {
  // Hide auth flows and dashboard
  $('#newUserFlow').style.display = 'none';
  $('#returningUserFlow').style.display = 'none';
  $('#dashboardView').style.display = 'none';
  
  // Show appropriate header
  if (state.isLoggedIn) {
    $('#loggedInBar').style.display = 'flex';
    updateLoggedInBar();
    
    // Show verification notice if not verified
    if (state.user && !state.user.verified) {
      $('#verificationNotice').style.display = 'block';
    }
  } else if (state.isTrialUser) {
    $('#trialNoticeBar').style.display = 'flex';
  }
  
  // Show auditor flow
  $('#auditorFlow').style.display = 'block';
  if (Object.keys(composerState).length === 0) initComposerState();
  renderComposer();
  
  // Scroll to form
  $('#auditorFlow').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function updateLoggedInBar() {
  if (!state.user) return;
  
  $('#currentUserEmail').textContent = state.user.email;
  
  const credits = state.user.credits || 0;
  const badge = $('#creditsDisplay');
  badge.textContent = `${credits} credit${credits !== 1 ? 's' : ''}`;
  badge.className = 'credits-badge' + (credits === 0 ? ' empty' : credits <= 2 ? ' low' : '');
  
  // Update template selector (in Evidence Request section)
  const templates = state.user.templates || [];
  const loaderSection = $('#templateLoaderSection');
  const select = $('#templateSelect');
  
  if (templates.length > 0 && loaderSection && select) {
    loaderSection.style.display = 'block';
    select.innerHTML = '<option value="">Load a saved template...</option>';
    templates.forEach(t => {
      select.innerHTML += `<option value="${esc(t.id)}">${esc(t.name)}</option>`;
    });
  } else if (loaderSection) {
    loaderSection.style.display = 'none';
  }
}

// ==================== AUTH FUNCTIONS ====================

async function checkExistingSession() {
  const token = localStorage.getItem('proofrepo_token');
  if (!token) return false;
  
  try {
    const res = await fetch(`${API}/auth/me`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    
    if (res.ok) {
      const data = await res.json();
      if (data.ok && data.user) {
        state.isLoggedIn = true;
        state.authToken = token;
        state.user = data.user;
        return true;
      }
    }
    
    // Invalid token
    localStorage.removeItem('proofrepo_token');
    return false;
  } catch (e) {
    return false;
  }
}

function showAuthStatus(elementId, message, type) {
  const el = $(`#${elementId}`);
  if (!el) return;
  el.textContent = message;
  el.className = `auth-status visible ${type}`;
}

function hideAuthStatus(elementId) {
  const el = $(`#${elementId}`);
  if (el) el.className = 'auth-status';
}

async function handleApplyTrialCode() {
  const code = ($('#trialCodeInput')?.value || '').trim().toUpperCase();
  const btn = $('#applyTrialBtn');
  
  if (!code) {
    showAuthStatus('trialStatus', 'Please enter a trial code', 'error');
    return;
  }
  
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Checking...';
  showAuthStatus('trialStatus', 'Validating code...', 'loading');
  
  try {
    const res = await fetch(`${API}/auth/validate-trial?code=${encodeURIComponent(code)}`);
    const data = await res.json();
    
    if (data.ok && data.valid) {
      state.code = code;
      state.codeValid = true;
      state.codeCredits = data.credits || 1;
      
      hideAuthStatus('trialStatus');
      
      // Show trial mode section
      $('#trialCodeSection').style.display = 'none';
      $('#trialModeSection').style.display = 'block';
    } else {
      showAuthStatus('trialStatus', data.error || 'Invalid trial code', 'error');
    }
  } catch (e) {
    showAuthStatus('trialStatus', 'Error validating code. Please try again.', 'error');
  }
  
  btn.disabled = false;
  btn.textContent = 'Apply Code';
}

function handleTrialModeChange() {
  const mode = document.querySelector('input[name="trialMode"]:checked')?.value || 'live';
  state.trialMode = mode;
  $('#testModeExplainer').style.display = mode === 'test' ? 'block' : 'none';
}

async function handleStartTrial() {
  const email = ($('#trialUserEmail')?.value || '').trim().toLowerCase();
  
  if (!email || !email.includes('@') || !email.includes('.')) {
    alert('Please enter a valid email address');
    return;
  }
  
  state.trialEmail = email;
  state.isTrialUser = true;
  state.trialCode = ($('#trialCodeInput')?.value || '').trim().toUpperCase();
  
  // Pre-fill auditor email
  setChipEmails('auditorEmailsContainer', [email]);
  
  // If test mode, also pre-fill client email
  if (state.trialMode === 'test') {
    setChipEmails('clientEmailsContainer', [email]);
    $('#clientCompany').value = 'Test Company';
  }
  
  // Show trial dashboard instead of going straight to builder
  showTrialDashboard();
}

async function showTrialDashboard() {
  // Hide auth flows
  $('#newUserFlow').style.display = 'none';
  $('#returningUserFlow').style.display = 'none';
  
  // Show trial notice bar
  $('#trialNoticeBar').style.display = 'flex';
  
  // Configure dashboard for trial view
  const dashboard = $('#dashboardView');
  dashboard.style.display = 'block';
  
  // Update header
  const title = dashboard.querySelector('.dashboard-title');
  const subtitle = dashboard.querySelector('.dashboard-subtitle');
  if (title) title.textContent = 'Welcome to ProofRepo';
  if (subtitle) subtitle.textContent = 'Here\'s what your dashboard looks like with an account';
  
  // Set stats to demo values
  $('#statActive').textContent = '0';
  $('#statCompleted').textContent = '0';
  $('#statEvidence').textContent = '0';
  $('#statThisMonth').textContent = '0';
  
  // Active Requests - trial empty state
  const activeList = $('#activeRequestsList');
  if (activeList) {
    activeList.innerHTML = '<div class="empty-state">' +
      '<div class="empty-state-icon">\ud83d\udce8</div>' +
      '<div class="empty-state-title">Track Evidence Requests</div>' +
      '<div class="empty-state-desc">See real-time status of every request you send \u2014 pending, in-progress, submitted. Never wonder where your evidence stands.</div>' +
      '</div>';
  }
  
  // Completed - trial empty state
  const completedList = $('#completedRequestsList');
  if (completedList) {
    completedList.innerHTML = '<div class="empty-state">' +
      '<div class="empty-state-icon">\u2705</div>' +
      '<div class="empty-state-title">Review Completed ProofPacks</div>' +
      '<div class="empty-state-desc">Download organized evidence, view match reports, and copy workpaper-ready logs. All in one place.</div>' +
      '</div>';
  }
  
  // Templates - trial empty state with badge
  const templatesList = $('#templatesList');
  if (templatesList) {
    templatesList.innerHTML = '<div class="empty-state">' +
      '<div class="empty-state-icon">\ud83d\udcbe</div>' +
      '<div class="empty-state-title">Saved Templates <span class="feature-badge">\u2726 Account Feature</span></div>' +
      '<div class="empty-state-desc">Save your evidence configurations for repeat audits. Load a template and send a new request in seconds \u2014 no rebuilding from scratch.</div>' +
      '</div>';
  }
  
  // Add feature badges to section titles
  const sectionTitles = dashboard.querySelectorAll('.section-title');
  sectionTitles.forEach(t => {
    if (t.textContent.includes('Active') || t.textContent.includes('Completed') || t.textContent.includes('Template')) {
      if (!t.querySelector('.feature-badge')) {
        t.insertAdjacentHTML('beforeend', ' <span class="feature-badge">\u2726 Account Feature</span>');
      }
    }
  });
  
  // Hide credit alert for trial users
  const creditAlert = $('#creditAlert');
  if (creditAlert) creditAlert.style.display = 'none';
  
  // Check for saved draft from server
  const serverDraft = await loadDraftFromServer();
  if (serverDraft) {
    const draftCard = $('#draftResumeCard');
    if (draftCard) {
      const company = serverDraft.clientCompany || 'Untitled';
      const savedDate = serverDraft.savedAt ? new Date(serverDraft.savedAt).toLocaleDateString() : '';
      const desc = $('#draftResumeDesc');
      if (desc) desc.textContent = company + (savedDate ? ' \u2014 saved ' + savedDate : '');
      draftCard.style.display = 'flex';
      
      $('#resumeDraftBtn')?.addEventListener('click', () => {
        restoreDraftData(serverDraft);
        showAuditorFlow();
        if (Object.keys(composerState).length === 0) initComposerState();
        renderComposer();
      });
      
      $('#discardDraftBtn')?.addEventListener('click', () => {
        draftCard.style.display = 'none';
        deleteDraftFromServer();
      });
    }
  }
  
  // Change "New Request" button to work for trial
  const newReqBtn = $('#newRequestBtn');
  if (newReqBtn) {
    newReqBtn.textContent = '\u2192 Start Your Free Request';
    newReqBtn.onclick = () => showAuditorFlow();
  }
}

function validatePassword(password) {
  const reqs = {
    length: password.length >= 8,
    number: /\d/.test(password),
    special: /[!@#$%^&*(),.?":{}|<>_\-+=\[\]\\\/`~;']/.test(password)
  };
  
  Object.entries(reqs).forEach(([key, valid]) => {
    const el = $(`.password-reqs .req[data-req="${key}"]`);
    if (el) el.classList.toggle('valid', valid);
  });
  
  return Object.values(reqs).every(Boolean);
}

async function handleSignup() {
  const email = ($('#signupEmail')?.value || '').trim().toLowerCase();
  const password = $('#signupPassword')?.value || '';
  const confirm = $('#signupPasswordConfirm')?.value || '';
  const btn = $('#signupBtn');
  
  if (!email || !email.includes('@')) {
    showAuthStatus('signupStatus', 'Please enter a valid email', 'error');
    return;
  }
  
  if (!validatePassword(password)) {
    showAuthStatus('signupStatus', 'Password does not meet requirements', 'error');
    return;
  }
  
  if (password !== confirm) {
    showAuthStatus('signupStatus', 'Passwords do not match', 'error');
    return;
  }
  
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Creating...';
  showAuthStatus('signupStatus', 'Creating account...', 'loading');
  
  try {
    const res = await fetch(`${API}/auth/signup`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password })
    });
    
    const data = await res.json();
    
    if (data.ok) {
      showAuthStatus('signupStatus', '&#10003; Account created! Check your email to verify.', 'success');
      
      // Auto-login but mark as unverified
      if (data.token && data.user) {
        state.isLoggedIn = true;
        state.authToken = data.token;
        state.user = data.user;
        localStorage.setItem('proofrepo_token', data.token);
        
        setTimeout(() => showDashboard(), 1500);
      }
    } else {
      showAuthStatus('signupStatus', data.error || 'Error creating account', 'error');
    }
  } catch (e) {
    showAuthStatus('signupStatus', 'Error connecting to server', 'error');
  }
  
  btn.disabled = false;
  btn.textContent = 'Create Account';
}

async function handleLogin() {
  const email = ($('#loginEmail')?.value || '').trim().toLowerCase();
  const password = $('#loginPassword')?.value || '';
  const remember = $('#rememberMe')?.checked;
  const btn = $('#loginBtn');
  
  if (!email || !password) {
    showAuthStatus('loginStatus', 'Please enter email and password', 'error');
    return;
  }
  
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Signing in...';
  showAuthStatus('loginStatus', 'Signing in...', 'loading');
  
  try {
    const res = await fetch(`${API}/auth/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password, remember })
    });
    
    const data = await res.json();
    
    if (data.ok && data.token) {
      state.isLoggedIn = true;
      state.authToken = data.token;
      state.user = data.user;
      localStorage.setItem('proofrepo_token', data.token);
      
      showAuthStatus('loginStatus', '&#10003; Signed in!', 'success');
      
      setTimeout(() => showDashboard(), 500);
    } else {
      showAuthStatus('loginStatus', data.error || 'Invalid email or password', 'error');
    }
  } catch (e) {
    showAuthStatus('loginStatus', 'Error connecting to server', 'error');
  }
  
  btn.disabled = false;
  btn.textContent = 'Sign In';
}

async function handleForgotPassword() {
  const email = ($('#resetEmail')?.value || '').trim().toLowerCase();
  const btn = $('#sendResetBtn');
  
  if (!email || !email.includes('@')) {
    showAuthStatus('resetStatus', 'Please enter a valid email', 'error');
    return;
  }
  
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Sending...';
  
  try {
    await fetch(`${API}/auth/forgot-password`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email })
    });
    
    // Always show success to prevent enumeration
    showAuthStatus('resetStatus', '&#10003; If an account exists, a reset link was sent.', 'success');
  } catch (e) {
    showAuthStatus('resetStatus', 'Error sending reset link', 'error');
  }
  
  btn.disabled = false;
  btn.textContent = 'Send Reset Link';
}

async function handleResetPassword() {
  const pw = ($('#newPassword')?.value || '');
  const pw2 = ($('#confirmNewPassword')?.value || '');
  const btn = $('#resetPasswordBtn');
  
  if (pw.length < 8 || !/\d/.test(pw) || !/[!@#$%^&*(),.?":{}|<>_\-+=\[\]\\\/`~;']/.test(pw)) {
    showAuthStatus('resetPasswordStatus', 'Password must be 8+ chars with 1 number and 1 special character', 'error');
    return;
  }
  
  if (pw !== pw2) {
    showAuthStatus('resetPasswordStatus', 'Passwords do not match', 'error');
    return;
  }
  
  const resetToken = new URLSearchParams(window.location.search).get('reset');
  if (!resetToken) {
    showAuthStatus('resetPasswordStatus', 'Missing reset token', 'error');
    return;
  }
  
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Resetting...';
  
  try {
    const res = await fetch(`${API}/auth/reset-password`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ token: resetToken, password: pw })
    });
    
    const data = await res.json();
    
    if (data.ok) {
      showAuthStatus('resetPasswordStatus', '&#10003; Password reset! You can now sign in with your new password.', 'success');
      // Clean URL and show login after a moment
      setTimeout(() => {
        window.history.replaceState({}, '', window.location.pathname);
        $('#resetPasswordSection').style.display = 'none';
        $('#roleSelect').value = 'returning';
        handleRoleChange('returning');
      }, 2500);
    } else {
      showAuthStatus('resetPasswordStatus', data.error || 'Reset failed', 'error');
    }
  } catch (e) {
    showAuthStatus('resetPasswordStatus', 'Error connecting to server', 'error');
  }
  
  btn.disabled = false;
  btn.textContent = 'Reset Password';
}

// Check URL for reset token and show reset form
function checkResetToken() {
  const params = new URLSearchParams(window.location.search);
  const resetToken = params.get('reset');
  if (!resetToken) return false;
  
  // Show returning customer path with reset form
  $('#roleSelect').value = 'returning';
  handleRoleChange('returning');
  
  // Hide the login/forgot sections, show reset form
  $('#loginSection').style.display = 'none';
  $('#forgotPasswordSection').style.display = 'none';
  $('#resetPasswordSection').style.display = 'block';
  
  return true;
}

function handleLogout() {
  state.isLoggedIn = false;
  state.authToken = null;
  state.user = null;
  localStorage.removeItem('proofrepo_token');
  
  // Reset UI
  $('#loggedInBar').style.display = 'none';
  $('#auditorFlow').style.display = 'none';
  $('#dashboardView').style.display = 'none';
  $('#verificationNotice').style.display = 'none';
  $('#roleSelectSection').style.display = 'block';
  $('#roleSelect').value = '';
}

async function handleResendVerification() {
  if (!state.authToken) return;
  
  try {
    const res = await fetch(`${API}/auth/resend-verification`, {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${state.authToken}` }
    });
    
    const data = await res.json();
    alert(data.ok ? 'Verification email sent!' : (data.error || 'Error sending email'));
  } catch (e) {
    alert('Error sending verification email');
  }
}

// ==================== TEMPLATE FUNCTIONS ====================

async function loadTemplate(templateId) {
  if (!templateId || !state.user?.templates) return;
  
  const template = state.user.templates.find(t => t.id === templateId);
  if (!template) return;
  
  // Restore composer state
  if (template.composerState) {
    composerState = JSON.parse(JSON.stringify(template.composerState));
  }
  if (template.customFrameworks) {
    customFrameworks = JSON.parse(JSON.stringify(template.customFrameworks));
  }
  
  // Render first, THEN set global instructions (render rebuilds the textarea)
  renderComposer();
  
  if (template.globalInstructions) {
    const gi = $('#globalInstructions');
    if (gi) gi.value = template.globalInstructions;
  }
  
  // Reset the select dropdown
  $('#templateSelect').value = '';
  
  // Show the loaded notification
  const notice = $('#templateLoadedNotice');
  const nameSpan = $('#loadedTemplateName');
  if (notice && nameSpan) {
    nameSpan.textContent = template.name;
    notice.style.display = 'block';
    
    // Scroll to show the notice
    notice.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }
}

async function saveAsTemplate() {
  if (!state.isLoggedIn) {
    alert('Please sign in to save templates');
    return;
  }
  
  const bar = $('#saveTemplateBar');
  if (!bar) return;
  
  // Check if inline form is already showing
  if (bar.querySelector('.save-template-form')) return;
  
  // Build inline form
  const form = document.createElement('div');
  form.className = 'save-template-form';
  form.style.cssText = 'margin-top: 10px; display: flex; flex-direction: column; gap: 8px;';
  form.innerHTML = `
    <input type="text" class="form-input" id="templateNameInput" placeholder='Template name (e.g., "SOC 2 Annual")' style="font-size: 0.9rem;">
    <label style="display: flex; align-items: center; gap: 8px; font-size: 0.85rem; color: var(--text-muted); cursor: pointer;">
      <input type="checkbox" id="includeInstructionsCheck" checked> Include item-level instructions
    </label>
    <div style="display: flex; gap: 8px;">
      <button type="button" class="btn btn-sm btn-accent" id="confirmSaveTemplateBtn">Save</button>
      <button type="button" class="btn btn-sm btn-outline" id="cancelSaveTemplateBtn">Cancel</button>
    </div>
    <div id="saveTemplateStatus" style="font-size: 0.85rem;"></div>
  `;
  bar.appendChild(form);
  
  const nameInput = $('#templateNameInput');
  nameInput.focus();
  
  // Cancel
  $('#cancelSaveTemplateBtn').addEventListener('click', () => form.remove());
  nameInput.addEventListener('keypress', e => {
    if (e.key === 'Enter') $('#confirmSaveTemplateBtn').click();
  });
  
  // Save
  $('#confirmSaveTemplateBtn').addEventListener('click', async () => {
    const name = (nameInput.value || '').trim();
    if (!name) {
      $('#saveTemplateStatus').textContent = 'Please enter a template name';
      $('#saveTemplateStatus').style.color = '#ef4444';
      nameInput.focus();
      return;
    }
    
    const includeInstructions = $('#includeInstructionsCheck').checked;
    const btn = $('#confirmSaveTemplateBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span>';
    
    try {
      const res = await fetch(`${API}/auth/templates`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${state.authToken}`
        },
        body: JSON.stringify({
          name,
          composerState: includeInstructions ? composerState : stripInstructions(composerState),
          customFrameworks,
          globalInstructions: includeInstructions ? ($('#globalInstructions')?.value || '') : ''
        })
      });
      
      const data = await res.json();
      
      if (data.ok && data.template) {
        state.user.templates = state.user.templates || [];
        state.user.templates.push(data.template);
        updateLoggedInBar();
        $('#saveTemplateStatus').textContent = '&#10003; Template saved!';
        $('#saveTemplateStatus').style.color = '#10b981';
        setTimeout(() => form.remove(), 1500);
      } else {
        $('#saveTemplateStatus').textContent = data.error || 'Error saving template';
        $('#saveTemplateStatus').style.color = '#ef4444';
        btn.disabled = false;
        btn.textContent = 'Save';
      }
    } catch (e) {
      $('#saveTemplateStatus').textContent = 'Error saving template';
      $('#saveTemplateStatus').style.color = '#ef4444';
      btn.disabled = false;
      btn.textContent = 'Save';
    }
  });
}

function stripInstructions(cs) {
  const stripped = JSON.parse(JSON.stringify(cs));
  for (const fwKey in stripped) {
    for (const gKey in stripped[fwKey]?.groups || {}) {
      for (const iKey in stripped[fwKey].groups[gKey]?.items || {}) {
        stripped[fwKey].groups[gKey].items[iKey].instructions = '';
      }
    }
  }
  return stripped;
}

function setupAuthListeners() {
  // New user type toggle
  $$('input[name="newUserType"]').forEach(r => {
    r.addEventListener('change', e => showNewUserSection(e.target.value));
  });
  
  // Trial code
  $('#applyTrialBtn')?.addEventListener('click', handleApplyTrialCode);
  $('#trialCodeInput')?.addEventListener('keypress', e => {
    if (e.key === 'Enter') handleApplyTrialCode();
  });
  
  // Trial mode
  $$('input[name="trialMode"]').forEach(r => {
    r.addEventListener('change', handleTrialModeChange);
  });
  $('#startTrialBtn')?.addEventListener('click', handleStartTrial);
  
  // Signup
  $('#signupPassword')?.addEventListener('input', e => validatePassword(e.target.value));
  $('#signupBtn')?.addEventListener('click', handleSignup);
  $('#signupPasswordConfirm')?.addEventListener('keypress', e => {
    if (e.key === 'Enter') handleSignup();
  });
  
  // Login
  $('#loginBtn')?.addEventListener('click', handleLogin);
  $('#loginPassword')?.addEventListener('keypress', e => {
    if (e.key === 'Enter') handleLogin();
  });
  
  // Forgot password
  $('#forgotPasswordLink')?.addEventListener('click', e => {
    e.preventDefault();
    showForgotPassword();
  });
  $('#sendResetBtn')?.addEventListener('click', handleForgotPassword);
  $('#backToLoginBtn')?.addEventListener('click', showLoginSection);
  
  // Reset password (from email link)
  $('#resetPasswordBtn')?.addEventListener('click', handleResetPassword);
  $('#newPassword')?.addEventListener('input', e => {
    const pw = e.target.value;
    const update = (id, ok) => {
      const el = $(`#${id}`);
      if (el) { el.textContent = (ok ? '&#10003; ' : 'X ') + el.textContent.slice(2); el.style.color = ok ? '#10b981' : '#ef4444'; }
    };
    update('resetReqLength', pw.length >= 8);
    update('resetReqNumber', /\d/.test(pw));
    update('resetReqSpecial', /[!@#$%^&*(),.?":{}|<>_\-+=\[\]\\\/`~;']/.test(pw));
  });
  $('#confirmNewPassword')?.addEventListener('keypress', e => {
    if (e.key === 'Enter') handleResetPassword();
  });
  
  // Logout
  $('#logoutBtn')?.addEventListener('click', handleLogout);
  
  // Resend verification
  $('#resendVerifyLink')?.addEventListener('click', e => {
    e.preventDefault();
    handleResendVerification();
  });
  
  // Create account from trial notice
  $('#createAccountLink')?.addEventListener('click', e => {
    e.preventDefault();
    $('#roleSelect').value = 'new';
    handleRoleChange('new');
    showNewUserSection('account');
    // Pre-fill email if we have it
    if (state.trialEmail) {
      $('#signupEmail').value = state.trialEmail;
    }
  });
  
  // Template selector
  $('#templateSelect')?.addEventListener('change', e => {
    if (e.target.value) loadTemplate(e.target.value);
  });
  
  // Dismiss template loaded notice
  $('#dismissTemplateNotice')?.addEventListener('click', () => {
    $('#templateLoadedNotice').style.display = 'none';
  });
  
  // Dashboard: New Request button
  $('#newRequestBtn')?.addEventListener('click', () => {
    showComposerFromDashboard();
  });
  
  // Dashboard: Back to Dashboard link
  $('#backToDashboardLink')?.addEventListener('click', e => {
    e.preventDefault();
    backToDashboard();
  });
  
  // Buy Credits buttons (header and alert)
  $('#buyCreditsHeaderBtn')?.addEventListener('click', () => {
    showBuyCreditsFromDashboard();
  });
  
  $('#buyCreditsAlertBtn')?.addEventListener('click', () => {
    showBuyCreditsFromDashboard();
  });
}

function showBuyCreditsFromDashboard() {
  // Hide dashboard, show composer with payment section open
  $('#dashboardView').style.display = 'none';
  $('#backToDashboard').style.display = 'block';
  
  // Show auditor flow
  $('#auditorFlow').style.display = 'block';
  if (Object.keys(composerState).length === 0) initComposerState();
  renderComposer();
  
  // Set auditor email
  if (state.user?.email) {
    setChipEmails('auditorEmailsContainer', [state.user.email]);
  }
  
  // Show payment section
  showPaymentSection();
  
  // Scroll to payment
  setTimeout(() => {
    $('#paymentSection').scrollIntoView({ behavior: 'smooth', block: 'center' });
  }, 100);
}

function showPaymentSection() {
  state.paymentVisible = true;
  $('#paymentSection').classList.add('visible');
  updateMainButton();
}

function updateMainButton() {
  const btn = $('#mainActionBtn');
  if (!btn) return;
  
  // If logged in with credits or trial user - show Send directly
  if ((state.isLoggedIn && state.user?.credits > 0) || state.isTrialUser) {
    btn.textContent = 'Send Evidence Request';
    btn.className = 'btn btn-accent btn-full';
    btn.disabled = false;
  } else if (state.isLoggedIn && !state.user?.verified) {
    btn.textContent = 'Verify Email to Continue';
    btn.className = 'btn btn-primary btn-full';
    btn.disabled = false;
  } else if (!state.paymentVisible) {
    btn.textContent = 'Continue';
    btn.className = 'btn btn-primary btn-full';
    btn.disabled = false;
  } else {
    btn.textContent = 'Send Evidence Request';
    btn.className = 'btn btn-accent btn-full';
    btn.disabled = false;
  }
}

function selectTier(tier) {
  $$('.pricing-card').forEach(card => { 
    card.classList.toggle('selected', card.dataset.tier === tier); 
  });
  state.selectedTier = tier;
  const buyBtn = $('#buyCreditsBtn');
  if (tier) { 
    const prices = { single: '$59', pack5: '$249', pack15: '$499', pack50: '$1,249' }; 
    buyBtn.disabled = false; 
    buyBtn.textContent = `Buy Credits &mdash; ${prices[tier]}`;
    // ADD THIS: Highlight the button
    buyBtn.className = 'btn btn-accent btn-full';
  } else { 
    buyBtn.disabled = true; 
    buyBtn.textContent = 'Select a plan to purchase';
    buyBtn.className = 'btn btn-outline btn-full';
  }
}
// ==================== MAIN ACTIONS ====================

async function handleMainAction() {
  const btn = $('#mainActionBtn');
  
  // Validation
  const auditorEmails = getChipEmails('auditorEmailsContainer');
  const clientEmails = getChipEmails('clientEmailsContainer');
  const company = ($('#clientCompany')?.value || '').trim();
  
  if (auditorEmails.length === 0) {
    alert('Please enter at least one team email address.');
    return;
  }
  if (!company) {
    alert('Please enter the client company name.');
    return;
  }
  if (clientEmails.length === 0) {
    alert('Please enter at least one client email address.');
    return;
  }
  
  const evidence = getPayload();
  if (evidence.length === 0) {
    alert('Please select at least one evidence item to request.');
    return;
  }
  
  saveFormState();
  
  // Check if user can send (logged in with credits, or trial user, or needs payment)
  if (state.isLoggedIn && state.user?.credits > 0) {
    // Logged in with credits - hide payment if visible and send directly
    if (state.paymentVisible) {
      $('#paymentSection').classList.remove('visible');
      state.paymentVisible = false;
    }
    await sendRequest();
  } else if (state.isTrialUser && state.codeValid) {
    // Trial user - send directly
    await sendRequest();
  } else if (state.isLoggedIn && (!state.user?.credits || state.user.credits === 0)) {
    // Logged in but no credits - show payment
    showPaymentSection();
    $('#paymentSection').scrollIntoView({ behavior: 'smooth', block: 'center' });
  } else if (state.isLoggedIn && !state.user?.verified) {
    // Logged in but not verified
    alert('Please verify your email before sending requests. Check your inbox for the verification link.');
  } else if (!state.paymentVisible) {
    // Not logged in, not trial - show payment section
    showPaymentSection();
    $('#paymentSection').scrollIntoView({ behavior: 'smooth', block: 'center' });
  } else {
    // Payment visible, validate code and send
    const code = ($('#auditorCode')?.value || '').trim().toUpperCase();
    
    if (!code) {
      alert('Please enter your credit code.');
      $('#auditorCode').focus();
      return;
    }
    
    if (!state.codeValid || state.code !== code) {
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> Checking code...';
      
      const result = await validateCode(code);
      updateCodeUI(result);
      
      if (!result.valid) {
        btn.disabled = false;
        btn.textContent = 'Send Evidence Request';
        alert(result.error || 'Invalid code. Please try again.');
        return;
      }
      
      state.code = code;
      saveFormState();
    }
    
    await sendRequest();
  }
}

async function handleCheckout() {
  if (!state.selectedTier) return;
  
  const buyBtn = $('#buyCreditsBtn');
  buyBtn.disabled = true;
  buyBtn.innerHTML = '<span class="spinner"></span> Processing...';
  
  saveFormState();
  
  try {
    const auditorEmails = getChipEmails('auditorEmailsContainer');
    const checkoutHeaders = { 'Content-Type': 'application/json' };
    if (state.authToken) {
      checkoutHeaders['Authorization'] = `Bearer ${state.authToken}`;
    }
    const res = await fetch(`${API}/checkout`, {
      method: 'POST',
      headers: checkoutHeaders,
      body: JSON.stringify({
        tier: state.selectedTier,
        email: auditorEmails[0] || '',
        successUrl: window.location.origin + window.location.pathname + '?session_id={CHECKOUT_SESSION_ID}',
        cancelUrl: window.location.href
      })
    });
    
    const data = await res.json();
    
    if (data.ok && data.url) {
      window.location.href = data.url;
    } else {
      alert('Error starting checkout: ' + (data.error || 'Unknown error'));
      buyBtn.disabled = false;
      buyBtn.textContent = 'Buy Credits';
    }
  } catch (e) {
    alert('Error: ' + e.message);
    buyBtn.disabled = false;
    buyBtn.textContent = 'Buy Credits';
  }
}

async function sendRequest() {
  const btn = $('#mainActionBtn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Sending...';
  
  const deadline = calculateDeadline();
  const frameworks = Object.entries(composerState)
    .filter(([_, s]) => s.enabled)
    .map(([k]) => { 
      const allFw = getAllFrameworks(); 
      return allFw[k]?.label || k; 
    });
  const requestedEvidence = getPayload();
  const auditorEmails = getChipEmails('auditorEmailsContainer');
  const clientEmails = getChipEmails('clientEmailsContainer');
  
  // Get audit period dates if set
  const auditPeriodStart = auditPeriodStartPicker?.selectedDates[0]?.toISOString() || null;
  const auditPeriodEnd = auditPeriodEndPicker?.selectedDates[0]?.toISOString() || null;
  
  // Build headers
  const headers = { 'Content-Type': 'application/json' };
  if (state.authToken) {
    headers['Authorization'] = `Bearer ${state.authToken}`;
  }
  
  try {
    const res = await fetch(`${API}/request`, {
      method: 'POST',
      headers,
      body: JSON.stringify({
        auditorEmail: auditorEmails[0] || '',
        auditorEmails: auditorEmails,
        clientEmail: clientEmails[0] || '',
        clientEmails: clientEmails,
        company: $('#clientCompany').value,
        frameworks: frameworks,
        deadlineISO: deadline.toISOString(),
        auditorCode: state.code || '',
        globalInstructions: $('#globalInstructions')?.value || '',
        requestedEvidence: requestedEvidence,
        // Audit period for period-of-time evidence
        auditPeriodStart: auditPeriodStart,
        auditPeriodEnd: auditPeriodEnd,
        // Engagement reference for workpaper PDF
        engagementRef: $('#engagementRef')?.value?.trim() || null,
        // Trial flags
        isTrialRequest: state.isTrialUser,
        trialMode: state.trialMode
      })
    });
    
    const data = await res.json();
    
    if (data.ok) {
      clearFormState();
      
      // Update local credits if logged in
      if (state.isLoggedIn && state.user) {
        state.user.credits = Math.max(0, (state.user.credits || 0) - 1);
        // Add token to local requests list
        if (data.token) {
          state.user.requests = state.user.requests || [];
          state.user.requests.unshift(data.token);
        }
        updateLoggedInBar();
      }
      
      const clientList = clientEmails.join(', ');
      
      if (state.isTrialUser) {
        // Special message for trial users
        alert(`Success! ${state.trialMode === 'test' ? 'Test request' : 'Evidence request'} sent to ${clientList}.\n\nCheck your email for next steps!`);
        window.location.reload();
      } else if (state.isLoggedIn) {
        // Show success and go to dashboard
        alert('Success! Evidence request sent to ' + clientList);
        backToDashboard();
      } else {
        alert('Success! Evidence request sent to ' + clientList + '\n\nClient link: ' + (data.magicLink || ''));
        window.location.reload();
      }
    } else {
      alert('Error: ' + (data.error || 'Unknown error'));
      btn.disabled = false;
      btn.textContent = 'Send Evidence Request';
    }
  } catch (e) {
    alert('Error: ' + e.message);
    btn.disabled = false;
    btn.textContent = 'Send Evidence Request';
  }
}

// ==================== MODALS ====================

function setupModals() {
  $('#cancelFwBtn')?.addEventListener('click', () => { 
    $('#addFwModal').classList.add('hidden'); 
    $('#customFwName').value = ''; 
    $('#customFwDesc').value = ''; 
  });
  
  $('#saveFwBtn')?.addEventListener('click', () => {
    const name = ($('#customFwName')?.value || '').trim();
    const desc = ($('#customFwDesc')?.value || '').trim();
    if (!name) return;
    const id = 'cf_' + Math.random().toString(36).slice(2, 8);
    customFrameworks.push({ id, label: name, description: desc || 'Custom framework', defaultOn: false, controlGroups: [] });
    composerState[id] = { enabled: true, groups: {} };
    $('#addFwModal').classList.add('hidden');
    $('#customFwName').value = '';
    $('#customFwDesc').value = '';
    renderComposer();
    saveFormState();
  });
  
  $('#cancelGroupBtn')?.addEventListener('click', () => { 
    $('#addGroupModal').classList.add('hidden'); 
    $('#customGroupName').value = ''; 
    $('#customGroupDesc').value = ''; 
    $('#customGroupFwKey').value = ''; 
  });
  
  $('#saveGroupBtn')?.addEventListener('click', () => {
    const name = ($('#customGroupName')?.value || '').trim();
    const desc = ($('#customGroupDesc')?.value || '').trim();
    const fwKey = $('#customGroupFwKey')?.value;
    if (!name || !fwKey) return;
    const gid = 'g_' + Math.random().toString(36).slice(2, 8);
    const allFw = getAllFrameworks();
    const fw = allFw[fwKey];
    if (fw) {
      fw.controlGroups.push({ id: gid, title: name, description: desc, items: [] });
      composerState[fwKey].groups[gid] = { expanded: true, showMore: false, excluded: false, items: {} };
    }
    $('#addGroupModal').classList.add('hidden');
    $('#customGroupName').value = '';
    $('#customGroupDesc').value = '';
    $('#customGroupFwKey').value = '';
    renderComposer();
    saveFormState();
  });
}


// ==================== URL PARAM PREFILL (for resend links) ====================

function handleUrlPrefill() {
  const params = new URLSearchParams(window.location.search);
  
  // Check if this is a resend link (mode=resend or has prev token)
  const mode = params.get('mode');
  const prev = params.get('prev');
  
  if (mode !== 'resend' && !prev) return false;
  
  // Get prefill values
  const company = params.get('company') || '';
  const frameworks = (params.get('frameworks') || '').split(',').filter(Boolean);
  const auditorEmails = (params.get('auditorEmails') || '').split(',').filter(e => e && e.includes('@'));
  const clientEmails = (params.get('clientEmails') || '').split(',').filter(e => e && e.includes('@'));
  
  // Set role to auditor
  const roleSelect = $('#roleSelect');
  if (roleSelect) {
    roleSelect.value = 'auditor';
    handleRoleChange('auditor');
  }
  
  // Prefill company
  const companyInput = $('#clientCompany');
  if (companyInput && company) {
    companyInput.value = company;
  }
  
  // Prefill emails (chip inputs must be initialized first)
  if (auditorEmails.length > 0) {
    setChipEmails('auditorEmailsContainer', auditorEmails);
  }
  if (clientEmails.length > 0) {
    setChipEmails('clientEmailsContainer', clientEmails);
  }
  
  // Enable frameworks in composer
  if (frameworks.length > 0) {
    frameworks.forEach(fw => {
      const fwUpper = fw.toUpperCase();
      if (composerState[fwUpper]) {
        composerState[fwUpper].enabled = true;
      }
    });
    renderComposer();
  }
  
  // Clean URL (remove params without reload)
  const cleanUrl = window.location.pathname;
  window.history.replaceState({}, '', cleanUrl);
  
  // Scroll to deadline picker (since that's all they need to change)
  setTimeout(() => {
    const deadlineInput = $('#deadlinePicker');
    if (deadlineInput && deadlinePicker) {
      deadlineInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
      // Flash the deadline field
      const altInput = deadlinePicker.altInput || deadlineInput;
      altInput.style.outline = '2px solid var(--accent)';
      altInput.style.boxShadow = '0 0 10px rgba(56, 189, 248, 0.3)';
      setTimeout(() => { 
        altInput.style.outline = ''; 
        altInput.style.boxShadow = '';
      }, 2500);
      // Open the picker
      deadlinePicker.open();
    }
  }, 300);
  
  return true;
}

// ==================== INIT ====================

async function init() {
  $('#year').textContent = new Date().getFullYear();
  
  // Initialize chip inputs FIRST (before any state restore)
  initChipInput('auditorEmailsContainer');
  initChipInput('clientEmailsContainer');
  
  // Initialize date picker
  initDeadlinePicker();
  
  initComposerState();
  
  // Set up auth event listeners
  setupAuthListeners();
  
  // Check for password reset token in URL (takes priority)
  const isResetFlow = checkResetToken();
  
  // Check for checkout return (handles its own session check)
  const isCheckoutReturn = !isResetFlow && await checkCheckoutReturn();
  
  // Check for existing session (skip if checkout return already handled it)
  let hasSession = false;
  if (!isResetFlow && !isCheckoutReturn) {
    hasSession = await checkExistingSession();
    if (hasSession) {
      showDashboard();
    }
  }
  
  // ALWAYS set up all event listeners
  setupAutoSave();
  setupModals();
  
  // Check for URL prefill (resend links from deadline-missed emails)
  const isResendPrefill = handleUrlPrefill();
  
  // Only restore form state when returning from Stripe checkout
  if (!isCheckoutReturn && !isResendPrefill && !hasSession) {
    clearFormState();
  }
  
  // Event listeners
  $('#roleSelect').addEventListener('change', e => {
    handleRoleChange(e.target.value);
    saveFormState();
  });
  
  $('#mainActionBtn').addEventListener('click', handleMainAction);
  
  $$('.pricing-card').forEach(card => {
    card.addEventListener('click', () => selectTier(card.dataset.tier));
  });
  
  $('#buyCreditsBtn').addEventListener('click', handleCheckout);
  
  $('#getStartedLink').addEventListener('click', e => {
    e.preventDefault();
    $('#roleSelect').scrollIntoView({ behavior: 'smooth' });
    $('#roleSelect').focus();
  });
  
  updateMainButton();
}

document.addEventListener('DOMContentLoaded', init);
</script>
<div id="draftIndicator" class="draft-indicator"></div>
</body>
</html>
