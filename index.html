<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ProofRepo — Compliance ProofPacks in Seconds</title>
  <meta name="description" content="Streamlined evidence collection for SOC 2, ISO 27001, HIPAA, GDPR audits. Send your client a guided upload link, get a structured ProofPack." />
  
  <!-- MAGIC LINK REDIRECT - Must be in head, executes immediately -->
  <script>
    (function() {
      var params = new URLSearchParams(window.location.search);
      var token = params.get('t');
      if (token && token.indexOf('req_') === 0) {
        window.location.replace('https://proofrepo-intake.atucker5.workers.dev/upload?t=' + encodeURIComponent(token));
      }
    })();
  </script>
  
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  
  <!-- Flatpickr Date/Time Picker -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <style>
    :root {
      --bg: #050a14;
      --surface: #0a1628;
      --surface-elevated: #0f1d32;
      --border: #1e3a5f;
      --text: #e2e8f0;
      --text-muted: #94a3b8;
      --primary: #2563eb;
      --primary-hover: #1d4ed8;
      --accent: #10b981;
      --accent-hover: #059669;
      --warning: #f59e0b;
      --error: #ef4444;
      --marquee-height: 48px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
      padding-bottom: var(--marquee-height);
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 24px;
      border-bottom: 1px solid var(--border);
      background: rgba(5, 10, 20, 0.9);
      backdrop-filter: blur(10px);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 700;
      font-size: 1.25rem;
      color: var(--text);
      text-decoration: none;
    }

    .logo-icon {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .header-links {
      display: flex;
      gap: 24px;
      align-items: center;
    }

    .header-links a {
      color: var(--text-muted);
      text-decoration: none;
      font-size: 0.9rem;
      font-weight: 500;
      transition: color 0.2s;
      cursor: pointer;
    }

    .header-links a:hover { color: var(--text); }

    .hero {
      padding: 48px 24px;
      text-align: center;
      background: linear-gradient(180deg, rgba(37, 99, 235, 0.1) 0%, transparent 100%);
    }

    .hero-badge {
      display: inline-block;
      padding: 6px 14px;
      background: rgba(37, 99, 235, 0.2);
      border: 1px solid rgba(37, 99, 235, 0.3);
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      color: #60a5fa;
      margin-bottom: 16px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .hero h1 {
      font-size: clamp(2rem, 5vw, 3rem);
      font-weight: 800;
      line-height: 1.2;
      margin-bottom: 16px;
      background: linear-gradient(135deg, var(--text) 0%, #94a3b8 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .hero p {
      font-size: 1.1rem;
      color: var(--text-muted);
      max-width: 600px;
      margin: 0 auto 12px;
    }

    .hero-features {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 24px;
      margin-top: 32px;
      padding: 0 24px;
    }

    .hero-feature {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .hero-feature svg {
      color: var(--accent);
      flex-shrink: 0;
    }

    .main-container {
      max-width: 900px;
      margin: 0 auto;
      padding: 24px;
    }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .card-header {
      margin-bottom: 20px;
    }

    .card-header h2 {
      font-size: 1.25rem;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .card-header p {
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text);
    }

    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 12px 16px;
      background: var(--surface-elevated);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      font-size: 1rem;
      font-family: inherit;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
    }

    .form-input::placeholder, .form-textarea::placeholder { color: var(--text-muted); }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    .form-textarea {
      min-height: 80px;
      resize: vertical;
    }

    /* Chip Input Styles */
    .chip-input-container {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      background: var(--surface-elevated);
      border: 1px solid var(--border);
      border-radius: 10px;
      min-height: 48px;
      cursor: text;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .chip-input-container:focus-within {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
    }
    .chip-input-container .chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      background: var(--primary);
      color: white;
      border-radius: 16px;
      font-size: 0.85rem;
      font-weight: 500;
      animation: chipIn 0.15s ease-out;
    }
    @keyframes chipIn {
      from { transform: scale(0.8); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    .chip-input-container .chip .chip-remove {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      background: rgba(255,255,255,0.2);
      border: none;
      border-radius: 50%;
      color: white;
      font-size: 12px;
      line-height: 1;
      cursor: pointer;
      transition: background 0.15s;
    }
    .chip-input-container .chip .chip-remove:hover {
      background: rgba(255,255,255,0.4);
    }
    .chip-input-container .chip-text-input {
      flex: 1;
      min-width: 150px;
      border: none;
      background: transparent;
      color: var(--text);
      font-size: 1rem;
      font-family: inherit;
      outline: none;
      padding: 4px 0;
    }
    .chip-input-container .chip-text-input::placeholder {
      color: var(--text-muted);
    }
    .chip-input-hint {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .role-selector {
      margin-bottom: 24px;
    }

    .role-selector select {
      width: 100%;
      padding: 14px 16px;
      background: var(--surface-elevated);
      border: 2px solid var(--border);
      border-radius: 12px;
      color: var(--text);
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .role-selector select:focus {
      outline: none;
      border-color: var(--primary);
    }

    .framework-selector {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 12px;
    }

    .framework-tag {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: var(--surface-elevated);
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      user-select: none;
    }

    .framework-tag:hover {
      border-color: var(--primary);
    }

    .framework-tag.selected {
      background: rgba(37, 99, 235, 0.2);
      border-color: var(--primary);
      color: #60a5fa;
    }

    .framework-tag input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: var(--primary);
    }

    .framework-tag.add-btn {
      border-style: dashed;
      color: var(--text-muted);
    }

    .control-group {
      border: 1px solid var(--border);
      border-radius: 12px;
      margin-bottom: 12px;
      overflow: hidden;
    }

    .control-group.excluded {
      opacity: 0.5;
      border-style: dashed;
    }

    .cg-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 16px;
      background: var(--surface-elevated);
      cursor: pointer;
      transition: background 0.2s;
    }

    .cg-header:hover {
      background: rgba(30, 58, 95, 0.5);
    }

    .cg-title {
      font-weight: 600;
      font-size: 0.95rem;
      flex: 1;
    }

    .cg-status {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .cg-count {
      font-size: 0.8rem;
      color: var(--text-muted);
      background: var(--bg);
      padding: 4px 10px;
      border-radius: 12px;
    }

    .cg-toggle {
      color: var(--text-muted);
      font-size: 0.9rem;
      width: 20px;
      text-align: center;
    }

    .cg-exclude, .cg-include {
      width: 24px;
      height: 24px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      cursor: pointer;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text-muted);
    }

    .cg-exclude:hover {
      background: #7f1d1d;
      border-color: #991b1b;
      color: #fecaca;
    }

    .cg-include:hover {
      background: #166534;
      border-color: #166534;
      color: #86efac;
    }

    .cg-body {
      display: none;
      padding: 12px 16px;
      background: var(--bg);
    }

    .cg-body.open {
      display: block;
    }

    .cg-description {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    .evidence-item {
      display: flex;
      gap: 10px;
      align-items: flex-start;
      padding: 12px;
      margin-bottom: 8px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--surface);
    }

    .evidence-item.included {
      border-color: var(--primary);
      background: rgba(37, 99, 235, 0.1);
    }

    .evidence-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      margin-top: 2px;
      accent-color: var(--primary);
      flex-shrink: 0;
    }

    .ei-content {
      flex: 1;
      min-width: 0;
    }

    .ei-title {
      font-weight: 500;
      margin-bottom: 4px;
    }

    .ei-hint {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .ei-instr {
      margin-top: 8px;
    }

    .ei-instr label {
      font-size: 0.8rem;
      color: var(--text-muted);
      display: block;
      margin-bottom: 4px;
    }

    .ei-instr textarea {
      width: 100%;
      min-height: 50px;
      padding: 8px 10px;
      font-size: 0.9rem;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      resize: vertical;
    }

    .ei-instr textarea::placeholder {
      color: #6b7a9a;
    }

    .ei-instr textarea:focus {
      outline: none;
      border-color: var(--primary);
    }

    .more-toggle {
      margin: 12px 0;
      padding: 10px 14px;
      font-size: 0.9rem;
      color: #7a9bff;
      cursor: pointer;
      background: var(--surface);
      border: 1px dashed var(--border);
      border-radius: 8px;
      text-align: center;
    }

    .more-toggle:hover {
      background: var(--surface-elevated);
      border-color: var(--primary);
    }

    .add-custom-section {
      margin-top: 16px;
      padding: 16px;
      border: 1px dashed var(--border);
      border-radius: 10px;
      background: rgba(0,0,0,0.2);
    }

    .add-custom-section h4 {
      margin: 0 0 12px;
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .custom-form {
      display: grid;
      gap: 10px;
    }

    .custom-form input,
    .custom-form textarea {
      background: var(--bg);
    }

    .global-instructions {
      padding: 16px;
      border-top: 1px solid var(--border);
      margin-top: 12px;
    }

    .global-instructions textarea {
      min-height: 70px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px 24px;
      font-size: 1rem;
      font-weight: 600;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      text-decoration: none;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      background: var(--primary-hover);
      transform: translateY(-1px);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-accent {
      background: var(--accent);
      color: white;
    }

    .btn-accent:hover:not(:disabled) {
      background: var(--accent-hover);
      transform: translateY(-1px);
    }

    .btn-accent:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-outline {
      background: transparent;
      border: 2px solid var(--border);
      color: var(--text);
    }

    .btn-outline:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    .btn-full {
      width: 100%;
    }

    .btn-sm {
      padding: 8px 14px;
      font-size: 0.9rem;
    }

    .btn-xs {
      padding: 4px 10px;
      font-size: 0.75rem;
    }

    /* Credit Alert */
    .credit-alert {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(239, 68, 68, 0.1));
      border: 1px solid rgba(245, 158, 11, 0.4);
      border-radius: 10px;
      padding: 12px 16px;
      margin-bottom: 20px;
      gap: 12px;
    }

    .credit-alert.critical {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(239, 68, 68, 0.1));
      border-color: rgba(239, 68, 68, 0.4);
    }

    .credit-alert-content {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .credit-alert-icon {
      font-size: 1.2rem;
    }

    .credit-alert-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .credit-alert-text strong {
      font-size: 0.9rem;
      color: var(--text);
    }

    .credit-alert-text span {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    @media (max-width: 600px) {
      .credit-alert {
        flex-direction: column;
        align-items: stretch;
        text-align: center;
      }
      .credit-alert-content {
        justify-content: center;
      }
    }

    /* Payment section */
    .payment-section {
      display: none;
      background: var(--surface-elevated);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      margin-top: 24px;
    }

    .payment-section.visible {
      display: block;
    }

    .payment-header {
      text-align: center;
      margin-bottom: 20px;
    }

    .payment-header h3 {
      font-size: 1.1rem;
      margin-bottom: 4px;
    }

    .payment-header p {
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    .code-entry {
      background: var(--bg);
      border-radius: 12px;
      padding: 16px;
    }

    .code-input {
      width: 100%;
      padding: 14px 16px;
      font-size: 1.1rem;
      font-weight: 600;
      letter-spacing: 2px;
      text-transform: uppercase;
      background: var(--surface);
      border: 2px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      text-align: center;
    }

    .code-input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .code-input.valid {
      border-color: var(--accent);
    }

    .code-input.invalid {
      border-color: var(--error);
    }

    .code-status {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-top: 12px;
      font-size: 0.9rem;
      min-height: 24px;
    }

    .code-status.valid { color: var(--accent); }
    .code-status.invalid { color: var(--error); }
    .code-status.checking { color: var(--text-muted); }

    .purchase-section {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
    }

    .purchase-section.hidden {
      display: none;
    }

    .divider-text {
      text-align: center;
      color: var(--text-muted);
      font-size: 0.9rem;
      margin-bottom: 16px;
    }

    .pricing-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }

    .pricing-card {
      background: var(--bg);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .pricing-card:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
    }

    .pricing-card.selected {
      border-color: var(--accent);
      background: rgba(16, 185, 129, 0.1);
    }

    .pricing-card-name {
      font-weight: 600;
      font-size: 0.95rem;
      margin-bottom: 4px;
    }

    .pricing-card-price {
      font-size: 1.4rem;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 4px;
    }

    .pricing-card-desc {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .success-banner {
      display: none;
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(16, 185, 129, 0.1));
      border: 1px solid var(--accent);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 24px;
      text-align: center;
    }

    .success-banner.visible {
      display: block;
    }

    .success-banner h3 {
      color: var(--accent);
      margin-bottom: 8px;
    }

    .success-banner p {
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    .success-banner .code-display {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--accent);
      letter-spacing: 3px;
      font-family: monospace;
      margin: 12px 0;
    }

    .how-section {
      padding: 48px 24px;
      max-width: 900px;
      margin: 0 auto;
    }

    .how-section h2 {
      text-align: center;
      margin-bottom: 32px;
      font-size: 1.5rem;
    }

    .how-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
    }

    .how-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
    }

    .how-card h3 {
      font-size: 1rem;
      margin-bottom: 8px;
    }

    .how-card p {
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    /* ==================== TRUST SECTION ==================== */
    .trust-section {
      padding: 48px 24px;
      background: linear-gradient(180deg, var(--bg) 0%, var(--surface) 50%, var(--bg) 100%);
      border-top: 1px solid var(--border);
      border-bottom: 1px solid var(--border);
    }

    .trust-section .section-inner {
      max-width: 900px;
      margin: 0 auto;
    }

    .trust-section .section-header {
      text-align: center;
      margin-bottom: 32px;
    }

    .trust-section .section-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(16, 185, 129, 0.15);
      border: 1px solid rgba(16, 185, 129, 0.3);
      color: var(--accent);
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }

    .trust-section h2 {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 8px;
    }

    .trust-section .section-subtitle {
      color: var(--text-muted);
      font-size: 1rem;
      max-width: 500px;
      margin: 0 auto;
    }

    .trust-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    .trust-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px 16px;
      text-align: center;
      transition: border-color 0.2s, transform 0.2s;
    }

    .trust-card:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
    }

    .trust-card-icon {
      width: 44px;
      height: 44px;
      margin: 0 auto 12px;
      background: linear-gradient(135deg, var(--primary), #8b5cf6);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .trust-card-icon svg {
      width: 22px;
      height: 22px;
      stroke: white;
      fill: none;
      stroke-width: 2;
    }

    .trust-card h3 {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 4px;
    }

    .trust-card p {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin: 0;
    }

    .trust-footer {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px 24px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
    }

    .trust-footer-text {
      color: var(--text-muted);
      font-size: 0.85rem;
    }

    .trust-links {
      display: flex;
      gap: 20px;
    }

    .trust-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: var(--text-muted);
      text-decoration: none;
      font-size: 0.85rem;
      font-weight: 500;
      transition: color 0.2s;
    }

    .trust-link:hover {
      color: var(--primary);
    }

    .trust-link svg {
      width: 14px;
      height: 14px;
      stroke: currentColor;
      fill: none;
      stroke-width: 2;
    }

    @media (max-width: 768px) {
      .trust-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 480px) {
      .trust-grid {
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }
      .trust-card {
        padding: 16px 12px;
      }
      .trust-links {
        flex-wrap: wrap;
        justify-content: center;
      }
    }

    /* ==================== FOOTER ==================== */
    .footer {
      text-align: center;
      padding: 32px 24px;
      color: var(--text-muted);
      font-size: 0.85rem;
      border-top: 1px solid var(--border);
    }

    .footer-links {
      display: flex;
      justify-content: center;
      gap: 24px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .footer-links a {
      color: var(--text-muted);
      text-decoration: none;
      font-size: 0.85rem;
      transition: color 0.2s;
    }

    .footer-links a:hover {
      color: var(--text);
    }

    .footer p {
      margin: 0;
    }

    /* ==================== AUTH STYLES ==================== */
    .auth-flow {
      margin-bottom: 20px;
    }

    .auth-box {
      background: var(--surface-elevated);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
    }

    .auth-box h3 {
      margin: 0 0 6px;
      font-size: 1.15rem;
    }

    .auth-subtitle {
      color: var(--text-muted);
      font-size: 0.9rem;
      margin-bottom: 16px;
    }

    .auth-options {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
    }

    .auth-option {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 14px 16px;
      background: var(--bg);
      border: 2px solid var(--border);
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .auth-option:hover {
      border-color: var(--primary);
    }

    .auth-option:has(input:checked) {
      border-color: var(--primary);
      background: rgba(37, 99, 235, 0.08);
    }

    .auth-option input[type="radio"] {
      margin-top: 2px;
      accent-color: var(--primary);
    }

    .auth-option-content {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .auth-option-title {
      font-weight: 600;
      font-size: 0.95rem;
    }

    .auth-option-desc {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .auth-section {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
    }

    .auth-status {
      margin-top: 12px;
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 0.9rem;
      display: none;
    }

    .auth-status.visible { display: block; }
    .auth-status.success { background: rgba(16, 185, 129, 0.1); color: var(--accent); border: 1px solid rgba(16, 185, 129, 0.3); }
    .auth-status.error { background: rgba(239, 68, 68, 0.1); color: var(--error); border: 1px solid rgba(239, 68, 68, 0.3); }
    .auth-status.loading { background: rgba(37, 99, 235, 0.1); color: var(--text-muted); border: 1px solid rgba(37, 99, 235, 0.3); }

    .auth-footnote {
      font-size: 0.8rem;
      color: var(--text-muted);
      text-align: center;
      margin-top: 12px;
    }

    .code-style {
      text-transform: uppercase;
      letter-spacing: 2px;
      font-weight: 600;
      text-align: center;
    }

    .success-box {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.3);
      border-radius: 8px;
      margin-bottom: 16px;
      color: var(--accent);
      font-weight: 500;
    }

    .success-icon {
      font-size: 1.1rem;
    }

    .trial-modes {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .trial-mode {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 12px 14px;
      background: var(--bg);
      border: 2px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .trial-mode:hover {
      border-color: var(--accent);
    }

    .trial-mode:has(input:checked) {
      border-color: var(--accent);
      background: rgba(16, 185, 129, 0.08);
    }

    .trial-mode input[type="radio"] {
      margin-top: 3px;
      accent-color: var(--accent);
    }

    .trial-mode-content {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .trial-mode-content strong {
      font-size: 0.9rem;
    }

    .trial-mode-content span {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .info-box {
      padding: 12px 14px;
      background: rgba(37, 99, 235, 0.1);
      border: 1px solid rgba(37, 99, 235, 0.2);
      border-radius: 8px;
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-top: 10px;
    }

    .password-reqs {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    .password-reqs .req {
      font-size: 0.75rem;
      padding: 4px 8px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text-muted);
    }

    .password-reqs .req.valid {
      background: rgba(16, 185, 129, 0.1);
      border-color: rgba(16, 185, 129, 0.4);
      color: var(--accent);
    }

    .login-options {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.85rem;
      color: var(--text-muted);
      cursor: pointer;
    }

    .checkbox-label input {
      accent-color: var(--primary);
    }

    .text-link {
      font-size: 0.85rem;
      color: var(--primary);
      text-decoration: none;
    }

    .text-link:hover {
      text-decoration: underline;
    }

    .logged-in-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: var(--surface-elevated);
      border: 1px solid var(--border);
      border-radius: 10px;
      margin-bottom: 16px;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-email {
      font-size: 0.9rem;
      font-weight: 500;
    }

    .credits-badge {
      padding: 4px 10px;
      background: rgba(16, 185, 129, 0.15);
      border: 1px solid rgba(16, 185, 129, 0.3);
      border-radius: 14px;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--accent);
    }

    .credits-badge.low {
      background: rgba(245, 158, 11, 0.15);
      border-color: rgba(245, 158, 11, 0.3);
      color: var(--warning);
    }

    .credits-badge.empty {
      background: rgba(239, 68, 68, 0.15);
      border-color: rgba(239, 68, 68, 0.3);
      color: var(--error);
    }

    .user-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .template-select {
      padding: 6px 12px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-size: 0.85rem;
      cursor: pointer;
    }

    .template-loader-section {
      margin-bottom: 12px;
    }

    .template-select-inline {
      width: 100%;
      padding: 10px 14px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 0.9rem;
      cursor: pointer;
      transition: border-color 0.2s;
    }

    .template-select-inline:hover {
      border-color: var(--primary);
    }

    .template-select-inline:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
    }

    .template-loaded-notice {
      margin-bottom: 16px;
      padding: 12px 16px;
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.3);
      border-radius: 8px;
    }

    .template-loaded-notice .notice-content {
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }

    .template-loaded-notice .notice-icon {
      color: var(--accent);
      font-size: 1.1rem;
      font-weight: 700;
      flex-shrink: 0;
      margin-top: 2px;
    }

    .template-loaded-notice .notice-text {
      flex: 1;
    }

    .template-loaded-notice .notice-text strong {
      color: var(--accent);
    }

    .template-loaded-notice .notice-text p {
      margin: 4px 0 0;
      font-size: 0.85rem;
      color: var(--text-muted);
      line-height: 1.4;
    }

    .template-loaded-notice .notice-dismiss {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 1.2rem;
      cursor: pointer;
      padding: 0;
      line-height: 1;
      opacity: 0.7;
      transition: opacity 0.2s;
    }

    .template-loaded-notice .notice-dismiss:hover {
      opacity: 1;
    }

    .trial-notice {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 16px;
      background: rgba(37, 99, 235, 0.1);
      border: 1px solid rgba(37, 99, 235, 0.2);
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 0.9rem;
    }

    .trial-badge {
      padding: 2px 8px;
      background: var(--primary);
      color: white;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 700;
      letter-spacing: 0.5px;
    }

    .verification-notice {
      padding: 10px 16px;
      background: rgba(245, 158, 11, 0.1);
      border: 1px solid rgba(245, 158, 11, 0.3);
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 0.9rem;
      color: var(--warning);
    }

    .verification-notice a {
      color: var(--warning);
      font-weight: 600;
    }

    /* Dashboard Styles */
    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 12px;
    }

    .dashboard-title {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--text);
      margin: 0;
    }

    .dashboard-subtitle {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin: 2px 0 0;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 14px 12px;
      text-align: center;
    }

    .stat-card.highlight {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(37, 99, 235, 0.1));
      border-color: rgba(16, 185, 129, 0.3);
    }

    .stat-value {
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--text);
      line-height: 1;
    }

    .stat-card.highlight .stat-value {
      color: var(--accent);
    }

    .stat-label {
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-top: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .request-section {
      margin-bottom: 24px;
    }

    .section-title {
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--text);
      margin: 0 0 16px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border);
    }

    .requests-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .request-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px 16px;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .request-card:hover {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
    }

    .request-card.overdue {
      border-color: rgba(245, 158, 11, 0.5);
      background: linear-gradient(135deg, var(--surface), rgba(245, 158, 11, 0.05));
    }

    .request-card.overdue:hover {
      border-color: var(--warning);
      box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.15);
    }

    .request-overdue-alert {
      background: rgba(245, 158, 11, 0.15);
      border-radius: 6px;
      padding: 8px 12px;
      font-size: 0.8rem;
      color: var(--warning);
      margin-bottom: 10px;
    }

    .request-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }

    .request-company {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text);
      margin: 0;
    }

    .request-frameworks {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
      margin-top: 3px;
    }

    .request-fw-tag {
      font-size: 0.65rem;
      padding: 2px 6px;
      background: rgba(37, 99, 235, 0.15);
      color: var(--primary);
      border-radius: 3px;
      font-weight: 500;
    }

    .request-status {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 0.8rem;
      font-weight: 500;
    }

    .request-status.pending {
      color: var(--warning);
    }

    .request-status.complete {
      color: var(--accent);
    }

    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
    }

    .request-meta {
      display: flex;
      gap: 16px;
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .request-meta-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .request-actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .request-action-btn {
      padding: 5px 10px;
      font-size: 0.75rem;
      border-radius: 5px;
      border: 1px solid var(--border);
      background: var(--bg);
      color: var(--text);
      cursor: pointer;
      transition: all 0.2s;
    }

    .request-action-btn:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    .request-action-btn.primary {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }

    .request-action-btn.primary:hover {
      background: var(--primary-hover);
    }

    .request-action-btn.danger {
      color: var(--error);
    }

    .request-action-btn.danger:hover {
      border-color: var(--error);
      background: rgba(239, 68, 68, 0.1);
    }

    .empty-state {
      text-align: center;
      padding: 24px 16px;
      color: var(--text-muted);
    }

    .empty-state-icon {
      font-size: 2rem;
      margin-bottom: 8px;
      opacity: 0.5;
    }

    .empty-state-text {
      font-size: 0.85rem;
    }

    .loading-placeholder {
      text-align: center;
      padding: 24px 16px;
      color: var(--text-muted);
      font-size: 0.85rem;
    }

    .section-count {
      font-weight: 400;
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    /* Template Cards */
    .templates-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .template-card {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px 16px;
      transition: border-color 0.2s;
    }

    .template-card:hover {
      border-color: var(--primary);
    }

    .template-info {
      flex: 1;
      min-width: 0;
    }

    .template-name {
      font-weight: 600;
      color: var(--text);
      font-size: 0.95rem;
      margin: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .template-meta {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .template-actions {
      display: flex;
      gap: 6px;
      flex-shrink: 0;
      margin-left: 12px;
    }

    .template-action-btn {
      padding: 4px 10px;
      font-size: 0.75rem;
      border-radius: 4px;
      border: 1px solid var(--border);
      background: var(--bg);
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s;
    }

    .template-action-btn:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    .template-action-btn.use {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }

    .template-action-btn.use:hover {
      background: var(--primary-hover);
    }

    .template-action-btn.delete:hover {
      border-color: var(--error);
      color: var(--error);
    }

    .back-link {
      margin-bottom: 16px;
    }

    .back-link a {
      color: var(--text-muted);
      text-decoration: none;
      font-size: 0.9rem;
      transition: color 0.2s;
    }

    .back-link a:hover {
      color: var(--primary);
    }

    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      .dashboard-header {
        flex-direction: column;
        align-items: stretch;
      }
      .dashboard-header button {
        width: 100%;
      }
    }

    @media (max-width: 480px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }
      .request-card-header {
        flex-direction: column;
        gap: 8px;
      }
      .request-meta {
        flex-direction: column;
        gap: 8px;
      }
    }

    /* Save Template Bar */
    .save-template-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: var(--surface-elevated);
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-top: 16px;
    }

    .save-template-bar span {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    @media (max-width: 600px) {
      .logged-in-bar {
        flex-direction: column;
        gap: 12px;
        align-items: stretch;
      }
      .user-actions {
        justify-content: space-between;
      }
      .login-options {
        flex-direction: column;
        gap: 10px;
        align-items: flex-start;
      }
    }

    .marquee-fixed {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      height: var(--marquee-height);
      display: flex;
      align-items: center;
      border-top: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0));
      backdrop-filter: blur(6px);
      z-index: 9999;
      overflow: hidden;
    }

    .marquee {
      white-space: nowrap;
      width: 100%;
      overflow: hidden;
    }

    .marquee > div {
      display: inline-block;
      padding-left: 100%;
      animation: scroll 28s linear infinite;
      color: #b9c6ff;
      opacity: 0.9;
    }

    @keyframes scroll {
      0% { transform: translateX(0); }
      100% { transform: translateX(-100%); }
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }

    .modal-overlay.hidden {
      display: none;
    }

    .modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      max-width: 500px;
      width: 90%;
    }

    .modal h3 {
      margin: 0 0 16px;
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 16px;
    }

    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      display: inline-block;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
      .how-grid { grid-template-columns: 1fr; }
      .pricing-grid { grid-template-columns: 1fr 1fr; }
    }

    @media (max-width: 600px) {
      .hero { padding: 32px 16px; }
      .main-container { padding: 16px; }
      .card { padding: 20px; }
      .form-row { grid-template-columns: 1fr; }
    }

    /* Flatpickr custom styling to match ProofRepo theme */
    .flatpickr-calendar {
      background: var(--surface-elevated) !important;
      border: 1px solid var(--border) !important;
      border-radius: 12px !important;
      box-shadow: 0 20px 40px rgba(0,0,0,0.4) !important;
      font-family: 'Inter', system-ui, sans-serif !important;
    }
    .flatpickr-months {
      background: var(--surface) !important;
      border-radius: 12px 12px 0 0 !important;
      padding: 8px 0 !important;
    }
    .flatpickr-months .flatpickr-month {
      color: var(--text) !important;
      fill: var(--text) !important;
    }
    .flatpickr-current-month {
      color: var(--text) !important;
      font-weight: 600 !important;
    }
    .flatpickr-current-month .flatpickr-monthDropdown-months {
      background: var(--surface) !important;
      color: var(--text) !important;
    }
    .flatpickr-current-month input.cur-year {
      color: var(--text) !important;
    }
    .flatpickr-months .flatpickr-prev-month, 
    .flatpickr-months .flatpickr-next-month {
      fill: var(--text-muted) !important;
      color: var(--text-muted) !important;
    }
    .flatpickr-months .flatpickr-prev-month:hover, 
    .flatpickr-months .flatpickr-next-month:hover {
      fill: var(--accent) !important;
      color: var(--accent) !important;
    }
    .flatpickr-weekdays {
      background: var(--surface) !important;
    }
    span.flatpickr-weekday {
      color: var(--text-muted) !important;
      font-weight: 500 !important;
    }
    .flatpickr-day {
      color: var(--text) !important;
      border-radius: 6px !important;
    }
    .flatpickr-day:hover {
      background: var(--border) !important;
      border-color: var(--border) !important;
    }
    .flatpickr-day.today {
      border-color: var(--accent) !important;
    }
    .flatpickr-day.selected {
      background: var(--accent) !important;
      border-color: var(--accent) !important;
      color: #000 !important;
      font-weight: 600 !important;
    }
    .flatpickr-day.flatpickr-disabled {
      color: var(--text-muted) !important;
      opacity: 0.4 !important;
    }
    .flatpickr-day.prevMonthDay,
    .flatpickr-day.nextMonthDay {
      color: var(--text-muted) !important;
      opacity: 0.5 !important;
    }
    .flatpickr-time {
      background: var(--surface) !important;
      border-top: 1px solid var(--border) !important;
    }
    .flatpickr-time input {
      color: var(--text) !important;
      background: var(--surface-elevated) !important;
      border: 1px solid var(--border) !important;
      border-radius: 6px !important;
    }
    .flatpickr-time input:hover,
    .flatpickr-time input:focus {
      background: var(--surface) !important;
      border-color: var(--accent) !important;
    }
    .flatpickr-time .flatpickr-am-pm {
      color: var(--text) !important;
      background: var(--surface-elevated) !important;
      border: 1px solid var(--border) !important;
      border-radius: 6px !important;
    }
    .flatpickr-time .flatpickr-am-pm:hover {
      background: var(--border) !important;
    }
    .numInputWrapper span {
      border-color: var(--border) !important;
    }
    .numInputWrapper span:hover {
      background: var(--border) !important;
    }
    .numInputWrapper span svg path {
      fill: var(--text-muted) !important;
    }
    
    /* Template Level Selector */
    .template-level-section {
      background: var(--surface-elevated);
      padding: 12px 16px;
      border-radius: 8px;
      border: 1px solid var(--border);
    }
    .template-level-btn {
      padding: 6px 14px;
      font-size: 0.85rem;
      font-weight: 500;
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text-muted);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .template-level-btn:hover {
      border-color: var(--accent);
      color: var(--text);
    }
    .template-level-btn.active {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }
    
    /* Enhanced Evidence Items */
    .ei-description {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 4px;
      line-height: 1.4;
    }
    .ei-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 6px;
      font-size: 0.75rem;
    }
    .ei-tag {
      padding: 2px 6px;
      border-radius: 4px;
      background: var(--surface);
      color: var(--text-muted);
    }
    .ei-tag.format {
      background: rgba(37, 99, 235, 0.15);
      color: #60a5fa;
    }
    .ei-tag.control {
      background: rgba(16, 185, 129, 0.15);
      color: #34d399;
    }
    .ei-tag.period {
      background: rgba(245, 158, 11, 0.15);
      color: #fbbf24;
    }
    .ei-tag.point {
      background: rgba(139, 92, 246, 0.15);
      color: #a78bfa;
    }
    .ei-common-issue {
      font-size: 0.75rem;
      color: var(--warning);
      margin-top: 6px;
      padding: 6px 8px;
      background: rgba(245, 158, 11, 0.1);
      border-radius: 4px;
      border-left: 2px solid var(--warning);
    }
    .ei-common-issue::before {
      content: '⚠️ Common issue: ';
    }
    
    /* Audit Period Group */
    .audit-period-group {
      background: var(--surface-elevated);
      padding: 16px;
      border-radius: 8px;
      border: 1px solid var(--border);
    }
  </style>
</head>
<body>
  <header class="header">
    <a href="/" class="logo">
      <div class="logo-icon">
        <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
      </div>
      ProofRepo
    </a>
    <nav class="header-links">
      <a href="#how-it-works">How it works</a>
      <a href="#trust">Security</a>
      <a id="getStartedLink">Get started</a>
    </nav>
  </header>

  <section class="hero">
    <div class="hero-badge">Compliance ProofPacks in Seconds</div>
    <h1>Streamlined evidence collection — without the chaos</h1>
    <p><strong>Compliance teams:</strong> Define exactly what evidence you need. Send your client a guided upload link.</p>
    <p><strong>Companies:</strong> Upload evidence with clear guidance. No more "wrong file" corrections.</p>
    <div class="hero-features">
      <div class="hero-feature">
        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
        <span><strong>Customized requests:</strong> Specify exactly what you need.</span>
      </div>
      <div class="hero-feature">
        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
        <span><strong>Guided for clients:</strong> Clear checklist shows what to upload.</span>
      </div>
      <div class="hero-feature">
        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
        <span><strong>Structured output:</strong> Files mapped to controls, ready for workpapers.</span>
      </div>
    </div>
  </section>

  <main class="main-container">
    <!-- Success Banner -->
    <div id="successBanner" class="success-banner">
      <h3>✓ Payment Successful!</h3>
      <p>Your code is ready to use:</p>
      <div class="code-display" id="successCodeDisplay">—</div>
      <p style="font-size: 0.85rem;">This code has been auto-filled below. Click "Send Request" when ready.</p>
    </div>

    <div id="mainFormCard" class="card">
      <div class="card-header">
        <h2>Request compliance evidence</h2>
        <p>Build guided evidence request checklists and let ProofRepo handle collection and follow-up.</p>
      </div>

      <div id="roleSelectSection" class="role-selector">
        <label class="form-label">Getting started</label>
        <select id="roleSelect">
          <option value="">Select...</option>
          <option value="new">I'm new to ProofRepo</option>
          <option value="returning">I'm a returning customer</option>
        </select>
      </div>

      <!-- Auth Flow: New User -->
      <div id="newUserFlow" class="auth-flow" style="display: none;">
        <div class="auth-box">
          <h3>Welcome to ProofRepo!</h3>
          <p class="auth-subtitle">Choose how you'd like to get started:</p>
          
          <div class="auth-options">
            <label class="auth-option">
              <input type="radio" name="newUserType" value="trial" checked>
              <span class="auth-option-content">
                <span class="auth-option-title">I have a trial code</span>
                <span class="auth-option-desc">Distributed to select members of the compliance community</span>
              </span>
            </label>
            <label class="auth-option">
              <input type="radio" name="newUserType" value="account">
              <span class="auth-option-content">
                <span class="auth-option-title">Create an account</span>
                <span class="auth-option-desc">Purchase credits and save templates</span>
              </span>
            </label>
          </div>

          <!-- Trial Code Entry -->
          <div id="trialCodeSection" class="auth-section">
            <div class="form-group">
              <label class="form-label">Trial Code</label>
              <input type="text" class="form-input code-style" id="trialCodeInput" placeholder="ENTER TRIAL CODE">
            </div>
            <button class="btn btn-primary btn-full" id="applyTrialBtn">Apply Code</button>
            <div id="trialStatus" class="auth-status"></div>
          </div>

          <!-- Trial Mode Selection (shown after valid trial code) -->
          <div id="trialModeSection" class="auth-section" style="display: none;">
            <div class="success-box">
              <span class="success-icon">✓</span>
              <span>Trial code accepted! 1 free request.</span>
            </div>
            
            <div class="form-group">
              <label class="form-label">Your email</label>
              <input type="email" class="form-input" id="trialUserEmail" placeholder="you@company.com">
              <span class="form-hint">We'll send confirmation and results here</span>
            </div>
            
            <div class="form-group">
              <label class="form-label">Trial mode</label>
              <div class="trial-modes">
                <label class="trial-mode">
                  <input type="radio" name="trialMode" value="live" checked>
                  <span class="trial-mode-content">
                    <strong>Live request</strong>
                    <span>Send to a real client</span>
                  </span>
                </label>
                <label class="trial-mode">
                  <input type="radio" name="trialMode" value="test">
                  <span class="trial-mode-content">
                    <strong>Test mode</strong>
                    <span>Send to myself (experience both sides)</span>
                  </span>
                </label>
              </div>
              <div id="testModeExplainer" class="info-box" style="display: none;">
                You'll receive both the auditor confirmation and client request emails. Upload test evidence, then view the results as if you were the auditor.
              </div>
            </div>
            
            <button class="btn btn-accent btn-full" id="startTrialBtn">Continue to Request Builder</button>
          </div>

          <!-- Account Creation -->
          <div id="accountSection" class="auth-section" style="display: none;">
            <div class="form-group">
              <label class="form-label">Email</label>
              <input type="email" class="form-input" id="signupEmail" placeholder="you@company.com">
            </div>
            <div class="form-group">
              <label class="form-label">Password</label>
              <input type="password" class="form-input" id="signupPassword" placeholder="Create a password">
              <div class="password-reqs">
                <span class="req" data-req="length">8+ characters</span>
                <span class="req" data-req="number">1 number</span>
                <span class="req" data-req="special">1 special character</span>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Confirm Password</label>
              <input type="password" class="form-input" id="signupPasswordConfirm" placeholder="Confirm password">
            </div>
            <button class="btn btn-primary btn-full" id="signupBtn">Create Account</button>
            <p class="auth-footnote">We'll send a verification email to confirm your account.</p>
            <div id="signupStatus" class="auth-status"></div>
          </div>
        </div>
      </div>

      <!-- Auth Flow: Returning User -->
      <div id="returningUserFlow" class="auth-flow" style="display: none;">
        <div class="auth-box">
          <h3>Welcome back!</h3>
          
          <!-- Login Form -->
          <div id="loginSection">
            <div class="form-group">
              <label class="form-label">Email</label>
              <input type="email" class="form-input" id="loginEmail" placeholder="you@company.com">
            </div>
            <div class="form-group">
              <label class="form-label">Password</label>
              <input type="password" class="form-input" id="loginPassword" placeholder="Your password">
            </div>
            <div class="login-options">
              <label class="checkbox-label">
                <input type="checkbox" id="rememberMe" checked>
                <span>Remember me for 30 days</span>
              </label>
              <a href="#" id="forgotPasswordLink" class="text-link">Forgot password?</a>
            </div>
            <button class="btn btn-primary btn-full" id="loginBtn">Sign In</button>
            <div id="loginStatus" class="auth-status"></div>
          </div>

          <!-- Forgot Password -->
          <div id="forgotPasswordSection" style="display: none;">
            <p class="auth-subtitle">Enter your email and we'll send a reset link.</p>
            <div class="form-group">
              <label class="form-label">Email</label>
              <input type="email" class="form-input" id="resetEmail" placeholder="you@company.com">
            </div>
            <button class="btn btn-primary btn-full" id="sendResetBtn">Send Reset Link</button>
            <button class="btn btn-outline btn-full" id="backToLoginBtn" style="margin-top: 8px;">Back to Sign In</button>
            <div id="resetStatus" class="auth-status"></div>
          </div>

          <!-- Reset Password Form (shown when ?reset= token in URL) -->
          <div id="resetPasswordSection" style="display: none;">
            <p class="auth-subtitle">Choose a new password for your account.</p>
            <div class="form-group">
              <label class="form-label">New Password</label>
              <input type="password" class="form-input" id="newPassword" placeholder="Minimum 8 characters">
              <div class="password-requirements" id="resetPwReqs">
                <span id="resetReqLength">✗ 8+ characters</span>
                <span id="resetReqNumber">✗ 1 number</span>
                <span id="resetReqSpecial">✗ 1 special character</span>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Confirm Password</label>
              <input type="password" class="form-input" id="confirmNewPassword" placeholder="Re-enter new password">
            </div>
            <button class="btn btn-primary btn-full" id="resetPasswordBtn">Reset Password</button>
            <div id="resetPasswordStatus" class="auth-status"></div>
          </div>
        </div>
      </div>

      <!-- Logged In Header Bar (shown when authenticated) -->
      <div id="loggedInBar" class="logged-in-bar" style="display: none;">
        <div class="user-info">
          <span class="user-email" id="currentUserEmail"></span>
          <span class="credits-badge" id="creditsDisplay">0 credits</span>
          <button class="btn btn-xs btn-outline" id="buyCreditsHeaderBtn">Buy Credits</button>
        </div>
        <div class="user-actions">
          <button class="btn btn-sm btn-outline" id="logoutBtn">Sign Out</button>
        </div>
      </div>

      <!-- Trial Notice Bar -->
      <div id="trialNoticeBar" class="trial-notice" style="display: none;">
        <span class="trial-badge">TRIAL</span>
        <span>You're using a trial credit. <a href="#" id="createAccountLink">Create an account</a> to save templates.</span>
      </div>

      <!-- Verification Notice -->
      <div id="verificationNotice" class="verification-notice" style="display: none;">
        <span>⚠️ Please verify your email to send requests. <a href="#" id="resendVerifyLink">Resend verification</a></span>
      </div>

      <!-- Dashboard View (shown for logged-in users) -->
      <div id="dashboardView" style="display: none;">
        <div class="dashboard-header">
          <div>
            <h2 class="dashboard-title">Your Evidence Requests</h2>
            <p class="dashboard-subtitle">Manage your compliance evidence collection</p>
          </div>
          <button class="btn btn-accent" id="newRequestBtn">+ New Evidence Request</button>
        </div>
        
        <!-- Low Credit Alert -->
        <div id="creditAlert" class="credit-alert" style="display: none;">
          <div class="credit-alert-content">
            <div class="credit-alert-icon">⚠️</div>
            <div class="credit-alert-text">
              <strong id="creditAlertTitle">Running low on credits</strong>
              <span id="creditAlertDesc">You have <span id="creditAlertCount">0</span> credit(s) remaining.</span>
            </div>
          </div>
          <button class="btn btn-sm btn-accent" id="buyCreditsAlertBtn">Buy More Credits</button>
        </div>
        
        <!-- Stats Cards -->
        <div class="stats-grid" id="statsGrid">
          <div class="stat-card">
            <div class="stat-value" id="statActive">-</div>
            <div class="stat-label">Active Requests</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statCompleted">-</div>
            <div class="stat-label">Completed</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statEvidence">-</div>
            <div class="stat-label">Evidence Items Collected</div>
          </div>
          <div class="stat-card highlight">
            <div class="stat-value" id="statThisMonth">-</div>
            <div class="stat-label">Requests This Month</div>
          </div>
        </div>
        
        <!-- Active Requests Section -->
        <div class="request-section">
          <h3 class="section-title">Active Requests</h3>
          <div id="activeRequestsList" class="requests-list">
            <div class="loading-placeholder">Loading requests...</div>
          </div>
        </div>
        
        <!-- Completed Requests Section -->
        <div class="request-section">
          <h3 class="section-title">Completed</h3>
          <div id="completedRequestsList" class="requests-list">
            <div class="loading-placeholder">Loading requests...</div>
          </div>
        </div>
        
        <!-- Saved Templates Section -->
        <div class="request-section">
          <h3 class="section-title">
            Saved Templates
            <span class="section-count" id="templateCount">(0)</span>
          </h3>
          <div id="templatesList" class="templates-list">
            <div class="loading-placeholder">Loading templates...</div>
          </div>
        </div>
      </div>

      <div id="auditorFlow" style="display: none;">
        <!-- Back to dashboard link (shown when coming from dashboard) -->
        <div id="backToDashboard" class="back-link" style="display: none;">
          <a href="#" id="backToDashboardLink">← Back to Dashboard</a>
        </div>
        
        <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 20px;">
          Define what evidence you need, then we'll email your client a guided upload link.
        </p>

        <div class="form-group">
          <label class="form-label">Your team's email(s)</label>
          <div class="chip-input-container" id="auditorEmailsContainer" data-placeholder="you@yourcompany.com">
            <input type="text" class="chip-text-input" placeholder="you@yourcompany.com">
          </div>
          <div class="chip-input-hint">Press Enter or comma to add multiple team members</div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Client company</label>
            <input type="text" class="form-input" id="clientCompany" placeholder="Acme Corp">
          </div>
          <div class="form-group">
            <label class="form-label">Client email(s)</label>
            <div class="chip-input-container" id="clientEmailsContainer" data-placeholder="client@company.com">
              <input type="text" class="chip-text-input" placeholder="client@company.com">
            </div>
            <div class="chip-input-hint">Add multiple contacts if needed</div>
          </div>
        </div>

        <!-- Deadline with Calendar Picker -->
        <div class="form-group">
          <label class="form-label">Deadline</label>
          <input type="text" class="form-control" id="deadlinePicker" placeholder="Select date and time..." readonly>
          <small class="form-hint" id="deadlineHint" style="margin-top:6px;display:block;color:var(--text-muted);font-size:12px;"></small>
        </div>

        <!-- Audit Period (Optional) -->
        <div class="form-group audit-period-group">
          <label class="form-label">Audit Period <span style="font-weight:normal;color:var(--text-muted);">(optional)</span></label>
          <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 10px;">
            For period-of-time evidence (logs, reviews, scans), these dates help clients understand what timeframe is required.
          </p>
          <div class="form-row" style="gap: 16px;">
            <div style="flex:1;">
              <label class="form-label" style="font-size:0.8rem;">Start Date</label>
              <input type="text" class="form-control" id="auditPeriodStart" placeholder="e.g., Jan 1, 2025" readonly>
            </div>
            <div style="flex:1;">
              <label class="form-label" style="font-size:0.8rem;">End Date</label>
              <input type="text" class="form-control" id="auditPeriodEnd" placeholder="e.g., Dec 31, 2025" readonly>
            </div>
          </div>
          <small id="auditPeriodHint" style="margin-top:6px;display:block;color:var(--text-muted);font-size:12px;"></small>
        </div>

        <div class="form-group">
          <label class="form-label">Evidence Request</label>
          
          <!-- Template Loader (shown when logged in with templates) -->
          <div id="templateLoaderSection" class="template-loader-section" style="display: none;">
            <select id="templateSelect" class="template-select-inline">
              <option value="">Load a saved template...</option>
            </select>
          </div>
          
          <!-- Template Loaded Notification -->
          <div id="templateLoadedNotice" class="template-loaded-notice" style="display: none;">
            <div class="notice-content">
              <span class="notice-icon">✓</span>
              <div class="notice-text">
                <strong>Template loaded:</strong> <span id="loadedTemplateName"></span>
                <p>Frameworks, evidence items, and instructions have been restored. If you make changes, remember to save as a new template below.</p>
              </div>
              <button type="button" class="notice-dismiss" id="dismissTemplateNotice">×</button>
            </div>
          </div>
          
          <!-- Template Level Selector -->
          <div id="templateLevelSection" class="template-level-section" style="margin-bottom: 12px;">
            <label style="font-size: 0.85rem; color: var(--text-muted); margin-right: 10px;">Template level:</label>
            <div class="template-level-buttons" style="display: inline-flex; gap: 8px;">
              <button type="button" class="template-level-btn" data-level="quickStart" title="Essential items only (~15-25 items)">Quick</button>
              <button type="button" class="template-level-btn active" data-level="standard" title="Comprehensive coverage (~30-45 items)">Standard</button>
              <button type="button" class="template-level-btn" data-level="thorough" title="Complete evidence set (~45-70 items)">Thorough</button>
            </div>
          </div>
          
          <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 12px;">
            Check frameworks, then customize what evidence you need. Items with ✓ are included by default.
          </p>
          <div id="composer"></div>
        </div>

        <!-- Payment Section -->
        <div id="paymentSection" class="payment-section">
          <div class="payment-header">
            <h3>Enter your credit code</h3>
            <p>Each code gives you credits to send evidence requests.</p>
          </div>

          <div class="code-entry">
            <label class="form-label">Credit Code</label>
            <input type="text" class="code-input" id="auditorCode" placeholder="ENTER CODE">
            <div id="codeStatus" class="code-status"></div>
          </div>

          <!-- Purchase section - hidden after checkout return -->
          <div id="purchaseSection" class="purchase-section">
            <p class="divider-text">— or purchase credits —</p>
            <div class="pricing-grid">
              <div class="pricing-card" data-tier="single">
                <div class="pricing-card-name">Single</div>
                <div class="pricing-card-price">$59</div>
                <div class="pricing-card-desc">1 credit</div>
              </div>
              <div class="pricing-card" data-tier="pack5">
                <div class="pricing-card-name">5-Pack</div>
                <div class="pricing-card-price">$249</div>
                <div class="pricing-card-desc">$50 each</div>
              </div>
              <div class="pricing-card" data-tier="pack15">
                <div class="pricing-card-name">15-Pack</div>
                <div class="pricing-card-price">$499</div>
                <div class="pricing-card-desc">$33 each</div>
              </div>
              <div class="pricing-card" data-tier="pack50">
                <div class="pricing-card-name">50-Pack</div>
                <div class="pricing-card-price">$1,249</div>
                <div class="pricing-card-desc">$25 each</div>
              </div>
            </div>
            <button class="btn btn-outline btn-full" id="buyCreditsBtn" disabled>
              Select a plan to purchase
            </button>
          </div>
        </div>

        <!-- Main Action Button -->
        <button class="btn btn-primary btn-full" id="mainActionBtn" style="margin-top: 24px;">
          Continue
        </button>
      </div>
    </div>
  </main>

  <section id="how-it-works" class="how-section">
    <h2>How it works</h2>
    <div class="how-grid">
      <div class="how-card">
        <h3>1. Create your request</h3>
        <p>Select frameworks, customize evidence items, add instructions for your client.</p>
      </div>
      <div class="how-card">
        <h3>2. Client uploads</h3>
        <p>Client receives a link with a clear checklist of exactly what to provide.</p>
      </div>
      <div class="how-card">
        <h3>3. ProofPack ready</h3>
        <p>Files organized by control area with a manifest ready for workpapers.</p>
      </div>
    </div>
  </section>

  <!-- TRUST SECTION -->
  <section class="trust-section" id="trust">
    <div class="section-inner">
      <div class="section-header">
        <div class="section-badge">
          <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
            <path d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
          </svg>
          Security First
        </div>
        <h2>Your Data, Protected</h2>
        <p class="section-subtitle">Enterprise-grade security without enterprise complexity. Built on trusted infrastructure.</p>
      </div>

      <div class="trust-grid">
        <div class="trust-card">
          <div class="trust-card-icon">
            <svg viewBox="0 0 24 24">
              <path d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
            </svg>
          </div>
          <h3>AES-256 Encryption</h3>
          <p>Bank-grade encryption at rest</p>
        </div>

        <div class="trust-card">
          <div class="trust-card-icon">
            <svg viewBox="0 0 24 24">
              <path d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
            </svg>
          </div>
          <h3>TLS 1.2+ Transit</h3>
          <p>Encrypted data transfer</p>
        </div>

        <div class="trust-card">
          <div class="trust-card-icon">
            <svg viewBox="0 0 24 24">
              <path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
            </svg>
          </div>
          <h3>90-Day Auto-Delete</h3>
          <p>Automatic data removal</p>
        </div>

        <div class="trust-card">
          <div class="trust-card-icon">
            <svg viewBox="0 0 24 24">
              <path d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
            </svg>
          </div>
          <h3>SOC 2 Infrastructure</h3>
          <p>Built on Cloudflare</p>
        </div>
      </div>

      <div class="trust-footer">
        <span class="trust-footer-text">Learn more:</span>
        <div class="trust-links">
          <a href="/security.html" class="trust-link">
            <svg viewBox="0 0 24 24">
              <path d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
            </svg>
            Security
          </a>
          <a href="/privacy.html" class="trust-link">
            <svg viewBox="0 0 24 24">
              <path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
              <path d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
            </svg>
            Privacy
          </a>
          <a href="/terms.html" class="trust-link">
            <svg viewBox="0 0 24 24">
              <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
            Terms
          </a>
        </div>
      </div>
    </div>
  </section>

  <footer class="footer">
    <div class="footer-links">
      <a href="#how-it-works">How it Works</a>
      <a href="/security.html">Security</a>
      <a href="/privacy.html">Privacy Policy</a>
      <a href="/terms.html">Terms of Service</a>
      <a href="/cdn-cgi/l/email-protection#7605030606190402360604191910041306195815191b">Contact</a>
    </div>
    <p>© <span id="year"></span> ProofRepo. All rights reserved.</p>
  </footer>

  <div class="marquee-fixed">
    <div class="marquee">
      <div>&nbsp;Guided compliance evidence collection • Built for compliance teams • SOC 2, ISO 27001, HIPAA, GDPR & more • Get started with a free trial •&nbsp;&nbsp;&nbsp;&nbsp;Guided compliance evidence collection • Built for compliance teams • SOC 2, ISO 27001, HIPAA, GDPR & more • Get started with a free trial •</div>
    </div>
  </div>

  <div id="addFwModal" class="modal-overlay hidden">
    <div class="modal">
      <h3>Add Custom Framework</h3>
      <div class="form-group">
        <label class="form-label">Framework name</label>
        <input type="text" class="form-input" id="customFwName" placeholder="e.g., PCI DSS, FedRAMP, Internal Audit">
      </div>
      <div class="form-group">
        <label class="form-label">Description (optional)</label>
        <input type="text" class="form-input" id="customFwDesc" placeholder="Brief description">
      </div>
      <div class="modal-actions">
        <button type="button" class="btn btn-outline" id="cancelFwBtn">Cancel</button>
        <button type="button" class="btn btn-primary" id="saveFwBtn">Add Framework</button>
      </div>
    </div>
  </div>

  <div id="addGroupModal" class="modal-overlay hidden">
    <div class="modal">
      <h3>Add Control Group</h3>
      <div class="form-group">
        <label class="form-label">Control group name</label>
        <input type="text" class="form-input" id="customGroupName" placeholder="e.g., Network Security, Physical Security">
      </div>
      <div class="form-group">
        <label class="form-label">Description (optional)</label>
        <input type="text" class="form-input" id="customGroupDesc" placeholder="What this control group covers">
      </div>
      <input type="hidden" id="customGroupFwKey" value="">
      <div class="modal-actions">
        <button type="button" class="btn btn-outline" id="cancelGroupBtn">Cancel</button>
        <button type="button" class="btn btn-primary" id="saveGroupBtn">Add Control Group</button>
      </div>
    </div>
  </div>

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
const API = 'https://proofrepo-intake.atucker5.workers.dev';
const STORAGE_KEY = 'proofrepo_form_state';


// ENHANCED FRAMEWORK LIBRARY v2.0
// Includes 7 frameworks with enhanced fields:
// - description: Detailed professional description
// - evidenceType: 'point-in-time' or 'period-of-time'
// - expectedFormat: PDF, Excel, Screenshot, etc.
// - controlRef: Control reference (CC6.1, A.8.5, etc.)
// - commonIssue: Common rejection reasons
// - frequency: annual, quarterly, monthly, etc.

const FRAMEWORK_LIBRARY = {
  SOC2: {
    label: 'SOC 2', 
    description: 'Service Organization Control 2 - Trust Services Criteria',
    defaultOn: true,
    controlGroups: [
      { 
        id: 'cc1_environment', 
        title: 'CC1: Control Environment', 
        description: 'Organization structure, integrity, ethics, and oversight',
        items: [
          { id: 'org_chart', title: 'Organization Chart', common: true, hint: 'Current org chart showing security reporting', description: 'Provide the current organizational chart showing key positions, reporting relationships, and security/IT governance structure.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'CC1.1', commonIssue: 'Must show security reporting lines, not just general org structure.', frequency: 'annual' },
          { id: 'info_sec_policy', title: 'Information Security Policy', common: true, hint: 'Current policy with approval date', description: 'Provide the organization\'s current Information Security Policy document. This should include version number, approval date, and executive sign-off.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'CC1.1, CC1.2', commonIssue: 'Often rejected if missing signature/approval date. Ensure document shows formal adoption.', frequency: 'annual' },
          { id: 'code_of_conduct', title: 'Code of Conduct', common: true, hint: 'Ethics and conduct expectations', description: 'Provide the Code of Conduct or Ethics Policy establishing expectations for employee behavior.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'CC1.1', commonIssue: 'Should be a formal document, not just employee handbook excerpt.', frequency: 'annual' },
          { id: 'security_roles', title: 'Security Roles & Responsibilities', common: true, hint: 'RACI showing security ownership', description: 'Provide documentation defining security roles and responsibilities (RACI matrix, job descriptions, or responsibility assignment).', evidenceType: 'point-in-time', expectedFormat: 'PDF or Excel', controlRef: 'CC1.3', commonIssue: 'Must clearly assign accountability for security, not just list job titles.', frequency: 'annual' },
          { id: 'hr_policies', title: 'HR Security Policies', common: false, hint: 'Background checks, onboarding', description: 'Provide HR policies covering background checks, onboarding security requirements, and employee screening.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'CC1.4', commonIssue: 'Should include background check requirements and timing.', frequency: 'annual' },
          { id: 'board_oversight', title: 'Board/Executive Oversight', common: false, hint: 'Evidence of governance oversight', description: 'Provide evidence of board or executive committee oversight of information security during {{auditPeriod}} (meeting minutes, presentations, reports).', evidenceType: 'period-of-time', expectedFormat: 'PDF', controlRef: 'CC1.2', commonIssue: 'Need evidence security was actually discussed at governance level.', frequency: 'quarterly' }
        ]
      },
      { 
        id: 'cc2_communication', 
        title: 'CC2: Communication & Information', 
        description: 'Internal and external communication of policies and objectives',
        items: [
          { id: 'security_awareness_program', title: 'Security Awareness Program', common: true, hint: 'Training program documentation', description: 'Provide documentation of the security awareness program including topics covered, delivery method, and frequency requirements.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'CC2.2', commonIssue: 'Should show program content, not just completion rates.', frequency: 'annual' },
          { id: 'security_training_completion', title: 'Security Training Completion', common: true, hint: 'Training records for audit period', description: 'Provide security awareness training completion records for {{auditPeriod}}. Include employee name, completion date, and course name.', evidenceType: 'period-of-time', expectedFormat: 'Excel or PDF', controlRef: 'CC2.2', commonIssue: 'WRONG DATE RANGE is top rejection cause. Verify dates cover full audit period.', frequency: 'annual' },
          { id: 'acceptable_use_policy', title: 'Acceptable Use Policy', common: true, hint: 'IT usage guidelines', description: 'Provide the Acceptable Use Policy defining permitted use of company IT resources, including email, internet, and devices.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'CC2.1', commonIssue: 'Should cover modern scenarios (BYOD, cloud services, remote work).', frequency: 'annual' },
          { id: 'policy_acknowledgments', title: 'Policy Acknowledgment Records', common: false, hint: 'Employee sign-offs', description: 'Provide evidence that employees acknowledged security policies during {{auditPeriod}}.', evidenceType: 'period-of-time', expectedFormat: 'Excel or PDF', controlRef: 'CC2.2', commonIssue: 'Should show acknowledgment, not just distribution.', frequency: 'annual' },
          { id: 'phishing_testing', title: 'Phishing Test Results', common: false, hint: 'Simulated phishing results', description: 'Provide phishing simulation test results from {{auditPeriod}} including click rates and remediation actions.', evidenceType: 'period-of-time', expectedFormat: 'PDF', controlRef: 'CC2.2', commonIssue: 'Should show trend data and follow-up training for clickers.', frequency: 'quarterly' }
        ]
      },
      { 
        id: 'cc3_risk', 
        title: 'CC3: Risk Assessment', 
        description: 'Risk identification, assessment, and management processes',
        items: [
          { id: 'risk_assessment', title: 'Risk Assessment', common: true, hint: 'Annual risk assessment', description: 'Provide the most recent comprehensive risk assessment covering information security risks, including methodology, identified risks, and risk ratings.', evidenceType: 'period-of-time', expectedFormat: 'PDF or Excel', controlRef: 'CC3.1, CC3.2', commonIssue: 'Must be from within audit period. Generic templates without specific findings are rejected.', frequency: 'annual' },
          { id: 'risk_register', title: 'Risk Register', common: true, hint: 'Current risk register', description: 'Provide the current risk register showing identified risks, owners, ratings, and treatment status.', evidenceType: 'point-in-time', expectedFormat: 'Excel', controlRef: 'CC3.2', commonIssue: 'Should show risk owners and treatment decisions, not just a list of risks.', frequency: 'quarterly' },
          { id: 'risk_treatment_plan', title: 'Risk Treatment Plan', common: true, hint: 'How risks are addressed', description: 'Provide risk treatment plans for significant identified risks showing planned mitigations and timelines.', evidenceType: 'point-in-time', expectedFormat: 'PDF or Excel', controlRef: 'CC3.2', commonIssue: 'Should show concrete actions, not just "accept" or "mitigate" decisions.', frequency: 'annual' },
          { id: 'third_party_risk_assessment', title: 'Third-Party Risk Assessments', common: false, hint: 'Vendor risk evaluations', description: 'Provide third-party/vendor risk assessments conducted during {{auditPeriod}} for critical vendors.', evidenceType: 'period-of-time', expectedFormat: 'PDF or Excel', controlRef: 'CC3.4', commonIssue: 'Focus on high-risk vendors. May not be needed if no new vendors.', frequency: 'annual' }
        ]
      },
      { 
        id: 'cc6_access', 
        title: 'CC6: Logical & Physical Access', 
        description: 'Access controls for systems and data',
        items: [
          { id: 'access_control_policy', title: 'Access Control Policy', common: true, hint: 'Access management policy', description: 'Provide the Access Control Policy defining how access is requested, approved, provisioned, and revoked.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'CC6.1', commonIssue: 'Should include least privilege and need-to-know principles.', frequency: 'annual' },
          { id: 'user_access_review', title: 'User Access Reviews', common: true, hint: 'Periodic access review evidence', description: 'Provide user access review documentation from {{auditPeriod}}. Include the user list reviewed, reviewer name, review date, and approval/remediation decisions for each user.', evidenceType: 'period-of-time', expectedFormat: 'Excel or PDF', controlRef: 'CC6.2', commonIssue: 'Must show actual review decisions, not just that a review occurred. Include evidence of remediation for inappropriate access.', frequency: 'quarterly' },
          { id: 'privileged_access_list', title: 'Privileged Access Listing', common: true, hint: 'Admin/elevated access users', description: 'Provide current listing of users with privileged/administrative access including system, access level, and business justification.', evidenceType: 'point-in-time', expectedFormat: 'Excel', controlRef: 'CC6.1, CC6.3', commonIssue: 'Should include justification for each privileged user.', frequency: 'quarterly' },
          { id: 'mfa_config', title: 'MFA Configuration', common: true, hint: 'Multi-factor authentication setup', description: 'Provide screenshots showing MFA is enabled and enforced for all users accessing production systems and sensitive data.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot', controlRef: 'CC6.1', commonIssue: 'Must show MFA is enforced, not just available. Include IdP configuration.', frequency: 'annual' },
          { id: 'password_policy_config', title: 'Password Policy Configuration', common: true, hint: 'Password requirements', description: 'Provide screenshot of password policy configuration from identity provider or Active Directory showing complexity, length, and expiration settings.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot', controlRef: 'CC6.1', commonIssue: 'Should show technical enforcement, not just written policy.', frequency: 'annual' },
          { id: 'onboarding_samples', title: 'New User Provisioning Samples', common: false, hint: 'Sample new hire access requests', description: 'Provide 2-3 sample new user access provisioning tickets from {{auditPeriod}} showing request, approval, and completion.', evidenceType: 'period-of-time', expectedFormat: 'PDF or Screenshot', controlRef: 'CC6.2', commonIssue: 'Approval must come before access was granted.', frequency: 'quarterly' },
          { id: 'offboarding_samples', title: 'Terminated User Access Removal', common: true, hint: 'Sample termination access removal', description: 'Provide 2-3 sample termination cases from {{auditPeriod}} showing access was removed timely (within 24 hours of termination).', evidenceType: 'period-of-time', expectedFormat: 'PDF or Screenshot', controlRef: 'CC6.2', commonIssue: 'Access removal date must be on or before termination date. Late removals are findings.', frequency: 'quarterly' },
          { id: 'encryption_at_rest', title: 'Encryption at Rest', common: true, hint: 'Data-at-rest encryption', description: 'Provide evidence of encryption at rest for databases, file storage, and backups containing sensitive data.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot', controlRef: 'CC6.1, CC6.7', commonIssue: 'Should show encryption is enabled in system settings, not just policy.', frequency: 'annual' },
          { id: 'encryption_in_transit', title: 'Encryption in Transit', common: false, hint: 'TLS/SSL configuration', description: 'Provide evidence of TLS 1.2+ enforcement for data in transit including certificate configuration and protocol settings.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot', controlRef: 'CC6.1, CC6.7', commonIssue: 'Should show TLS 1.2 minimum; TLS 1.0/1.1 should be disabled.', frequency: 'annual' }
        ]
      },
      { 
        id: 'cc7_operations', 
        title: 'CC7: System Operations', 
        description: 'Security operations, monitoring, and vulnerability management',
        items: [
          { id: 'vulnerability_scanning', title: 'Vulnerability Scan Reports', common: true, hint: 'Vuln scan results', description: 'Provide vulnerability scan reports from {{auditPeriod}} showing internal and external scan results including severity ratings and remediation status.', evidenceType: 'period-of-time', expectedFormat: 'PDF', controlRef: 'CC7.1', commonIssue: 'WRONG DATE RANGE common. Should include monthly or quarterly scans for full period.', frequency: 'monthly' },
          { id: 'vulnerability_remediation', title: 'Vulnerability Remediation Evidence', common: true, hint: 'How vulns were fixed', description: 'Provide evidence of vulnerability remediation during {{auditPeriod}} showing critical/high vulnerabilities were addressed within SLA.', evidenceType: 'period-of-time', expectedFormat: 'PDF or Excel', controlRef: 'CC7.1', commonIssue: 'Should show tickets/tracking, not just before/after scans.', frequency: 'quarterly' },
          { id: 'penetration_testing', title: 'Penetration Test Report', common: true, hint: 'Annual pentest report', description: 'Provide the most recent penetration test report including scope, findings, severity ratings, and remediation recommendations.', evidenceType: 'period-of-time', expectedFormat: 'PDF', controlRef: 'CC7.1', commonIssue: 'Must be from within audit period. Third-party pentests preferred.', frequency: 'annual' },
          { id: 'security_monitoring', title: 'Security Monitoring Configuration', common: true, hint: 'SIEM/monitoring setup', description: 'Provide documentation of security monitoring and alerting configuration including what events trigger alerts and escalation procedures.', evidenceType: 'point-in-time', expectedFormat: 'PDF or Screenshot', controlRef: 'CC7.2', commonIssue: 'Should show specific alert rules, not just that monitoring exists.', frequency: 'annual' },
          { id: 'endpoint_protection', title: 'Endpoint Protection', common: true, hint: 'EDR/antivirus coverage', description: 'Provide evidence of endpoint protection deployment including coverage report showing all endpoints have current protection.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot or PDF', controlRef: 'CC7.1', commonIssue: 'Should show coverage percentage and list any exceptions.', frequency: 'quarterly' },
          { id: 'security_alert_samples', title: 'Security Alert Samples', common: false, hint: 'Sample security alerts', description: 'Provide 3-5 sample security alerts from {{auditPeriod}} showing alert, investigation, and resolution.', evidenceType: 'period-of-time', expectedFormat: 'PDF or Screenshot', controlRef: 'CC7.2, CC7.3', commonIssue: 'Should show investigation steps, not just alert acknowledgment.', frequency: 'quarterly' }
        ]
      },
      { 
        id: 'cc8_change', 
        title: 'CC8: Change Management', 
        description: 'Change control for systems and applications',
        items: [
          { id: 'change_management_policy', title: 'Change Management Policy', common: true, hint: 'Change control requirements', description: 'Provide the Change Management Policy defining requirements for requesting, approving, testing, and deploying changes.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'CC8.1', commonIssue: 'Should address both application and infrastructure changes.', frequency: 'annual' },
          { id: 'change_log', title: 'Change Log', common: true, hint: 'Record of changes', description: 'Provide change log showing changes deployed during {{auditPeriod}} including change ID, description, date, and approver.', evidenceType: 'period-of-time', expectedFormat: 'Excel or Screenshot', controlRef: 'CC8.1', commonIssue: 'Should be comprehensive, not just major releases.', frequency: 'quarterly' },
          { id: 'change_samples', title: 'Change Ticket Samples', common: true, hint: 'Sample change approvals', description: 'Provide 3-5 sample change tickets from {{auditPeriod}} showing request, approval, testing evidence, and deployment.', evidenceType: 'period-of-time', expectedFormat: 'PDF or Screenshot', controlRef: 'CC8.1', commonIssue: 'Approval must occur BEFORE deployment. Show different change types if possible.', frequency: 'quarterly' },
          { id: 'branch_protection', title: 'Branch Protection Rules', common: true, hint: 'Code merge controls', description: 'Provide screenshot of branch protection configuration showing required reviews, approvals, and merge restrictions for main/production branches.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot', controlRef: 'CC8.1', commonIssue: 'Should show enforcement, not just optional settings.', frequency: 'annual' },
          { id: 'code_review_evidence', title: 'Code Review Evidence', common: false, hint: 'Pull request approvals', description: 'Provide 3-5 sample pull requests from {{auditPeriod}} showing code review comments and approvals before merge.', evidenceType: 'period-of-time', expectedFormat: 'Screenshot', controlRef: 'CC8.1', commonIssue: 'Should show actual review comments, not just approval click.', frequency: 'quarterly' }
        ]
      },
      { 
        id: 'cc9_risk_mitigation', 
        title: 'CC9: Risk Mitigation', 
        description: 'Vendor management and business continuity',
        items: [
          { id: 'vendor_inventory', title: 'Vendor Inventory', common: true, hint: 'List of vendors with risk tiers', description: 'Provide current vendor inventory including vendor name, services provided, data accessed, and risk tier.', evidenceType: 'point-in-time', expectedFormat: 'Excel', controlRef: 'CC9.2', commonIssue: 'Should include all vendors with access to sensitive data or systems.', frequency: 'annual' },
          { id: 'vendor_management_policy', title: 'Vendor Management Policy', common: true, hint: 'Third-party risk policy', description: 'Provide the Vendor Management Policy defining how vendors are evaluated, approved, and monitored.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'CC9.2', commonIssue: 'Should include risk assessment requirements and ongoing monitoring.', frequency: 'annual' },
          { id: 'vendor_assessments', title: 'Vendor Security Assessments', common: false, hint: 'Sample vendor reviews', description: 'Provide 2-3 sample vendor security assessments from {{auditPeriod}} showing due diligence performed.', evidenceType: 'period-of-time', expectedFormat: 'PDF', controlRef: 'CC9.2', commonIssue: 'Should show actual assessment, not just questionnaire sent.', frequency: 'annual' },
          { id: 'vendor_soc_reports', title: 'Vendor SOC Reports', common: false, hint: 'Critical vendor SOC reports', description: 'Provide current SOC 2 reports from critical vendors (cloud providers, hosting, key SaaS).', evidenceType: 'period-of-time', expectedFormat: 'PDF', controlRef: 'CC9.2', commonIssue: 'Review for exceptions that affect your controls.', frequency: 'annual' },
          { id: 'bcp_plan', title: 'Business Continuity Plan', common: true, hint: 'BCP document', description: 'Provide the current Business Continuity Plan including critical processes, recovery objectives (RTO/RPO), and recovery procedures.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'CC9.1', commonIssue: 'Should be specific to the service, not generic corporate BCP.', frequency: 'annual' },
          { id: 'dr_plan', title: 'Disaster Recovery Plan', common: true, hint: 'IT recovery procedures', description: 'Provide the Disaster Recovery Plan for IT systems including failover procedures and recovery steps.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'CC9.1', commonIssue: 'Should include specific systems and step-by-step procedures.', frequency: 'annual' },
          { id: 'bcp_dr_testing', title: 'BCP/DR Test Results', common: true, hint: 'Recovery test evidence', description: 'Provide evidence of BCP/DR testing during {{auditPeriod}} including test scenario, results, and lessons learned.', evidenceType: 'period-of-time', expectedFormat: 'PDF', controlRef: 'CC9.1', commonIssue: 'Should show actual test execution, not just planning documents.', frequency: 'annual' },
          { id: 'backup_config', title: 'Backup Configuration', common: true, hint: 'Backup settings', description: 'Provide backup configuration showing frequency, retention, and encryption settings for critical systems.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot', controlRef: 'CC9.1', commonIssue: 'Should show all production systems are included.', frequency: 'annual' },
          { id: 'backup_monitoring', title: 'Backup Completion Logs', common: false, hint: 'Backup success evidence', description: 'Provide backup completion logs from {{auditPeriod}} showing successful backups.', evidenceType: 'period-of-time', expectedFormat: 'Screenshot or PDF', controlRef: 'CC9.1', commonIssue: 'Should show how failures are detected and resolved.', frequency: 'quarterly' }
        ]
      },
      { 
        id: 'incident_response', 
        title: 'Incident Response', 
        description: 'Security incident handling and response',
        items: [
          { id: 'ir_plan', title: 'Incident Response Plan', common: true, hint: 'IR procedures and contacts', description: 'Provide the Incident Response Plan including incident classification, response procedures, escalation paths, and communication templates.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'CC7.4, CC7.5', commonIssue: 'Should be actionable with specific steps, not just high-level policy.', frequency: 'annual' },
          { id: 'ir_team', title: 'IR Team & Contacts', common: true, hint: 'Incident response team', description: 'Provide documentation of the incident response team including roles, responsibilities, and contact information.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'CC7.4', commonIssue: 'Should include on-call rotation if applicable.', frequency: 'annual' },
          { id: 'incident_log', title: 'Security Incident Log', common: true, hint: 'Record of incidents', description: 'Provide security incident log from {{auditPeriod}} showing incidents, severity, response, and resolution. If no incidents occurred, provide a signed attestation.', evidenceType: 'period-of-time', expectedFormat: 'Excel or PDF', controlRef: 'CC7.4, CC7.5', commonIssue: 'Zero incidents is acceptable but requires management attestation.', frequency: 'quarterly' },
          { id: 'ir_testing', title: 'IR Plan Testing', common: false, hint: 'Tabletop or simulation', description: 'Provide evidence of incident response testing during {{auditPeriod}} including tabletop exercises or simulations.', evidenceType: 'period-of-time', expectedFormat: 'PDF', controlRef: 'CC7.5', commonIssue: 'Should include lessons learned and plan updates.', frequency: 'annual' }
        ]
      }
    ]
  },
  
  ISO27001: {
    label: 'ISO 27001', 
    description: 'Information Security Management System (ISMS)',
    defaultOn: false,
    controlGroups: [
      { 
        id: 'isms_core', 
        title: 'ISMS Core Documentation', 
        description: 'Mandatory ISMS documents per Clauses 4-10',
        items: [
          { id: 'isms_scope', title: 'ISMS Scope Statement', common: true, hint: 'Boundaries of the ISMS', description: 'Provide the ISMS Scope Statement defining organizational boundaries, locations, assets, and technologies covered by the ISMS.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'Clause 4.3', commonIssue: 'Must clearly define what is IN and OUT of scope.', frequency: 'annual' },
          { id: 'isms_policy', title: 'ISMS Policy', common: true, hint: 'Top-level security policy', description: 'Provide the Information Security Policy (ISMS Policy) establishing management commitment and security objectives.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'Clause 5.2', commonIssue: 'Must be signed by top management and communicated to employees.', frequency: 'annual' },
          { id: 'risk_assessment_iso', title: 'Risk Assessment Report', common: true, hint: 'ISO 27001 risk assessment', description: 'Provide the risk assessment report following the documented risk methodology. Include asset inventory, threat analysis, and risk ratings.', evidenceType: 'period-of-time', expectedFormat: 'PDF or Excel', controlRef: 'Clause 6.1.2', commonIssue: 'Must follow documented methodology consistently.', frequency: 'annual' },
          { id: 'risk_treatment_plan_iso', title: 'Risk Treatment Plan', common: true, hint: 'Risk treatment decisions', description: 'Provide the Risk Treatment Plan showing treatment decisions (accept, mitigate, transfer, avoid) for each identified risk with implementation status.', evidenceType: 'point-in-time', expectedFormat: 'Excel', controlRef: 'Clause 6.1.3', commonIssue: 'Each risk must have a documented treatment decision.', frequency: 'annual' },
          { id: 'soa', title: 'Statement of Applicability (SoA)', common: true, hint: 'Which Annex A controls apply', description: 'Provide the Statement of Applicability showing all Annex A controls with justification for inclusion/exclusion and implementation status.', evidenceType: 'point-in-time', expectedFormat: 'Excel', controlRef: 'Clause 6.1.3', commonIssue: 'Every Annex A control must be listed with clear justification.', frequency: 'annual' },
          { id: 'internal_audit_results', title: 'Internal Audit Results', common: true, hint: 'Recent ISMS audit', description: 'Provide internal audit report(s) from {{auditPeriod}} covering ISMS effectiveness and control implementation.', evidenceType: 'period-of-time', expectedFormat: 'PDF', controlRef: 'Clause 9.2', commonIssue: 'Must be conducted by qualified, independent auditors.', frequency: 'annual' },
          { id: 'management_review', title: 'Management Review Minutes', common: true, hint: 'Management review meeting', description: 'Provide management review meeting minutes from {{auditPeriod}} covering ISMS performance, audit results, and improvement decisions.', evidenceType: 'period-of-time', expectedFormat: 'PDF', controlRef: 'Clause 9.3', commonIssue: 'Must address all required inputs per Clause 9.3.', frequency: 'annual' },
          { id: 'nonconformity_log', title: 'Nonconformity & Corrective Actions', common: false, hint: 'NC tracking and resolution', description: 'Provide log of nonconformities from {{auditPeriod}} with corrective actions, root cause analysis, and closure evidence.', evidenceType: 'period-of-time', expectedFormat: 'Excel or PDF', controlRef: 'Clause 10.1', commonIssue: 'All NCs must have documented corrective actions.', frequency: 'quarterly' }
        ]
      },
      { 
        id: 'annex_a', 
        title: 'Annex A Controls (Sample)', 
        description: 'Evidence for key Annex A controls',
        items: [
          { id: 'asset_inventory_iso', title: 'Information Asset Inventory', common: true, hint: 'Registry of information assets', description: 'Provide the information asset inventory including asset name, owner, classification, and location.', evidenceType: 'point-in-time', expectedFormat: 'Excel', controlRef: 'A.5.9', commonIssue: 'Must include all information assets in scope, not just IT systems.', frequency: 'annual' },
          { id: 'access_control_iso', title: 'Access Control Evidence', common: true, hint: 'Implementation of access controls', description: 'Provide evidence of access control implementation including user access reviews, privilege management, and authentication controls.', evidenceType: 'period-of-time', expectedFormat: 'Excel or Screenshot', controlRef: 'A.5.15, A.5.16, A.5.17', commonIssue: 'Should show both policy and technical implementation.', frequency: 'quarterly' },
          { id: 'cryptography', title: 'Cryptographic Controls', common: false, hint: 'Encryption implementation', description: 'Provide evidence of cryptographic controls including encryption at rest, in transit, and key management procedures.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot or PDF', controlRef: 'A.8.24', commonIssue: 'Include key management procedures.', frequency: 'annual' },
          { id: 'physical_security', title: 'Physical Security', common: false, hint: 'Physical access controls', description: 'Provide evidence of physical security controls for facilities containing information assets (access logs, visitor procedures).', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'A.7.1, A.7.2', commonIssue: 'May rely on cloud provider SOC report if applicable.', frequency: 'annual' },
          { id: 'supplier_security', title: 'Supplier Security', common: false, hint: 'Third-party security management', description: 'Provide evidence of supplier security management including assessments, contracts, and ongoing monitoring.', evidenceType: 'period-of-time', expectedFormat: 'PDF or Excel', controlRef: 'A.5.19, A.5.20, A.5.21', commonIssue: 'Focus on suppliers with access to information assets.', frequency: 'annual' }
        ]
      }
    ]
  },
  
  SOC1: {
    label: 'SOC 1', 
    description: 'Service Organization Control 1 (ICFR)',
    defaultOn: false,
    controlGroups: [
      { 
        id: 'soc1_control_env', 
        title: 'Control Environment', 
        description: 'Organizational governance and human resources',
        items: [
          { id: 'soc1_org_chart', title: 'Organization Chart', common: true, hint: 'Key positions and reporting', description: 'Provide the current organization chart showing key positions related to processing activities, including finance, IT, and operations management.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'COSO: Control Environment', commonIssue: 'Should show positions relevant to financial processing.', frequency: 'annual' },
          { id: 'soc1_code_conduct', title: 'Code of Conduct', common: true, hint: 'Ethics expectations', description: 'Provide the Code of Conduct or Ethics Policy establishing expectations for employee integrity and ethical behavior.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'COSO: Control Environment', commonIssue: 'Should address ethical behavior related to financial processing.', frequency: 'annual' },
          { id: 'soc1_bg_checks', title: 'Background Check Evidence', common: true, hint: 'Background checks for new hires', description: 'Provide evidence of background check completion for new hires during {{auditPeriod}} involved in financial transaction processing.', evidenceType: 'period-of-time', expectedFormat: 'PDF', controlRef: 'COSO: Control Environment', commonIssue: 'Focus on roles with access to financial data.', frequency: 'quarterly' }
        ]
      },
      { 
        id: 'soc1_logical_access', 
        title: 'Logical Access Controls', 
        description: 'System access and authentication',
        items: [
          { id: 'soc1_access_policy', title: 'Logical Access Policy', common: true, hint: 'System access policy', description: 'Provide the Logical Access Policy defining requirements for requesting, approving, and reviewing access to financial systems.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'CC6.1, CC6.2', commonIssue: 'Should cover all in-scope financial systems.', frequency: 'annual' },
          { id: 'soc1_user_list', title: 'User Access Listing', common: true, hint: 'Current user access', description: 'Provide current user access listings for in-scope financial systems showing username, access level, and department.', evidenceType: 'point-in-time', expectedFormat: 'Excel', controlRef: 'CC6.2', commonIssue: 'Should include all systems that process financial transactions.', frequency: 'quarterly' },
          { id: 'soc1_access_review', title: 'User Access Reviews', common: true, hint: 'Periodic access review', description: 'Provide user access review documentation from {{auditPeriod}} showing all users with access to financial systems were reviewed.', evidenceType: 'period-of-time', expectedFormat: 'PDF or Excel', controlRef: 'CC6.2', commonIssue: 'Should show action taken for inappropriate access.', frequency: 'quarterly' },
          { id: 'soc1_segregation', title: 'Segregation of Duties', common: true, hint: 'SoD matrix', description: 'Provide segregation of duties matrix showing separation of development, testing, approval, and deployment.', evidenceType: 'point-in-time', expectedFormat: 'Excel', controlRef: 'CC8.1, CC5.1', commonIssue: 'Critical for SOC 1: developer cannot approve and deploy own code.', frequency: 'annual' }
        ]
      },
      { 
        id: 'soc1_change', 
        title: 'Change Management', 
        description: 'Change control for financial systems',
        items: [
          { id: 'soc1_change_policy', title: 'Change Management Policy', common: true, hint: 'Change control requirements', description: 'Provide the Change Management Policy defining requirements for requesting, approving, testing, and implementing changes to financial systems.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'CC8.1', commonIssue: 'Should address both application and infrastructure changes.', frequency: 'annual' },
          { id: 'soc1_change_log', title: 'Change Log', common: true, hint: 'Record of changes', description: 'Provide log of changes made to financial systems during {{auditPeriod}} including change description, requester, approver, and date.', evidenceType: 'period-of-time', expectedFormat: 'Excel', controlRef: 'CC8.1', commonIssue: 'Log should be comprehensive.', frequency: 'quarterly' },
          { id: 'soc1_change_samples', title: 'Change Request Samples', common: true, hint: 'Sample change tickets', description: 'Provide 3-5 sample change requests from {{auditPeriod}} showing testing evidence and approval before implementation.', evidenceType: 'period-of-time', expectedFormat: 'PDF', controlRef: 'CC8.1', commonIssue: 'Approval must occur before deployment.', frequency: 'quarterly' }
        ]
      },
      { 
        id: 'soc1_processing', 
        title: 'Data Processing Integrity', 
        description: 'Transaction processing controls',
        items: [
          { id: 'soc1_procedures', title: 'Processing Procedures', common: true, hint: 'Transaction processing docs', description: 'Provide documented procedures for processing financial transactions including input, processing, and output controls.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'PI1.1, PI1.2', commonIssue: 'Should cover the complete transaction lifecycle.', frequency: 'annual' },
          { id: 'soc1_reconciliations', title: 'Reconciliation Reports', common: true, hint: 'Input/output reconciliations', description: 'Provide reconciliation reports from {{auditPeriod}} showing processing completeness and accuracy.', evidenceType: 'period-of-time', expectedFormat: 'PDF or Excel', controlRef: 'PI1.4', commonIssue: 'Reconciliations should be performed independently.', frequency: 'monthly' },
          { id: 'soc1_ipe_testing', title: 'IPE Testing', common: true, hint: 'Testing of system reports', description: 'Provide evidence of testing Information Produced by the Entity (IPE) used in control operation.', evidenceType: 'period-of-time', expectedFormat: 'PDF', controlRef: 'PI1.4', commonIssue: 'Critical for SOC 1: reports must be reliable.', frequency: 'annual' }
        ]
      }
    ]
  },
  
  NISTCSF: {
    label: 'NIST CSF', 
    description: 'NIST Cybersecurity Framework 2.0',
    defaultOn: false,
    controlGroups: [
      { 
        id: 'nist_govern', 
        title: 'GOVERN', 
        description: 'Organizational context, strategy, roles, policies',
        items: [
          { id: 'nist_context', title: 'Organizational Context', common: true, hint: 'Mission and dependencies', description: 'Provide documentation of organizational context including mission, key stakeholders, legal requirements, and critical dependencies.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'GV.OC', commonIssue: 'Should identify critical assets and processes.', frequency: 'annual' },
          { id: 'nist_risk_strategy', title: 'Risk Management Strategy', common: true, hint: 'Risk tolerance and approach', description: 'Provide documentation of cybersecurity risk management strategy including risk tolerance levels.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'GV.RM', commonIssue: 'Strategy should be approved by leadership.', frequency: 'annual' },
          { id: 'nist_roles', title: 'Cybersecurity Roles', common: true, hint: 'Responsibility assignments', description: 'Provide documentation of cybersecurity roles and responsibilities including accountability assignments.', evidenceType: 'point-in-time', expectedFormat: 'PDF or Excel', controlRef: 'GV.RR', commonIssue: 'Should clearly assign accountability.', frequency: 'annual' },
          { id: 'nist_policies', title: 'Cybersecurity Policies', common: true, hint: 'Policy set', description: 'Provide cybersecurity policies covering key security domains with evidence of approval and communication.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'GV.PO', commonIssue: 'Policies should be approved and communicated.', frequency: 'annual' }
        ]
      },
      { 
        id: 'nist_protect', 
        title: 'PROTECT', 
        description: 'Access control, awareness, data security',
        items: [
          { id: 'nist_access', title: 'Access Management', common: true, hint: 'Access controls', description: 'Provide documentation of identity and access management including policy, provisioning, and access review.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'PR.AA', commonIssue: 'Should cover full access lifecycle.', frequency: 'annual' },
          { id: 'nist_mfa', title: 'Multi-Factor Authentication', common: true, hint: 'MFA implementation', description: 'Provide evidence of MFA configuration for sensitive systems and remote access.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot', controlRef: 'PR.AA', commonIssue: 'MFA should be required for sensitive access.', frequency: 'annual' },
          { id: 'nist_awareness', title: 'Security Awareness', common: true, hint: 'Training program', description: 'Provide security awareness program documentation and training completion records from {{auditPeriod}}.', evidenceType: 'period-of-time', expectedFormat: 'PDF or Excel', controlRef: 'PR.AT', commonIssue: 'Training should cover all personnel.', frequency: 'annual' },
          { id: 'nist_encryption', title: 'Data Protection', common: true, hint: 'Encryption controls', description: 'Provide evidence of encryption at rest and in transit for sensitive data.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot or PDF', controlRef: 'PR.DS', commonIssue: 'Should cover all sensitive data locations.', frequency: 'annual' }
        ]
      },
      { 
        id: 'nist_detect', 
        title: 'DETECT', 
        description: 'Monitoring and vulnerability management',
        items: [
          { id: 'nist_monitoring', title: 'Continuous Monitoring', common: true, hint: 'Security monitoring', description: 'Provide documentation of continuous monitoring including what is monitored and alerting configuration.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot or PDF', controlRef: 'DE.CM', commonIssue: 'Should show what events generate alerts.', frequency: 'annual' },
          { id: 'nist_vuln', title: 'Vulnerability Management', common: true, hint: 'Vuln scanning and remediation', description: 'Provide vulnerability scan reports from {{auditPeriod}} including findings and remediation status.', evidenceType: 'period-of-time', expectedFormat: 'PDF', controlRef: 'DE.CM', commonIssue: 'Should show regular scanning and remediation.', frequency: 'quarterly' }
        ]
      },
      { 
        id: 'nist_respond', 
        title: 'RESPOND', 
        description: 'Incident response',
        items: [
          { id: 'nist_ir_plan', title: 'Incident Response Plan', common: true, hint: 'IR procedures', description: 'Provide the Incident Response Plan including classification, response procedures, and escalation paths.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'RS.MA', commonIssue: 'Plan should be detailed enough to be actionable.', frequency: 'annual' },
          { id: 'nist_incident_log', title: 'Incident Log', common: true, hint: 'Security incidents', description: 'Provide security incident log from {{auditPeriod}}. If none, provide attestation.', evidenceType: 'period-of-time', expectedFormat: 'Excel or PDF', controlRef: 'RS.AN', commonIssue: 'Zero incidents requires attestation.', frequency: 'quarterly' }
        ]
      }
    ]
  },
  
  CMMC: {
    label: 'CMMC Level 2', 
    description: 'Cybersecurity Maturity Model Certification',
    defaultOn: false,
    controlGroups: [
      { 
        id: 'cmmc_core', 
        title: 'Core Required Documents', 
        description: 'Mandatory CMMC documentation',
        items: [
          { id: 'cmmc_ssp', title: 'System Security Plan (SSP)', common: true, hint: 'Documents all 110 practices', description: 'Provide the System Security Plan documenting how each of the 110 NIST 800-171 practices is implemented covering the CUI boundary.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'CA.L2-3.12.4', commonIssue: 'Must address each of 110 practices with specific details.', frequency: 'annual' },
          { id: 'cmmc_poam', title: 'Plan of Action & Milestones', common: true, hint: 'Tracks unmet practices', description: 'Provide the POA&M listing practices not fully implemented with remediation actions and target dates.', evidenceType: 'point-in-time', expectedFormat: 'Excel or PDF', controlRef: 'CA.L2-3.12.2', commonIssue: 'POA&M entries must have realistic milestones.', frequency: 'quarterly' },
          { id: 'cmmc_cui_inventory', title: 'CUI Inventory', common: true, hint: 'CUI locations and types', description: 'Provide inventory of CUI handled including category, location, handling requirements, and authorized personnel.', evidenceType: 'point-in-time', expectedFormat: 'Excel', controlRef: 'MP.L2-3.8.1', commonIssue: 'Must identify all CUI types and locations.', frequency: 'annual' },
          { id: 'cmmc_boundary', title: 'CUI Boundary Diagram', common: true, hint: 'Network diagram with CUI enclave', description: 'Provide network diagram showing the CUI boundary including systems and security controls at boundary points.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'SC.L2-3.13.5', commonIssue: 'Must clearly show what is inside/outside CUI boundary.', frequency: 'annual' }
        ]
      },
      { 
        id: 'cmmc_access', 
        title: 'Access Control (AC)', 
        description: 'Access to CUI systems',
        items: [
          { id: 'cmmc_access_policy', title: 'Access Control Policy', common: true, hint: 'CUI access policy', description: 'Provide Access Control Policy defining who can access CUI systems and access restrictions.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'AC.L2-3.1.1', commonIssue: 'Must specifically address CUI system access.', frequency: 'annual' },
          { id: 'cmmc_user_list', title: 'CUI System User Listing', common: true, hint: 'Authorized CUI users', description: 'Provide current listing of users authorized to access CUI systems.', evidenceType: 'point-in-time', expectedFormat: 'Excel', controlRef: 'AC.L2-3.1.1', commonIssue: 'Should be limited to personnel with need-to-know.', frequency: 'quarterly' },
          { id: 'cmmc_fips', title: 'FIPS-Validated Encryption', common: true, hint: 'FIPS 140-2 cryptography', description: 'Provide evidence that FIPS 140-2 validated cryptographic modules are used to protect CUI.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'SC.L2-3.13.11', commonIssue: 'Non-FIPS encryption is not acceptable for CUI.', frequency: 'annual' }
        ]
      }
    ]
  },
  
  HIPAA: {
    label: 'HIPAA', 
    description: 'Health Insurance Portability and Accountability Act',
    defaultOn: false,
    controlGroups: [
      { 
        id: 'hipaa_admin', 
        title: 'Administrative Safeguards', 
        description: 'Security management and workforce security',
        items: [
          { id: 'hipaa_risk_analysis', title: 'Security Risk Analysis', common: true, hint: 'HIPAA risk assessment', description: 'Provide risk analysis covering ePHI as required by HIPAA. Include identified risks, ratings, and treatment decisions.', evidenceType: 'period-of-time', expectedFormat: 'PDF or Excel', controlRef: '§164.308(a)(1)(ii)(A)', commonIssue: 'Must specifically address ePHI risks. Generic IT assessments are insufficient.', frequency: 'annual' },
          { id: 'hipaa_security_officer', title: 'Security Officer Designation', common: true, hint: 'Assigned security responsibility', description: 'Provide documentation showing a Security Officer has been designated for HIPAA compliance.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: '§164.308(a)(2)', commonIssue: 'Must be a specific, named individual.', frequency: 'annual' },
          { id: 'hipaa_training', title: 'Security Awareness Training', common: true, hint: 'HIPAA training records', description: 'Provide training program documentation and completion records from {{auditPeriod}}.', evidenceType: 'period-of-time', expectedFormat: 'PDF or Excel', controlRef: '§164.308(a)(5)', commonIssue: 'Training must address HIPAA requirements.', frequency: 'annual' },
          { id: 'hipaa_incident', title: 'Security Incident Procedures', common: true, hint: 'Incident handling', description: 'Provide Security Incident Response Procedures covering incidents involving ePHI.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: '§164.308(a)(6)', commonIssue: 'Must address breach notification.', frequency: 'annual' },
          { id: 'hipaa_contingency', title: 'Contingency Plan', common: true, hint: 'Emergency operations', description: 'Provide the Contingency Plan covering data backup, disaster recovery, and emergency operations for ePHI.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: '§164.308(a)(7)', commonIssue: 'Must address ePHI availability in emergencies.', frequency: 'annual' },
          { id: 'hipaa_baa_inventory', title: 'Business Associate Inventory', common: true, hint: 'List of BAs', description: 'Provide inventory of Business Associates with ePHI access including BAA status.', evidenceType: 'point-in-time', expectedFormat: 'Excel', controlRef: '§164.308(b)', commonIssue: 'Must have BAA with all entities accessing ePHI.', frequency: 'annual' }
        ]
      },
      { 
        id: 'hipaa_technical', 
        title: 'Technical Safeguards', 
        description: 'Access control, audit controls, transmission security',
        items: [
          { id: 'hipaa_access', title: 'Access Controls', common: true, hint: 'ePHI access controls', description: 'Provide evidence of access control configuration for ePHI systems including unique user IDs and auto-logoff.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot', controlRef: '§164.312(a)(1)', commonIssue: 'Must ensure only authorized access to ePHI.', frequency: 'annual' },
          { id: 'hipaa_audit', title: 'Audit Controls', common: true, hint: 'ePHI access logging', description: 'Provide evidence of audit controls for ePHI systems including configuration and sample logs.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot or PDF', controlRef: '§164.312(b)', commonIssue: 'Must log ePHI access.', frequency: 'annual' },
          { id: 'hipaa_encryption', title: 'Encryption', common: true, hint: 'ePHI encryption', description: 'Provide evidence of encryption for ePHI at rest and in transit.', evidenceType: 'point-in-time', expectedFormat: 'Screenshot', controlRef: '§164.312(a)(2)(iv), §164.312(e)', commonIssue: 'Must cover all ePHI storage and transmission.', frequency: 'annual' }
        ]
      }
    ]
  },
  
  GDPR: {
    label: 'GDPR', 
    description: 'General Data Protection Regulation (Supplementary)',
    defaultOn: false,
    controlGroups: [
      { 
        id: 'gdpr_core', 
        title: 'Core Requirements', 
        description: 'Fundamental GDPR compliance',
        items: [
          { id: 'gdpr_ropa', title: 'Record of Processing Activities', common: true, hint: 'Article 30 records', description: 'Provide the Record of Processing Activities as required by Article 30. Include processing purpose, data categories, recipients, and retention.', evidenceType: 'point-in-time', expectedFormat: 'Excel', controlRef: 'Article 30', commonIssue: 'Must include all required fields per Article 30(1).', frequency: 'annual' },
          { id: 'gdpr_privacy_notice', title: 'Privacy Notice', common: true, hint: 'Public privacy policy', description: 'Provide the current Privacy Notice/Policy informing data subjects about data processing.', evidenceType: 'point-in-time', expectedFormat: 'PDF or URL', controlRef: 'Articles 13, 14', commonIssue: 'Must be clear and include all required information.', frequency: 'annual' },
          { id: 'gdpr_lawful_basis', title: 'Lawful Basis Documentation', common: true, hint: 'Legal basis for processing', description: 'Provide documentation showing the lawful basis for each processing activity.', evidenceType: 'point-in-time', expectedFormat: 'PDF or Excel', controlRef: 'Article 6', commonIssue: 'Each processing activity must have documented lawful basis.', frequency: 'annual' }
        ]
      },
      { 
        id: 'gdpr_rights', 
        title: 'Data Subject Rights', 
        description: 'Handling data subject requests',
        items: [
          { id: 'gdpr_dsar', title: 'DSAR Process', common: true, hint: 'Data subject request process', description: 'Provide documentation of the Data Subject Access Request process including intake, verification, and fulfillment.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'Articles 15-22', commonIssue: 'Must be able to respond within 30 days.', frequency: 'annual' },
          { id: 'gdpr_dsar_log', title: 'DSAR Log', common: false, hint: 'Log of requests', description: 'Provide log of Data Subject Requests from {{auditPeriod}}. If none, provide attestation.', evidenceType: 'period-of-time', expectedFormat: 'Excel or PDF', controlRef: 'Articles 15-22', commonIssue: 'Response times must meet GDPR requirements.', frequency: 'quarterly' }
        ]
      },
      { 
        id: 'gdpr_processors', 
        title: 'Processors & Transfers', 
        description: 'Third-party processors and transfers',
        items: [
          { id: 'gdpr_processor_list', title: 'Processor Inventory', common: true, hint: 'List of processors', description: 'Provide inventory of data processors including services and data accessed.', evidenceType: 'point-in-time', expectedFormat: 'Excel', controlRef: 'Article 28', commonIssue: 'Must have DPAs with all processors.', frequency: 'annual' },
          { id: 'gdpr_dpa', title: 'Data Processing Agreements', common: true, hint: 'Sample DPAs', description: 'Provide sample Data Processing Agreements showing required Article 28 provisions.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'Article 28(3)', commonIssue: 'DPAs must include all required provisions.', frequency: 'annual' }
        ]
      },
      { 
        id: 'gdpr_security', 
        title: 'Security & Breach', 
        description: 'Security measures and breach notification',
        items: [
          { id: 'gdpr_security_measures', title: 'Security Measures', common: true, hint: 'TOMs documentation', description: 'Provide documentation of technical and organizational security measures (TOMs).', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'Article 32', commonIssue: 'Should address confidentiality, integrity, availability.', frequency: 'annual' },
          { id: 'gdpr_breach_procedure', title: 'Breach Notification Procedure', common: true, hint: 'Breach process', description: 'Provide the breach notification procedure including 72-hour supervisory authority notification.', evidenceType: 'point-in-time', expectedFormat: 'PDF', controlRef: 'Articles 33, 34', commonIssue: 'Must enable 72-hour notification.', frequency: 'annual' }
        ]
      }
    ]
  }
};

let composerState = {};
let customFrameworks = [];
let state = { 
  role: '', 
  code: '', 
  codeValid: false, 
  codeCredits: 0, 
  selectedTier: null, 
  paymentVisible: false,
  isCheckoutReturn: false,
  // Auth state
  isLoggedIn: false,
  isTrialUser: false,
  user: null,         // { id, email, credits, verified, templates }
  authToken: null,
  trialMode: 'live',  // 'live' or 'test'
  trialEmail: ''
};

const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
const esc = s => String(s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');

// ==================== CHIP INPUT FUNCTIONS ====================

function initChipInput(containerId) {
  const container = document.getElementById(containerId);
  if (!container) return;
  
  const input = container.querySelector('.chip-text-input');
  if (!input) return;
  
  container._emails = [];
  
  container.addEventListener('click', (e) => {
    if (e.target === container) input.focus();
  });
  
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' || e.key === ',') {
      e.preventDefault();
      addChipFromInput(container, input);
    } else if (e.key === 'Backspace' && input.value === '' && container._emails.length > 0) {
      removeChip(container, container._emails.length - 1);
    }
  });
  
  input.addEventListener('blur', () => {
    if (input.value.trim()) addChipFromInput(container, input);
  });
  
  input.addEventListener('paste', (e) => {
    const pasted = (e.clipboardData || window.clipboardData).getData('text');
    if (pasted.includes(',') || pasted.includes(';') || pasted.includes(' ')) {
      e.preventDefault();
      const emails = pasted.split(/[,;\s]+/).filter(em => em.includes('@'));
      emails.forEach(email => addChip(container, email.trim()));
      input.value = '';
    }
  });
}

function addChipFromInput(container, input) {
  const email = input.value.trim().replace(/,+$/, '');
  if (addChip(container, email)) input.value = '';
}

function addChip(container, email) {
  if (!email || !email.includes('@') || !email.includes('.')) return false;
  if (container._emails.includes(email.toLowerCase())) return false;
  
  container._emails.push(email.toLowerCase());
  
  const chip = document.createElement('span');
  chip.className = 'chip';
  chip.innerHTML = esc(email) + '<button type="button" class="chip-remove" aria-label="Remove">&times;</button>';
  
  const inp = container.querySelector('.chip-text-input');
  container.insertBefore(chip, inp);
  
  chip.querySelector('.chip-remove').addEventListener('click', () => {
    const idx = container._emails.indexOf(email.toLowerCase());
    if (idx > -1) removeChip(container, idx);
  });
  
  updateChipPlaceholder(container);
  saveFormState();
  return true;
}

function removeChip(container, index) {
  if (index < 0 || index >= container._emails.length) return;
  container._emails.splice(index, 1);
  const chips = container.querySelectorAll('.chip');
  if (chips[index]) chips[index].remove();
  updateChipPlaceholder(container);
  saveFormState();
}

function updateChipPlaceholder(container) {
  const inp = container.querySelector('.chip-text-input');
  if (!inp) return;
  inp.placeholder = container._emails.length === 0 
    ? (container.dataset.placeholder || 'Add email...') 
    : 'Add another...';
}

function getChipEmails(containerId) {
  const container = document.getElementById(containerId);
  return container?._emails || [];
}

function setChipEmails(containerId, emails) {
  const container = document.getElementById(containerId);
  if (!container) return;
  container._emails = [];
  container.querySelectorAll('.chip').forEach(c => c.remove());
  (emails || []).forEach(email => addChip(container, email));
}

// ==================== LOCAL STORAGE ====================

function saveFormState() {
  try {
    const data = {
      role: $('#roleSelect')?.value || '',
      auditorEmails: getChipEmails('auditorEmailsContainer'),
      clientCompany: $('#clientCompany')?.value || '',
      clientEmails: getChipEmails('clientEmailsContainer'),
      deadlineISO: deadlinePicker?.selectedDates[0]?.toISOString() || null,
      globalInstructions: $('#globalInstructions')?.value || '',
      appliedCode: state.code || '',
      composerState: composerState,
      customFrameworks: customFrameworks,
      savedAt: Date.now()
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  } catch (e) { console.warn('Could not save form state:', e); }
}

function loadFormState() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return null;
    const data = JSON.parse(raw);
    if (data.savedAt && (Date.now() - data.savedAt) > 24 * 60 * 60 * 1000) {
      localStorage.removeItem(STORAGE_KEY);
      return null;
    }
    return data;
  } catch (e) { return null; }
}

function restoreFormState(data) {
  if (!data) return false;
  if (data.role) $('#roleSelect').value = data.role;
  if (data.auditorEmails && data.auditorEmails.length) {
    setChipEmails('auditorEmailsContainer', data.auditorEmails);
  } else if (data.auditorEmail) {
    setChipEmails('auditorEmailsContainer', [data.auditorEmail]);
  }
  if (data.clientCompany) $('#clientCompany').value = data.clientCompany;
  if (data.clientEmails && data.clientEmails.length) {
    setChipEmails('clientEmailsContainer', data.clientEmails);
  } else if (data.clientEmail) {
    setChipEmails('clientEmailsContainer', [data.clientEmail]);
  }
  if (data.deadlineISO) {
    setDeadlineFromISO(data.deadlineISO);
  }
  if (data.appliedCode) { 
    state.code = data.appliedCode; 
    if ($('#auditorCode')) $('#auditorCode').value = data.appliedCode; 
  }
  if (data.composerState && Object.keys(data.composerState).length) composerState = data.composerState;
  if (data.customFrameworks && data.customFrameworks.length) customFrameworks = data.customFrameworks;
  return true;
}

function clearFormState() { 
  try { localStorage.removeItem(STORAGE_KEY); } catch (e) {} 
}

function setupAutoSave() {
  ['roleSelect', 'clientCompany'].forEach(id => {
    const el = $(`#${id}`);
    if (el) { 
      el.addEventListener('change', saveFormState); 
      el.addEventListener('input', saveFormState); 
    }
  });
  // Note: deadlinePicker saves via its onChange callback
}

// ==================== DEADLINE LOGIC (FLATPICKR CALENDAR) ====================

let deadlinePicker = null;

function initDeadlinePicker() {
  const defaultDate = new Date();
  defaultDate.setDate(defaultDate.getDate() + 5); // Default: 5 days from now
  defaultDate.setHours(17, 0, 0, 0); // Default: 5:00 PM
  
  deadlinePicker = flatpickr('#deadlinePicker', {
    enableTime: true,
    dateFormat: 'F j, Y at h:i K', // "January 30, 2026 at 5:00 PM"
    altInput: true,
    altFormat: 'F j, Y at h:i K',
    minDate: 'today',
    maxDate: new Date().fp_incr(90), // Max 90 days out
    defaultDate: defaultDate,
    time_24hr: false,
    minuteIncrement: 15,
    disableMobile: false,
    theme: 'dark',
    onReady: function(selectedDates, dateStr, instance) {
      updateDeadlineHint(selectedDates[0]);
      // Style the input to match our theme
      instance.altInput.style.backgroundColor = 'var(--surface)';
      instance.altInput.style.border = '1px solid var(--border)';
      instance.altInput.style.color = 'var(--text)';
      instance.altInput.style.borderRadius = '8px';
      instance.altInput.style.padding = '12px 14px';
      instance.altInput.style.fontSize = '14px';
      instance.altInput.style.cursor = 'pointer';
    },
    onChange: function(selectedDates, dateStr, instance) {
      updateDeadlineHint(selectedDates[0]);
      saveFormState();
    }
  });
  
  // Initialize audit period pickers
  initAuditPeriodPickers();
}

let auditPeriodStartPicker, auditPeriodEndPicker;

function initAuditPeriodPickers() {
  const commonOpts = {
    enableTime: false,
    dateFormat: 'F j, Y', // "January 1, 2025"
    altInput: true,
    altFormat: 'F j, Y',
    disableMobile: false,
    theme: 'dark',
    onReady: function(selectedDates, dateStr, instance) {
      instance.altInput.style.backgroundColor = 'var(--surface)';
      instance.altInput.style.border = '1px solid var(--border)';
      instance.altInput.style.color = 'var(--text)';
      instance.altInput.style.borderRadius = '8px';
      instance.altInput.style.padding = '12px 14px';
      instance.altInput.style.fontSize = '14px';
      instance.altInput.style.cursor = 'pointer';
    },
    onChange: function() {
      updateAuditPeriodHint();
      saveFormState();
    }
  };
  
  // Default: start of current year
  const defaultStart = new Date();
  defaultStart.setMonth(0, 1);
  defaultStart.setHours(0, 0, 0, 0);
  
  // Default: end of current year (or today if past Dec 31)
  const defaultEnd = new Date();
  defaultEnd.setMonth(11, 31);
  defaultEnd.setHours(0, 0, 0, 0);
  
  auditPeriodStartPicker = flatpickr('#auditPeriodStart', {
    ...commonOpts,
    maxDate: new Date().fp_incr(365), // Up to 1 year from now
    onChange: function(selectedDates) {
      if (selectedDates[0] && auditPeriodEndPicker) {
        auditPeriodEndPicker.set('minDate', selectedDates[0]);
      }
      updateAuditPeriodHint();
      saveFormState();
    }
  });
  
  auditPeriodEndPicker = flatpickr('#auditPeriodEnd', {
    ...commonOpts,
    maxDate: new Date().fp_incr(365),
    onChange: function(selectedDates) {
      if (selectedDates[0] && auditPeriodStartPicker) {
        auditPeriodStartPicker.set('maxDate', selectedDates[0]);
      }
      updateAuditPeriodHint();
      saveFormState();
    }
  });
}

function updateAuditPeriodHint() {
  const hint = $('#auditPeriodHint');
  if (!hint) return;
  
  const startDate = auditPeriodStartPicker?.selectedDates[0];
  const endDate = auditPeriodEndPicker?.selectedDates[0];
  
  if (startDate && endDate) {
    const months = Math.round((endDate - startDate) / (1000 * 60 * 60 * 24 * 30));
    hint.textContent = `📆 ${months} month audit period — date range will be included in period-based evidence requests`;
    hint.style.color = 'var(--accent)';
  } else if (startDate || endDate) {
    hint.textContent = `⚠️ Please set both start and end dates for the audit period`;
    hint.style.color = 'var(--warning)';
  } else {
    hint.textContent = '';
  }
}

function getAuditPeriodString() {
  const startDate = auditPeriodStartPicker?.selectedDates[0];
  const endDate = auditPeriodEndPicker?.selectedDates[0];
  
  if (startDate && endDate) {
    const opts = { year: 'numeric', month: 'short', day: 'numeric' };
    return `${startDate.toLocaleDateString('en-US', opts)} - ${endDate.toLocaleDateString('en-US', opts)}`;
  }
  return null;
}

function updateDeadlineHint(date) {
  const hint = $('#deadlineHint');
  if (!hint || !date) return;
  
  const now = new Date();
  const diff = date - now;
  const hours = Math.round(diff / (1000 * 60 * 60));
  const days = Math.round(diff / (1000 * 60 * 60 * 24));
  
  if (hours < 24) {
    hint.textContent = `⏰ ${hours} hours from now`;
    hint.style.color = '#f59e0b'; // Warning orange
  } else if (days === 1) {
    hint.textContent = `📅 Tomorrow`;
    hint.style.color = 'var(--text-muted)';
  } else if (days < 7) {
    hint.textContent = `📅 ${days} days from now`;
    hint.style.color = 'var(--text-muted)';
  } else if (days < 14) {
    hint.textContent = `📅 About 1 week from now`;
    hint.style.color = 'var(--text-muted)';
  } else if (days < 30) {
    hint.textContent = `📅 ${Math.round(days / 7)} weeks from now`;
    hint.style.color = 'var(--text-muted)';
  } else {
    hint.textContent = `📅 About ${Math.round(days / 30)} month(s) from now`;
    hint.style.color = 'var(--text-muted)';
  }
}

function calculateDeadline() {
  if (deadlinePicker && deadlinePicker.selectedDates.length > 0) {
    return deadlinePicker.selectedDates[0];
  }
  // Fallback: 5 days from now
  const fallback = new Date();
  fallback.setDate(fallback.getDate() + 5);
  fallback.setHours(17, 0, 0, 0);
  return fallback;
}

function setDeadlineFromISO(isoString) {
  if (deadlinePicker && isoString) {
    try {
      const date = new Date(isoString);
      if (!isNaN(date.getTime())) {
        deadlinePicker.setDate(date, true);
        updateDeadlineHint(date);
      }
    } catch (e) {
      console.warn('Invalid deadline ISO:', isoString);
    }
  }
}

// ==================== FRAMEWORK HELPERS ====================

function getAllFrameworks() {
  const all = { ...FRAMEWORK_LIBRARY };
  customFrameworks.forEach(f => { all[f.id] = f; });
  return all;
}

function initComposerState() {
  composerState = {};
  const allFw = getAllFrameworks();
  for (const [fwKey, fw] of Object.entries(allFw)) {
    composerState[fwKey] = { enabled: fw.defaultOn || false, groups: {} };
    for (const g of (fw.controlGroups || [])) {
      composerState[fwKey].groups[g.id] = { expanded: false, showMore: false, excluded: false, items: {} };
      for (const item of (g.items || [])) {
        composerState[fwKey].groups[g.id].items[item.id] = { included: item.common, instructions: '' };
      }
    }
  }
}

// ==================== COMPOSER RENDERING ====================

function renderComposer() {
  const c = $('#composer');
  if (!c) return;
  const allFw = getAllFrameworks();
  let html = '<div class="framework-selector">';
  for (const [fwKey, fw] of Object.entries(allFw)) {
    const on = composerState[fwKey]?.enabled;
    html += `<label class="framework-tag ${on ? 'selected' : ''}"><input type="checkbox" ${on ? 'checked' : ''} data-fw-toggle="${esc(fwKey)}">${on ? '✓' : ''} ${esc(fw.label)}</label>`;
  }
  html += '<button type="button" class="framework-tag add-btn" id="addFwChip">+ Add framework</button></div>';
  for (const [fwKey, fw] of Object.entries(allFw)) {
    if (!composerState[fwKey]?.enabled) continue;
    html += renderFwBody(fwKey, fw);
  }
  const savedGlobalInstr = $('#globalInstructions')?.value || '';
  html += `<div class="global-instructions"><label class="form-label">Overall instructions for client</label><textarea class="form-textarea" id="globalInstructions" placeholder="Example: Please provide evidence covering Jan–Dec 2025. Screenshots acceptable. Redact any secrets or credentials.">${esc(savedGlobalInstr)}</textarea><p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 6px;">Shown prominently to your client above the checklist.</p></div>`;
  
  // Save template bar (only show when logged in or trial user who might want to save)
  html += `<div class="save-template-bar" id="saveTemplateBar">
    <span>💾 Save this configuration for future use</span>
    <button type="button" class="btn btn-sm btn-outline" id="saveTemplateBtn">Save as Template</button>
  </div>`;
  
  c.innerHTML = html;
  wireComposer();
  const gi = $('#globalInstructions');
  if (gi) gi.addEventListener('input', saveFormState);
  
  // Wire save template button
  const saveBtn = $('#saveTemplateBtn');
  if (saveBtn) {
    saveBtn.addEventListener('click', () => {
      if (!state.isLoggedIn) {
        if (confirm('Create an account to save templates. Go to account creation?')) {
          $('#roleSelect').value = 'new';
          handleRoleChange('new');
          showNewUserSection('account');
          if (state.trialEmail) $('#signupEmail').value = state.trialEmail;
        }
      } else {
        saveAsTemplate();
      }
    });
  }
}

function renderFwBody(fwKey, fw) {
  let html = `<div style="margin-top: 16px; margin-bottom: 8px;"><strong>${esc(fw.label)}</strong>${fw.description ? ` <span style="color: var(--text-muted);">— ${esc(fw.description)}</span>` : ''}</div>`;
  for (const g of (fw.controlGroups || [])) html += renderGroup(fwKey, g);
  html += `<button type="button" class="btn btn-sm btn-outline" style="width: 100%; margin-top: 8px; border-style: dashed;" data-add-group-btn="${esc(fwKey)}">+ Add control group</button>`;
  return html;
}

function renderGroup(fwKey, g) {
  const gs = composerState[fwKey]?.groups?.[g.id];
  const exp = gs?.expanded, more = gs?.showMore, excluded = gs?.excluded;
  const common = (g.items || []).filter(i => i.common), extra = (g.items || []).filter(i => !i.common);
  const includedCount = (g.items || []).filter(i => gs?.items?.[i.id]?.included && !excluded).length;
  const totalCount = (g.items || []).length;
  let html = `<div class="control-group ${excluded ? 'excluded' : ''}" data-fw="${esc(fwKey)}" data-group="${esc(g.id)}"><div class="cg-header"><span class="cg-title">${esc(g.title)}</span><div class="cg-status">${excluded ? `<span style="color: var(--text-muted); font-size: 0.8rem;">Excluded</span><button type="button" class="cg-include" data-include-group="${esc(fwKey)}-${esc(g.id)}" title="Include">+</button>` : `<span class="cg-count">${includedCount}/${totalCount}</span><button type="button" class="cg-exclude" data-exclude-group="${esc(fwKey)}-${esc(g.id)}" title="Exclude">×</button>`}<span class="cg-toggle">${exp ? '▼' : '▶'}</span></div></div><div class="cg-body ${exp ? 'open' : ''}">`;
  if (excluded) {
    html += `<p style="color: var(--text-muted); text-align: center; padding: 12px;">This control group is excluded from the request.</p>`;
  } else {
    if (g.description) html += `<p class="cg-description">${esc(g.description)}</p>`;
    for (const item of common) html += renderItem(fwKey, g.id, item, gs);
    if (extra.length) {
      html += `<div class="extra-items" style="display: ${more ? 'block' : 'none'};">`;
      for (const item of extra) html += renderItem(fwKey, g.id, item, gs);
      html += '</div>';
      html += `<div class="more-toggle" data-fw="${esc(fwKey)}" data-group="${esc(g.id)}">${more ? '− Show fewer options' : `+ Show ${extra.length} more options`}</div>`;
    }
    html += `<div class="add-custom-section"><h4>Add custom request to "${esc(g.title)}"</h4><div class="custom-form"><input class="form-input" placeholder="e.g., Network Diagram, Encryption Key Rotation Log" data-custom-name="${esc(fwKey)}-${esc(g.id)}"><textarea class="form-textarea" placeholder="Instructions for client (describe what you need, date ranges, format...)" data-custom-instr="${esc(fwKey)}-${esc(g.id)}" style="min-height: 50px;"></textarea><button type="button" class="btn btn-sm btn-outline" data-add-item="${esc(fwKey)}" data-group="${esc(g.id)}">+ Add request</button></div></div>`;
  }
  html += '</div></div>';
  return html;
}

function renderItem(fwKey, gid, item, gs) {
  const st = gs?.items?.[item.id];
  const inc = st?.included ?? item.common;
  const instr = st?.instructions || '';
  
  // Build enhanced meta tags
  let metaHtml = '';
  if (item.expectedFormat || item.controlRef || item.evidenceType) {
    metaHtml = '<div class="ei-meta">';
    if (item.expectedFormat) {
      metaHtml += `<span class="ei-tag format">📄 ${esc(item.expectedFormat)}</span>`;
    }
    if (item.controlRef) {
      metaHtml += `<span class="ei-tag control">${esc(item.controlRef)}</span>`;
    }
    if (item.evidenceType === 'period-of-time') {
      metaHtml += '<span class="ei-tag period">📆 Period</span>';
    } else if (item.evidenceType === 'point-in-time') {
      metaHtml += '<span class="ei-tag point">📍 Point-in-time</span>';
    }
    metaHtml += '</div>';
  }
  
  // Show description if available, fallback to hint
  const descText = item.description || item.hint || '';
  const descHtml = descText ? `<div class="ei-description">${esc(descText)}</div>` : '';
  
  // Common issue warning (shown when item is included)
  const issueHtml = (item.commonIssue && inc) ? `<div class="ei-common-issue">${esc(item.commonIssue)}</div>` : '';
  
  return `<div class="evidence-item ${inc ? 'included' : ''}" data-fw="${esc(fwKey)}" data-group="${esc(gid)}" data-item="${esc(item.id)}"><input type="checkbox" ${inc ? 'checked' : ''}><div class="ei-content"><div class="ei-title">${esc(item.title)}</div>${descHtml}${metaHtml}${issueHtml}<div class="ei-instr"><label>Instructions for client (optional)</label><textarea placeholder="e.g., Please include date range, reviewer sign-off, specific format..." data-item-instr="${esc(fwKey)}-${esc(gid)}-${esc(item.id)}">${esc(instr)}</textarea></div></div></div>`;
}

function wireComposer() {
  $$('[data-fw-toggle]').forEach(cb => {
    cb.addEventListener('change', e => {
      const k = e.target.dataset.fwToggle;
      if (!composerState[k]) composerState[k] = { enabled: false, groups: {} };
      composerState[k].enabled = e.target.checked;
      const allFw = getAllFrameworks();
      const fw = allFw[k];
      if (fw && composerState[k].enabled) {
        for (const g of (fw.controlGroups || [])) {
          if (!composerState[k].groups[g.id]) {
            composerState[k].groups[g.id] = { expanded: false, showMore: false, excluded: false, items: {} };
            for (const item of (g.items || [])) composerState[k].groups[g.id].items[item.id] = { included: item.common, instructions: '' };
          }
        }
      }
      renderComposer();
      saveFormState();
    });
  });
  $$('.cg-header').forEach(h => {
    h.addEventListener('click', e => {
      if (e.target.closest('.cg-exclude') || e.target.closest('.cg-include')) return;
      const g = h.closest('.control-group');
      const fk = g.dataset.fw, gid = g.dataset.group;
      composerState[fk].groups[gid].expanded = !composerState[fk].groups[gid].expanded;
      renderComposer();
    });
  });
  $$('[data-exclude-group]').forEach(btn => {
    btn.addEventListener('click', e => { e.stopPropagation(); const [fk, gid] = btn.dataset.excludeGroup.split('-'); composerState[fk].groups[gid].excluded = true; renderComposer(); saveFormState(); });
  });
  $$('[data-include-group]').forEach(btn => {
    btn.addEventListener('click', e => { e.stopPropagation(); const [fk, gid] = btn.dataset.includeGroup.split('-'); composerState[fk].groups[gid].excluded = false; renderComposer(); saveFormState(); });
  });
  $$('.more-toggle').forEach(t => {
    t.addEventListener('click', e => { e.stopPropagation(); const fk = t.dataset.fw, gid = t.dataset.group; composerState[fk].groups[gid].showMore = !composerState[fk].groups[gid].showMore; renderComposer(); });
  });
  $$('.evidence-item input[type="checkbox"]').forEach(cb => {
    cb.addEventListener('change', e => { const el = e.target.closest('.evidence-item'); const { fw, group, item } = el.dataset; composerState[fw].groups[group].items[item].included = e.target.checked; renderComposer(); saveFormState(); });
  });
  $$('[data-item-instr]').forEach(ta => {
    ta.addEventListener('input', e => { const parts = ta.dataset.itemInstr.split('-'); const [fw, group] = [parts[0], parts[1]]; const item = parts.slice(2).join('-'); if (composerState[fw]?.groups?.[group]?.items?.[item]) composerState[fw].groups[group].items[item].instructions = e.target.value; saveFormState(); });
  });
  $$('[data-add-item]').forEach(btn => {
    btn.addEventListener('click', () => {
      const fk = btn.dataset.addItem, gid = btn.dataset.group;
      const nameInput = document.querySelector(`[data-custom-name="${fk}-${gid}"]`);
      const instrInput = document.querySelector(`[data-custom-instr="${fk}-${gid}"]`);
      const title = (nameInput?.value || '').trim(), instructions = (instrInput?.value || '').trim();
      if (!title) { alert('Please enter a request name.'); return; }
      const cid = 'c_' + Math.random().toString(36).slice(2, 8);
      const allFw = getAllFrameworks();
      const fw = allFw[fk], grp = fw?.controlGroups?.find(g => g.id === gid);
      if (grp) { grp.items.push({ id: cid, title, common: true, hint: '' }); composerState[fk].groups[gid].items[cid] = { included: true, instructions }; }
      nameInput.value = ''; instrInput.value = '';
      renderComposer(); saveFormState();
    });
  });
  $('#addFwChip')?.addEventListener('click', () => { $('#addFwModal').classList.remove('hidden'); });
  $$('[data-add-group-btn]').forEach(btn => {
    btn.addEventListener('click', () => { $('#customGroupFwKey').value = btn.dataset.addGroupBtn; $('#addGroupModal').classList.remove('hidden'); });
  });
  
  // Template level buttons
  $$('.template-level-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const level = btn.dataset.level;
      $$('.template-level-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      applyTemplateLevel(level);
    });
  });
}

// Apply template level (Quick/Standard/Thorough) to current selections
function applyTemplateLevel(level) {
  const allFw = getAllFrameworks();
  
  for (const [fk, fw] of Object.entries(allFw)) {
    if (!composerState[fk]?.enabled) continue;
    
    for (const g of (fw.controlGroups || [])) {
      if (!composerState[fk].groups[g.id]) continue;
      
      for (const item of (g.items || [])) {
        if (!composerState[fk].groups[g.id].items[item.id]) {
          composerState[fk].groups[g.id].items[item.id] = { included: false, instructions: '' };
        }
        
        // Determine if item should be included based on template level
        let shouldInclude = false;
        if (level === 'quickStart') {
          // Only common items
          shouldInclude = item.common === true;
        } else if (level === 'standard') {
          // Common items (same as quickStart for now, but could be expanded)
          shouldInclude = item.common === true;
        } else if (level === 'thorough') {
          // All items
          shouldInclude = true;
        }
        
        composerState[fk].groups[g.id].items[item.id].included = shouldInclude;
      }
    }
  }
  
  renderComposer();
  saveFormState();
}

function getPayload() {
  const result = [];
  const allFw = getAllFrameworks();
  const auditPeriod = getAuditPeriodString();
  
  for (const [fk, fs] of Object.entries(composerState)) {
    if (!fs.enabled) continue;
    const fw = allFw[fk];
    if (!fw) continue;
    for (const g of (fw.controlGroups || [])) {
      const gs = fs.groups?.[g.id];
      if (!gs || gs.excluded) continue;
      for (const item of (g.items || [])) {
        const is = gs.items?.[item.id];
        if (!is?.included) continue;
        
        // Build description with audit period injection for period-of-time items
        let description = item.description || item.hint || '';
        if (auditPeriod && item.evidenceType === 'period-of-time' && description.includes('{{auditPeriod}}')) {
          description = description.replace(/\{\{auditPeriod\}\}/g, auditPeriod);
        }
        
        result.push({ 
          id: item.id, 
          framework: fw.label || fk, 
          group: g.title, 
          title: item.title, 
          instructions: is.instructions || '',
          // Enhanced fields
          description: description,
          evidenceType: item.evidenceType || 'point-in-time',
          expectedFormat: item.expectedFormat || null,
          controlRef: item.controlRef || null,
          commonIssue: item.commonIssue || null
        });
      }
    }
  }
  return result;
}

// ==================== CODE VALIDATION ====================

async function validateCode(code) {
  if (!code) return { valid: false, error: 'No code entered' };
  
  try {
    const res = await fetch(`${API}/check-code?code=${encodeURIComponent(code)}`);
    const data = await res.json();
    
    if (data.ok && data.remaining > 0) {
      return { 
        valid: true, 
        credits: data.remaining,
        message: data.remaining >= 9999 ? 'Unlimited credits' : `${data.remaining} credit${data.remaining !== 1 ? 's' : ''} remaining`
      };
    } else if (data.remaining === 0) {
      return { valid: false, error: 'No credits remaining on this code' };
    } else {
      return { valid: false, error: 'Invalid code' };
    }
  } catch (e) {
    return { valid: false, error: 'Error checking code' };
  }
}

function updateCodeUI(result) {
  const codeInput = $('#auditorCode');
  const codeStatus = $('#codeStatus');
  
  if (!codeInput || !codeStatus) return;
  
  if (result.valid) {
    codeInput.classList.remove('invalid');
    codeInput.classList.add('valid');
    codeStatus.className = 'code-status valid';
    codeStatus.textContent = `✓ Valid — ${result.message}`;
    state.codeValid = true;
    state.codeCredits = result.credits;
  } else if (result.error) {
    codeInput.classList.remove('valid');
    codeInput.classList.add('invalid');
    codeStatus.className = 'code-status invalid';
    codeStatus.textContent = `✗ ${result.error}`;
    state.codeValid = false;
  } else {
    codeInput.classList.remove('valid', 'invalid');
    codeStatus.className = 'code-status';
    codeStatus.textContent = '';
    state.codeValid = false;
  }
}

// ==================== CHECKOUT RETURN ====================

async function checkCheckoutReturn() {
  const url = new URL(location.href);
  const sessionId = url.searchParams.get('session_id');
  if (!sessionId) return false;
  
  state.isCheckoutReturn = true;
  
  // Clear URL
  url.searchParams.delete('session_id');
  window.history.replaceState({}, '', url.toString());
  
  // Check for existing session first (user might still be logged in)
  const hasSession = await checkExistingSession();
  
  // Restore saved form state
  const savedState = loadFormState();
  if (savedState) {
    restoreFormState(savedState);
  }
  
  // If logged in, show dashboard — polling will update credits
  if (hasSession || state.isLoggedIn) {
    showDashboard();
  } else {
    // Legacy: not logged in, show code-based flow
    if (savedState?.role === 'auditor') {
      handleRoleChange('auditor');
    } else {
      $('#roleSelect').value = 'auditor';
      handleRoleChange('auditor');
    }
    showPaymentSection();
    $('#purchaseSection').classList.add('hidden');
  }
  
  // Show success banner
  const successBanner = $('#successBanner');
  const successCodeDisplay = $('#successCodeDisplay');
  successBanner.classList.add('visible');
  successCodeDisplay.textContent = 'Loading...';
  
  const codeInput = $('#auditorCode');
  const codeStatus = $('#codeStatus');
  
  // Aggressive polling - keep trying every second for 90 seconds
  let code = null;
  let creditsText = '';
  let accountCredited = false;
  
  for (let attempt = 0; attempt < 90; attempt++) {
    try {
      const res = await fetch(`${API}/checkout/session?session_id=${sessionId}`);
      const data = await res.json();
      
      console.log(`Attempt ${attempt + 1}:`, data);
      
      // v6: Account-based credit return
      if (data.ok && data.accountCredit) {
        accountCredited = true;
        
        // Update local state with new credit balance
        if (state.user) {
          state.user.credits = typeof data.credits === 'number' ? data.credits : state.user.credits;
        }
        
        // Refresh session to get latest account state
        await checkExistingSession();
        
        successCodeDisplay.textContent = `+${data.creditsAdded} credits added!`;
        successBanner.querySelector('p:last-of-type').textContent = `Your account now has ${data.creditsDisplay}. You're ready to send requests.`;
        
        // Hide code input section since account users don't need codes
        if (codeInput) codeInput.closest('.form-group')?.classList.add('hidden');
        if (codeStatus) codeStatus.textContent = '';
        
        // Hide the entire payment section — user has credits now
        const paymentSec = $('#paymentSection');
        if (paymentSec) paymentSec.classList.remove('visible');
        state.paymentVisible = false;
        
        // Show dashboard with credits visible
        showDashboard();
        break;
      }
      
      // Legacy: code-based return
      if (data.ok && data.code) {
        code = data.code;
        state.code = code;
        state.codeValid = true;
        state.codeCredits = data.credits;
        creditsText = data.creditsDisplay || `${data.credits} credit${data.credits !== 1 ? 's' : ''} remaining`;
        break;
      }
      
      // Keep trying
      if (codeStatus) {
        codeStatus.innerHTML = `<span class="spinner"></span> Processing your purchase... (${attempt + 1}s)`;
      }
      
    } catch (e) {
      console.error('Checkout check error:', e);
    }
    
    await new Promise(r => setTimeout(r, 1000));
  }
  
  if (!accountCredited) {
    if (code) {
      // Legacy success - show the code
      successCodeDisplay.textContent = code;
      if (codeInput) {
        codeInput.value = code;
        codeInput.placeholder = 'ENTER CODE';
        codeInput.classList.add('valid');
      }
      if (codeStatus) {
        codeStatus.className = 'code-status valid';
        codeStatus.textContent = `✓ Valid — ${creditsText}`;
      }
      saveFormState();
    } else {
      // Fallback - tell them to check email
      successCodeDisplay.textContent = 'Check your email';
      successBanner.querySelector('p:last-of-type').textContent = 'Your code should arrive shortly. Enter it below when you receive it.';
      if (codeInput) {
        codeInput.value = '';
        codeInput.placeholder = 'ENTER CODE';
      }
      if (codeStatus) {
        codeStatus.className = 'code-status';
        codeStatus.textContent = 'Enter the code from your email';
      }
    }
  }
  
  updateMainButton();
  return true;
}

// ==================== UI STATE ====================

function handleRoleChange(role) {
  state.role = role;
  
  // Hide all flows first
  $('#newUserFlow').style.display = 'none';
  $('#returningUserFlow').style.display = 'none';
  $('#auditorFlow').style.display = 'none';
  $('#loggedInBar').style.display = 'none';
  $('#trialNoticeBar').style.display = 'none';
  $('#verificationNotice').style.display = 'none';
  
  if (role === 'new') {
    $('#newUserFlow').style.display = 'block';
    showNewUserSection('trial'); // Default to trial
  } else if (role === 'returning') {
    $('#returningUserFlow').style.display = 'block';
    showLoginSection();
  }
  // Note: 'auditor' role is set internally after auth
}

function showNewUserSection(type) {
  $('#trialCodeSection').style.display = type === 'trial' ? 'block' : 'none';
  $('#trialModeSection').style.display = 'none';
  $('#accountSection').style.display = type === 'account' ? 'block' : 'none';
}

function showLoginSection() {
  $('#loginSection').style.display = 'block';
  $('#forgotPasswordSection').style.display = 'none';
}

function showForgotPassword() {
  $('#loginSection').style.display = 'none';
  $('#forgotPasswordSection').style.display = 'block';
}

// ==================== DASHBOARD FUNCTIONS ====================

async function showDashboard() {
  // Hide auth flows and role selector
  $('#newUserFlow').style.display = 'none';
  $('#returningUserFlow').style.display = 'none';
  $('#auditorFlow').style.display = 'none';
  $('#roleSelectSection').style.display = 'none';
  
  // Show logged in bar
  $('#loggedInBar').style.display = 'flex';
  updateLoggedInBar();
  
  // Show verification notice if not verified
  if (state.user && !state.user.verified) {
    $('#verificationNotice').style.display = 'block';
  }
  
  // Show dashboard
  $('#dashboardView').style.display = 'block';
  
  // Fetch and render dashboard data
  await fetchAndRenderDashboard();
  
  // Scroll to top
  $('#dashboardView').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

async function fetchAndRenderDashboard() {
  if (!state.authToken) {
    renderDashboardError('Not authenticated');
    return;
  }
  
  // Show loading state
  $('#activeRequestsList').innerHTML = '<div class="loading-placeholder">Loading requests...</div>';
  $('#completedRequestsList').innerHTML = '<div class="loading-placeholder">Loading...</div>';
  
  let retries = 2;
  while (retries >= 0) {
    try {
      const res = await fetch(`${API}/auth/requests`, {
        headers: { 'Authorization': `Bearer ${state.authToken}` }
      });
      
      if (!res.ok) {
        throw new Error(`HTTP ${res.status}`);
      }
      
      const data = await res.json();
      
      if (data.ok) {
        renderDashboard(data.requests || [], data.stats || {});
        return; // Success - exit
      } else {
        throw new Error(data.error || 'Failed to load');
      }
    } catch (e) {
      console.error('Dashboard fetch error (retries left: ' + retries + '):', e);
      retries--;
      if (retries >= 0) {
        await new Promise(r => setTimeout(r, 500)); // Wait 500ms before retry
      }
    }
  }
  
  // All retries failed
  renderDashboardError('Error loading dashboard. Please refresh the page.');
}

function renderDashboard(requests, stats) {
  // Update stats
  $('#statActive').textContent = stats.activeRequests || 0;
  $('#statCompleted').textContent = stats.completedRequests || 0;
  $('#statEvidence').textContent = stats.totalEvidenceCollected || 0;
  $('#statThisMonth').textContent = stats.requestsThisMonth || 0;
  
  // Show/hide credit alert based on credit balance
  const credits = state.user?.credits || 0;
  const creditAlert = $('#creditAlert');
  if (credits <= 2) {
    creditAlert.style.display = 'flex';
    $('#creditAlertCount').textContent = credits;
    
    if (credits === 0) {
      creditAlert.classList.add('critical');
      $('#creditAlertTitle').textContent = 'No credits remaining';
      $('#creditAlertDesc').innerHTML = 'You need to <strong>purchase credits</strong> to send new evidence requests.';
    } else {
      creditAlert.classList.remove('critical');
      $('#creditAlertTitle').textContent = credits === 1 ? 'Last credit remaining' : 'Running low on credits';
      $('#creditAlertDesc').innerHTML = `You have <strong>${credits}</strong> credit${credits !== 1 ? 's' : ''} remaining.`;
    }
  } else {
    creditAlert.style.display = 'none';
  }
  
  // Split requests into active and completed
  const active = requests.filter(r => r.status === 'pending');
  const completed = requests.filter(r => r.status === 'complete');
  
  // Render active requests
  const activeList = $('#activeRequestsList');
  if (active.length === 0) {
    activeList.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">📋</div>
        <div class="empty-state-text">No active requests. Click "New Evidence Request" to get started.</div>
      </div>
    `;
  } else {
    activeList.innerHTML = active.map(r => renderRequestCard(r, 'active')).join('');
  }
  
  // Render completed requests
  const completedList = $('#completedRequestsList');
  if (completed.length === 0) {
    completedList.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">✓</div>
        <div class="empty-state-text">No completed requests yet.</div>
      </div>
    `;
  } else {
    completedList.innerHTML = completed.map(r => renderRequestCard(r, 'completed')).join('');
  }
  
  // Render templates
  renderTemplatesSection();
  
  // Wire up action buttons
  wireRequestActions();
  wireTemplateActions();
}

function renderTemplatesSection() {
  const templates = state.user?.templates || [];
  const templatesList = $('#templatesList');
  const templateCount = $('#templateCount');
  
  templateCount.textContent = `(${templates.length})`;
  
  if (templates.length === 0) {
    templatesList.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">💾</div>
        <div class="empty-state-text">No saved templates. Create a request and save it as a template for reuse.</div>
      </div>
    `;
  } else {
    templatesList.innerHTML = templates.map(t => renderTemplateCard(t)).join('');
  }
}

function renderTemplateCard(template) {
  const created = new Date(template.createdAt);
  const createdStr = created.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
  
  // Count frameworks enabled
  const fwCount = Object.values(template.composerState || {}).filter(fw => fw.enabled).length;
  
  // Count total items
  let itemCount = 0;
  for (const fwKey in template.composerState || {}) {
    const fw = template.composerState[fwKey];
    if (!fw.enabled) continue;
    for (const gKey in fw.groups || {}) {
      const g = fw.groups[gKey];
      if (g.excluded) continue;
      for (const iKey in g.items || {}) {
        if (g.items[iKey].included) itemCount++;
      }
    }
  }
  
  return `
    <div class="template-card" data-template-id="${esc(template.id)}">
      <div class="template-info">
        <h4 class="template-name">${esc(template.name)}</h4>
        <div class="template-meta">${fwCount} framework${fwCount !== 1 ? 's' : ''} · ${itemCount} items · Created ${createdStr}</div>
      </div>
      <div class="template-actions">
        <button class="template-action-btn use" data-action="use-template" data-id="${esc(template.id)}">Use</button>
        <button class="template-action-btn" data-action="duplicate-template" data-id="${esc(template.id)}">Duplicate</button>
        <button class="template-action-btn delete" data-action="delete-template" data-id="${esc(template.id)}">Delete</button>
      </div>
    </div>
  `;
}

function wireTemplateActions() {
  // Use template
  $$('[data-action="use-template"]').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.dataset.id;
      useTemplateFromDashboard(id);
    });
  });
  
  // Duplicate template
  $$('[data-action="duplicate-template"]').forEach(btn => {
    btn.addEventListener('click', async () => {
      const id = btn.dataset.id;
      await duplicateTemplate(id);
    });
  });
  
  // Delete template
  $$('[data-action="delete-template"]').forEach(btn => {
    btn.addEventListener('click', async () => {
      const id = btn.dataset.id;
      await deleteTemplateFromDashboard(id);
    });
  });
}

function useTemplateFromDashboard(templateId) {
  const template = state.user?.templates?.find(t => t.id === templateId);
  if (!template) return;
  
  // Hide dashboard, show composer
  $('#dashboardView').style.display = 'none';
  $('#backToDashboard').style.display = 'block';
  
  // Reset form first
  resetComposerForm();
  
  // Load template
  loadTemplate(templateId);
  
  // Show auditor flow
  $('#auditorFlow').style.display = 'block';
  
  // Set auditor email
  if (state.user?.email) {
    setChipEmails('auditorEmailsContainer', [state.user.email]);
  }
  
  $('#auditorFlow').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

async function duplicateTemplate(templateId) {
  const template = state.user?.templates?.find(t => t.id === templateId);
  if (!template) return;
  
  const newName = prompt('Enter name for duplicated template:', template.name + ' (Copy)');
  if (!newName || !newName.trim()) return;
  
  try {
    const res = await fetch(`${API}/auth/templates`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${state.authToken}`
      },
      body: JSON.stringify({
        name: newName.trim(),
        composerState: template.composerState,
        customFrameworks: template.customFrameworks,
        globalInstructions: template.globalInstructions || ''
      })
    });
    
    const data = await res.json();
    
    if (data.ok && data.template) {
      state.user.templates = state.user.templates || [];
      state.user.templates.push(data.template);
      renderTemplatesSection();
      wireTemplateActions();
    } else {
      alert(data.error || 'Error duplicating template');
    }
  } catch (e) {
    alert('Error duplicating template');
  }
}

async function deleteTemplateFromDashboard(templateId) {
  const template = state.user?.templates?.find(t => t.id === templateId);
  if (!template) return;
  
  if (!confirm(`Delete template "${template.name}"? This cannot be undone.`)) return;
  
  try {
    const res = await fetch(`${API}/auth/templates?id=${templateId}`, {
      method: 'DELETE',
      headers: { 'Authorization': `Bearer ${state.authToken}` }
    });
    
    const data = await res.json();
    
    if (data.ok) {
      state.user.templates = state.user.templates.filter(t => t.id !== templateId);
      renderTemplatesSection();
      wireTemplateActions();
      updateLoggedInBar(); // Update template dropdown in composer if visible
    } else {
      alert(data.error || 'Error deleting template');
    }
  } catch (e) {
    alert('Error deleting template');
  }
}

function renderRequestCard(req, type) {
  const deadline = req.deadlineISO ? new Date(req.deadlineISO) : null;
  const created = new Date(req.createdAt);
  const now = new Date();
  
  // Format dates
  const deadlineStr = deadline ? deadline.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'No deadline';
  const createdStr = created.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  
  // Check if overdue
  const isOverdue = deadline && deadline < now && req.status === 'pending';
  
  // Calculate days overdue
  const daysOverdue = isOverdue ? Math.floor((now - deadline) / (1000 * 60 * 60 * 24)) : 0;
  
  // Status display
  let statusHtml = '';
  if (req.status === 'pending') {
    if (isOverdue) {
      statusHtml = `<div class="request-status pending"><span class="status-dot"></span> Overdue ${daysOverdue > 0 ? `(${daysOverdue}d)` : ''}</div>`;
    } else {
      statusHtml = '<div class="request-status pending"><span class="status-dot"></span> Waiting for upload</div>';
    }
  } else {
    const submittedDate = req.submittedAt ? new Date(req.submittedAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '';
    statusHtml = `<div class="request-status complete"><span class="status-dot"></span> Completed${submittedDate ? ` ${submittedDate}` : ''}</div>`;
  }
  
  // Framework tags
  const fwTags = (req.frameworks || []).map(fw => `<span class="request-fw-tag">${esc(fw)}</span>`).join('');
  
  // Client link URL
  const clientLink = `${location.origin}?t=${req.token}`;
  
  // Actions based on type and status
  let actionsHtml = '';
  if (type === 'active') {
    actionsHtml = `
      <button class="request-action-btn" data-action="copy-link" data-token="${esc(req.token)}">Copy Client Link</button>
      <button class="request-action-btn" data-action="resend" data-token="${esc(req.token)}">Resend Email</button>
    `;
    // Add extend deadline for overdue requests
    if (isOverdue && req.extendToken) {
      actionsHtml += `
        <button class="request-action-btn primary" data-action="extend" data-extend-token="${esc(req.extendToken)}" data-company="${esc(req.company || '')}">Extend Deadline</button>
      `;
    }
  } else {
    actionsHtml = `
      <button class="request-action-btn primary" data-action="view-pack" data-token="${esc(req.token)}">View ProofPack</button>
      <button class="request-action-btn" data-action="copy-link" data-token="${esc(req.token)}">Copy Client Link</button>
    `;
  }
  
  // Add overdue alert banner for overdue requests
  let overdueAlertHtml = '';
  if (isOverdue) {
    overdueAlertHtml = `
      <div class="request-overdue-alert">
        ⚠️ Deadline passed ${daysOverdue > 0 ? `${daysOverdue} day${daysOverdue !== 1 ? 's' : ''} ago` : 'today'}. Client can still upload late, or you can extend the deadline.
      </div>
    `;
  }
  
  return `
    <div class="request-card ${isOverdue ? 'overdue' : ''}" data-token="${esc(req.token)}">
      ${overdueAlertHtml}
      <div class="request-card-header">
        <div>
          <h4 class="request-company">${esc(req.company || 'Unnamed Request')}</h4>
          <div class="request-frameworks">${fwTags}</div>
        </div>
        ${statusHtml}
      </div>
      <div class="request-meta">
        <div class="request-meta-item">
          <span>📧</span> ${esc(req.clientEmail || 'No client email')}
        </div>
        <div class="request-meta-item">
          <span>📅</span> Due: ${deadlineStr}
        </div>
        <div class="request-meta-item">
          <span>📋</span> ${req.totalItems || 0} evidence items
        </div>
      </div>
      <div class="request-actions">
        ${actionsHtml}
      </div>
    </div>
  `;
}

function wireRequestActions() {
  // Copy link buttons
  $$('[data-action="copy-link"]').forEach(btn => {
    btn.addEventListener('click', async () => {
      const token = btn.dataset.token;
      const link = `${location.origin}?t=${token}`;
      try {
        await navigator.clipboard.writeText(link);
        const originalText = btn.textContent;
        btn.textContent = 'Copied!';
        setTimeout(() => btn.textContent = originalText, 2000);
      } catch (e) {
        alert('Link: ' + link);
      }
    });
  });
  
  // Resend email buttons
  $$('[data-action="resend"]').forEach(btn => {
    btn.addEventListener('click', async () => {
      const token = btn.dataset.token;
      // For now, just copy the link - full resend would need a new endpoint
      const link = `${location.origin}?t=${token}`;
      try {
        await navigator.clipboard.writeText(link);
        btn.textContent = 'Link Copied!';
        setTimeout(() => btn.textContent = 'Resend Email', 2000);
      } catch (e) {
        alert('Share this link with your client: ' + link);
      }
    });
  });
  
  // View pack buttons
  $$('[data-action="view-pack"]').forEach(btn => {
    btn.addEventListener('click', () => {
      const token = btn.dataset.token;
      // Open the viewer - this will show the pack if available
      window.open(`${API}/d?t=${token}`, '_blank');
    });
  });
  
  // Extend deadline buttons
  $$('[data-action="extend"]').forEach(btn => {
    btn.addEventListener('click', async () => {
      const extendToken = btn.dataset.extendToken;
      const company = btn.dataset.company || 'this request';
      
      const days = prompt(`Extend deadline for "${company}" by how many days?`, '7');
      if (!days || isNaN(parseInt(days))) return;
      
      btn.disabled = true;
      btn.textContent = 'Extending...';
      
      try {
        const res = await fetch(`${API}/extend?t=${extendToken}&days=${parseInt(days)}`);
        const data = await res.json();
        
        if (data.ok) {
          alert(`Deadline extended by ${days} days. New deadline: ${new Date(data.deadlineISO).toLocaleDateString()}`);
          // Refresh dashboard to show updated deadline
          await fetchAndRenderDashboard();
        } else {
          alert('Error extending deadline: ' + (data.error || 'Unknown error'));
          btn.disabled = false;
          btn.textContent = 'Extend Deadline';
        }
      } catch (e) {
        alert('Error extending deadline: ' + e.message);
        btn.disabled = false;
        btn.textContent = 'Extend Deadline';
      }
    });
  });
}

function renderDashboardError(message) {
  $('#activeRequestsList').innerHTML = `<div class="empty-state"><div class="empty-state-text">${esc(message)}</div></div>`;
  $('#completedRequestsList').innerHTML = '';
}

function showComposerFromDashboard() {
  // Hide dashboard
  $('#dashboardView').style.display = 'none';
  
  // Show back link
  $('#backToDashboard').style.display = 'block';
  
  // Reset form for new request
  resetComposerForm();
  
  // Show auditor flow
  $('#auditorFlow').style.display = 'block';
  if (Object.keys(composerState).length === 0) initComposerState();
  renderComposer();
  
  // Set auditor email to current user
  if (state.user?.email) {
    setChipEmails('auditorEmailsContainer', [state.user.email]);
  }
  
  // Scroll to form
  $('#auditorFlow').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function resetComposerForm() {
  // Clear client info
  const clientCompany = $('#clientCompany');
  if (clientCompany) clientCompany.value = '';
  
  // Clear client emails
  setChipEmails('clientEmailsContainer', []);
  
  // Reset deadline to 5 days from now
  const picker = $('#deadlinePicker');
  if (picker && picker._flatpickr) {
    const defaultDeadline = new Date();
    defaultDeadline.setDate(defaultDeadline.getDate() + 5);
    defaultDeadline.setHours(17, 0, 0, 0);
    picker._flatpickr.setDate(defaultDeadline);
  }
  
  // Reset composer state
  composerState = {};
  customFrameworks = [];
  initComposerState();
  
  // Hide template loaded notice
  const notice = $('#templateLoadedNotice');
  if (notice) notice.style.display = 'none';
}

function backToDashboard() {
  // Hide composer
  $('#auditorFlow').style.display = 'none';
  $('#backToDashboard').style.display = 'none';
  
  // Show dashboard
  showDashboard();
}

// ==================== END DASHBOARD FUNCTIONS ====================

function showAuditorFlow() {
  // Hide auth flows
  $('#newUserFlow').style.display = 'none';
  $('#returningUserFlow').style.display = 'none';
  
  // Show appropriate header
  if (state.isLoggedIn) {
    $('#loggedInBar').style.display = 'flex';
    updateLoggedInBar();
    
    // Show verification notice if not verified
    if (state.user && !state.user.verified) {
      $('#verificationNotice').style.display = 'block';
    }
  } else if (state.isTrialUser) {
    $('#trialNoticeBar').style.display = 'flex';
  }
  
  // Show auditor flow
  $('#auditorFlow').style.display = 'block';
  if (Object.keys(composerState).length === 0) initComposerState();
  renderComposer();
  
  // Scroll to form
  $('#auditorFlow').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function updateLoggedInBar() {
  if (!state.user) return;
  
  $('#currentUserEmail').textContent = state.user.email;
  
  const credits = state.user.credits || 0;
  const badge = $('#creditsDisplay');
  badge.textContent = `${credits} credit${credits !== 1 ? 's' : ''}`;
  badge.className = 'credits-badge' + (credits === 0 ? ' empty' : credits <= 2 ? ' low' : '');
  
  // Update template selector (in Evidence Request section)
  const templates = state.user.templates || [];
  const loaderSection = $('#templateLoaderSection');
  const select = $('#templateSelect');
  
  if (templates.length > 0 && loaderSection && select) {
    loaderSection.style.display = 'block';
    select.innerHTML = '<option value="">Load a saved template...</option>';
    templates.forEach(t => {
      select.innerHTML += `<option value="${esc(t.id)}">${esc(t.name)}</option>`;
    });
  } else if (loaderSection) {
    loaderSection.style.display = 'none';
  }
}

// ==================== AUTH FUNCTIONS ====================

async function checkExistingSession() {
  const token = localStorage.getItem('proofrepo_token');
  if (!token) return false;
  
  try {
    const res = await fetch(`${API}/auth/me`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    
    if (res.ok) {
      const data = await res.json();
      if (data.ok && data.user) {
        state.isLoggedIn = true;
        state.authToken = token;
        state.user = data.user;
        return true;
      }
    }
    
    // Invalid token
    localStorage.removeItem('proofrepo_token');
    return false;
  } catch (e) {
    return false;
  }
}

function showAuthStatus(elementId, message, type) {
  const el = $(`#${elementId}`);
  if (!el) return;
  el.textContent = message;
  el.className = `auth-status visible ${type}`;
}

function hideAuthStatus(elementId) {
  const el = $(`#${elementId}`);
  if (el) el.className = 'auth-status';
}

async function handleApplyTrialCode() {
  const code = ($('#trialCodeInput')?.value || '').trim().toUpperCase();
  const btn = $('#applyTrialBtn');
  
  if (!code) {
    showAuthStatus('trialStatus', 'Please enter a trial code', 'error');
    return;
  }
  
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Checking...';
  showAuthStatus('trialStatus', 'Validating code...', 'loading');
  
  try {
    const res = await fetch(`${API}/auth/validate-trial?code=${encodeURIComponent(code)}`);
    const data = await res.json();
    
    if (data.ok && data.valid) {
      state.code = code;
      state.codeValid = true;
      state.codeCredits = data.credits || 1;
      
      hideAuthStatus('trialStatus');
      
      // Show trial mode section
      $('#trialCodeSection').style.display = 'none';
      $('#trialModeSection').style.display = 'block';
    } else {
      showAuthStatus('trialStatus', data.error || 'Invalid trial code', 'error');
    }
  } catch (e) {
    showAuthStatus('trialStatus', 'Error validating code. Please try again.', 'error');
  }
  
  btn.disabled = false;
  btn.textContent = 'Apply Code';
}

function handleTrialModeChange() {
  const mode = document.querySelector('input[name="trialMode"]:checked')?.value || 'live';
  state.trialMode = mode;
  $('#testModeExplainer').style.display = mode === 'test' ? 'block' : 'none';
}

async function handleStartTrial() {
  const email = ($('#trialUserEmail')?.value || '').trim().toLowerCase();
  
  if (!email || !email.includes('@') || !email.includes('.')) {
    alert('Please enter a valid email address');
    return;
  }
  
  state.trialEmail = email;
  state.isTrialUser = true;
  
  // Pre-fill auditor email
  setChipEmails('auditorEmailsContainer', [email]);
  
  // If test mode, also pre-fill client email
  if (state.trialMode === 'test') {
    setChipEmails('clientEmailsContainer', [email]);
    $('#clientCompany').value = 'Test Company';
  }
  
  showAuditorFlow();
}

function validatePassword(password) {
  const reqs = {
    length: password.length >= 8,
    number: /\d/.test(password),
    special: /[!@#$%^&*(),.?":{}|<>_\-+=\[\]\\\/`~;']/.test(password)
  };
  
  Object.entries(reqs).forEach(([key, valid]) => {
    const el = $(`.password-reqs .req[data-req="${key}"]`);
    if (el) el.classList.toggle('valid', valid);
  });
  
  return Object.values(reqs).every(Boolean);
}

async function handleSignup() {
  const email = ($('#signupEmail')?.value || '').trim().toLowerCase();
  const password = $('#signupPassword')?.value || '';
  const confirm = $('#signupPasswordConfirm')?.value || '';
  const btn = $('#signupBtn');
  
  if (!email || !email.includes('@')) {
    showAuthStatus('signupStatus', 'Please enter a valid email', 'error');
    return;
  }
  
  if (!validatePassword(password)) {
    showAuthStatus('signupStatus', 'Password does not meet requirements', 'error');
    return;
  }
  
  if (password !== confirm) {
    showAuthStatus('signupStatus', 'Passwords do not match', 'error');
    return;
  }
  
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Creating...';
  showAuthStatus('signupStatus', 'Creating account...', 'loading');
  
  try {
    const res = await fetch(`${API}/auth/signup`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password })
    });
    
    const data = await res.json();
    
    if (data.ok) {
      showAuthStatus('signupStatus', '✓ Account created! Check your email to verify.', 'success');
      
      // Auto-login but mark as unverified
      if (data.token && data.user) {
        state.isLoggedIn = true;
        state.authToken = data.token;
        state.user = data.user;
        localStorage.setItem('proofrepo_token', data.token);
        
        setTimeout(() => showDashboard(), 1500);
      }
    } else {
      showAuthStatus('signupStatus', data.error || 'Error creating account', 'error');
    }
  } catch (e) {
    showAuthStatus('signupStatus', 'Error connecting to server', 'error');
  }
  
  btn.disabled = false;
  btn.textContent = 'Create Account';
}

async function handleLogin() {
  const email = ($('#loginEmail')?.value || '').trim().toLowerCase();
  const password = $('#loginPassword')?.value || '';
  const remember = $('#rememberMe')?.checked;
  const btn = $('#loginBtn');
  
  if (!email || !password) {
    showAuthStatus('loginStatus', 'Please enter email and password', 'error');
    return;
  }
  
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Signing in...';
  showAuthStatus('loginStatus', 'Signing in...', 'loading');
  
  try {
    const res = await fetch(`${API}/auth/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password, remember })
    });
    
    const data = await res.json();
    
    if (data.ok && data.token) {
      state.isLoggedIn = true;
      state.authToken = data.token;
      state.user = data.user;
      localStorage.setItem('proofrepo_token', data.token);
      
      showAuthStatus('loginStatus', '✓ Signed in!', 'success');
      
      setTimeout(() => showDashboard(), 500);
    } else {
      showAuthStatus('loginStatus', data.error || 'Invalid email or password', 'error');
    }
  } catch (e) {
    showAuthStatus('loginStatus', 'Error connecting to server', 'error');
  }
  
  btn.disabled = false;
  btn.textContent = 'Sign In';
}

async function handleForgotPassword() {
  const email = ($('#resetEmail')?.value || '').trim().toLowerCase();
  const btn = $('#sendResetBtn');
  
  if (!email || !email.includes('@')) {
    showAuthStatus('resetStatus', 'Please enter a valid email', 'error');
    return;
  }
  
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Sending...';
  
  try {
    await fetch(`${API}/auth/forgot-password`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email })
    });
    
    // Always show success to prevent enumeration
    showAuthStatus('resetStatus', '✓ If an account exists, a reset link was sent.', 'success');
  } catch (e) {
    showAuthStatus('resetStatus', 'Error sending reset link', 'error');
  }
  
  btn.disabled = false;
  btn.textContent = 'Send Reset Link';
}

async function handleResetPassword() {
  const pw = ($('#newPassword')?.value || '');
  const pw2 = ($('#confirmNewPassword')?.value || '');
  const btn = $('#resetPasswordBtn');
  
  if (pw.length < 8 || !/\d/.test(pw) || !/[!@#$%^&*(),.?":{}|<>_\-+=\[\]\\\/`~;']/.test(pw)) {
    showAuthStatus('resetPasswordStatus', 'Password must be 8+ chars with 1 number and 1 special character', 'error');
    return;
  }
  
  if (pw !== pw2) {
    showAuthStatus('resetPasswordStatus', 'Passwords do not match', 'error');
    return;
  }
  
  const resetToken = new URLSearchParams(window.location.search).get('reset');
  if (!resetToken) {
    showAuthStatus('resetPasswordStatus', 'Missing reset token', 'error');
    return;
  }
  
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Resetting...';
  
  try {
    const res = await fetch(`${API}/auth/reset-password`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ token: resetToken, password: pw })
    });
    
    const data = await res.json();
    
    if (data.ok) {
      showAuthStatus('resetPasswordStatus', '✓ Password reset! You can now sign in with your new password.', 'success');
      // Clean URL and show login after a moment
      setTimeout(() => {
        window.history.replaceState({}, '', window.location.pathname);
        $('#resetPasswordSection').style.display = 'none';
        $('#roleSelect').value = 'returning';
        handleRoleChange('returning');
      }, 2500);
    } else {
      showAuthStatus('resetPasswordStatus', data.error || 'Reset failed', 'error');
    }
  } catch (e) {
    showAuthStatus('resetPasswordStatus', 'Error connecting to server', 'error');
  }
  
  btn.disabled = false;
  btn.textContent = 'Reset Password';
}

// Check URL for reset token and show reset form
function checkResetToken() {
  const params = new URLSearchParams(window.location.search);
  const resetToken = params.get('reset');
  if (!resetToken) return false;
  
  // Show returning customer path with reset form
  $('#roleSelect').value = 'returning';
  handleRoleChange('returning');
  
  // Hide the login/forgot sections, show reset form
  $('#loginSection').style.display = 'none';
  $('#forgotPasswordSection').style.display = 'none';
  $('#resetPasswordSection').style.display = 'block';
  
  return true;
}

function handleLogout() {
  state.isLoggedIn = false;
  state.authToken = null;
  state.user = null;
  localStorage.removeItem('proofrepo_token');
  
  // Reset UI
  $('#loggedInBar').style.display = 'none';
  $('#auditorFlow').style.display = 'none';
  $('#dashboardView').style.display = 'none';
  $('#verificationNotice').style.display = 'none';
  $('#roleSelectSection').style.display = 'block';
  $('#roleSelect').value = '';
}

async function handleResendVerification() {
  if (!state.authToken) return;
  
  try {
    const res = await fetch(`${API}/auth/resend-verification`, {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${state.authToken}` }
    });
    
    const data = await res.json();
    alert(data.ok ? 'Verification email sent!' : (data.error || 'Error sending email'));
  } catch (e) {
    alert('Error sending verification email');
  }
}

// ==================== TEMPLATE FUNCTIONS ====================

async function loadTemplate(templateId) {
  if (!templateId || !state.user?.templates) return;
  
  const template = state.user.templates.find(t => t.id === templateId);
  if (!template) return;
  
  // Restore composer state
  if (template.composerState) {
    composerState = JSON.parse(JSON.stringify(template.composerState));
  }
  if (template.customFrameworks) {
    customFrameworks = JSON.parse(JSON.stringify(template.customFrameworks));
  }
  
  // Render first, THEN set global instructions (render rebuilds the textarea)
  renderComposer();
  
  if (template.globalInstructions) {
    const gi = $('#globalInstructions');
    if (gi) gi.value = template.globalInstructions;
  }
  
  // Reset the select dropdown
  $('#templateSelect').value = '';
  
  // Show the loaded notification
  const notice = $('#templateLoadedNotice');
  const nameSpan = $('#loadedTemplateName');
  if (notice && nameSpan) {
    nameSpan.textContent = template.name;
    notice.style.display = 'block';
    
    // Scroll to show the notice
    notice.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }
}

async function saveAsTemplate() {
  if (!state.isLoggedIn) {
    alert('Please sign in to save templates');
    return;
  }
  
  const bar = $('#saveTemplateBar');
  if (!bar) return;
  
  // Check if inline form is already showing
  if (bar.querySelector('.save-template-form')) return;
  
  // Build inline form
  const form = document.createElement('div');
  form.className = 'save-template-form';
  form.style.cssText = 'margin-top: 10px; display: flex; flex-direction: column; gap: 8px;';
  form.innerHTML = `
    <input type="text" class="form-input" id="templateNameInput" placeholder='Template name (e.g., "SOC 2 Annual")' style="font-size: 0.9rem;">
    <label style="display: flex; align-items: center; gap: 8px; font-size: 0.85rem; color: var(--text-muted); cursor: pointer;">
      <input type="checkbox" id="includeInstructionsCheck" checked> Include item-level instructions
    </label>
    <div style="display: flex; gap: 8px;">
      <button type="button" class="btn btn-sm btn-accent" id="confirmSaveTemplateBtn">Save</button>
      <button type="button" class="btn btn-sm btn-outline" id="cancelSaveTemplateBtn">Cancel</button>
    </div>
    <div id="saveTemplateStatus" style="font-size: 0.85rem;"></div>
  `;
  bar.appendChild(form);
  
  const nameInput = $('#templateNameInput');
  nameInput.focus();
  
  // Cancel
  $('#cancelSaveTemplateBtn').addEventListener('click', () => form.remove());
  nameInput.addEventListener('keypress', e => {
    if (e.key === 'Enter') $('#confirmSaveTemplateBtn').click();
  });
  
  // Save
  $('#confirmSaveTemplateBtn').addEventListener('click', async () => {
    const name = (nameInput.value || '').trim();
    if (!name) {
      $('#saveTemplateStatus').textContent = 'Please enter a template name';
      $('#saveTemplateStatus').style.color = '#ef4444';
      nameInput.focus();
      return;
    }
    
    const includeInstructions = $('#includeInstructionsCheck').checked;
    const btn = $('#confirmSaveTemplateBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span>';
    
    try {
      const res = await fetch(`${API}/auth/templates`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${state.authToken}`
        },
        body: JSON.stringify({
          name,
          composerState: includeInstructions ? composerState : stripInstructions(composerState),
          customFrameworks,
          globalInstructions: includeInstructions ? ($('#globalInstructions')?.value || '') : ''
        })
      });
      
      const data = await res.json();
      
      if (data.ok && data.template) {
        state.user.templates = state.user.templates || [];
        state.user.templates.push(data.template);
        updateLoggedInBar();
        $('#saveTemplateStatus').textContent = '✓ Template saved!';
        $('#saveTemplateStatus').style.color = '#10b981';
        setTimeout(() => form.remove(), 1500);
      } else {
        $('#saveTemplateStatus').textContent = data.error || 'Error saving template';
        $('#saveTemplateStatus').style.color = '#ef4444';
        btn.disabled = false;
        btn.textContent = 'Save';
      }
    } catch (e) {
      $('#saveTemplateStatus').textContent = 'Error saving template';
      $('#saveTemplateStatus').style.color = '#ef4444';
      btn.disabled = false;
      btn.textContent = 'Save';
    }
  });
}

function stripInstructions(cs) {
  const stripped = JSON.parse(JSON.stringify(cs));
  for (const fwKey in stripped) {
    for (const gKey in stripped[fwKey]?.groups || {}) {
      for (const iKey in stripped[fwKey].groups[gKey]?.items || {}) {
        stripped[fwKey].groups[gKey].items[iKey].instructions = '';
      }
    }
  }
  return stripped;
}

function setupAuthListeners() {
  // New user type toggle
  $$('input[name="newUserType"]').forEach(r => {
    r.addEventListener('change', e => showNewUserSection(e.target.value));
  });
  
  // Trial code
  $('#applyTrialBtn')?.addEventListener('click', handleApplyTrialCode);
  $('#trialCodeInput')?.addEventListener('keypress', e => {
    if (e.key === 'Enter') handleApplyTrialCode();
  });
  
  // Trial mode
  $$('input[name="trialMode"]').forEach(r => {
    r.addEventListener('change', handleTrialModeChange);
  });
  $('#startTrialBtn')?.addEventListener('click', handleStartTrial);
  
  // Signup
  $('#signupPassword')?.addEventListener('input', e => validatePassword(e.target.value));
  $('#signupBtn')?.addEventListener('click', handleSignup);
  $('#signupPasswordConfirm')?.addEventListener('keypress', e => {
    if (e.key === 'Enter') handleSignup();
  });
  
  // Login
  $('#loginBtn')?.addEventListener('click', handleLogin);
  $('#loginPassword')?.addEventListener('keypress', e => {
    if (e.key === 'Enter') handleLogin();
  });
  
  // Forgot password
  $('#forgotPasswordLink')?.addEventListener('click', e => {
    e.preventDefault();
    showForgotPassword();
  });
  $('#sendResetBtn')?.addEventListener('click', handleForgotPassword);
  $('#backToLoginBtn')?.addEventListener('click', showLoginSection);
  
  // Reset password (from email link)
  $('#resetPasswordBtn')?.addEventListener('click', handleResetPassword);
  $('#newPassword')?.addEventListener('input', e => {
    const pw = e.target.value;
    const update = (id, ok) => {
      const el = $(`#${id}`);
      if (el) { el.textContent = (ok ? '✓ ' : '✗ ') + el.textContent.slice(2); el.style.color = ok ? '#10b981' : '#ef4444'; }
    };
    update('resetReqLength', pw.length >= 8);
    update('resetReqNumber', /\d/.test(pw));
    update('resetReqSpecial', /[!@#$%^&*(),.?":{}|<>_\-+=\[\]\\\/`~;']/.test(pw));
  });
  $('#confirmNewPassword')?.addEventListener('keypress', e => {
    if (e.key === 'Enter') handleResetPassword();
  });
  
  // Logout
  $('#logoutBtn')?.addEventListener('click', handleLogout);
  
  // Resend verification
  $('#resendVerifyLink')?.addEventListener('click', e => {
    e.preventDefault();
    handleResendVerification();
  });
  
  // Create account from trial notice
  $('#createAccountLink')?.addEventListener('click', e => {
    e.preventDefault();
    $('#roleSelect').value = 'new';
    handleRoleChange('new');
    showNewUserSection('account');
    // Pre-fill email if we have it
    if (state.trialEmail) {
      $('#signupEmail').value = state.trialEmail;
    }
  });
  
  // Template selector
  $('#templateSelect')?.addEventListener('change', e => {
    if (e.target.value) loadTemplate(e.target.value);
  });
  
  // Dismiss template loaded notice
  $('#dismissTemplateNotice')?.addEventListener('click', () => {
    $('#templateLoadedNotice').style.display = 'none';
  });
  
  // Dashboard: New Request button
  $('#newRequestBtn')?.addEventListener('click', () => {
    showComposerFromDashboard();
  });
  
  // Dashboard: Back to Dashboard link
  $('#backToDashboardLink')?.addEventListener('click', e => {
    e.preventDefault();
    backToDashboard();
  });
  
  // Buy Credits buttons (header and alert)
  $('#buyCreditsHeaderBtn')?.addEventListener('click', () => {
    showBuyCreditsFromDashboard();
  });
  
  $('#buyCreditsAlertBtn')?.addEventListener('click', () => {
    showBuyCreditsFromDashboard();
  });
}

function showBuyCreditsFromDashboard() {
  // Hide dashboard, show composer with payment section open
  $('#dashboardView').style.display = 'none';
  $('#backToDashboard').style.display = 'block';
  
  // Show auditor flow
  $('#auditorFlow').style.display = 'block';
  if (Object.keys(composerState).length === 0) initComposerState();
  renderComposer();
  
  // Set auditor email
  if (state.user?.email) {
    setChipEmails('auditorEmailsContainer', [state.user.email]);
  }
  
  // Show payment section
  showPaymentSection();
  
  // Scroll to payment
  setTimeout(() => {
    $('#paymentSection').scrollIntoView({ behavior: 'smooth', block: 'center' });
  }, 100);
}

function showPaymentSection() {
  state.paymentVisible = true;
  $('#paymentSection').classList.add('visible');
  updateMainButton();
}

function updateMainButton() {
  const btn = $('#mainActionBtn');
  if (!btn) return;
  
  // If logged in with credits or trial user - show Send directly
  if ((state.isLoggedIn && state.user?.credits > 0) || state.isTrialUser) {
    btn.textContent = 'Send Evidence Request';
    btn.className = 'btn btn-accent btn-full';
    btn.disabled = false;
  } else if (state.isLoggedIn && !state.user?.verified) {
    btn.textContent = 'Verify Email to Continue';
    btn.className = 'btn btn-primary btn-full';
    btn.disabled = false;
  } else if (!state.paymentVisible) {
    btn.textContent = 'Continue';
    btn.className = 'btn btn-primary btn-full';
    btn.disabled = false;
  } else {
    btn.textContent = 'Send Evidence Request';
    btn.className = 'btn btn-accent btn-full';
    btn.disabled = false;
  }
}

function selectTier(tier) {
  $$('.pricing-card').forEach(card => { 
    card.classList.toggle('selected', card.dataset.tier === tier); 
  });
  state.selectedTier = tier;
  const buyBtn = $('#buyCreditsBtn');
  if (tier) { 
    const prices = { single: '$59', pack5: '$249', pack15: '$499', pack50: '$1,249' }; 
    buyBtn.disabled = false; 
    buyBtn.textContent = `Buy Credits — ${prices[tier]}`;
    // ADD THIS: Highlight the button
    buyBtn.className = 'btn btn-accent btn-full';
  } else { 
    buyBtn.disabled = true; 
    buyBtn.textContent = 'Select a plan to purchase';
    buyBtn.className = 'btn btn-outline btn-full';
  }
}
// ==================== MAIN ACTIONS ====================

async function handleMainAction() {
  const btn = $('#mainActionBtn');
  
  // Validation
  const auditorEmails = getChipEmails('auditorEmailsContainer');
  const clientEmails = getChipEmails('clientEmailsContainer');
  const company = ($('#clientCompany')?.value || '').trim();
  
  if (auditorEmails.length === 0) {
    alert('Please enter at least one team email address.');
    return;
  }
  if (!company) {
    alert('Please enter the client company name.');
    return;
  }
  if (clientEmails.length === 0) {
    alert('Please enter at least one client email address.');
    return;
  }
  
  const evidence = getPayload();
  if (evidence.length === 0) {
    alert('Please select at least one evidence item to request.');
    return;
  }
  
  saveFormState();
  
  // Check if user can send (logged in with credits, or trial user, or needs payment)
  if (state.isLoggedIn && state.user?.credits > 0) {
    // Logged in with credits - hide payment if visible and send directly
    if (state.paymentVisible) {
      $('#paymentSection').classList.remove('visible');
      state.paymentVisible = false;
    }
    await sendRequest();
  } else if (state.isTrialUser && state.codeValid) {
    // Trial user - send directly
    await sendRequest();
  } else if (state.isLoggedIn && (!state.user?.credits || state.user.credits === 0)) {
    // Logged in but no credits - show payment
    showPaymentSection();
    $('#paymentSection').scrollIntoView({ behavior: 'smooth', block: 'center' });
  } else if (state.isLoggedIn && !state.user?.verified) {
    // Logged in but not verified
    alert('Please verify your email before sending requests. Check your inbox for the verification link.');
  } else if (!state.paymentVisible) {
    // Not logged in, not trial - show payment section
    showPaymentSection();
    $('#paymentSection').scrollIntoView({ behavior: 'smooth', block: 'center' });
  } else {
    // Payment visible, validate code and send
    const code = ($('#auditorCode')?.value || '').trim().toUpperCase();
    
    if (!code) {
      alert('Please enter your credit code.');
      $('#auditorCode').focus();
      return;
    }
    
    if (!state.codeValid || state.code !== code) {
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> Checking code...';
      
      const result = await validateCode(code);
      updateCodeUI(result);
      
      if (!result.valid) {
        btn.disabled = false;
        btn.textContent = 'Send Evidence Request';
        alert(result.error || 'Invalid code. Please try again.');
        return;
      }
      
      state.code = code;
      saveFormState();
    }
    
    await sendRequest();
  }
}

async function handleCheckout() {
  if (!state.selectedTier) return;
  
  const buyBtn = $('#buyCreditsBtn');
  buyBtn.disabled = true;
  buyBtn.innerHTML = '<span class="spinner"></span> Processing...';
  
  saveFormState();
  
  try {
    const auditorEmails = getChipEmails('auditorEmailsContainer');
    const checkoutHeaders = { 'Content-Type': 'application/json' };
    if (state.authToken) {
      checkoutHeaders['Authorization'] = `Bearer ${state.authToken}`;
    }
    const res = await fetch(`${API}/checkout`, {
      method: 'POST',
      headers: checkoutHeaders,
      body: JSON.stringify({
        tier: state.selectedTier,
        email: auditorEmails[0] || '',
        successUrl: window.location.origin + window.location.pathname + '?session_id={CHECKOUT_SESSION_ID}',
        cancelUrl: window.location.href
      })
    });
    
    const data = await res.json();
    
    if (data.ok && data.url) {
      window.location.href = data.url;
    } else {
      alert('Error starting checkout: ' + (data.error || 'Unknown error'));
      buyBtn.disabled = false;
      buyBtn.textContent = 'Buy Credits';
    }
  } catch (e) {
    alert('Error: ' + e.message);
    buyBtn.disabled = false;
    buyBtn.textContent = 'Buy Credits';
  }
}

async function sendRequest() {
  const btn = $('#mainActionBtn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Sending...';
  
  const deadline = calculateDeadline();
  const frameworks = Object.entries(composerState)
    .filter(([_, s]) => s.enabled)
    .map(([k]) => { 
      const allFw = getAllFrameworks(); 
      return allFw[k]?.label || k; 
    });
  const requestedEvidence = getPayload();
  const auditorEmails = getChipEmails('auditorEmailsContainer');
  const clientEmails = getChipEmails('clientEmailsContainer');
  
  // Get audit period dates if set
  const auditPeriodStart = auditPeriodStartPicker?.selectedDates[0]?.toISOString() || null;
  const auditPeriodEnd = auditPeriodEndPicker?.selectedDates[0]?.toISOString() || null;
  
  // Build headers
  const headers = { 'Content-Type': 'application/json' };
  if (state.authToken) {
    headers['Authorization'] = `Bearer ${state.authToken}`;
  }
  
  try {
    const res = await fetch(`${API}/request`, {
      method: 'POST',
      headers,
      body: JSON.stringify({
        auditorEmail: auditorEmails[0] || '',
        auditorEmails: auditorEmails,
        clientEmail: clientEmails[0] || '',
        clientEmails: clientEmails,
        company: $('#clientCompany').value,
        frameworks: frameworks,
        deadlineISO: deadline.toISOString(),
        auditorCode: state.code || '',
        globalInstructions: $('#globalInstructions')?.value || '',
        requestedEvidence: requestedEvidence,
        // Audit period for period-of-time evidence
        auditPeriodStart: auditPeriodStart,
        auditPeriodEnd: auditPeriodEnd,
        // Trial flags
        isTrialRequest: state.isTrialUser,
        trialMode: state.trialMode
      })
    });
    
    const data = await res.json();
    
    if (data.ok) {
      clearFormState();
      
      // Update local credits if logged in
      if (state.isLoggedIn && state.user) {
        state.user.credits = Math.max(0, (state.user.credits || 0) - 1);
        // Add token to local requests list
        if (data.token) {
          state.user.requests = state.user.requests || [];
          state.user.requests.unshift(data.token);
        }
        updateLoggedInBar();
      }
      
      const clientList = clientEmails.join(', ');
      
      if (state.isTrialUser) {
        // Special message for trial users
        alert(`Success! ${state.trialMode === 'test' ? 'Test request' : 'Evidence request'} sent to ${clientList}.\n\nCheck your email for next steps!`);
        window.location.reload();
      } else if (state.isLoggedIn) {
        // Show success and go to dashboard
        alert('Success! Evidence request sent to ' + clientList);
        backToDashboard();
      } else {
        alert('Success! Evidence request sent to ' + clientList + '\n\nClient link: ' + (data.magicLink || ''));
        window.location.reload();
      }
    } else {
      alert('Error: ' + (data.error || 'Unknown error'));
      btn.disabled = false;
      btn.textContent = 'Send Evidence Request';
    }
  } catch (e) {
    alert('Error: ' + e.message);
    btn.disabled = false;
    btn.textContent = 'Send Evidence Request';
  }
}

// ==================== MODALS ====================

function setupModals() {
  $('#cancelFwBtn')?.addEventListener('click', () => { 
    $('#addFwModal').classList.add('hidden'); 
    $('#customFwName').value = ''; 
    $('#customFwDesc').value = ''; 
  });
  
  $('#saveFwBtn')?.addEventListener('click', () => {
    const name = ($('#customFwName')?.value || '').trim();
    const desc = ($('#customFwDesc')?.value || '').trim();
    if (!name) return;
    const id = 'cf_' + Math.random().toString(36).slice(2, 8);
    customFrameworks.push({ id, label: name, description: desc || 'Custom framework', defaultOn: false, controlGroups: [] });
    composerState[id] = { enabled: true, groups: {} };
    $('#addFwModal').classList.add('hidden');
    $('#customFwName').value = '';
    $('#customFwDesc').value = '';
    renderComposer();
    saveFormState();
  });
  
  $('#cancelGroupBtn')?.addEventListener('click', () => { 
    $('#addGroupModal').classList.add('hidden'); 
    $('#customGroupName').value = ''; 
    $('#customGroupDesc').value = ''; 
    $('#customGroupFwKey').value = ''; 
  });
  
  $('#saveGroupBtn')?.addEventListener('click', () => {
    const name = ($('#customGroupName')?.value || '').trim();
    const desc = ($('#customGroupDesc')?.value || '').trim();
    const fwKey = $('#customGroupFwKey')?.value;
    if (!name || !fwKey) return;
    const gid = 'g_' + Math.random().toString(36).slice(2, 8);
    const allFw = getAllFrameworks();
    const fw = allFw[fwKey];
    if (fw) {
      fw.controlGroups.push({ id: gid, title: name, description: desc, items: [] });
      composerState[fwKey].groups[gid] = { expanded: true, showMore: false, excluded: false, items: {} };
    }
    $('#addGroupModal').classList.add('hidden');
    $('#customGroupName').value = '';
    $('#customGroupDesc').value = '';
    $('#customGroupFwKey').value = '';
    renderComposer();
    saveFormState();
  });
}


// ==================== URL PARAM PREFILL (for resend links) ====================

function handleUrlPrefill() {
  const params = new URLSearchParams(window.location.search);
  
  // Check if this is a resend link (mode=resend or has prev token)
  const mode = params.get('mode');
  const prev = params.get('prev');
  
  if (mode !== 'resend' && !prev) return false;
  
  // Get prefill values
  const company = params.get('company') || '';
  const frameworks = (params.get('frameworks') || '').split(',').filter(Boolean);
  const auditorEmails = (params.get('auditorEmails') || '').split(',').filter(e => e && e.includes('@'));
  const clientEmails = (params.get('clientEmails') || '').split(',').filter(e => e && e.includes('@'));
  
  // Set role to auditor
  const roleSelect = $('#roleSelect');
  if (roleSelect) {
    roleSelect.value = 'auditor';
    handleRoleChange('auditor');
  }
  
  // Prefill company
  const companyInput = $('#clientCompany');
  if (companyInput && company) {
    companyInput.value = company;
  }
  
  // Prefill emails (chip inputs must be initialized first)
  if (auditorEmails.length > 0) {
    setChipEmails('auditorEmailsContainer', auditorEmails);
  }
  if (clientEmails.length > 0) {
    setChipEmails('clientEmailsContainer', clientEmails);
  }
  
  // Enable frameworks in composer
  if (frameworks.length > 0) {
    frameworks.forEach(fw => {
      const fwUpper = fw.toUpperCase();
      if (composerState[fwUpper]) {
        composerState[fwUpper].enabled = true;
      }
    });
    renderComposer();
  }
  
  // Clean URL (remove params without reload)
  const cleanUrl = window.location.pathname;
  window.history.replaceState({}, '', cleanUrl);
  
  // Scroll to deadline picker (since that's all they need to change)
  setTimeout(() => {
    const deadlineInput = $('#deadlinePicker');
    if (deadlineInput && deadlinePicker) {
      deadlineInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
      // Flash the deadline field
      const altInput = deadlinePicker.altInput || deadlineInput;
      altInput.style.outline = '2px solid var(--accent)';
      altInput.style.boxShadow = '0 0 10px rgba(56, 189, 248, 0.3)';
      setTimeout(() => { 
        altInput.style.outline = ''; 
        altInput.style.boxShadow = '';
      }, 2500);
      // Open the picker
      deadlinePicker.open();
    }
  }, 300);
  
  return true;
}

// ==================== INIT ====================

async function init() {
  $('#year').textContent = new Date().getFullYear();
  
  // Initialize chip inputs FIRST (before any state restore)
  initChipInput('auditorEmailsContainer');
  initChipInput('clientEmailsContainer');
  
  // Initialize date picker
  initDeadlinePicker();
  
  initComposerState();
  
  // Set up auth event listeners
  setupAuthListeners();
  
  // Check for password reset token in URL (takes priority)
  const isResetFlow = checkResetToken();
  
  // Check for checkout return (handles its own session check)
  const isCheckoutReturn = !isResetFlow && await checkCheckoutReturn();
  
  // Check for existing session (skip if checkout return already handled it)
  let hasSession = false;
  if (!isResetFlow && !isCheckoutReturn) {
    hasSession = await checkExistingSession();
    if (hasSession) {
      showDashboard();
    }
  }
  
  // ALWAYS set up all event listeners
  setupAutoSave();
  setupModals();
  
  // Check for URL prefill (resend links from deadline-missed emails)
  const isResendPrefill = handleUrlPrefill();
  
  // Only restore form state when returning from Stripe checkout
  if (!isCheckoutReturn && !isResendPrefill && !hasSession) {
    clearFormState();
  }
  
  // Event listeners
  $('#roleSelect').addEventListener('change', e => {
    handleRoleChange(e.target.value);
    saveFormState();
  });
  
  $('#mainActionBtn').addEventListener('click', handleMainAction);
  
  $$('.pricing-card').forEach(card => {
    card.addEventListener('click', () => selectTier(card.dataset.tier));
  });
  
  $('#buyCreditsBtn').addEventListener('click', handleCheckout);
  
  $('#getStartedLink').addEventListener('click', e => {
    e.preventDefault();
    $('#roleSelect').scrollIntoView({ behavior: 'smooth' });
    $('#roleSelect').focus();
  });
  
  updateMainButton();
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
