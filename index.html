<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ProofRepo ‚Äî Compliance ProofPacks in seconds</title>

  <!-- SEO -->
  <meta name="description" content="Compliance ProofPacks in seconds. Auditors and third parties use ProofRepo to collect SOC 2 and other framework evidence without messy folders or endless correction emails. Companies use it to stay audit- or event-ready without buying a full automation suite." />
  <meta name="keywords" content="SOC 2 evidence, ISO 27001 evidence, HIPAA evidence, GDPR evidence, vendor security review, compliance proof, audit readiness" />

  <!-- Open Graph -->
  <meta property="og:title" content="ProofRepo ‚Äî Compliance ProofPacks in seconds">
  <meta property="og:description" content="Built for boutique auditors and their clients. Guided evidence collection that reduces errors and back-and-forth, without the overhead of a full GRC platform.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://proofrepo.com/">
  <meta property="og:image" content="https://proofrepo.com/og.png">

  <link rel="canonical" href="https://proofrepo.com/">
  <meta name="twitter:card" content="summary_large_image">

  <style>
    :root{
      --bg:#0b1020; --gradA:#0b1020; --gradB:#0d1b3d;
      --panel:#10183a; --panel2:#0e1532; --text:#e8edff; --muted:#a7b6e7; --line:#1d2857;
      --primary:#2563eb; --primary2:#3b82f6; --accent:#22c55e; --ring:rgba(37,99,235,.35);
      --r:16px; --rs:12px; --shadow:0 14px 40px rgba(3,7,18,.35); --max:1200px;
      --marqueeH:54px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:linear-gradient(180deg,var(--gradA),var(--gradB));color:var(--text);font:16px/1.55 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    body{padding-bottom:calc(var(--marqueeH) + env(safe-area-inset-bottom,0px))}
    a{color:inherit;text-decoration:none}
    img{max-width:100%;height:auto}
    .wrap{max-width:var(--max);margin:0 auto;padding:28px}
    .row{display:flex;align-items:center;justify-content:space-between;gap:16px}

    /* NAV */
    .logo{display:flex;align-items:center;gap:10px;font-weight:800}
    .glyph{width:34px;height:34px;border-radius:10px;background:conic-gradient(from 210deg,var(--primary),var(--primary2));box-shadow:var(--shadow)}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 18px;border-radius:999px;border:1px solid #2a3766;cursor:pointer;transition:transform .12s ease, background .12s ease, filter .12s ease}
    .btn:hover{background:#111b3e; transform:translateY(-1px)}
    .btn.primary{background:linear-gradient(135deg,var(--primary),var(--primary2));border-color:transparent;color:#fff;box-shadow:var(--shadow)}
    .btn.primary[disabled]{opacity:.6;cursor:not-allowed;transform:none}
    .btn.link{padding:0;border:0;color:#9db0ff}
    .nav{backdrop-filter:saturate(120%) blur(4px)}

    /* HERO */
    .hero{padding:56px 28px}
    .heroGrid{display:grid;grid-template-columns:1.1fr .9fr;gap:28px;align-items:center}
    .kicker{color:var(--accent);font-weight:800;letter-spacing:.12em;text-transform:uppercase;font-size:.8rem}
    h1{font-size:clamp(28px,4vw,46px);line-height:1.15;margin:10px 0 12px}
    .sub{color:var(--muted);font-size:1.05rem;max-width:60ch}
    .card{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--line);border-radius:var(--r);padding:22px;transition:transform .15s ease, box-shadow .15s ease, border-color .15s ease}
    .card:hover{transform:translateY(-2px); box-shadow:0 18px 45px rgba(20,40,120,.35); border-color:#2b3e7a}
    .ticks{display:grid;gap:10px;margin-top:12px}
    .li{display:flex;gap:10px}
    .tick{width:20px;height:20px;border-radius:999px;display:inline-grid;place-items:center;background:linear-gradient(135deg,#34d399,#86efac);color:#062312;font-weight:900;font-size:.8rem}
    .pill{display:inline-block;padding:6px 10px;border:1px solid #2a3766;border-radius:999px;background:#0c1636;color:#a7b9ff;font-size:.85rem}

    /* STICKY BOTTOM MARQUEE */
    .marquee-fixed{position:fixed;left:0;right:0;bottom:0;height:var(--marqueeH);display:flex;align-items:center;border-top:1px solid var(--line);background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,0));backdrop-filter:saturate(120%) blur(6px);z-index:9999;padding-bottom:env(safe-area-inset-bottom,0px)}
    .marquee{white-space:nowrap;overflow:hidden;width:100%}
    .marquee > div{display:inline-block;padding-left:100%;animation:scroll 24s linear infinite;color:#b9c6ff;opacity:.95}
    @keyframes scroll{0%{transform:translateX(0)}100%{transform:translateX(-100%)}}

    /* SECTIONS / GRID */
    .section{padding:40px 28px}
    .grid{display:grid;gap:18px}
    .cols2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .cols3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .muted{color:var(--muted)}
    .small{font-size:.9rem;color:var(--muted)}
    .tag{color:var(--muted);font-size:.9rem}
    .hint{font-size:.85rem;color:#9fb2ff;margin-top:6px}

    /* PRICING */
    .pricing .plan{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--line);border-radius:14px;padding:20px;display:flex;flex-direction:column;gap:10px; position:relative}
    .pricing h3{margin:0}
    .price{font-size:1.4rem;font-weight:700}
    .popular{border-color:#2b5cff;box-shadow:0 12px 36px rgba(43,92,255,.25)}

    /* FORM */
    form{display:grid;gap:14px}
    label{font-weight:600}
    input, select, textarea{width:100%; padding:12px 12px; border-radius:10px; border:1px solid #2a3766; background:#0e1634; color:var(--text)}
    textarea{min-height:110px;resize:vertical}
    .form-row{display:grid;gap:12px}
    .two{grid-template-columns:1fr 1fr}
    .three{grid-template-columns:1fr 1fr 1fr}
    .status{margin-top:8px;padding:10px;border-radius:10px;background:#0d193c;border:1px solid #27356b}
    .status.ok{border-color:#195d3a;background:#0f2a22}
    .status.err{border-color:#7a1a2a;background:#2b0e16}
    .filebox{border:1px dashed #3a4a86;border-radius:12px;padding:14px;transition:border-color .15s ease, background .15s ease}
    .filebox.dragover{border-style:solid;border-color:#4b65ff;background:#0f1a3d}
    .filemeta{font-size:.9rem;color:#a9b8ef}

    .guidance{margin-top:12px;padding:12px 14px;border-radius:10px;border:1px solid #27356b;background:#0d1736;font-size:.9rem}
    .guidance h4{margin:0 0 6px;font-size:.95rem}
    .guidance ul{margin:0;padding-left:18px}
    .guidance li{margin:6px 0}
    .guidance .ok{color:#4ade80}
    .guidance .missing{color:#fca5a5}

    details.advanced{margin-top:8px}
    details.advanced summary{cursor:pointer;font-weight:600;color:#9fb2ff}

    @media (max-width:980px){
      .heroGrid{grid-template-columns:1fr}
      .cols3,.cols2{grid-template-columns:1fr}
    }
    .focusable:focus-visible,.btn:focus-visible,a:focus-visible,summary:focus-visible{outline:3px solid var(--ring);outline-offset:2px;border-radius:10px}
  </style>

  <!-- JSON-LD -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"Organization",
    "name":"ProofRepo",
    "url":"https://proofrepo.com",
    "email":"ops@proofrepo.com",
    "description":"Compliance ProofPacks in seconds. Guided evidence collection for boutique auditors and their clients.",
    "address":{
      "@type":"PostalAddress",
      "addressLocality":"Jacksonville",
      "addressRegion":"FL",
      "addressCountry":"US"
    }
  }
  </script>
</head>
<body>
  <!-- NAV -->
  <header class="wrap row nav" role="banner">
    <div class="logo">
      <div class="glyph" aria-hidden="true"></div>
      <span>ProofRepo</span>
    </div>
    <nav class="row" aria-label="primary">
      <a class="btn" href="#companies">For companies</a>
      <a class="btn" href="#how">How it works</a>
      <a class="btn" href="#request">Upload evidence</a>
    </nav>
  </header>

  <!-- HERO -->
  <section class="wrap hero">
    <div class="heroGrid">
      <div>
        <div class="kicker">Compliance ProofPacks in seconds</div>
        <h1>Streamlined evidence collection ‚Äî without Drive, Dropbox, or email chaos</h1>
        <p class="sub">
          ProofRepo replaces scattered Google Drive folders, ad-hoc Dropbox links, and
          long email threads with a single guided flow for compliance evidence.
          <br><br>
          <strong>Auditors and third parties</strong> use ProofRepo to collect the right
          artifacts from clients ‚Äî mapped to controls and ready for workpapers.
          <br><br>
          <strong>Companies</strong> use ProofRepo to be audit- or review-ready with clean,
          correctly labeled inputs, without buying a big-ticket compliance suite.
        </p>
        <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:16px">
          <a class="btn primary" href="#request" data-analytics="cta_upload">Upload evidence</a>
         
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:14px">
          <span class="pill">Built for boutique audit firms</span>
          <span class="pill">SOC 2, ISO 27001, HIPAA, GDPR, NIST CSF</span>
          <span class="pill">Cleaner than ad-hoc Google Drives</span>
          <span class="pill">No $20k ‚Äúall-in-one‚Äù suite required</span>
        </div>
      </div>

      <aside class="card" aria-label="Highlights">
        <div class="ticks">
          <div class="li">
            <span class="tick">‚úì</span>
            <div><strong>Guided for clients:</strong> fewer wrong files, fewer ‚Äúoops, wrong export‚Äù corrections.</div>
          </div>
          <div class="li">
            <span class="tick">‚úì</span>
            <div><strong>Reviewer-first view:</strong> ProofPack groups files by what they prove (e.g., access review, change log, vendors).</div>
          </div>
          <div class="li">
            <span class="tick">‚úì</span>
            <div><strong>Lightweight by design:</strong> no agents, no dashboards ‚Äî just evidence in ‚Üí ProofPack out.</div>
          </div>
        </div>
        <p class="muted" style="margin-top:12px">
          Today‚Äôs beta supports <strong>SOC 2</strong> plus guided minimums for ISO 27001, HIPAA,
          GDPR, and NIST CSF so you can keep everything organized as your program grows.
        </p>
      </aside>
    </div>
  </section>

    <!-- REQUEST / INTAKE -->
  <section id="request" class="wrap section">
    <h2>Upload evidence and get a ProofPack</h2>
    <p class="muted">
      Use this form to send SOC 2 and related evidence. You‚Äôll receive a confirmation email with a
      secure ProofPack link. During beta we‚Äôre focused on correctness and reviewer experience ‚Äî
      payments (Stripe, etc.) will plug in later.
    </p>

    <form id="intakeForm" class="card" novalidate>
      <!-- STEP 0: role first -->
      <div class="form-row" id="roleRow">
        <div>
          <label for="role">What is ProofRepo helping you with today?</label>
          <select id="role" name="role" required>
            <option value="" selected disabled>Choose one‚Ä¶</option>
            <option value="auditor">I‚Äôm an auditor or a third party collecting evidence from a company</option>
            <option value="client">A third party sent me here to upload evidence documentation to generate a ProofPack</option>
            <option value="company">I‚Äôm a company proactively updating my ProofPack</option>
          </select>
          <div class="hint" id="roleHint">
            We use this for routing, wording, and which fields show up ‚Äî not for billing.
          </div>
        </div>
      </div>

      <!-- Contact -->
      <div class="form-row three step-after-role" id="contactRow" style="display:none">
        <div>
          <label id="emailLabel" for="email">Work email</label>
         <input id="email" name="email" type="email" required placeholder="you@company.com" autocomplete="email"/>
<div class="hint" id="emailHint" style="margin-top:6px"></div>
        </div>
        <!-- Company (optional) -->
<div id="companyCol">
  <label id="companyLabel" for="company">Company</label>
  <input id="company" name="company" placeholder="Company Inc." autocomplete="organization"/>
</div>

<!-- Client contact email (shown for auditor role instead of company) -->
<div id="clientContactCol" style="display:none">
  <label for="clientContactEmail">Client contact email</label>
  <input id="clientContactEmail" name="clientContactEmail" type="email" placeholder="client@company.com" autocomplete="email"/>
  <div class="hint">Use this instead of ‚ÄúClient company‚Äù.</div>
</div>

      </div>

<!-- Deadline (AUDITOR only) -->
<div class="form-row step-after-role" id="deadlineRow" style="display:none">
  <div class="form-row two">
    <div>
      <label for="deadlineDays">Evidence deadline</label>
      <select id="deadlineDays" name="deadlineDays">
        <option value="3">3 days</option>
        <option value="5" selected>5 days</option>
        <option value="7">7 days</option>
        <option value="10">10 days</option>
        <option value="14">14 days</option>
        <option value="21">21 days</option>
        <option value="30">30 days</option>
      </select>
      <div class="hint">This powers automatic reminder + deadline follow-ups.</div>
    </div>

    <div>
      <label for="deadlineTimeLocal">Time (local)</label>
      <input id="deadlineTimeLocal" name="deadlineTimeLocal" type="time" value="17:00" />
      <div class="hint">Defaults to 5:00pm your local time.</div>
    </div>
  </div>
</div>

      <!-- Frameworks -->
      <div class="form-row step-after-role" id="frameworkRow" style="display:none">
        <div>
          <label for="frameworks">Framework(s)</label>
          <select id="frameworks" name="frameworks" multiple required>
            <option value="SOC2" selected>SOC 2</option>
            <option value="ISO27001">ISO 27001</option>
            <option value="HIPAA">HIPAA</option>
            <option value="GDPR">GDPR</option>
            <option value="NIST CSF">NIST CSF</option>
            <option value="Other">Other</option>
          </select>
          <div class="hint">Select all that apply. The guided checklist will show minimum evidence for each framework.</div>
        </div>
      </div>

      <!-- Files (drag & drop) -->
      <div class="filebox step-after-role" id="filesRow" style="display:none">
        <label for="files">
          <strong>Upload artifacts</strong>
          <span class="muted">(Drag and drop or choose files ‚Äî zip archives are fine.)</span>
        </label>
        <input id="files" name="files" type="file" multiple />
        <div id="fileMeta" class="filemeta">No files selected.</div>
      </div>

      <!-- Dynamic framework guidance / tagging -->
      <div id="frameworkGuides" class="guidance step-after-role" style="display:none"></div>

            <!-- ROUTING (non-payment routing fields only; codes are entered in the unlock gate) -->
      <div class="form-row three step-after-role" id="routingRow" style="display:none">
        <div id="auditorCodeCol" style="display:none">
        </div>

        <div id="auditorEmailCol">
          <label for="auditorEmail">Auditor / third-party email (optional)</label>
          <input id="auditorEmail" name="auditorEmail" type="email" placeholder="reviewer@examplefirm.com"/>
          <div class="hint" id="auditorEmailHint">
            If you know the reviewer‚Äôs email, add it so we can route the ProofPack to them too.
          </div>
        </div>

        <div id="clientEmailCol">
          <label for="clientEmail">Client contact email (optional)</label>
          <input id="clientEmail" name="clientEmail" type="email" placeholder="client@company.com"/>
          <div class="hint" id="clientEmailHint">
            If you‚Äôre an auditor, add your client contact so we can associate the pack with them.
          </div>
        </div>
      </div>

      <!-- Optional block: everything else -->
      <details class="advanced step-after-role" id="optionalRow" style="display:none">
       <summary>Optional details: plan label, context, and advanced mapping</summary>
        <div style="margin-top:12px;display:grid;gap:16px">
          <!-- Plan & coverage (shown after files present) -->
          <div class="form-row two" id="planBillingRow" style="display:none">
            <div>
              <label for="plan">Plan label (beta)</label>
              <select id="plan" name="plan">
                <option value="Trial" selected>Trial</option>
                <option value="OneOff">One-off pack</option>
                <option value="Starter">Starter (planned)</option>
                <option value="Pro">Pro (planned)</option>
              </select>
              <div class="hint">Backend uses this as a label plus simple caps. Real pricing will be upload-based.</div>
            </div>
            <div>
              <label for="billingMode">How will this ProofPack be covered?</label>
              <select id="billingMode" name="billingMode">
                <option value="">Not decided yet</option>
                <option value="code">I have a code from an auditor / third party</option>
                <option value="card">I want to pay by card (Stripe)</option>
              </select>
              <div class="hint" id="billingHint">
                You can decide this later. In beta we mostly use codes or manual billing via ops@proofrepo.com.
              </div>
            </div>
          </div>

          <!-- Context (hidden cadence, visible notes) -->
          <input type="hidden" id="cadence" name="cadence" value="">
          <input type="hidden" id="requestToken" name="requestToken" value="">
          <div class="form-row">
            <div>
              <label for="notes">Anything we should know?</label>
              <textarea id="notes" name="notes" placeholder="Deadlines, specific controls, output preferences‚Ä¶"></textarea>
            </div>
          </div>

          <!-- Advanced manual map -->
          <details class="advanced">
            <summary>Advanced: Manual map JSON (optional)</summary>
            <div style="margin-top:8px">
              <label for="map">Manual Map JSON</label>
              <textarea id="map" name="map" class="muted" placeholder='{"AccessReview":"access.csv","ChangeLog":"change.txt","Vendors":"vendors.json"}'></textarea>
              <div class="hint">Most people can ignore this. It overrides the auto-mapping engine for specific files.</div>
            </div>
          </details>
        </div>
      </details>

      <!-- INLINE PRICING GATE (shown after clicking Start) -->
<div id="pricingGate" class="guidance pricing" style="display:none">
  <h3 style="margin:0 0 6px">Choose how to unlock</h3>
  <p class="small muted" style="margin:0 0 12px">
    Pay per ProofPack. No subscriptions. Bundles are for repeated use across multiple companies/clients.
  </p>

  <div class="grid cols3" role="list" style="margin-top:10px">
    <!-- One-off -->
    <article class="plan" role="listitem" aria-label="One-off ProofPack">
      <h3>One-off ProofPack</h3>
      <div class="price">$29</div>
      <p class="muted">Single ProofPack for one company submission or one client request.</p>
      <ul class="muted">
        <li>1 ProofPack credit</li>
        <li>Guided tagging + ProofPack output</li>
        <li>No subscription</li>
      </ul>
      <button type="button" class="btn primary" data-unlock-plan="OneOff">Continue</button>
      <div class="small">Checkout flow coming next.</div>
    </article>

    <!-- Bundle 25 -->
    <article class="plan" role="listitem" aria-label="ProofPack bundle 25">
      <h3>ProofPack Bundle ‚Äî 25</h3>
      <div class="price">$199</div>
      <p class="muted">Great for repeat evidence requests across multiple engagements.</p>
      <ul class="muted">
        <li>25 ProofPack credits</li>
        <li>Designed for repeat workflows</li>
        <li>No subscription</li>
      </ul>
      <a class="btn primary" href="mailto:ops@proofrepo.com?subject=ProofPack%20Bundle%2025">Buy pack</a>
    </article>

    <!-- Bundle 50 -->
    <article class="plan" role="listitem" aria-label="ProofPack bundle 50">
      <h3>ProofPack Bundle ‚Äî 50</h3>
      <div class="price">$349</div>
      <p class="muted">Most common fit for seasonal waves and ongoing evidence requests.</p>
      <ul class="muted">
        <li>50 ProofPack credits</li>
        <li>Use across multiple clients</li>
        <li>No subscription</li>
      </ul>
      <a class="btn primary" href="mailto:ops@proofrepo.com?subject=ProofPack%20Bundle%2050">Buy pack</a>
    </article>

    <!-- Bundle 75 -->
    <article class="plan" role="listitem" aria-label="ProofPack bundle 75">
      <h3>ProofPack Bundle ‚Äî 75</h3>
      <div class="price">$499</div>
      <p class="muted">Designed for higher-volume workflows across many clients.</p>
      <ul class="muted">
        <li>75 ProofPack credits</li>
        <li>Repeat workflows</li>
        <li>No subscription</li>
      </ul>
      <a class="btn primary" href="mailto:ops@proofrepo.com?subject=ProofPack%20Bundle%2075">Buy pack</a>
    </article>
  </div>

  <div style="margin-top:12px">
    <strong class="muted">Have an auditor / reviewer code? (Use this instead of buying)</strong>
    <div class="form-row two" style="margin-top:8px">
      <div>
        <input id="unlockCode" placeholder="Enter code (if you have one)" />
      </div>
      <div>
        <button type="button" class="btn primary" id="applyUnlockCodeBtn">Apply code</button>
      </div>
    </div>
    <div class="hint" id="unlockHint"></div>
  </div>
</div>
<!-- /INLINE PRICING GATE -->


      <div id="status" class="status" style="display:none"></div>

      <div class="wiz-actions step-after-role" id="actionsRow" style="display:none;gap:10px;justify-content:flex-end">
  <button id="startBtn" class="btn primary" type="button">
    Start guided ProofPack
  </button>

  <!-- Auditor-only, shown AFTER unlock -->
  <button id="sendReqBtn" class="btn primary" type="button" style="display:none">
    Send request to client
  </button>

  <!-- Normal upload submit (client/company & client-from-link) -->
  <button id="submitBtn" class="btn primary" type="submit" style="display:none">
    Send and build ProofPack
  </button>
</div>

    </form>
  </section>

<!-- PRICING (hidden until role selected) -->
<section id="pricing" class="wrap section pricing" aria-labelledby="pricing-h" style="display:none">
  <h2 id="pricing-h">Pricing</h2>
  <p class="small muted">
    Pay per ProofPack. No subscriptions. Purchase bundles for use across multiple companies, clients, or internal evidence requests.
  </p>

  <div class="grid cols3" role="list">
    <!-- One-off -->
    <article class="plan" role="listitem" aria-label="One-off ProofPack">
      <h3>One-off ProofPack</h3>
      <div class="price">$29</div>
      <p class="muted">For a single ProofPack‚Äîeither to request evidence from a company or to generate one directly.</p>
      <ul class="muted">
        <li>1 ProofPack credit</li>
        <li>Guided SOC 2 tagging</li>
        <li>Reusable ProofPack output</li>
      </ul>
      <a class="btn primary" href="mailto:ops@proofrepo.com?subject=One-off%20ProofPack">Buy pack</a>
      <div class="small">Checkout flow coming next.</div>
    </article>

    <!-- Bundle 25 -->
    <article class="plan popular" role="listitem" aria-label="ProofPack bundle 25">
      <h3>ProofPack Bundle ‚Äî 25</h3>
      <div class="price">$199</div>
      <p class="muted">Best for pilots and smaller teams running evidence requests across multiple engagements.</p>
      <ul class="muted">
        <li>25 ProofPack credits</li>
        <li>Designed for repeat client workflows</li>
        <li>No subscription required</li>
      </ul>
      <a class="btn primary" href="mailto:ops@proofrepo.com?subject=ProofPack%20Bundle%2025">Buy pack</a>
      <div class="small">Checkout flow coming next.</div>
    </article>

    <!-- Bundle 50 -->
    <article class="plan" role="listitem" aria-label="ProofPack bundle 50">
      <h3>ProofPack Bundle ‚Äî 50</h3>
      <div class="price">$349</div>
      <p class="muted">Most common fit for teams who want a clean, repeatable evidence collection motion.</p>
      <ul class="muted">
        <li>50 ProofPack credits</li>
        <li>Great for seasonal audit waves</li>
        <li>No subscription required</li>
      </ul>
      <a class="btn primary" href="mailto:ops@proofrepo.com?subject=ProofPack%20Bundle%2050">Buy pack</a>
    </article>

    <!-- Bundle 75 -->
    <article class="plan" role="listitem" aria-label="ProofPack bundle 75">
      <h3>ProofPack Bundle ‚Äî 75</h3>
      <div class="price">$499</div>
      <p class="muted">Designed for higher-volume workflows across many clients or recurring vendor reviews.</p>
      <ul class="muted">
        <li>75 ProofPack credits</li>
        <li>Built for repeat workflows</li>
        <li>No subscription required</li>
      </ul>
      <a class="btn primary" href="mailto:ops@proofrepo.com?subject=ProofPack%20Bundle%2075">Buy pack</a>
    </article>
  </div>

  <div class="card" style="margin-top:18px">
    <strong class="muted">How it works:</strong>
    <div class="muted" style="margin-top:8px">
      Use a ProofPack credit to request evidence or generate a ProofPack. Bundles are for repeated use across multiple engagements.
    </div>
  </div>
</section>


<!-- TRUST -->
<section id="trust" class="wrap section" aria-labelledby="trust-h">
  <h2 id="trust-h">Trust, privacy, and retention</h2>

  <div class="grid cols2">
    <div class="card">
      <h3>Private by default</h3>
      <p class="muted">
        ProofPacks are shared via secure, unguessable links. No public indexing.
      </p>
      <p class="small">
        Only people you share the link with can access the ProofPack.
      </p>
    </div>

    <div class="card">
      <h3>Storage + retention</h3>
      <p class="muted">
        Files are stored in Cloudflare R2 and automatically deleted after a short retention window.
      </p>
      <p class="small">
        If you need different retention, email <a class="btn link" href="mailto:ops@proofrepo.com">ops@proofrepo.com</a>.
      </p>
    </div>
  </div>

  <div class="card" style="margin-top:18px">
    <h3>We don‚Äôt ‚Äúread your evidence‚Äù</h3>
    <p class="muted">
      The guided tagging uses filenames + your selections to organize what each file proves.
      Reviewers use the ProofPack viewer to evaluate evidence in context.
    </p>
    <p class="small">
      You control what you upload and who receives the ProofPack link.
    </p>
  </div>
</section>
  
    <!-- FOR COMPANIES -->
  <section id="companies" class="wrap section" aria-labelledby="companies-h">
    <h2 id="companies-h">For companies</h2>

    <div class="grid cols2">
      <div class="card">
        <h3>Get audit- and review-ready</h3>
        <p class="muted">
          Upload evidence once and keep a clean ProofPack you can reuse with auditors, customers, investors, and partners.
        </p>
      </div>

      <div class="card">
        <h3>Reduce ‚Äúplease resend‚Äù loops</h3>
        <p class="muted">
          Guided prompts + required SOC 2 tagging helps prevent wrong exports, wrong date ranges, and missing artifacts.
        </p>
      </div>
    </div>
  </section>

  <!-- HOW IT WORKS -->
  <section id="how" class="wrap section">
    <h2>How ProofRepo works (today)</h2>
    <div class="grid cols3">
      <div class="card">
        <h3>1) Share or open the link</h3>
        <p class="muted">
          An auditor, third party, or company goes to <strong>proofrepo.com</strong>.
          Auditors can share the link plus a short code so uploads are routed and tracked to the right engagement.
        </p>
      </div>
      <div class="card">
        <h3>2) Guided upload</h3>
        <p class="muted">
          The form nudges uploaders toward the expected artifacts for the frameworks selected.
          No shared drives, no random screenshots in Slack.
        </p>
      </div>
      <div class="card">
        <h3>3) ProofPack for reviewers</h3>
        <p class="muted">
          ProofRepo generates a structured manifest and a human-friendly viewer that groups files by what they
          prove and flags missing items. You can keep using your own workpapers ‚Äî just link to the pack.
        </p>
      </div>
    </div>
  </section>

  <!-- FOOTER -->
  <footer class="wrap">
    <div class="row" style="margin-bottom:8px">
      <div>
        ¬© <span id="y"></span> ProofRepo ‚Ä¢
        <a class="btn link" href="mailto:ops@proofrepo.com" data-analytics="cta_mail_footer">ops@proofrepo.com</a>
      </div>
      <div class="tag">Based in Jacksonville, Florida</div>
    </div>
    <div class="small">
      Disclaimer: ProofRepo prepares materials to assist with audits and vendor reviews; it is not a certification or attestation body.
    </div>
  </footer>

  <script>
    // IMPORTANT: stays pointed at your existing Intake Worker.
    const WORKER_BASE = 'https://proofrepo-intake.atucker5.workers.dev';


    const FRAMEWORK_CONFIG = {
      SOC2: {
        label: 'SOC 2',
        key: 'SOC2',
        items: [
          { id: 'AccessReview', label: 'Access review', mapKey: 'AccessReview', patterns: [/access/i, /user.*review/i] },
          { id: 'ChangeLog',    label: 'Change log',    mapKey: 'ChangeLog',    patterns: [/change/i, /deploy|release/i] },
          { id: 'Vendors',      label: 'Vendor list',   mapKey: 'Vendors',      patterns: [/vendor|supplier|third[-_ ]party/i] }
        ]
      },
      ISO27001: {
        label: 'ISO 27001',
        key: 'ISO27001',
        items: [
          { id: 'AssetRegister', label: 'Asset inventory / register', patterns: [/asset/i, /inventory/i] },
          { id: 'RiskRegister',  label: 'Risk register',              patterns: [/risk/i] },
          { id: 'SoA',           label: 'Statement of Applicability (SoA)', patterns: [/soa/i, /statement.*applicability/i] }
        ]
      },
      HIPAA: {
        label: 'HIPAA',
        key: 'HIPAA',
        items: [
          { id: 'BAAList',   label: 'Business Associate Agreements (BAAs)', patterns: [/baa/i, /business.*associate/i] },
          { id: 'PHIAccess', label: 'PHI access log',                       patterns: [/phi/i, /access.*log/i] }
        ]
      },
      GDPR: {
        label: 'GDPR',
        key: 'GDPR',
        items: [
          { id: 'RoPA', label: 'Record of Processing Activities (RoPA)', patterns: [/ropa/i, /processing.*activities/i] },
          { id: 'DPA',  label: 'Data processing agreements',            patterns: [/dpa/i, /processing.*agreement/i] }
        ]
      },
      'NIST CSF': {
        label: 'NIST CSF',
        key: 'NIST CSF',
        items: [
          { id: 'Policies',       label: 'Core security policies', patterns: [/policy/i] },
          { id: 'RiskAssessment', label: 'Risk assessment',        patterns: [/risk.*assessment/i] }
        ]
      }
    };

const $ = s => document.querySelector(s);
    
// ===== PATCH UTILS (escape + safeUrl) =====
const esc = (s = '') =>
  String(s)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');

const safeUrl = (u) => {
  try {
    const url = new URL(String(u), window.location.href);
    if (url.protocol !== 'https:' && url.protocol !== 'http:') return '';
    return url.toString();
  } catch {
    return '';
  }
};    
// ===== /PATCH UTILS =====

// Try hard to pull a request token from the URL, in multiple shapes.
function getRequestTokenFromUrl() {
  try {
    const url = new URL(window.location.href);

    // 1) Look in normal query params under a few possible names
    const params = url.searchParams;
    const names = ['t', 'token', 'requestToken', 'request', 'r', 'prev']; // <-- added prev
    for (const name of names) {
      const v = params.get(name);
      if (v) return v;
    }

    // 2) Look in the hash (e.g. #t=..., #token=...)
    const hash = url.hash || '';
    const hashMatch = hash.match(/(?:t|token|requestToken|request|r|prev)=([^&]+)/i); // <-- added prev
    if (hashMatch) return decodeURIComponent(hashMatch[1]);

    // 3) Look in the path (e.g. /r/ABC123, /request/ABC123)
    const pathMatch = url.pathname.match(/\/(?:r|t|request|prev)\/([^/]+)/i); // <-- added prev
    if (pathMatch) return pathMatch[1];
  } catch (e) {
    console.warn('Token parse error:', e);
  }
  return null;
}


    
    const statusEl = $('#status');
    const submitBtn = $('#submitBtn');
   
    const startBtn   = document.getElementById('startBtn');
    const sendReqBtn = document.getElementById('sendReqBtn');

    const roleSelect = $('#role');
    const emailLabel = $('#emailLabel');
    const companyLabel = $('#companyLabel');
    const roleHint = $('#roleHint');

    const auditorCodeCol = $('#auditorCodeCol');
    const auditorEmailCol = $('#auditorEmailCol');
    const clientEmailCol = $('#clientEmailCol');

    const auditorEmailHint = $('#auditorEmailHint');
    const clientEmailHint = $('#clientEmailHint');

    const billingHint = $('#billingHint');
    const billingSelect = $('#billingMode');

    const optionalDetails = $('#optionalRow');
    const planBillingRow = $('#planBillingRow');

    const frameworksSelectEl = $('#frameworks');
    const frameworkGuides = $('#frameworkGuides');

    const laterRows = document.querySelectorAll('.step-after-role');
    const pricingSection = document.getElementById('pricing');

    // ===== STEP 1 FIX: define file DOM refs BEFORE any use =====
const fileInput = document.getElementById('files');     // <input type="file" id="files">
const fileBox   = document.getElementById('filesRow');  // <div id="filesRow"> ... </div>
const fileMeta  = document.getElementById('fileMeta');  // <div id="fileMeta"> ... </div>
// ===== /STEP 1 FIX =====


    // ===== PRICING GATE (inline) =====
const pricingGate = document.getElementById('pricingGate');
const unlockCodeEl = document.getElementById('unlockCode');
const applyUnlockCodeBtn = document.getElementById('applyUnlockCodeBtn');
const unlockHint = document.getElementById('unlockHint');

// Remember a code that successfully passed /check-code
let appliedCode = null;
const CODE_STORAGE_KEY = 'proofrepo_applied_code';


let isUnlocked = false;
let isFromRequestLink = false;        // NEW
let hasFrameworkOverride = false;     // NEW
let hasCompanyOverride   = false;     // NEW
let hasAuditorOverride   = false;     // NEW

if (fileInput) fileInput.disabled = true;

/* =======================
   STEP 2: DROP-IN HELPERS
   (easy to find + replace)
   ======================= */

async function submitAuditorRequest() {
  const auditorEmail = (document.getElementById('email')?.value || '').trim();
  const clientEmail  = (document.getElementById('clientContactEmail')?.value || '').trim();
  const company      = (document.getElementById('company')?.value || '').trim();

  const frameworks = Array.from(document.getElementById('frameworks')?.selectedOptions || [])
    .map(o => o.value)
    .filter(Boolean);

  // minimal validation (keep it blunt)
  const looksLikeEmail = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(auditorEmail);
  const looksLikeEmail2 = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(clientEmail);
  if (!looksLikeEmail) throw new Error('Enter a valid auditor email.');
  if (!looksLikeEmail2) throw new Error('Enter a valid client email.');
  if (!company) throw new Error('Enter the client company (required).');
  if (!frameworks.length) throw new Error('Select at least one framework.');

  // Build deadlineISO from "days from now" + local time
  const days = parseInt((document.getElementById('deadlineDays')?.value || '5'), 10);
  const timeStr = (document.getElementById('deadlineTimeLocal')?.value || '17:00').trim(); // HH:MM
  const [hh, mm] = timeStr.split(':').map(x => parseInt(x, 10));

  const d = new Date();
  d.setDate(d.getDate() + (Number.isFinite(days) ? days : 5));
  d.setHours(Number.isFinite(hh) ? hh : 17, Number.isFinite(mm) ? mm : 0, 0, 0);

  const deadlineISO = d.toISOString();

  const payload = {
    auditorEmail,
    clientEmail,
    company,
    frameworks,
    deadlineISO
  };


  // üîπ NEW: attach the applied bundle code so /request can store it
  if (appliedCode) {
    payload.auditorCode = appliedCode;
  }

  const res = await fetch(`${WORKER_BASE}/request`, {
    method: 'POST',
    headers: { 'content-type': 'application/json' },
    body: JSON.stringify(payload),
  });

  const j = await res.json().catch(() => null);
  if (!res.ok || !j?.ok) throw new Error(j?.error || `Request failed (${res.status})`);
  return j; // { ok, token, magicLink, emailedClient }
}


    
// Single source of truth for "locked" UI state
function resetUnlockState(opts = { clearFiles: true }) {
  isUnlocked = false;
  appliedCode = null; 

  // Hide gate + swap buttons
  if (pricingGate) pricingGate.style.display = 'none';
  if (startBtn) startBtn.style.display = 'inline-flex';
  if (submitBtn) submitBtn.style.display = 'none';
  if (sendReqBtn) sendReqBtn.style.display = 'none';

  // Clear unlock UI
if (unlockCodeEl) unlockCodeEl.value = '';
if (unlockHint) unlockHint.textContent = '';


  // Lock uploads and optionally clear files
  if (fileInput) {
    fileInput.disabled = true;
    if (opts.clearFiles) fileInput.value = '';
  }

  // IMPORTANT: hide the entire upload artifacts box while locked
  // (so it‚Äôs not just disabled ‚Äî it disappears until unlocked)
  if (fileBox) fileBox.style.display = 'none';
  if (fileMeta) fileMeta.textContent = 'Unlock guided ProofPack to proceed with uploads.';

  // Hide anything that should not show while locked
  if (frameworkGuides) {
    frameworkGuides.style.display = 'none';
    frameworkGuides.innerHTML = '';
  }
  if (optionalDetails) {
    optionalDetails.style.display = 'none';
    optionalDetails.open = false;
  }
  if (planBillingRow) planBillingRow.style.display = 'none';

  // Refresh any lock messaging
  if (typeof updateFileMeta === 'function') updateFileMeta();
}

function requireRoleOrExplain() {
  const role = roleSelect?.value || '';
  if (!role) {
    showStatus('Please choose a role first.', false);
    return false;
  }
  return true;
}

/* =======================
   END STEP 2 HELPERS
   ======================= */

    
function openPricingGate() {
  if (pricingGate) pricingGate.style.display = 'block';
  if (unlockHint) unlockHint.textContent = '';
  if (pricingGate) pricingGate.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

async function autoUnlockFromStoredCodeIfPossible() {
  // Only helpful for auditor resend links
  const role = (roleSelect?.value || '').trim();
  if (role !== 'auditor') return;

  let stored = null;
  try { stored = (localStorage.getItem(CODE_STORAGE_KEY) || '').trim(); } catch {}
  if (!stored) return;

  // If already unlocked, do nothing
  if (isUnlocked) return;

  // Fill the UI field for visibility
  if (unlockCodeEl) unlockCodeEl.value = stored;

  // Attempt to validate + unlock automatically
  try {
    const res = await fetch(
      `${WORKER_BASE}/check-code?code=${encodeURIComponent(stored)}`,
      { method: 'GET', headers: { accept: 'application/json' } }
    );
    const j = await res.json().catch(() => null);
    if (!res.ok || !j || j.ok === false) return;

    appliedCode = j.code || stored;
    setUnlocked('Code');
  } catch {
    // Silent: if this fails, auditor can still manually press Start + Apply code
  }
}

    
function setUnlocked(planLabel) {
  isUnlocked = true;

  const role = (roleSelect?.value || '').trim();

  // Optional: store chosen plan label in existing hidden plan selector
  const planEl = document.getElementById('plan');
  if (planEl && planLabel) planEl.value = planLabel;

  // Close the pricing gate, hide the start button
  if (pricingGate) pricingGate.style.display = 'none';
  if (startBtn) startBtn.style.display = 'none';

  if (role === 'auditor') {
    // AUDITOR FLOW: no uploads here, just send client request
    if (fileInput) {
      fileInput.disabled = true;
      fileInput.value = '';
    }
    if (fileBox) fileBox.style.display = 'none';

    if (sendReqBtn) sendReqBtn.style.display = 'inline-flex';
    if (submitBtn) submitBtn.style.display = 'none';

    // No need to render upload guidance for auditors
    if (frameworkGuides) {
      frameworkGuides.style.display = 'none';
      frameworkGuides.innerHTML = '';
    }
  } else {
    // CLIENT / COMPANY FLOW: normal uploads
    if (fileInput) fileInput.disabled = false;
    if (fileBox) fileBox.style.display = 'block';

    if (submitBtn) submitBtn.style.display = 'inline-flex';
    if (sendReqBtn) sendReqBtn.style.display = 'none';

    // Now allow guidance + file meta to render
    updateFileMeta();
    renderFrameworkGuides();
  }
}

/* =======================
   STEP 3: START BTN HANDLER
   ======================= */
if (startBtn) {
  startBtn.addEventListener('click', () => {
    clearStatus();
    if (!requireRoleOrExplain()) return;

    // For ALL roles, first open pricing / code gate.
    // After unlock, auditors will see "Send request to client",
    // others will see the normal upload submit button.
    openPricingGate();
  });
}
/* =======================
   END STEP 3
   ======================= */

// AUDITOR-ONLY: after unlock, actually send the client request
if (sendReqBtn) {
  sendReqBtn.addEventListener('click', async () => {
    clearStatus();

    const role = (roleSelect?.value || '').trim();
    if (role !== 'auditor') {
      // Safety: this button is only meaningful for auditors
      return;
    }

    sendReqBtn.disabled = true;
    const prev = sendReqBtn.textContent;
    sendReqBtn.textContent = 'Sending request‚Ä¶';

    try {
      if (!appliedCode) {
        throw new Error('Enter and apply your auditor bundle code first (Stripe isn‚Äôt live yet).');
      }
      
      const j = await submitAuditorRequest();

      const emailed = j?.emailedClient ? 'Yes' : 'No (email config issue)';

      // Backend currently returns j.magicLink; we just label it clearly
      const link =
        safeUrl(j?.clientUploadLink || j?.magicLink) ||
        j?.clientUploadLink ||
        j?.magicLink ||
        '';

      showStatus(
        `‚úÖ Client upload request created.<br>
         <strong>Client emailed:</strong> ${esc(emailed)}<br><br>
         <strong>Client upload link (copy):</strong><br>
         <a href="${esc(link)}" target="_blank" rel="noopener noreferrer">${esc(link)}</a>`,
        true
      );
    } catch (e) {
      showStatus(esc(e?.message || e), false);
    } finally {
      sendReqBtn.disabled = false;
      sendReqBtn.textContent = prev;
    }
  });
}
    
// Click one-off "Continue" => Stripe NOT live yet.
// For now, force "code-only" unlock (except request-token links which auto-unlock).
if (pricingGate) {
  pricingGate.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-unlock-plan]');
    if (!btn) return;

    clearStatus();

    // If they‚Äôre on a request link, ignore OneOff purchase entirely (token unlock path)
    if (isFromRequestLink) return;

    // If they already applied a code, unlock immediately
    if (appliedCode) {
      setUnlocked('Code');
      return;
    }

    // Otherwise: show a clear message
    showStatus(
      'Checkout is not live yet. Please enter an auditor/reviewer code below and click ‚ÄúApply code‚Äù. ' +
      'If you don‚Äôt have one, email <a href="mailto:ops@proofrepo.com">ops@proofrepo.com</a>.',
      false
    );
  });
}



// Apply code => validate against Worker, then unlock + remember code
if (applyUnlockCodeBtn) {
  applyUnlockCodeBtn.addEventListener('click', async () => {
    clearStatus?.();

    const raw = (unlockCodeEl?.value || '').trim();
    const code = raw.toUpperCase();

    if (!code) {
      if (unlockHint) unlockHint.textContent = 'Enter a code.';
      return;
    }

    let j;
    try {
      const res = await fetch(
        `${WORKER_BASE}/check-code?code=${encodeURIComponent(code)}`,
        { method: 'GET', headers: { accept: 'application/json' } }
      );

      j = await res.json().catch(() => null);

      if (!res.ok || !j || j.ok === false) {
        const msg = (j && j.error) ? j.error : 'Code is not valid.';
        throw new Error(msg);
      }
    } catch (e) {
      appliedCode = null;
      if (unlockHint) unlockHint.textContent = e.message || 'Code is not valid.';
      return;
    }

    // Store accepted code so gather() can send it as auditorCode
    appliedCode = j.code || code;
    try { localStorage.setItem(CODE_STORAGE_KEY, appliedCode); } catch {}


    if (unlockHint) {
      const rem = (typeof j.remaining === 'number') ? j.remaining : '?';
      const bundle = (typeof j.bundleSize === 'number') ? j.bundleSize : null;
      const tail = bundle != null ? ` ${rem} of ${bundle}` : ` ${rem}`;
      unlockHint.textContent = `Code accepted.${tail ? ` Remaining credits:${tail}.` : ''}`;
    }

    // Unlock main flow using "Code" as the plan label
    setUnlocked('Code');
  });
}


    // frameworkSelections[frameworkKey][itemId] = filename
    const frameworkSelections = {};
    // ===== PATCH: always have SOC2 map ready =====
frameworkSelections.SOC2 = frameworkSelections.SOC2 || {};
// Pre-seed SOC2 required keys so validation is deterministic
for (const item of (FRAMEWORK_CONFIG.SOC2?.items || [])) {
  if (!(item.id in frameworkSelections.SOC2)) frameworkSelections.SOC2[item.id] = '';
}
// ===== /PATCH =====

    document.getElementById('y').textContent = new Date().getFullYear();

function showStatus(msg, ok=false){
  statusEl.style.display = 'block';
  statusEl.className = 'status ' + (ok ? 'ok' : 'err');
  statusEl.innerHTML = msg;
}
function clearStatus(){
  statusEl.style.display = 'none';
  statusEl.innerHTML = '';
}

async function maybeUnlockFromStripeReturn() {
  const url = new URL(window.location.href);
  const sessionId = url.searchParams.get('session_id');
  if (!sessionId) return;

  const res = await fetch(`${WORKER_BASE}/verify-checkout-session`, {
    method: 'POST',
    headers: { 'content-type': 'application/json' },
    body: JSON.stringify({ sessionId }),
  });
  const j = await res.json().catch(() => null);
  if (!res.ok || !j?.ok) return;

  // Unlock based on Stripe-confirmed purchase
  setUnlocked(j.planLabel || 'OneOff');

  // Clean URL (remove ?session_id=...)
  url.searchParams.delete('session_id');
  window.history.replaceState({}, '', url.toString());
}


// Ensure SOC2 is selected by default (even if the <select multiple> started hidden)
if (frameworksSelectEl && frameworksSelectEl.selectedOptions.length === 0) {
  const soc2Opt = Array.from(frameworksSelectEl.options).find(o => o.value === 'SOC2');
  if (soc2Opt) soc2Opt.selected = true;
}


// Keep Optional Details hidden until files are added (pre-GTM simpler flow)
if (optionalDetails) {
  optionalDetails.style.display = 'none';
  optionalDetails.open = false;
}

    function getSelectedFrameworkKeys() {
      const fs = Array.from(frameworksSelectEl?.selectedOptions || []).map(o => o.value);
      return fs;
    }

    function updateItemStatusSpan(span, label, selectedName) {
      if (!span) return;
      if (selectedName) {
        span.textContent = '‚úî ' + label + ' ‚Äî tagged as ' + selectedName;
        span.className = 'ok';
      } else {
        span.textContent = label + ' ‚Äî not tagged yet';
        span.className = 'missing';
      }
    }

    function renderFrameworkGuides() {
  if (!frameworkGuides) return;

  // Don‚Äôt show guidance until user unlocks (prevents ‚Äúfree checklist‚Äù use)
  if (!isUnlocked) {
    frameworkGuides.style.display = 'none';
    frameworkGuides.innerHTML = '';
    return;
  }

  const selectedKeys = getSelectedFrameworkKeys().filter(k => FRAMEWORK_CONFIG[k]);
  const files = Array.from(fileInput?.files || []);


  // Hide until at least one framework is selected
  // (we now allow showing the checklist even before files are uploaded)
  if (!selectedKeys.length) {
    frameworkGuides.style.display = 'none';
    frameworkGuides.innerHTML = '';
    return;
  }



      frameworkGuides.style.display = '';
      frameworkGuides.innerHTML = '';

      selectedKeys.forEach(fwKey => {
        const cfg = FRAMEWORK_CONFIG[fwKey];
        if (!cfg) return;
        const block = document.createElement('div');
        block.style.marginBottom = '12px';

        const h4 = document.createElement('h4');
        h4.textContent = (fwKey === 'SOC2')
  ? (cfg.label + ' ‚Äî required items (needed to build your ProofPack)')
  : (cfg.label + ' ‚Äî recommended minimum evidence');
        block.appendChild(h4);

        const ul = document.createElement('ul');

        cfg.items.forEach(item => {
          if (!frameworkSelections[fwKey]) frameworkSelections[fwKey] = {};

          const li = document.createElement('li');

          const statusSpan = document.createElement('span');
          statusSpan.id = `fw-${fwKey}-${item.id}-status`;
          statusSpan.className = 'missing';
          statusSpan.textContent = item.label + ' ‚Äî not tagged yet';
          li.appendChild(statusSpan);

          const div = document.createElement('div');
          const label = document.createElement('label');
          label.className = 'small';
          label.htmlFor = `fw-${fwKey}-${item.id}-select`;
          label.textContent = `Which file is your ${item.label.toLowerCase()}?`;
          div.appendChild(label);

          const select = document.createElement('select');
          select.id = `fw-${fwKey}-${item.id}-select`;
          select.dataset.framework = fwKey;
          select.dataset.item = item.id;

          const noneOpt = document.createElement('option');
          noneOpt.value = '';
          noneOpt.textContent = 'Not set / not sure yet';
          select.appendChild(noneOpt);

          files.forEach(f => {
            const opt = document.createElement('option');
            opt.value = f.name;
            opt.textContent = f.name;
            select.appendChild(opt);
          });

          // restore or auto-guess
          const prev = frameworkSelections[fwKey][item.id] || '';
          let selectedName = prev && files.some(f => f.name === prev) ? prev : '';

          if (!selectedName && files.length && item.patterns && item.patterns.length) {
            const guess = files.find(f => item.patterns.some(re => re.test(f.name || '')));
            if (guess) selectedName = guess.name;
          }

          select.value = selectedName;
          frameworkSelections[fwKey][item.id] = selectedName;
          updateItemStatusSpan(statusSpan, item.label, selectedName);

          select.addEventListener('change', () => {
            const fw = select.dataset.framework;
            const it = select.dataset.item;
            if (!frameworkSelections[fw]) frameworkSelections[fw] = {};
            frameworkSelections[fw][it] = select.value;
            updateItemStatusSpan(statusSpan, item.label, select.value);
          });

          div.appendChild(select);
          li.appendChild(div);
          ul.appendChild(li);
        });

        block.appendChild(ul);
        frameworkGuides.appendChild(block);
      });

      const info = document.createElement('div');
      info.className = 'small';
      info.textContent = 'We auto-suggest based on filenames. If something is named weirdly, just pick it so we treat it as the right artifact.';
      frameworkGuides.appendChild(info);
    }

// File handling & drag/drop
function updateFileMeta() {
  const files = Array.from(fileInput?.files || []);

  // Don‚Äôt show file stats or optional plan/billing until unlocked
  if (!isUnlocked) {
    if (fileMeta) fileMeta.textContent = 'Unlock guided ProofPack to proceed with uploads.';
    if (planBillingRow) planBillingRow.style.display = 'none';
    if (optionalDetails) {
      optionalDetails.style.display = 'none';
      optionalDetails.open = false;
    }
    return;
  }

  if (!files.length) {
    if (fileMeta) fileMeta.textContent = 'No files selected.';
    if (planBillingRow) planBillingRow.style.display = 'none';

    // Hide optional details until files exist
    if (optionalDetails) {
      optionalDetails.style.display = 'none';
      optionalDetails.open = false;
    }

    renderFrameworkGuides();
    return;
  }

  const total = files.reduce((n, f) => n + (f.size || 0), 0);
  const totalMB = (total / 1024 / 1024).toFixed(2);

  if (fileMeta) fileMeta.textContent = `${files.length} file(s), ${totalMB} MB total`;

  if (planBillingRow) planBillingRow.style.display = '';

  // Show optional details once files exist, but keep it collapsed
  if (optionalDetails) {
    optionalDetails.style.display = '';
    optionalDetails.open = false;
  }

  renderFrameworkGuides();
}


    function handleFilesList(list) {
  if (!list || !list.length) return;

  try {
    if (window.DataTransfer) {
      const dt = new DataTransfer();
      Array.from(list).forEach(f => dt.items.add(f));
      fileInput.files = dt.files;
    }
  } catch (_) {
    // Some browsers (older Safari/iOS) don't allow programmatic file assignment.
    // We'll still update UI and let native input behavior handle selection.
  }

  updateFileMeta();
}

    if (fileInput) {
      fileInput.addEventListener('change', () => handleFilesList(fileInput.files));
    }

    if (fileBox) {
      ['dragenter','dragover'].forEach(evt => {
        fileBox.addEventListener(evt, e => {
          e.preventDefault();
          e.stopPropagation();
          fileBox.classList.add('dragover');
        });
      });
      ['dragleave','dragend'].forEach(evt => {
        fileBox.addEventListener(evt, e => {
          e.preventDefault();
          e.stopPropagation();
          fileBox.classList.remove('dragover');
        });
      });
      fileBox.addEventListener('drop', e => {
        e.preventDefault();
        e.stopPropagation();
        fileBox.classList.remove('dragover');
        if (e.dataTransfer && e.dataTransfer.files) {
          handleFilesList(e.dataTransfer.files);
        }
      });
    }

function updateBillingUI() {
  if (!billingSelect || !billingHint) return;

  const billing = billingSelect.value;

  if (!billing) {
    billingHint.textContent =
      'You can decide this later. In beta we mostly use codes or manual billing via ops@proofrepo.com.';
  } else if (billing === 'code') {
    billingHint.textContent =
      'If you have a code, you‚Äôll enter it during the unlock step (right before upload).';
  } else if (billing === 'card') {
    billingHint.textContent =
      'Card payment via Stripe will live here. For now this is a placeholder ‚Äî use codes or email ops@proofrepo.com.';
  }

  // Routing-row code input is NEVER shown.
  // Codes are entered ONLY in the inline pay/unlock gate.
  if (auditorCodeCol) auditorCodeCol.style.display = 'none';
}

// ===== DROP-IN REPLACEMENT: updateRoleUI (auditor flow + unlock-safe) =====
function updateRoleUI() {
  const role = (roleSelect?.value || '').trim();
  // Codes are entered ONLY at unlock time (pricing gate)
if (auditorCodeCol) auditorCodeCol.style.display = 'none';


  // --- field refs we will toggle (no markup changes required) ---
  const contactRow = document.getElementById('contactRow');
  const companyInput = document.getElementById('company');
  const companyLabelEl = document.getElementById('companyLabel');

  // Routing row bits
  const clientEmailInput = document.getElementById('clientEmail');
  const clientEmailLabelEl = document.querySelector('label[for="clientEmail"]');
  const auditorCodeInput = document.getElementById('auditorCode');

  // Contact-row swap: company vs client contact
  const companyColEl = document.getElementById('companyCol');
  const clientContactColEl = document.getElementById('clientContactCol');
  const clientContactEmailInput = document.getElementById('clientContactEmail');
  // --- /refs ---

  // Email placeholder + hint helper
  const emailHintEl = document.getElementById('emailHint');
  const emailInput = document.getElementById('email');
  if (emailHintEl && emailInput) {
    if (role === 'auditor') {
      emailInput.placeholder = 'you@auditfirm.com';
      emailHintEl.textContent = 'Use your auditor / reviewer email here.';
    } else {
      emailInput.placeholder = 'you@company.com';
      emailHintEl.textContent = '';
    }
  }

  // Always hide the big pricing section (you‚Äôre using inline gate)
  if (pricingSection) pricingSection.style.display = 'none';

  // If role is not selected: hide everything and reset
  if (!role) {
    laterRows.forEach(r => (r.style.display = 'none'));

    const routingRow0 = document.getElementById('routingRow');
    if (routingRow0) routingRow0.style.display = 'none';

    if (roleHint) roleHint.textContent = "Start by telling us which side of the audit you're on.";

    if (contactRow) contactRow.style.display = 'none';

    // Reset contact sub-columns
    if (clientContactColEl) clientContactColEl.style.display = 'none';
    if (companyColEl) companyColEl.style.display = 'block';

    resetUnlockState({ clearFiles: true });
    return;
  }

  // Role IS selected: reset lock state (prevents cross-role leakage)
  resetUnlockState({ clearFiles: true });

  // Set CTA wording by role
  if (startBtn) {
    startBtn.textContent =
      (role === 'auditor')
        ? 'Request guided evidence collection from client'
        : 'Start guided ProofPack';
  }

  // Show the post-role rows, BUT keep locked-only sections hidden until unlocked/files
  laterRows.forEach(r => {
    if (r.id === 'actionsRow') {
      r.style.display = 'flex';
      return;
    }
    // Keep these hidden until unlock + (optionally) files exist
    if (r.id === 'filesRow' || r.id === 'frameworkGuides' || r.id === 'optionalRow') {
      r.style.display = 'none';
      return;
    }
    r.style.display = 'block';
  });

  // Routing row special-case: hide for company
  const routingRow = document.getElementById('routingRow');
  if (routingRow) routingRow.style.display = (role === 'company') ? 'none' : 'block';

  // Contact row shown
  if (contactRow) contactRow.style.display = 'grid';

  // ---------------------------------------------------------------

  // Role-specific copy + which fields show
  if (role === 'auditor') {
  emailLabel.textContent = 'Auditor / third-party email';

  // Auditor needs BOTH: client contact email + client company (worker requires company)
  if (clientContactColEl) clientContactColEl.style.display = 'block';
  if (companyColEl) companyColEl.style.display = 'block';

  // Deadline row is auditor-only
  const deadlineRow = document.getElementById('deadlineRow');
  if (deadlineRow) deadlineRow.style.display = 'block';


  if (companyInput) {
    companyInput.required = true;
    companyInput.placeholder = 'Client Company Inc.';
  }
  if (companyLabelEl) companyLabelEl.textContent = 'Client company';

  if (clientContactEmailInput) clientContactEmailInput.required = true;

  // IMPORTANT: auditor flow should NOT show the routing-row "clientEmail" (redundant/confusing)
  if (clientEmailCol) clientEmailCol.style.display = 'none';
  if (clientEmailInput) clientEmailInput.value = '';

  // Ensure required client contact field is obvious
  if (clientContactEmailInput) {
    clientContactEmailInput.placeholder = 'client@company.com';
    clientContactEmailInput.required = true;
  }

  // Keep label text consistent (even though routing clientEmail is hidden)
  if (clientEmailLabelEl) clientEmailLabelEl.textContent = 'Client contact email';

  roleHint.textContent =
    'You‚Äôre an auditor / third party. Enter your email + client email + client company, then we‚Äôll email the client a secure upload link.';

  // Auditor role: hide auditorEmail routing field (email is already captured)
  if (auditorEmailCol) auditorEmailCol.style.display = 'none';

  // Auditor code hidden by default (shown only if they choose the code path)
  if (auditorCodeCol) auditorCodeCol.style.display = 'none';
  if (auditorCodeInput) auditorCodeInput.value = '';

} else if (role === 'client') {
  emailLabel.textContent = 'Your email';
  roleHint.textContent =
    'Use this if an auditor or third party pointed you here to upload evidence.';

  const deadlineRow = document.getElementById('deadlineRow');
  if (deadlineRow) deadlineRow.style.display = 'none';


  // Client/company should show company, hide client contact email
  if (clientContactColEl) clientContactColEl.style.display = 'none';
  if (clientContactEmailInput) {
    clientContactEmailInput.required = false;
    clientContactEmailInput.value = '';
  }
  if (companyColEl) companyColEl.style.display = 'block';

  if (companyLabelEl) companyLabelEl.textContent = 'Your company (optional)';
  if (companyInput) companyInput.required = false;

  // Client can optionally add reviewer email
  if (auditorEmailCol) auditorEmailCol.style.display = 'block';

  // Hide routing clientEmail (not needed)
  if (clientEmailCol) clientEmailCol.style.display = 'none';
  if (clientEmailInput) clientEmailInput.value = '';

  if (auditorEmailHint) {
    auditorEmailHint.textContent =
      'If you know the reviewer‚Äôs email, add it so we can also route the ProofPack to them.';
  }

  if (auditorCodeCol) auditorCodeCol.style.display = 'none';
  if (auditorCodeInput) auditorCodeInput.value = '';

} else { // company
  emailLabel.textContent = 'Your email';
  roleHint.textContent =
    'Direct company use: preparing for an audit or vendor review without an auditor driving this yet.';

  const deadlineRow = document.getElementById('deadlineRow');
  if (deadlineRow) deadlineRow.style.display = 'none';

  if (clientContactColEl) clientContactColEl.style.display = 'none';
  if (clientContactEmailInput) {
    clientContactEmailInput.required = false;
    clientContactEmailInput.value = '';
  }
  if (companyColEl) companyColEl.style.display = 'block';

  if (companyLabelEl) companyLabelEl.textContent = 'Your company (optional)';
  if (companyInput) companyInput.required = false;

  if (auditorEmailCol) auditorEmailCol.style.display = 'none';
  if (clientEmailCol) clientEmailCol.style.display = 'none';
  if (clientEmailInput) clientEmailInput.value = '';

  if (auditorCodeCol) auditorCodeCol.style.display = 'none';
  if (auditorCodeInput) auditorCodeInput.value = '';
}

  // Keep billing + guide UI coherent with role
  updateBillingUI();
  renderFrameworkGuides();
  updateFileMeta();
}
// ===== END DROP-IN REPLACEMENT =====

async function prefillFromRequestToken() {
  const url = new URL(window.location.href);

  // Two modes:
  //  A) Client magic link:   ?t=<token>  (or token/requestToken/etc) => resolve() + lock as client
  //  B) Auditor resend link: ?prev=<token>&auditorEmail=...&clientEmail=...&company=...&frameworks=... => lock as auditor + prefill

  // If this is an auditor resend link (?prev=...), do NOT treat it like a client token link.
  const isAuditorResend = !!(url.searchParams.get('prev') || url.searchParams.get('previous'));
  if (isAuditorResend) return;

  const token =
    url.searchParams.get('t') ||
    url.searchParams.get('token') ||
    url.searchParams.get('requestToken') ||
    url.searchParams.get('request') ||
    url.searchParams.get('r') ||
    null;


  // Helper to parse frameworks from query or from worker response
  const parseFrameworks = (v) => {
    if (!v) return [];
    if (Array.isArray(v)) return v.filter(Boolean);
    if (typeof v === 'string') {
      return v
        .split(',')
        .map(s => s.trim())
        .filter(Boolean);
    }
    return [];
  };

  // =========================
  // MODE A: Client magic link
  // =========================
  if (!token) return; // normal visitors

  // HARD HIDE unlock UI immediately for token visitors (even before /resolve returns)
  isFromRequestLink = true;

  // Hide the pricing gate + Start button while we resolve
  if (pricingGate) pricingGate.style.display = 'none';
  if (startBtn) startBtn.style.display = 'none';

  // Optional: give a tiny status message so it doesn‚Äôt feel broken
  showStatus('Verifying your link‚Ä¶', true);


  // Hide the pricing gate + Start button while we resolve
  if (pricingGate) pricingGate.style.display = 'none';
  if (startBtn) startBtn.style.display = 'none';

  // Optional: give a tiny status message so it doesn‚Äôt feel broken
  showStatus('Verifying your link‚Ä¶', true);


  console.log('Request token from URL:', token);

  // Remember token so we can send it with the upload
  const requestTokenInput = document.getElementById('requestToken');
  if (requestTokenInput) requestTokenInput.value = token;

  // Fetch details from intake worker
  let res;
  try {
    res = await fetch(`${WORKER_BASE}/resolve?t=${encodeURIComponent(token)}`, {
      method: 'GET',
      headers: { accept: 'application/json' },
    });
  } catch (err) {
    console.warn('Prefill lookup failed:', err);
    return;
  }

  let j = null;
  try {
    j = await res.json();
  } catch (_) {
    console.warn('Prefill JSON parse failed');
    return;
  }

  if (!res.ok || !j || j.ok === false) {
    console.warn('Prefill response not ok:', j);
    return;
  }

  isFromRequestLink = true;

  const clientEmailVal =
    j.clientEmail ||
    j.clientContactEmail ||
    j.client_email ||
    j.client ||
    j.email ||
    '';

  const companyVal =
    j.company ||
    j.clientCompany ||
    j.client_company ||
    j.org ||
    '';

  const auditorEmailVal =
    j.auditorEmail ||
    j.auditor_email ||
    j.reviewerEmail ||
    j.reviewer_email ||
    '';

  const frameworkVals = parseFrameworks(j.frameworks || j.framework_ids);

  // Force client role + lock it (client upload flow)
  if (roleSelect) {
    roleSelect.value = 'client';
    updateRoleUI();

    roleSelect.disabled = true;
    if (roleHint) {
      roleHint.textContent =
        'Your auditor sent you this link. Your role is set as the client for guided evidence upload.';
    }
  }

  const emailInput = document.getElementById('email');
  const companyInput = document.getElementById('company');
  const auditorEmailRouting = document.getElementById('auditorEmail');

  if (emailInput && clientEmailVal) emailInput.value = clientEmailVal;
  if (companyInput && companyVal) companyInput.value = companyVal;
  if (auditorEmailRouting && auditorEmailVal) auditorEmailRouting.value = auditorEmailVal;

  if (frameworkVals.length && frameworksSelectEl) {
    const wanted = new Set(frameworkVals);
    Array.from(frameworksSelectEl.options).forEach(opt => {
      opt.selected = wanted.has(opt.value);
    });
  }

  // Guards (optional but fine to keep)
  attachPrefillGuards({ companyVal, auditorEmailVal, frameworkVals });

  // Client came from a paid request (or auditor code), so skip pricing gate and unlock uploads
  clearStatus();
  setUnlocked(j.planLabel || 'OneOff');


  // Ensure the upload box is visible immediately after unlock (client flow)
  if (fileBox) fileBox.style.display = 'block';
  updateFileMeta();
  renderFrameworkGuides();
}

async function prefillFromAuditorResendLink() {
  let url;
  try { url = new URL(window.location.href); } catch { return; }

  const role = (url.searchParams.get('role') || '').toLowerCase();
  const flow = (url.searchParams.get('flow') || '').toLowerCase();

  const mode = (url.searchParams.get('mode') || '').toLowerCase();

  const isAuditorResend =
    (role === 'auditor' && flow === 'request') ||
    (mode === 'auditor' && url.searchParams.get('prev'));

  if (!isAuditorResend) return;


  // Pull fields from query params (from follow-up worker link)
  const auditorEmailVal = url.searchParams.get('auditorEmail') || '';
  const clientEmailVal  = url.searchParams.get('clientEmail') || '';
  const companyVal      = url.searchParams.get('company') || '';
  const frameworksRaw   = url.searchParams.get('frameworks') || '';
  const expanded        = url.searchParams.get('expanded') || '0';
  const prevToken       = url.searchParams.get('prev') || '';

  const frameworkVals = frameworksRaw
    ? frameworksRaw.split(',').map(s => s.trim()).filter(Boolean)
    : [];

  // Set role to auditor and build the correct UI
  if (roleSelect) {
    roleSelect.value = 'auditor';
    updateRoleUI();

    // Optional: prevent changing roles when coming from resend link
    roleSelect.disabled = true;

    if (roleHint) {
      roleHint.textContent =
        'Prefilled from your previous request. Update the deadline (coming soon) and click ‚ÄúSend request to client‚Äù.';
    }
  }

  // Fill auditor + client fields
  const auditorEmailInput = document.getElementById('email'); // auditor email for auditor role
  const clientContactEmailInput = document.getElementById('clientContactEmail'); // shown for auditor role
  const companyInput = document.getElementById('company');

  if (auditorEmailInput && auditorEmailVal) auditorEmailInput.value = auditorEmailVal;
  if (clientContactEmailInput && clientEmailVal) clientContactEmailInput.value = clientEmailVal;
  if (companyInput && companyVal) companyInput.value = companyVal;

  // Preselect frameworks
  if (frameworkVals.length && frameworksSelectEl) {
    const wanted = new Set(frameworkVals);
    Array.from(frameworksSelectEl.options).forEach(opt => {
      opt.selected = wanted.has(opt.value);
    });
  }

  // Store prev token for later (if you add deadline + resend API, you‚Äôll use this)
  const requestTokenInput = document.getElementById('requestToken');
  if (requestTokenInput && prevToken) requestTokenInput.value = prevToken;

  // Expand optional details if requested
  if (expanded === '1') {
    const optionalRow = document.getElementById('optionalRow');
    if (optionalRow) {
      optionalRow.style.display = '';
      optionalRow.open = true;
    }
  }

  // Scroll user to the form
  const requestSection = document.getElementById('request');
  if (requestSection) requestSection.scrollIntoView({ behavior: 'smooth', block: 'start' });

  // If we have a stored code, auto-apply it to skip the pricing gate
  await autoUnlockFromStoredCodeIfPossible();

  // If we couldn't auto-unlock, open the pricing/code gate so the auditor sees where to enter the code.
  if (!isUnlocked) {
    openPricingGate();
  }
}

function attachPrefillGuards(prefill) {
  if (!isFromRequestLink || !prefill) return;

  const { companyVal, auditorEmailVal, frameworkVals } = prefill;

  // --- Frameworks multi-select guard ---
  if (frameworksSelectEl && Array.isArray(frameworkVals) && frameworkVals.length) {
    const original = [...frameworkVals];
    const originalSet = new Set(original);

    frameworksSelectEl.addEventListener('change', () => {
      if (hasFrameworkOverride) return;

      const current = Array.from(frameworksSelectEl.selectedOptions || []).map(o => o.value);
      const changed =
        current.length !== original.length ||
        current.some(v => !originalSet.has(v));

      if (!changed) return;

      const ok = window.confirm(
        'These frameworks were set by your auditor. Are you sure you want to change them?'
      );

      if (!ok) {
        // Revert to original selection
        Array.from(frameworksSelectEl.options).forEach(opt => {
          opt.selected = originalSet.has(opt.value);
        });
        renderFrameworkGuides();
        return;
      }

      hasFrameworkOverride = true;
    });
  }

  // --- Company guard ---
  const companyInput = document.getElementById('company');
  if (companyInput && companyVal) {
    const originalCompany = companyVal;
    companyInput.addEventListener('change', () => {
      if (hasCompanyOverride) return;
      const now = (companyInput.value || '').trim();
      if (now === originalCompany.trim()) return;

      const ok = window.confirm(
        'The client company was set by your auditor. Are you sure you want to change it?'
      );
      if (!ok) {
        companyInput.value = originalCompany;
        return;
      }
      hasCompanyOverride = true;
    });
  }

  // --- Auditor / reviewer email guard ---
  const auditorEmailRouting = document.getElementById('auditorEmail');
  if (auditorEmailRouting && auditorEmailVal) {
    const originalAud = auditorEmailVal;
    auditorEmailRouting.addEventListener('change', () => {
      if (hasAuditorOverride) return;
      const now = (auditorEmailRouting.value || '').trim();
      if (now === originalAud.trim()) return;

      const ok = window.confirm(
        'The reviewer email was set by your auditor. Are you sure you want to change it?'
      );
      if (!ok) {
        auditorEmailRouting.value = originalAud;
        return;
      }
      hasAuditorOverride = true;
    });
  }
}

    
function validate() {
  // Must have role
  const role = (roleSelect?.value || '').trim();
  if (!role) return 'Please choose a role first.';

  // Must be unlocked (gate)
  if (!isUnlocked) return 'Please click ‚ÄúStart guided ProofPack‚Äù to unlock uploads.';

  // Auditors should not submit uploads from this screen ‚Äî they use the
  // "Send request to client" button instead.
  if (role === 'auditor') {
    return 'As an auditor, use ‚ÄúSend request to client‚Äù above to email your client a secure upload link.';
  }

  const email = (document.getElementById('email')?.value || '').trim().toLowerCase();

  // Allowlist your own test emails
  const ALLOWLIST = new Set([
    'atucker5@alumni.nd.edu',
    // 'you@proofrepo.com',
  ]);

  // Basic email format
  const looksLikeEmail = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
  if (!looksLikeEmail) return 'Please enter a valid email address.';

    // If auditor role, require client contact email
  if (role === 'auditor') {
    const clientContact = (document.getElementById('clientContactEmail')?.value || '').trim();
    const looksLikeEmail2 = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(clientContact);
    if (!looksLikeEmail2) return 'Please enter a valid client contact email.';
  }

  // Block common personal domains (unless allowlisted)
  const PERSONAL_DOMAINS = new Set([
    'gmail.com','yahoo.com','outlook.com','hotmail.com','icloud.com','aol.com',
    'proton.me','protonmail.com','gmx.com','mail.com','live.com','msn.com'
  ]);

  const domain = (email.split('@')[1] || '').toLowerCase();
  const isPersonal = PERSONAL_DOMAINS.has(domain);
  if (!ALLOWLIST.has(email) && isPersonal) {
    return 'Please use a work email (or contact ops@proofrepo.com if you need an exception).';
  }

  // Frameworks
  const frameworksSel = document.getElementById('frameworks');
  const fws = Array.from(frameworksSel?.selectedOptions || []).map(o => o.value);
  if (fws.length === 0) return 'Please select at least one framework.';

  // Files
  const files = Array.from(fileInput?.files || []);
  const planEl = document.getElementById('plan');
  const plan = planEl ? (planEl.value || 'Trial') : 'Trial';
  const total = files.reduce((n, f) => n + (f.size || 0), 0);

  if (files.length === 0) {
    return 'Please upload at least one file so we can build a ProofPack.';
  }

  // Lightweight client caps (worker should enforce real limits later)
  if (plan === 'Trial') {
    if (files.length > 10) return 'Trial is tuned for roughly 10 files. If needed, zip extras together.';
    if (total > 5 * 1024 * 1024) return 'Right now the trial is tuned for small uploads (~5 MB). Please zip or trim your upload.';
  } else {
    if (files.length > 50) return 'For large batches, split into multiple submissions.';
  }

  // Enforce required SOC2 tagging ONLY
  const missing = [];
  const soc2Selected = fws.includes('SOC2');

  if (soc2Selected) {
    const cfg = FRAMEWORK_CONFIG.SOC2;
    const sel = frameworkSelections.SOC2 || {};
    (cfg.items || []).forEach(item => {
      if (!sel[item.id]) missing.push(`${cfg.label}: ${item.label}`);
    });
  }

  if (missing.length) {
    return 'For SOC 2, please tag files for these required items:\n‚Ä¢ ' + missing.join('\n‚Ä¢ ');
  }

  return null;
}
/* =======================
   END DROP-IN: validate()
   ======================= */
    
function gather() {
  const fd = new FormData();
  const planEl = document.getElementById('plan');
  const cadenceEl = document.getElementById('cadence');
  const requestTokenEl = document.getElementById('requestToken');

  fd.append('email', (document.getElementById('email')?.value || '').trim());
  fd.append('company', (document.getElementById('company')?.value || '').trim());
  fd.append('plan', planEl ? (planEl.value || 'Trial') : 'Trial');
  fd.append('cadence', (cadenceEl && cadenceEl.value) ? cadenceEl.value : '');
  fd.append('role', (document.getElementById('role')?.value || 'client'));

      // If this upload came from an emailed request, include the request token
  if (requestTokenEl && requestTokenEl.value) {
    // This is what the Worker expects:
    fd.append('t', requestTokenEl.value);

    // (Optional) keep this line if you want the old field for debugging:
    // fd.append('requestToken', requestTokenEl.value);
  }

  // Auditor flow: send required client contact email
  const clientContactEmail = (document.getElementById('clientContactEmail')?.value || '').trim();
  if (clientContactEmail) fd.append('clientContactEmail', clientContactEmail);

  // Optional compatibility: also send as clientEmail if routing clientEmail empty
  const routingClientEmail = (document.getElementById('clientEmail')?.value || '').trim();
  if (clientContactEmail && !routingClientEmail) {
    fd.append('clientEmail', clientContactEmail);
  }

    if (billingSelect && billingSelect.value) {
    fd.append('billingMode', billingSelect.value);
  }

  // If a code was applied but billingMode wasn't selected, force it to "code"
  if (appliedCode && !(billingSelect && billingSelect.value)) {
    fd.append('billingMode', 'code');
  }

  // If a code was successfully applied at the pricing gate, send it through
  if (appliedCode) {
    fd.append('auditorCode', appliedCode);
  }



  // Frameworks
  const frameworksSel = document.getElementById('frameworks');
  Array.from(frameworksSel?.selectedOptions || []).forEach(o => fd.append('frameworks', o.value));

  // Notes
  const notesEl = document.getElementById('notes');
  fd.append('notes', notesEl ? notesEl.value.trim() : '');

// Routing fields (NO auditorCode ‚Äî codes are only entered in pricing gate)
const auditorEmail = (document.getElementById('auditorEmail')?.value || '').trim();
const clientEmail  = (document.getElementById('clientEmail')?.value || '').trim();
if (auditorEmail) fd.append('auditorEmail', auditorEmail);
if (clientEmail)  fd.append('clientEmail', clientEmail);


  // Map JSON (manual or synthesized from frameworkSelections)
  const mapEl = document.getElementById('map');
  let mapVal = mapEl ? mapEl.value.trim() : '';

  if (!mapVal) {
    const autoMap = {};
    Object.keys(frameworkSelections).forEach(fwKey => {
      const cfg = FRAMEWORK_CONFIG[fwKey];
      const sel = frameworkSelections[fwKey] || {};
      if (!cfg) return;

      (cfg.items || []).forEach(item => {
        const filename = sel[item.id];
        if (!filename) return;

        if (fwKey === 'SOC2' && item.mapKey) {
          autoMap[item.mapKey] = filename; // flat keys for worker compatibility
        } else {
          if (!autoMap[fwKey]) autoMap[fwKey] = {};
          autoMap[fwKey][item.id] = filename;
        }
      });
    });

    if (Object.keys(autoMap).length) {
      mapVal = JSON.stringify(autoMap);
    }
  }

  if (mapVal) fd.append('map', mapVal);

  // Files
  Array.from(fileInput?.files || []).forEach(f => fd.append('files', f, f.name));

  return fd;
}

document.getElementById('intakeForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  clearStatus();

  const err = validate();
  if (err) {
    showStatus(esc(err).replace(/\n/g, '<br>'), false);
    return;
  }

  submitBtn.disabled = true;
  submitBtn.textContent = 'Uploading‚Ä¶';

  // Worker returns needs like: [{ framework:"SOC2", missing:[...] }, ...]
  function renderNeedsHtml(needs) {
    if (!needs) return '';

    if (Array.isArray(needs)) {
      const lines = [];
      for (const n of needs) {
        const fw = n?.framework || 'Framework';
        const missing = Array.isArray(n?.missing) ? n.missing : [];
        if (!missing.length) continue;
        lines.push(`<strong>${esc(fw)}:</strong> ${missing.map(x => esc(String(x))).join(', ')}`);
      }
      return lines.join('<br>');
    }

    // fallback if needs is an object shape
    if (typeof needs === 'object') {
      const parts = [];
      for (const fw in needs) {
        const arr = needs[fw];
        if (!Array.isArray(arr) || !arr.length) continue;
        parts.push(`<strong>${esc(fw)}:</strong> ${arr.map(x => esc(String(x))).join(', ')}`);
      }
      return parts.join('<br>');
    }

    return esc(String(needs));
  }

  try {
    const res = await fetch(`${WORKER_BASE}/intake`, { method: 'POST', body: gather() });
    const text = await res.text();

    let json = null;
    try { json = JSON.parse(text); } catch (_) {}

    if (!res.ok || !json || json.ok === false) {
      const msg = (json && (json.error || json.message)) ? (json.error || json.message) : `Upload failed (${res.status})`;

      // If worker returns an actionable "problem" response, show it as a link/button
      const actionUrl = safeUrl(json?.action?.url);
      const actionLabel = json?.action?.label ? String(json.action.label) : 'Fix this';

      const actionHtml = actionUrl
        ? `<br><br><a class="btn primary" href="${esc(actionUrl)}" target="_blank" rel="noopener noreferrer">${esc(actionLabel)}</a>`
        : '';

      const detailHtml = json?.detail ? `<br><br><div class="small muted">${esc(String(json.detail))}</div>` : '';

      showStatus(`${esc(msg)}${actionHtml}${detailHtml}`, false);
      return;
    }


    const filesCount =
      json?.usage?.files ??
      (Array.isArray(json?.saved) ? json.saved.length : 0);

    const viewer = safeUrl(json.viewerUrl || json.packUrl);
    const linkHtml = viewer
      ? `<br><br><a href="${esc(viewer)}" target="_blank" rel="noopener noreferrer">Open ProofPack viewer</a>`
      : '';

    // IMPORTANT: never trust backend HTML; escape it
    const needsHtml = json.missingSummary
      ? esc(String(json.missingSummary)).replace(/\n/g, '<br>')
      : renderNeedsHtml(json.needs);

    const missingBlock = needsHtml
      ? `<br><br><strong>Missing items (backend):</strong><br>${needsHtml}`
      : '';

    const packUrl = safeUrl(json.packUrl);
    const packUrlHtml = packUrl
      ? `<br><br><strong>Signed JSON:</strong> <a href="${esc(packUrl)}" target="_blank" rel="noopener noreferrer">Open</a>`
      : '';

    const manifestKey = json.manifestKey
      ? `<br><strong>Manifest key:</strong> <code>${esc(json.manifestKey)}</code>`
      : '';

        const emailOk =
      (json.emailOk === true) ? 'Yes' :
      (json.emailOk === false) ? 'No (check email config)' :
      'Unknown';

    const emailBlock = `<br><strong>Email sent:</strong> ${esc(emailOk)}`;

    // NEW: credit status, if present
    let creditBlock = '';
    const c = json.credit;
    if (c && c.code) {
      if (c.error) {
        creditBlock =
          `<br><strong>Code:</strong> ${esc(c.code)} ‚Äî ` +
          `<span style="color:#fca5a5">${esc(c.error)}</span>`;
      } else {
        const rem = (typeof c.remaining === 'number') ? c.remaining : '?';
        const bundle = (typeof c.bundleSize === 'number') ? c.bundleSize : null;
        const tail = bundle != null ? `${rem} of ${bundle}` : `${rem}`;
        creditBlock =
          `<br><strong>Code:</strong> ${esc(c.code)} ‚Äî remaining credits: ${esc(String(tail))}`;
      }
    }

    const fixEnds = json.fixWindowEndsAt
      ? `<br><strong>Fix window ends:</strong> ${esc(json.fixWindowEndsAt)}`
      : '';

    showStatus(
      `‚úÖ Received! <strong>${esc(filesCount)}</strong> file(s) saved.<br>
       A ProofPack email will arrive shortly.${missingBlock}${linkHtml}
       <div class="small">${emailBlock}${creditBlock}${fixEnds}${manifestKey}${packUrlHtml}</div>`,
      true
    );

  } catch (err) {
    showStatus(esc(`Network error: ${err?.message || err}`), false);
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = 'Send and build ProofPack';
  }
});

/* =======================
   DROP-IN: wiring
   ======================= */
if (roleSelect) roleSelect.addEventListener('change', updateRoleUI);
if (billingSelect) billingSelect.addEventListener('change', updateBillingUI);
if (frameworksSelectEl) frameworksSelectEl.addEventListener('change', renderFrameworkGuides);

// Initial render
updateRoleUI();
updateBillingUI();
renderFrameworkGuides();
updateFileMeta();
prefillFromAuditorResendLink(); // auditor resend link prefill (role=auditor&flow=request...)
prefillFromRequestToken();      // client magic link prefill (t=...)
maybeUnlockFromStripeReturn();


/* =======================
   END DROP-IN: wiring
   ======================= */


  </script>

  <!-- STICKY BOTTOM MARQUEE -->
  <div class="marquee-fixed" role="region" aria-label="Key highlights">
    <div class="marquee"><div>
      &nbsp;Guided SOC 2 evidence collection ‚Ä¢ Built for boutique auditors and their clients ‚Ä¢ Lightweight alternative to messy shared folders ‚Ä¢ No need for a full 5-figure compliance platform ‚Ä¢ Beta pricing and Stripe billing coming soon ‚Ä¢ Ask for complimentary auditor codes at ops@proofrepo.com ‚Ä¢
      Guided SOC 2 evidence collection ‚Ä¢ Built for boutique auditors and their clients ‚Ä¢ Lightweight alternative to messy shared folders ‚Ä¢ No need for a full 5-figure compliance platform ‚Ä¢ Beta pricing and Stripe billing coming soon ‚Ä¢ Ask for complimentary auditor codes at ops@proofrepo.com ‚Ä¢
    </div></div>
  </div>

</body>
</html>
