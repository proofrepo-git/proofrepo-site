<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ProofRepo — Compliance ProofPacks in Seconds</title>
  <meta name="description" content="Streamlined evidence collection for SOC 2, ISO 27001, HIPAA, GDPR audits. Send your client a guided upload link, get a structured ProofPack." />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #050a14;
      --surface: #0a1628;
      --surface-elevated: #0f1d32;
      --border: #1e3a5f;
      --text: #e2e8f0;
      --text-muted: #94a3b8;
      --primary: #2563eb;
      --primary-hover: #1d4ed8;
      --accent: #10b981;
      --accent-hover: #059669;
      --warning: #f59e0b;
      --error: #ef4444;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 24px;
      border-bottom: 1px solid var(--border);
      background: rgba(5, 10, 20, 0.9);
      backdrop-filter: blur(10px);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 700;
      font-size: 1.25rem;
      color: var(--text);
      text-decoration: none;
    }

    .logo-icon {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .header-links {
      display: flex;
      gap: 24px;
      align-items: center;
    }

    .header-links a {
      color: var(--text-muted);
      text-decoration: none;
      font-size: 0.9rem;
      font-weight: 500;
      transition: color 0.2s;
    }

    .header-links a:hover { color: var(--text); }

    /* Hero */
    .hero {
      padding: 48px 24px;
      text-align: center;
      background: linear-gradient(180deg, rgba(37, 99, 235, 0.1) 0%, transparent 100%);
    }

    .hero-badge {
      display: inline-block;
      padding: 6px 14px;
      background: rgba(37, 99, 235, 0.2);
      border: 1px solid rgba(37, 99, 235, 0.3);
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      color: #60a5fa;
      margin-bottom: 16px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .hero h1 {
      font-size: clamp(2rem, 5vw, 3rem);
      font-weight: 800;
      line-height: 1.2;
      margin-bottom: 16px;
      background: linear-gradient(135deg, var(--text) 0%, #94a3b8 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .hero p {
      font-size: 1.1rem;
      color: var(--text-muted);
      max-width: 600px;
      margin: 0 auto 24px;
    }

    .hero-features {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 24px;
      margin-top: 32px;
      padding: 0 24px;
    }

    .hero-feature {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .hero-feature svg {
      color: var(--accent);
      flex-shrink: 0;
    }

    /* Main Container */
    .main-container {
      max-width: 900px;
      margin: 0 auto;
      padding: 24px;
    }

    /* Cards */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .card-header {
      margin-bottom: 20px;
    }

    .card-header h2 {
      font-size: 1.25rem;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .card-header p {
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    /* Form Elements */
    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text);
    }

    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 12px 16px;
      background: var(--surface-elevated);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      font-size: 1rem;
      font-family: inherit;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
    }

    .form-input::placeholder { color: var(--text-muted); }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    /* Role Selector */
    .role-selector {
      margin-bottom: 24px;
    }

    .role-selector select {
      width: 100%;
      padding: 14px 16px;
      background: var(--surface-elevated);
      border: 2px solid var(--border);
      border-radius: 12px;
      color: var(--text);
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .role-selector select:focus {
      outline: none;
      border-color: var(--primary);
    }

    /* Code Input Section - STEP 2 ONLY */
    .code-section {
      background: var(--surface-elevated);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 24px;
    }

    .code-input-wrapper {
      display: flex;
      gap: 12px;
    }

    .code-input {
      flex: 1;
      padding: 14px 16px;
      font-size: 1.1rem;
      font-weight: 600;
      letter-spacing: 2px;
      text-transform: uppercase;
      background: var(--bg);
      border: 2px solid var(--border);
      border-radius: 10px;
      color: var(--text);
    }

    .code-input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .code-status {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 12px;
      font-size: 0.9rem;
    }

    .code-status.valid { color: var(--accent); }
    .code-status.invalid { color: var(--error); }
    .code-status.checking { color: var(--text-muted); }

    /* Framework Tags */
    .framework-selector {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }

    .framework-tag {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: var(--surface-elevated);
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      user-select: none;
    }

    .framework-tag:hover {
      border-color: var(--primary);
    }

    .framework-tag.selected {
      background: rgba(37, 99, 235, 0.2);
      border-color: var(--primary);
      color: #60a5fa;
    }

    .framework-tag input {
      display: none;
    }

    /* Evidence Categories */
    .evidence-category {
      border: 1px solid var(--border);
      border-radius: 12px;
      margin-bottom: 12px;
      overflow: hidden;
    }

    .evidence-category-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 16px;
      background: var(--surface-elevated);
      cursor: pointer;
      transition: background 0.2s;
    }

    .evidence-category-header:hover {
      background: rgba(30, 58, 95, 0.5);
    }

    .evidence-category-title {
      font-weight: 600;
      font-size: 0.95rem;
    }

    .evidence-category-count {
      font-size: 0.8rem;
      color: var(--text-muted);
      background: var(--bg);
      padding: 4px 10px;
      border-radius: 12px;
    }

    .evidence-category-items {
      display: none;
      padding: 12px;
      background: var(--bg);
    }

    .evidence-category.expanded .evidence-category-items {
      display: block;
    }

    .evidence-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .evidence-item:hover {
      background: var(--surface);
    }

    .evidence-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--primary);
    }

    .evidence-item-text {
      flex: 1;
      font-size: 0.9rem;
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px 24px;
      font-size: 1rem;
      font-weight: 600;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      text-decoration: none;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      background: var(--primary-hover);
      transform: translateY(-1px);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-accent {
      background: var(--accent);
      color: white;
    }

    .btn-accent:hover:not(:disabled) {
      background: var(--accent-hover);
      transform: translateY(-1px);
    }

    .btn-outline {
      background: transparent;
      border: 2px solid var(--border);
      color: var(--text);
    }

    .btn-outline:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    .btn-full {
      width: 100%;
    }

    /* Success Display */
    .success-display {
      display: none;
      text-align: center;
      padding: 32px;
    }

    .success-display.visible {
      display: block;
    }

    .success-icon {
      width: 64px;
      height: 64px;
      background: rgba(16, 185, 129, 0.2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
    }

    .success-icon svg {
      color: var(--accent);
      width: 32px;
      height: 32px;
    }

    .success-display h3 {
      font-size: 1.5rem;
      margin-bottom: 8px;
    }

    .success-display p {
      color: var(--text-muted);
      margin-bottom: 24px;
    }

    .code-display-box {
      background: rgba(16, 185, 129, 0.1);
      border: 2px solid var(--accent);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .code-display-label {
      font-size: 0.9rem;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .code-display-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--accent);
      letter-spacing: 3px;
      font-family: 'Courier New', monospace;
    }

    .code-display-credits {
      margin-top: 8px;
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .success-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
    }

    /* Payment Banner */
    .payment-banner {
      display: none;
      background: linear-gradient(135deg, rgba(37, 99, 235, 0.2), rgba(16, 185, 129, 0.2));
      border: 1px solid rgba(37, 99, 235, 0.3);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 24px;
      text-align: center;
    }

    .payment-banner.visible {
      display: block !important;
    }

    .payment-banner h3 {
      font-size: 1.1rem;
      margin-bottom: 8px;
    }

    .payment-banner p {
      color: var(--text-muted);
      font-size: 0.9rem;
      margin-bottom: 16px;
    }

    /* Loading Spinner */
    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      display: inline-block;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Payment Gate Section - STEP 2 */
    .payment-gate {
      display: none;
      background: var(--surface-elevated);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .payment-gate.visible {
      display: block;
    }

    .payment-gate-header {
      text-align: center;
      margin-bottom: 20px;
    }

    .payment-gate-header h3 {
      font-size: 1.1rem;
      margin-bottom: 4px;
    }

    .payment-gate-header p {
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    /* Tab switcher for code vs buy */
    .gate-tabs {
      display: flex;
      gap: 0;
      margin-bottom: 20px;
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
    }

    .gate-tab {
      flex: 1;
      padding: 12px;
      text-align: center;
      cursor: pointer;
      font-weight: 500;
      background: var(--bg);
      transition: all 0.2s;
    }

    .gate-tab:hover {
      background: var(--surface);
    }

    .gate-tab.active {
      background: var(--primary);
      color: white;
    }

    .gate-content {
      display: none;
    }

    .gate-content.active {
      display: block;
    }

    /* Pricing Section */
    .pricing-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }

    .pricing-card {
      background: var(--bg);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .pricing-card:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
    }

    .pricing-card.selected {
      border-color: var(--accent);
      background: rgba(16, 185, 129, 0.1);
    }

    .pricing-card-name {
      font-weight: 600;
      font-size: 0.9rem;
      margin-bottom: 4px;
    }

    .pricing-card-price {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 4px;
    }

    .pricing-card-desc {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    /* Instructions Textarea */
    .form-textarea {
      min-height: 80px;
      resize: vertical;
    }

    /* Deadline Row */
    .deadline-row {
      display: flex;
      gap: 12px;
      align-items: end;
    }

    .deadline-row .form-group {
      flex: 1;
      margin-bottom: 0;
    }

    /* Footer */
    .footer {
      text-align: center;
      padding: 32px 24px;
      color: var(--text-muted);
      font-size: 0.85rem;
      border-top: 1px solid var(--border);
      margin-top: 48px;
    }

    /* Responsive */
    @media (max-width: 600px) {
      .hero { padding: 32px 16px; }
      .main-container { padding: 16px; }
      .card { padding: 20px; }
      .form-row { grid-template-columns: 1fr; }
      .pricing-grid { grid-template-columns: 1fr 1fr; }
      .success-buttons { flex-direction: column; }
      .success-buttons .btn { width: 100%; }
    }
  </style>
</head>
<body>
  <header class="header">
    <a href="/" class="logo">
      <div class="logo-icon">
        <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
      </div>
      ProofRepo
    </a>
    <nav class="header-links">
      <a href="#how-it-works">How it works</a>
      <a href="#" id="getStartedLink">Get started</a>
    </nav>
  </header>

  <section class="hero">
    <button class="btn btn-primary" id="heroGetStarted">Get started</button>
    <div class="hero-features">
      <div class="hero-feature">
        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
        <span><strong>Auditor-defined requests:</strong> Specify exactly what you need.</span>
      </div>
      <div class="hero-feature">
        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
        <span><strong>Guided for clients:</strong> Clear checklist shows what to upload.</span>
      </div>
      <div class="hero-feature">
        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
        <span><strong>Structured output:</strong> Files mapped to controls, ready for workpapers.</span>
      </div>
    </div>
  </section>

  <main class="main-container">
    <!-- Success Banner (inline, not blocking) -->
    <div id="successBanner" class="payment-banner" style="display:none; background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(16, 185, 129, 0.1)); border-color: var(--accent);">
      <h3 style="color: var(--accent);">✓ Payment Successful!</h3>
      <p>Your code is ready. Complete your request below.</p>
    </div>

    <!-- Main Form Card -->
    <div id="mainFormCard" class="card">
      <div class="card-header">
        <h2>Upload evidence and get a ProofPack</h2>
        <p>Choose your role to get started.</p>
      </div>

      <!-- Role Selector -->
      <div class="role-selector">
        <label class="form-label">What brings you here?</label>
        <select id="roleSelect">
          <option value="">Select your role...</option>
          <option value="auditor">I'm an auditor requesting evidence from a client</option>
          <option value="client">I'm responding to an evidence request</option>
        </select>
      </div>

      <!-- Auditor Flow -->
      <div id="auditorFlow" style="display: none;">
        <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 20px;">
          Define what evidence you need, then we'll email your client a guided upload link.
        </p>

        <!-- STEP 1: Basic Info (always visible when auditor selected) -->
        <div id="auditorStep1">
          <!-- Email -->
          <div class="form-group">
            <label class="form-label">Your email (auditor)</label>
            <input type="email" class="form-input" id="auditorEmail" placeholder="auditor@firm.com">
          </div>

          <!-- Client Info -->
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Client company</label>
              <input type="text" class="form-input" id="clientCompany" placeholder="Acme Corp">
            </div>
            <div class="form-group">
              <label class="form-label">Client's email (where to send the upload link)</label>
              <input type="email" class="form-input" id="clientEmail" placeholder="client@company.com">
            </div>
          </div>

          <!-- Deadline -->
          <div class="deadline-row" style="margin-bottom: 20px;">
            <div class="form-group">
              <label class="form-label">Deadline</label>
              <select class="form-select" id="deadlineDays">
                <option value="5">5 days</option>
                <option value="7">7 days</option>
                <option value="14">14 days</option>
                <option value="30">30 days</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Time</label>
              <input type="time" class="form-input" id="deadlineTime" value="17:00">
              <span style="font-size: 0.8rem; color: var(--text-muted);">local time</span>
            </div>
          </div>

          <!-- Framework Selector -->
          <div class="form-group">
            <label class="form-label">Evidence Request</label>
            <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 12px;">Check frameworks, then customize what evidence you need. Items marked ✓ are included by default.</p>
            <div class="framework-selector">
              <label class="framework-tag selected">
                <input type="checkbox" value="SOC2" checked> ✓ SOC 2
              </label>
              <label class="framework-tag">
                <input type="checkbox" value="ISO27001"> ISO 27001
              </label>
              <label class="framework-tag">
                <input type="checkbox" value="HIPAA"> HIPAA
              </label>
              <label class="framework-tag">
                <input type="checkbox" value="GDPR"> GDPR
              </label>
            </div>
          </div>

          <!-- Evidence Categories (populated by JS) -->
          <div id="evidenceCategories">
            <!-- Will be populated by JS when SOC2 is selected -->
          </div>

          <!-- Global Instructions -->
          <div class="form-group" style="margin-top: 20px;">
            <label class="form-label">Overall Instructions for client</label>
            <textarea class="form-textarea" id="globalInstructions" placeholder="Example: Please provide evidence covering Jan-Dec 2025. Screenshots acceptable. Redact any secrets or credentials."></textarea>
            <label style="display: flex; align-items: center; gap: 8px; margin-top: 8px; font-size: 0.85rem; color: var(--text-muted); cursor: pointer;">
              <input type="checkbox" id="showInstructionsAbove" checked>
              Show prominently to your client above the checklist
            </label>
          </div>

          <!-- Continue Button (moves to Step 2) -->
          <button class="btn btn-primary btn-full" id="continueToPaymentBtn" style="margin-top: 24px;">
            Continue
          </button>
        </div>

        <!-- STEP 2: Payment Gate (hidden until Continue is clicked) -->
        <div id="auditorStep2" class="payment-gate">
          <div class="payment-gate-header">
            <h3>Almost there!</h3>
            <p>Enter your credit code or purchase credits to send this request.</p>
          </div>

          <!-- Tabs -->
          <div class="gate-tabs">
            <div class="gate-tab active" data-tab="code">I have a code</div>
            <div class="gate-tab" data-tab="buy">Buy credits</div>
          </div>

          <!-- Code Entry Tab -->
          <div id="gateCodeContent" class="gate-content active">
            <div class="code-section" style="margin: 0; background: var(--bg);">
              <label class="form-label">Credit Code</label>
              <div class="code-input-wrapper">
                <input type="text" class="code-input" id="auditorCode" placeholder="ENTER CODE">
                <button class="btn btn-outline" id="verifyCodeBtn">Verify</button>
              </div>
              <div id="codeStatus" class="code-status"></div>
            </div>
          </div>

          <!-- Buy Credits Tab -->
          <div id="gateBuyContent" class="gate-content">
            <div class="pricing-grid">
              <div class="pricing-card" data-tier="single">
                <div class="pricing-card-name">Single Pack</div>
                <div class="pricing-card-price">$59</div>
                <div class="pricing-card-desc">1 evidence pack</div>
              </div>
              <div class="pricing-card" data-tier="pack5">
                <div class="pricing-card-name">5-Pack</div>
                <div class="pricing-card-price">$249</div>
                <div class="pricing-card-desc">5 packs ($50 each)</div>
              </div>
              <div class="pricing-card" data-tier="pack15">
                <div class="pricing-card-name">15-Pack</div>
                <div class="pricing-card-price">$499</div>
                <div class="pricing-card-desc">15 packs ($33 each)</div>
              </div>
              <div class="pricing-card" data-tier="pack50">
                <div class="pricing-card-name">50-Pack</div>
                <div class="pricing-card-price">$1,249</div>
                <div class="pricing-card-desc">50 packs ($25 each)</div>
              </div>
            </div>
            <button class="btn btn-accent btn-full" id="buyCreditsBtn" disabled>
              Select a plan above
            </button>
          </div>

          <!-- Back button -->
          <button class="btn btn-outline btn-full" id="backToStep1Btn" style="margin-top: 12px;">
            ← Back to edit request
          </button>
        </div>

        <!-- STEP 3: Send Request Button (only visible when code is valid) -->
        <button class="btn btn-accent btn-full" id="sendRequestBtn" style="margin-top: 24px; display: none;">
          Send Evidence Request to Client
        </button>
      </div>

      <!-- Client Flow (placeholder) -->
      <div id="clientFlow" style="display: none;">
        <p style="color: var(--text-muted);">
          Please use the link provided by your auditor to upload evidence. 
          If you don't have a link, contact your auditor to request one.
        </p>
      </div>
    </div>
  </main>

  <footer class="footer">
    <p>ProofRepo — Compliance evidence collection for auditors • SOC 2, ISO 27001, HIPAA, GDPR & more • Get started with a free trial</p>
  </footer>

  <script>
    const API = 'https://proofrepo-intake.atucker5.workers.dev';
    
    // State
    let state = {
      role: '',
      code: '',
      codeValid: false,
      codeCredits: 0,
      selectedTier: null,
      frameworks: ['SOC2'],
      formData: null,
      step: 'form' // 'form' | 'payment' | 'ready'
    };

    // Evidence categories data for SOC 2
    const EVIDENCE_CATEGORIES = {
      SOC2: [
        {
          name: 'Governance & Policies',
          items: [
            { id: 'info_security_policy', label: 'Information Security Policy', default: true },
            { id: 'acceptable_use', label: 'Acceptable Use Policy', default: true },
            { id: 'access_control_policy', label: 'Access Control Policy', default: true },
            { id: 'data_classification', label: 'Data Classification Policy', default: false },
            { id: 'vendor_management', label: 'Vendor Management Policy', default: false }
          ]
        },
        {
          name: 'Risk Assessment',
          items: [
            { id: 'risk_assessment', label: 'Risk Assessment Report', default: true },
            { id: 'risk_treatment', label: 'Risk Treatment Plan', default: false },
            { id: 'risk_register', label: 'Risk Register', default: false }
          ]
        },
        {
          name: 'Access Control',
          items: [
            { id: 'access_review', label: 'User Access Review', default: true },
            { id: 'user_provisioning', label: 'User Provisioning Evidence', default: true },
            { id: 'terminated_access', label: 'Terminated User Access Removal', default: true },
            { id: 'mfa_evidence', label: 'MFA Configuration Evidence', default: true },
            { id: 'privileged_access', label: 'Privileged Access List', default: false }
          ]
        },
        {
          name: 'Change Management',
          items: [
            { id: 'change_log', label: 'Change Log / Release Notes', default: true },
            { id: 'change_approval', label: 'Change Approval Records', default: true },
            { id: 'code_review', label: 'Code Review Evidence', default: false },
            { id: 'deployment_records', label: 'Deployment Records', default: false }
          ]
        },
        {
          name: 'System Operations',
          items: [
            { id: 'backup_evidence', label: 'Backup Configuration & Logs', default: true },
            { id: 'monitoring_alerts', label: 'Monitoring & Alerting Config', default: false },
            { id: 'incident_response', label: 'Incident Response Plan', default: true },
            { id: 'incident_log', label: 'Incident Log / Tickets', default: false }
          ]
        },
        {
          name: 'Vendor Management',
          items: [
            { id: 'vendor_list', label: 'Vendor / Subprocessor List', default: true },
            { id: 'vendor_assessments', label: 'Vendor Security Assessments', default: false },
            { id: 'vendor_contracts', label: 'Vendor Contracts / DPAs', default: false }
          ]
        },
        {
          name: 'Security Testing',
          items: [
            { id: 'pentest_report', label: 'Penetration Test Report', default: false },
            { id: 'vuln_scan', label: 'Vulnerability Scan Results', default: false },
            { id: 'security_training', label: 'Security Training Records', default: true }
          ]
        }
      ]
    };

    // Render evidence categories
    function renderEvidenceCategories() {
      const container = document.getElementById('evidenceCategories');
      if (!container) return;
      
      // Only show for SOC2 currently
      if (!state.frameworks.includes('SOC2')) {
        container.innerHTML = '';
        return;
      }

      const categories = EVIDENCE_CATEGORIES.SOC2 || [];
      let html = '';

      categories.forEach((cat, catIndex) => {
        const isExpanded = catIndex === 0; // First category expanded by default
        const checkedCount = cat.items.filter(item => item.default).length;
        
        html += `
          <div class="evidence-category ${isExpanded ? 'expanded' : ''}" data-category="${catIndex}">
            <div class="evidence-category-header" onclick="toggleCategory(${catIndex})">
              <span class="evidence-category-title">${cat.name}</span>
              <span class="evidence-category-count">${checkedCount}/${cat.items.length} selected</span>
            </div>
            <div class="evidence-category-items">
        `;
        
        cat.items.forEach(item => {
          html += `
            <label class="evidence-item">
              <input type="checkbox" value="${item.id}" ${item.default ? 'checked' : ''} onchange="updateCategoryCount(${catIndex})">
              <span class="evidence-item-text">${item.label}</span>
            </label>
          `;
        });
        
        html += `
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    // Toggle category expansion
    function toggleCategory(index) {
      const cat = document.querySelector(`.evidence-category[data-category="${index}"]`);
      if (cat) cat.classList.toggle('expanded');
    }

    // Update category count display
    function updateCategoryCount(index) {
      const cat = document.querySelector(`.evidence-category[data-category="${index}"]`);
      if (!cat) return;
      const checkboxes = cat.querySelectorAll('input[type="checkbox"]');
      const checked = Array.from(checkboxes).filter(cb => cb.checked).length;
      const countEl = cat.querySelector('.evidence-category-count');
      if (countEl) countEl.textContent = `${checked}/${checkboxes.length} selected`;
    }

    // Restore state from localStorage
    function restoreState() {
      try {
        const saved = localStorage.getItem('proofrepo_form_state');
        if (saved) {
          const parsed = JSON.parse(saved);
          if (parsed.auditorEmail) document.getElementById('auditorEmail').value = parsed.auditorEmail;
          if (parsed.clientCompany) document.getElementById('clientCompany').value = parsed.clientCompany;
          if (parsed.clientEmail) document.getElementById('clientEmail').value = parsed.clientEmail;
          if (parsed.globalInstructions) document.getElementById('globalInstructions').value = parsed.globalInstructions;
          state.formData = parsed;
        }
      } catch (e) {}
    }

    // Save state to localStorage
    function saveState() {
      try {
        const data = {
          auditorEmail: document.getElementById('auditorEmail').value,
          clientCompany: document.getElementById('clientCompany').value,
          clientEmail: document.getElementById('clientEmail').value,
          globalInstructions: document.getElementById('globalInstructions').value,
          timestamp: Date.now()
        };
        localStorage.setItem('proofrepo_form_state', JSON.stringify(data));
      } catch (e) {}
    }

    // Check for checkout return (payment completed)
    async function checkCheckoutReturn() {
      const params = new URLSearchParams(window.location.search);
      const sessionId = params.get('session_id');
      
      if (!sessionId) return false;

      // Show auditor flow and go to payment step
      document.getElementById('roleSelect').value = 'auditor';
      handleRoleChange('auditor');
      
      // Restore saved form state
      restoreState();
      
      // Go directly to payment step with code tab active
      goToStep('payment');
      
      // Show success banner
      const banner = document.getElementById('successBanner');
      if (banner) banner.classList.add('visible');

      // Show loading state in code field
      const codeInput = document.getElementById('auditorCode');
      const codeStatus = document.getElementById('codeStatus');
      codeInput.value = 'LOADING...';
      codeInput.disabled = true;
      codeStatus.className = 'code-status checking';
      codeStatus.innerHTML = '<span class="spinner"></span> Retrieving your code...';

      // Poll for code
      let code = null;
      let creditsText = '';
      
      for (let attempt = 0; attempt < 30; attempt++) {
        try {
          const res = await fetch(`${API}/checkout/session?session_id=${sessionId}`);
          const data = await res.json();
          
          if (data.ok && data.code) {
            code = data.code;
            state.code = code;
            state.codeValid = true;
            state.codeCredits = data.credits;
            creditsText = data.creditsDisplay || `${data.credits} credit${data.credits !== 1 ? 's' : ''} remaining`;
            break;
          }
          
          codeStatus.innerHTML = `<span class="spinner"></span> Retrieving your code... (${attempt + 1}/30)`;
          await new Promise(r => setTimeout(r, 2000));
        } catch (e) {
          console.error('Checkout check error:', e);
        }
      }

      // Fill in the code field
      codeInput.disabled = false;
      if (code) {
        codeInput.value = code;
        codeStatus.className = 'code-status valid';
        codeStatus.innerHTML = `✓ Valid code — ${creditsText}`;
        updateUI();
      } else {
        codeInput.value = '';
        codeInput.placeholder = 'CHECK YOUR EMAIL';
        codeStatus.className = 'code-status';
        codeStatus.innerHTML = 'Your code is being emailed. Enter it above when you receive it.';
      }

      // Clear the URL params
      window.history.replaceState({}, '', window.location.pathname);
      
      return true;
    }

    // Step navigation
    function goToStep(step) {
      state.step = step;
      
      const step1 = document.getElementById('auditorStep1');
      const step2 = document.getElementById('auditorStep2');
      const sendBtn = document.getElementById('sendRequestBtn');
      
      if (step === 'form') {
        step1.style.display = 'block';
        step2.classList.remove('visible');
        sendBtn.style.display = 'none';
      } else if (step === 'payment') {
        step1.style.display = 'none';
        step2.classList.add('visible');
        sendBtn.style.display = 'none';
        // If code already valid, show send button
        if (state.codeValid) {
          sendBtn.style.display = 'block';
        }
      } else if (step === 'ready') {
        step1.style.display = 'none';
        step2.classList.add('visible');
        sendBtn.style.display = 'block';
      }
    }

    // Role change handler
    function handleRoleChange(role) {
      state.role = role;
      document.getElementById('auditorFlow').style.display = role === 'auditor' ? 'block' : 'none';
      document.getElementById('clientFlow').style.display = role === 'client' ? 'block' : 'none';
      
      if (role === 'auditor') {
        goToStep('form');
        renderEvidenceCategories();
      }
    }

    // Verify code
    async function verifyCode() {
      const code = document.getElementById('auditorCode').value.trim().toUpperCase();
      const statusEl = document.getElementById('codeStatus');
      
      if (!code) {
        statusEl.innerHTML = '';
        state.codeValid = false;
        updateUI();
        return;
      }

      statusEl.className = 'code-status checking';
      statusEl.innerHTML = '<span class="spinner"></span> Checking...';

      try {
        const res = await fetch(`${API}/check-code?code=${encodeURIComponent(code)}`);
        const data = await res.json();

        if (data.ok && data.remaining > 0) {
          state.code = code;
          state.codeValid = true;
          state.codeCredits = data.remaining;
          const creditsText = data.remaining >= 9999 ? 'Unlimited credits' : `${data.remaining} credit${data.remaining !== 1 ? 's' : ''} remaining`;
          statusEl.className = 'code-status valid';
          statusEl.innerHTML = `✓ Valid code — ${creditsText}`;
        } else if (data.remaining === 0) {
          state.codeValid = false;
          statusEl.className = 'code-status invalid';
          statusEl.innerHTML = '✗ No credits remaining on this code';
        } else {
          state.codeValid = false;
          statusEl.className = 'code-status invalid';
          statusEl.innerHTML = '✗ Invalid code';
        }
      } catch (e) {
        state.codeValid = false;
        statusEl.className = 'code-status invalid';
        statusEl.innerHTML = '✗ Error checking code';
      }

      updateUI();
    }

    // Update UI based on state
    function updateUI() {
      const sendBtn = document.getElementById('sendRequestBtn');

      if (state.codeValid && state.step === 'payment') {
        sendBtn.style.display = 'block';
        sendBtn.disabled = false;
        sendBtn.textContent = 'Send Evidence Request to Client';
      } else {
        sendBtn.style.display = 'none';
      }
    }

    // Handle tier selection
    function selectTier(tier) {
      document.querySelectorAll('.pricing-card').forEach(card => {
        card.classList.toggle('selected', card.dataset.tier === tier);
      });
      state.selectedTier = tier;
      
      const buyBtn = document.getElementById('buyCreditsBtn');
      if (tier) {
        const prices = { single: '$59', pack5: '$249', pack15: '$499', pack50: '$1,249' };
        buyBtn.disabled = false;
        buyBtn.textContent = `Buy Now — ${prices[tier]}`;
      } else {
        buyBtn.disabled = true;
        buyBtn.textContent = 'Select a plan above';
      }
    }

    // Handle checkout
    async function handleCheckout() {
      if (!state.selectedTier) return;

      const buyBtn = document.getElementById('buyCreditsBtn');
      buyBtn.disabled = true;
      buyBtn.innerHTML = '<span class="spinner"></span> Processing...';

      saveState();

      try {
        const res = await fetch(`${API}/checkout`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            tier: state.selectedTier,
            email: document.getElementById('auditorEmail').value,
            successUrl: window.location.origin + window.location.pathname + '?session_id={CHECKOUT_SESSION_ID}',
            cancelUrl: window.location.href
          })
        });

        const data = await res.json();

        if (data.ok && data.url) {
          window.location.href = data.url;
        } else {
          alert('Error starting checkout: ' + (data.error || 'Unknown error'));
          buyBtn.disabled = false;
          buyBtn.textContent = 'Buy Now';
        }
      } catch (e) {
        alert('Error: ' + e.message);
        buyBtn.disabled = false;
        buyBtn.textContent = 'Buy Now';
      }
    }

    // Tab switching
    function switchTab(tabName) {
      document.querySelectorAll('.gate-tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tabName));
      document.getElementById('gateCodeContent').classList.toggle('active', tabName === 'code');
      document.getElementById('gateBuyContent').classList.toggle('active', tabName === 'buy');
    }

    // Send request
    async function sendRequest() {
      if (!state.codeValid) return;

      const sendBtn = document.getElementById('sendRequestBtn');
      sendBtn.disabled = true;
      sendBtn.innerHTML = '<span class="spinner"></span> Sending...';

      const deadlineDays = parseInt(document.getElementById('deadlineDays').value);
      const deadline = new Date(Date.now() + deadlineDays * 24 * 60 * 60 * 1000).toISOString();

      try {
        const res = await fetch(`${API}/request`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            auditorEmail: document.getElementById('auditorEmail').value,
            clientEmail: document.getElementById('clientEmail').value,
            company: document.getElementById('clientCompany').value,
            frameworks: state.frameworks,
            deadlineISO: deadline,
            auditorCode: state.code,
            globalInstructions: document.getElementById('globalInstructions').value
          })
        });

        const data = await res.json();

        if (data.ok) {
          localStorage.removeItem('proofrepo_form_state');
          alert('Success! Evidence request sent to ' + document.getElementById('clientEmail').value);
          window.location.reload();
        } else {
          alert('Error: ' + (data.error || 'Unknown error'));
          sendBtn.disabled = false;
          sendBtn.textContent = 'Send Evidence Request to Client';
        }
      } catch (e) {
        alert('Error: ' + e.message);
        sendBtn.disabled = false;
        sendBtn.textContent = 'Send Evidence Request to Client';
      }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      // Check for checkout return first
      const isCheckoutReturn = await checkCheckoutReturn();

      // Event listeners
      document.getElementById('roleSelect').addEventListener('change', (e) => {
        handleRoleChange(e.target.value);
      });

      document.getElementById('verifyCodeBtn').addEventListener('click', verifyCode);
      document.getElementById('auditorCode').addEventListener('keyup', (e) => {
        if (e.key === 'Enter') verifyCode();
      });

      // Continue button (Step 1 -> Step 2)
      document.getElementById('continueToPaymentBtn').addEventListener('click', () => {
        // Basic validation
        const email = document.getElementById('auditorEmail').value.trim();
        const clientEmail = document.getElementById('clientEmail').value.trim();
        const company = document.getElementById('clientCompany').value.trim();
        
        if (!email || !email.includes('@')) {
          alert('Please enter your email address.');
          return;
        }
        if (!company) {
          alert('Please enter the client company name.');
          return;
        }
        if (!clientEmail || !clientEmail.includes('@')) {
          alert('Please enter the client email address.');
          return;
        }
        
        saveState();
        goToStep('payment');
      });

      // Back button (Step 2 -> Step 1)
      document.getElementById('backToStep1Btn').addEventListener('click', () => {
        goToStep('form');
      });

      // Tab switching
      document.querySelectorAll('.gate-tab').forEach(tab => {
        tab.addEventListener('click', () => switchTab(tab.dataset.tab));
      });

      // Pricing cards
      document.querySelectorAll('.pricing-card').forEach(card => {
        card.addEventListener('click', () => selectTier(card.dataset.tier));
      });

      document.getElementById('buyCreditsBtn').addEventListener('click', handleCheckout);
      document.getElementById('sendRequestBtn').addEventListener('click', sendRequest);

      // Framework toggles
      document.querySelectorAll('.framework-tag input').forEach(input => {
        input.addEventListener('change', (e) => {
          const tag = e.target.closest('.framework-tag');
          tag.classList.toggle('selected', e.target.checked);
          if (e.target.checked) {
            state.frameworks.push(e.target.value);
          } else {
            state.frameworks = state.frameworks.filter(f => f !== e.target.value);
          }
          // Re-render evidence categories when frameworks change
          renderEvidenceCategories();
        });
      });

      // Scroll to main on hero button click
      document.getElementById('heroGetStarted').addEventListener('click', () => {
        document.getElementById('roleSelect').scrollIntoView({ behavior: 'smooth' });
        document.getElementById('roleSelect').focus();
      });

      document.getElementById('getStartedLink').addEventListener('click', (e) => {
        e.preventDefault();
        document.getElementById('roleSelect').scrollIntoView({ behavior: 'smooth' });
      });

      // Initial render if role is already set
      if (document.getElementById('roleSelect').value === 'auditor') {
        renderEvidenceCategories();
      }

      updateUI();
    });
  </script>
</body>
</html>
