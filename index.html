<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ProofRepo — Compliance ProofPacks in Seconds</title>
  <meta name="description" content="Streamlined evidence collection for SOC 2, ISO 27001, HIPAA, GDPR audits. Send your client a guided upload link, get a structured ProofPack." />
  
  <!-- MAGIC LINK REDIRECT - Must be in head, executes immediately -->
  <script>
    (function() {
      var params = new URLSearchParams(window.location.search);
      var token = params.get('t');
      if (token && token.indexOf('req_') === 0) {
        window.location.replace('https://proofrepo-intake.atucker5.workers.dev/upload?t=' + encodeURIComponent(token));
      }
    })();
  </script>
  
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #050a14;
      --surface: #0a1628;
      --surface-elevated: #0f1d32;
      --border: #1e3a5f;
      --text: #e2e8f0;
      --text-muted: #94a3b8;
      --primary: #2563eb;
      --primary-hover: #1d4ed8;
      --accent: #10b981;
      --accent-hover: #059669;
      --warning: #f59e0b;
      --error: #ef4444;
      --marquee-height: 48px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
      padding-bottom: var(--marquee-height);
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 24px;
      border-bottom: 1px solid var(--border);
      background: rgba(5, 10, 20, 0.9);
      backdrop-filter: blur(10px);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 700;
      font-size: 1.25rem;
      color: var(--text);
      text-decoration: none;
    }

    .logo-icon {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .header-links {
      display: flex;
      gap: 24px;
      align-items: center;
    }

    .header-links a {
      color: var(--text-muted);
      text-decoration: none;
      font-size: 0.9rem;
      font-weight: 500;
      transition: color 0.2s;
      cursor: pointer;
    }

    .header-links a:hover { color: var(--text); }

    .hero {
      padding: 48px 24px;
      text-align: center;
      background: linear-gradient(180deg, rgba(37, 99, 235, 0.1) 0%, transparent 100%);
    }

    .hero-badge {
      display: inline-block;
      padding: 6px 14px;
      background: rgba(37, 99, 235, 0.2);
      border: 1px solid rgba(37, 99, 235, 0.3);
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      color: #60a5fa;
      margin-bottom: 16px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .hero h1 {
      font-size: clamp(2rem, 5vw, 3rem);
      font-weight: 800;
      line-height: 1.2;
      margin-bottom: 16px;
      background: linear-gradient(135deg, var(--text) 0%, #94a3b8 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .hero p {
      font-size: 1.1rem;
      color: var(--text-muted);
      max-width: 600px;
      margin: 0 auto 12px;
    }

    .hero-features {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 24px;
      margin-top: 32px;
      padding: 0 24px;
    }

    .hero-feature {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .hero-feature svg {
      color: var(--accent);
      flex-shrink: 0;
    }

    .main-container {
      max-width: 900px;
      margin: 0 auto;
      padding: 24px;
    }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .card-header {
      margin-bottom: 20px;
    }

    .card-header h2 {
      font-size: 1.25rem;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .card-header p {
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text);
    }

    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 12px 16px;
      background: var(--surface-elevated);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      font-size: 1rem;
      font-family: inherit;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
    }

    .form-input::placeholder, .form-textarea::placeholder { color: var(--text-muted); }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    .form-textarea {
      min-height: 80px;
      resize: vertical;
    }

    .role-selector {
      margin-bottom: 24px;
    }

    .role-selector select {
      width: 100%;
      padding: 14px 16px;
      background: var(--surface-elevated);
      border: 2px solid var(--border);
      border-radius: 12px;
      color: var(--text);
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .role-selector select:focus {
      outline: none;
      border-color: var(--primary);
    }

    .framework-selector {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 12px;
    }

    .framework-tag {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: var(--surface-elevated);
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      user-select: none;
    }

    .framework-tag:hover {
      border-color: var(--primary);
    }

    .framework-tag.selected {
      background: rgba(37, 99, 235, 0.2);
      border-color: var(--primary);
      color: #60a5fa;
    }

    .framework-tag input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: var(--primary);
    }

    .framework-tag.add-btn {
      border-style: dashed;
      color: var(--text-muted);
    }

    .control-group {
      border: 1px solid var(--border);
      border-radius: 12px;
      margin-bottom: 12px;
      overflow: hidden;
    }

    .control-group.excluded {
      opacity: 0.5;
      border-style: dashed;
    }

    .cg-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 16px;
      background: var(--surface-elevated);
      cursor: pointer;
      transition: background 0.2s;
    }

    .cg-header:hover {
      background: rgba(30, 58, 95, 0.5);
    }

    .cg-title {
      font-weight: 600;
      font-size: 0.95rem;
      flex: 1;
    }

    .cg-status {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .cg-count {
      font-size: 0.8rem;
      color: var(--text-muted);
      background: var(--bg);
      padding: 4px 10px;
      border-radius: 12px;
    }

    .cg-toggle {
      color: var(--text-muted);
      font-size: 0.9rem;
      width: 20px;
      text-align: center;
    }

    .cg-exclude, .cg-include {
      width: 24px;
      height: 24px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      cursor: pointer;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text-muted);
    }

    .cg-exclude:hover {
      background: #7f1d1d;
      border-color: #991b1b;
      color: #fecaca;
    }

    .cg-include:hover {
      background: #166534;
      border-color: #166534;
      color: #86efac;
    }

    .cg-body {
      display: none;
      padding: 12px 16px;
      background: var(--bg);
    }

    .cg-body.open {
      display: block;
    }

    .cg-description {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    .evidence-item {
      display: flex;
      gap: 10px;
      align-items: flex-start;
      padding: 12px;
      margin-bottom: 8px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--surface);
    }

    .evidence-item.included {
      border-color: var(--primary);
      background: rgba(37, 99, 235, 0.1);
    }

    .evidence-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      margin-top: 2px;
      accent-color: var(--primary);
      flex-shrink: 0;
    }

    .ei-content {
      flex: 1;
      min-width: 0;
    }

    .ei-title {
      font-weight: 500;
      margin-bottom: 4px;
    }

    .ei-hint {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .ei-instr {
      margin-top: 8px;
    }

    .ei-instr label {
      font-size: 0.8rem;
      color: var(--text-muted);
      display: block;
      margin-bottom: 4px;
    }

    .ei-instr textarea {
      width: 100%;
      min-height: 50px;
      padding: 8px 10px;
      font-size: 0.9rem;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      resize: vertical;
    }

    .ei-instr textarea::placeholder {
      color: #6b7a9a;
    }

    .ei-instr textarea:focus {
      outline: none;
      border-color: var(--primary);
    }

    .more-toggle {
      margin: 12px 0;
      padding: 10px 14px;
      font-size: 0.9rem;
      color: #7a9bff;
      cursor: pointer;
      background: var(--surface);
      border: 1px dashed var(--border);
      border-radius: 8px;
      text-align: center;
    }

    .more-toggle:hover {
      background: var(--surface-elevated);
      border-color: var(--primary);
    }

    .add-custom-section {
      margin-top: 16px;
      padding: 16px;
      border: 1px dashed var(--border);
      border-radius: 10px;
      background: rgba(0,0,0,0.2);
    }

    .add-custom-section h4 {
      margin: 0 0 12px;
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .custom-form {
      display: grid;
      gap: 10px;
    }

    .custom-form input,
    .custom-form textarea {
      background: var(--bg);
    }

    .global-instructions {
      padding: 16px;
      border-top: 1px solid var(--border);
      margin-top: 12px;
    }

    .global-instructions textarea {
      min-height: 70px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px 24px;
      font-size: 1rem;
      font-weight: 600;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      text-decoration: none;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      background: var(--primary-hover);
      transform: translateY(-1px);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-accent {
      background: var(--accent);
      color: white;
    }

    .btn-accent:hover:not(:disabled) {
      background: var(--accent-hover);
      transform: translateY(-1px);
    }

    .btn-accent:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-outline {
      background: transparent;
      border: 2px solid var(--border);
      color: var(--text);
    }

    .btn-outline:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    .btn-full {
      width: 100%;
    }

    .btn-sm {
      padding: 8px 14px;
      font-size: 0.9rem;
    }

    /* Payment section */
    .payment-section {
      display: none;
      background: var(--surface-elevated);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      margin-top: 24px;
    }

    .payment-section.visible {
      display: block;
    }

    .payment-header {
      text-align: center;
      margin-bottom: 20px;
    }

    .payment-header h3 {
      font-size: 1.1rem;
      margin-bottom: 4px;
    }

    .payment-header p {
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    .code-entry {
      background: var(--bg);
      border-radius: 12px;
      padding: 16px;
    }

    .code-input {
      width: 100%;
      padding: 14px 16px;
      font-size: 1.1rem;
      font-weight: 600;
      letter-spacing: 2px;
      text-transform: uppercase;
      background: var(--surface);
      border: 2px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      text-align: center;
    }

    .code-input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .code-input.valid {
      border-color: var(--accent);
    }

    .code-input.invalid {
      border-color: var(--error);
    }

    .code-status {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-top: 12px;
      font-size: 0.9rem;
      min-height: 24px;
    }

    .code-status.valid { color: var(--accent); }
    .code-status.invalid { color: var(--error); }
    .code-status.checking { color: var(--text-muted); }

    .purchase-section {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
    }

    .purchase-section.hidden {
      display: none;
    }

    .divider-text {
      text-align: center;
      color: var(--text-muted);
      font-size: 0.9rem;
      margin-bottom: 16px;
    }

    .pricing-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }

    .pricing-card {
      background: var(--bg);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .pricing-card:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
    }

    .pricing-card.selected {
      border-color: var(--accent);
      background: rgba(16, 185, 129, 0.1);
    }

    .pricing-card-name {
      font-weight: 600;
      font-size: 0.95rem;
      margin-bottom: 4px;
    }

    .pricing-card-price {
      font-size: 1.4rem;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 4px;
    }

    .pricing-card-desc {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .success-banner {
      display: none;
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(16, 185, 129, 0.1));
      border: 1px solid var(--accent);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 24px;
      text-align: center;
    }

    .success-banner.visible {
      display: block;
    }

    .success-banner h3 {
      color: var(--accent);
      margin-bottom: 8px;
    }

    .success-banner p {
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    .success-banner .code-display {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--accent);
      letter-spacing: 3px;
      font-family: monospace;
      margin: 12px 0;
    }

    .how-section {
      padding: 48px 24px;
      max-width: 900px;
      margin: 0 auto;
    }

    .how-section h2 {
      text-align: center;
      margin-bottom: 32px;
      font-size: 1.5rem;
    }

    .how-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
    }

    .how-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
    }

    .how-card h3 {
      font-size: 1rem;
      margin-bottom: 8px;
    }

    .how-card p {
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    .footer {
      text-align: center;
      padding: 32px 24px;
      color: var(--text-muted);
      font-size: 0.85rem;
      border-top: 1px solid var(--border);
    }

    .marquee-fixed {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      height: var(--marquee-height);
      display: flex;
      align-items: center;
      border-top: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0));
      backdrop-filter: blur(6px);
      z-index: 9999;
      overflow: hidden;
    }

    .marquee {
      white-space: nowrap;
      width: 100%;
      overflow: hidden;
    }

    .marquee > div {
      display: inline-block;
      padding-left: 100%;
      animation: scroll 28s linear infinite;
      color: #b9c6ff;
      opacity: 0.9;
    }

    @keyframes scroll {
      0% { transform: translateX(0); }
      100% { transform: translateX(-100%); }
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }

    .modal-overlay.hidden {
      display: none;
    }

    .modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      max-width: 500px;
      width: 90%;
    }

    .modal h3 {
      margin: 0 0 16px;
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 16px;
    }

    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      display: inline-block;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
      .how-grid { grid-template-columns: 1fr; }
      .pricing-grid { grid-template-columns: 1fr 1fr; }
    }

    @media (max-width: 600px) {
      .hero { padding: 32px 16px; }
      .main-container { padding: 16px; }
      .card { padding: 20px; }
      .form-row { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header class="header">
    <a href="/" class="logo">
      <div class="logo-icon">
        <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
      </div>
      ProofRepo
    </a>
    <nav class="header-links">
      <a href="#how-it-works">How it works</a>
      <a id="getStartedLink">Get started</a>
    </nav>
  </header>

  <section class="hero">
    <div class="hero-badge">Compliance ProofPacks in Seconds</div>
    <h1>Streamlined evidence collection — without the chaos</h1>
    <p><strong>Auditors:</strong> Define exactly what evidence you need. Send your client a guided upload link.</p>
    <p><strong>Companies:</strong> Upload evidence with clear guidance. No more "wrong file" corrections.</p>
    <div class="hero-features">
      <div class="hero-feature">
        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
        <span><strong>Auditor-defined requests:</strong> Specify exactly what you need.</span>
      </div>
      <div class="hero-feature">
        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
        <span><strong>Guided for clients:</strong> Clear checklist shows what to upload.</span>
      </div>
      <div class="hero-feature">
        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
        <span><strong>Structured output:</strong> Files mapped to controls, ready for workpapers.</span>
      </div>
    </div>
  </section>

  <main class="main-container">
    <!-- Success Banner -->
    <div id="successBanner" class="success-banner">
      <h3>✓ Payment Successful!</h3>
      <p>Your code is ready to use:</p>
      <div class="code-display" id="successCodeDisplay">—</div>
      <p style="font-size: 0.85rem;">This code has been auto-filled below. Click "Send Request" when ready.</p>
    </div>

    <div id="mainFormCard" class="card">
      <div class="card-header">
        <h2>Request compliance evidence</h2>
        <p>Choose your role to get started.</p>
      </div>

      <div class="role-selector">
        <label class="form-label">What brings you here?</label>
        <select id="roleSelect">
          <option value="">Select your role...</option>
          <option value="auditor">I'm an auditor requesting evidence from a client</option>
          <option value="client">I'm responding to an evidence request</option>
        </select>
      </div>

      <div id="auditorFlow" style="display: none;">
        <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 20px;">
          Define what evidence you need, then we'll email your client a guided upload link.
        </p>

        <div class="form-group">
          <label class="form-label">Your email (auditor)</label>
          <input type="email" class="form-input" id="auditorEmail" placeholder="auditor@firm.com">
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Client company</label>
            <input type="text" class="form-input" id="clientCompany" placeholder="Acme Corp">
          </div>
          <div class="form-group">
            <label class="form-label">Client's email</label>
            <input type="email" class="form-input" id="clientEmail" placeholder="client@company.com">
          </div>
        </div>

        <!-- Simplified Deadline - NO TIME PICKER -->
        <div class="form-group">
          <label class="form-label">Deadline</label>
          <select class="form-select" id="deadlineSelect">
            <option value="8">8 hours</option>
            <option value="12">12 hours</option>
            <option value="24">24 hours</option>
            <option value="48">2 days</option>
            <option value="72">3 days</option>
            <option value="120" selected>5 days</option>
            <option value="168">1 week</option>
            <option value="240">10 days</option>
            <option value="336">2 weeks</option>
            <option value="504">3 weeks</option>
            <option value="720">1 month</option>
            <option value="1080">45 days</option>
            <option value="1440">2 months</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Evidence Request</label>
          <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 12px;">
            Check frameworks, then customize what evidence you need. Items with ✓ are included by default.
          </p>
          <div id="composer"></div>
        </div>

        <!-- Payment Section -->
        <div id="paymentSection" class="payment-section">
          <div class="payment-header">
            <h3>Enter your credit code</h3>
            <p>Each code gives you credits to send evidence requests.</p>
          </div>

          <div class="code-entry">
            <label class="form-label">Credit Code</label>
            <input type="text" class="code-input" id="auditorCode" placeholder="ENTER CODE">
            <div id="codeStatus" class="code-status"></div>
          </div>

          <!-- Purchase section - hidden after checkout return -->
          <div id="purchaseSection" class="purchase-section">
            <p class="divider-text">— or purchase credits —</p>
            <div class="pricing-grid">
              <div class="pricing-card" data-tier="single">
                <div class="pricing-card-name">Single</div>
                <div class="pricing-card-price">$59</div>
                <div class="pricing-card-desc">1 credit</div>
              </div>
              <div class="pricing-card" data-tier="pack5">
                <div class="pricing-card-name">5-Pack</div>
                <div class="pricing-card-price">$249</div>
                <div class="pricing-card-desc">$50 each</div>
              </div>
              <div class="pricing-card" data-tier="pack15">
                <div class="pricing-card-name">15-Pack</div>
                <div class="pricing-card-price">$499</div>
                <div class="pricing-card-desc">$33 each</div>
              </div>
              <div class="pricing-card" data-tier="pack50">
                <div class="pricing-card-name">50-Pack</div>
                <div class="pricing-card-price">$1,249</div>
                <div class="pricing-card-desc">$25 each</div>
              </div>
            </div>
            <button class="btn btn-outline btn-full" id="buyCreditsBtn" disabled>
              Select a plan to purchase
            </button>
          </div>
        </div>

        <!-- Main Action Button -->
        <button class="btn btn-primary btn-full" id="mainActionBtn" style="margin-top: 24px;">
          Continue
        </button>
      </div>

      <div id="clientFlow" style="display: none;">
        <p style="color: var(--text-muted);">
          Please use the link provided by your auditor to upload evidence. 
          If you don't have a link, contact your auditor to request one.
        </p>
      </div>
    </div>
  </main>

  <section id="how-it-works" class="how-section">
    <h2>How it works</h2>
    <div class="how-grid">
      <div class="how-card">
        <h3>1. Auditor creates request</h3>
        <p>Select frameworks, customize evidence items, add instructions for your client.</p>
      </div>
      <div class="how-card">
        <h3>2. Client uploads</h3>
        <p>Client receives a link with a clear checklist of exactly what to provide.</p>
      </div>
      <div class="how-card">
        <h3>3. ProofPack ready</h3>
        <p>Files organized by control area with a manifest ready for workpapers.</p>
      </div>
    </div>
  </section>

  <footer class="footer">
    <p>© <span id="year"></span> ProofRepo • <a href="mailto:support@proofrepo.com" style="color: #9db0ff;">support@proofrepo.com</a></p>
  </footer>

  <div class="marquee-fixed">
    <div class="marquee">
      <div>&nbsp;Guided compliance evidence collection • Built for auditors • SOC 2, ISO 27001, HIPAA, GDPR & more • Get started with a free trial •&nbsp;&nbsp;&nbsp;&nbsp;Guided compliance evidence collection • Built for auditors • SOC 2, ISO 27001, HIPAA, GDPR & more • Get started with a free trial •</div>
    </div>
  </div>

  <div id="addFwModal" class="modal-overlay hidden">
    <div class="modal">
      <h3>Add Custom Framework</h3>
      <div class="form-group">
        <label class="form-label">Framework name</label>
        <input type="text" class="form-input" id="customFwName" placeholder="e.g., PCI DSS, FedRAMP, Internal Audit">
      </div>
      <div class="form-group">
        <label class="form-label">Description (optional)</label>
        <input type="text" class="form-input" id="customFwDesc" placeholder="Brief description">
      </div>
      <div class="modal-actions">
        <button type="button" class="btn btn-outline" id="cancelFwBtn">Cancel</button>
        <button type="button" class="btn btn-primary" id="saveFwBtn">Add Framework</button>
      </div>
    </div>
  </div>

  <div id="addGroupModal" class="modal-overlay hidden">
    <div class="modal">
      <h3>Add Control Group</h3>
      <div class="form-group">
        <label class="form-label">Control group name</label>
        <input type="text" class="form-input" id="customGroupName" placeholder="e.g., Network Security, Physical Security">
      </div>
      <div class="form-group">
        <label class="form-label">Description (optional)</label>
        <input type="text" class="form-input" id="customGroupDesc" placeholder="What this control group covers">
      </div>
      <input type="hidden" id="customGroupFwKey" value="">
      <div class="modal-actions">
        <button type="button" class="btn btn-outline" id="cancelGroupBtn">Cancel</button>
        <button type="button" class="btn btn-primary" id="saveGroupBtn">Add Control Group</button>
      </div>
    </div>
  </div>

<script>
const API = 'https://proofrepo-intake.atucker5.workers.dev';
const STORAGE_KEY = 'proofrepo_form_state';

const FRAMEWORK_LIBRARY = {
  SOC2: {
    label: 'SOC 2', description: 'Service Organization Control 2', defaultOn: true,
    controlGroups: [
      { id: 'governance', title: 'Governance & Policies', description: 'Security policies and organizational governance',
        items: [
          { id: 'info_sec_policy', title: 'Information Security Policy', common: true, hint: 'Current policy document with approval date' },
          { id: 'security_roles', title: 'Security Roles & Responsibilities', common: true, hint: 'Org chart or RACI showing security ownership' },
          { id: 'acceptable_use', title: 'Acceptable Use Policy', common: true, hint: 'Employee IT usage guidelines' },
          { id: 'code_of_conduct', title: 'Code of Conduct', common: false, hint: 'Ethics and conduct expectations' },
          { id: 'data_classification', title: 'Data Classification Policy', common: false, hint: 'How data is categorized by sensitivity' },
          { id: 'remote_work', title: 'Remote Work Policy', common: false, hint: 'Security requirements for remote workers' },
        ]},
      { id: 'risk', title: 'Risk Assessment', description: 'How risks are identified and managed',
        items: [
          { id: 'risk_assessment', title: 'Risk Assessment', common: true, hint: 'Most recent risk assessment with ratings' },
          { id: 'risk_register', title: 'Risk Register', common: true, hint: 'List of risks with owners and status' },
          { id: 'risk_treatment', title: 'Risk Treatment Plan', common: true, hint: 'How identified risks are being addressed' },
          { id: 'risk_acceptance', title: 'Risk Acceptance Documentation', common: false, hint: 'Formal acceptance of residual risks' },
        ]},
      { id: 'awareness', title: 'Security Awareness & Training', description: 'Employee security education',
        items: [
          { id: 'security_training', title: 'Security Awareness Training', common: true, hint: 'Training completion report or LMS screenshot' },
          { id: 'training_materials', title: 'Training Materials', common: false, hint: 'Topics covered in training' },
          { id: 'phishing_testing', title: 'Phishing Test Results', common: false, hint: 'Simulated phishing campaign results' },
        ]},
      { id: 'incident', title: 'Incident Response', description: 'How security incidents are handled',
        items: [
          { id: 'ir_plan', title: 'Incident Response Plan', common: true, hint: 'IR procedures and escalation paths' },
          { id: 'ir_team', title: 'IR Team Contacts', common: true, hint: 'Who is on the IR team' },
          { id: 'incident_log', title: 'Security Incident Log', common: true, hint: 'Record of incidents (or attestation of none)' },
          { id: 'ir_testing', title: 'IR Plan Testing', common: false, hint: 'Tabletop exercises or IR tests' },
          { id: 'postmortem', title: 'Incident Postmortems', common: false, hint: 'Post-incident review samples' },
        ]},
      { id: 'access', title: 'Access Control', description: 'How user access is managed',
        items: [
          { id: 'access_review', title: 'User Access Review', common: true, hint: 'Periodic access review with approvals' },
          { id: 'mfa_evidence', title: 'MFA Enforcement', common: true, hint: 'Screenshot showing MFA is required' },
          { id: 'access_policy', title: 'Access Control Policy', common: true, hint: 'Policy defining access principles' },
          { id: 'jml_process', title: 'Joiner/Mover/Leaver Process', common: true, hint: 'How access is granted and revoked' },
          { id: 'jml_samples', title: 'JML Process Samples', common: false, hint: '2-3 onboarding/offboarding examples' },
          { id: 'privileged_list', title: 'Privileged Access List', common: true, hint: 'Admin users and justification' },
          { id: 'privileged_controls', title: 'Privileged Access Controls', common: false, hint: 'PAM, just-in-time access, etc.' },
          { id: 'sso_config', title: 'SSO Configuration', common: false, hint: 'Single sign-on setup' },
          { id: 'password_policy', title: 'Password Policy', common: false, hint: 'Password requirements' },
        ]},
      { id: 'operations', title: 'System Operations & Monitoring', description: 'How systems are monitored and maintained',
        items: [
          { id: 'logging', title: 'Logging & Audit Trails', common: true, hint: 'What is logged, where, retention period' },
          { id: 'monitoring', title: 'Monitoring & Alerting', common: true, hint: 'Tools used and how alerts are handled' },
          { id: 'siem', title: 'SIEM / Log Aggregation', common: false, hint: 'Centralized logging solution' },
          { id: 'vuln_scanning', title: 'Vulnerability Scanning', common: true, hint: 'Scan results or summary' },
          { id: 'patch_mgmt', title: 'Patch Management', common: false, hint: 'How patches are applied' },
          { id: 'endpoint', title: 'Endpoint Protection', common: false, hint: 'Antivirus/EDR coverage' },
          { id: 'backups', title: 'Backup & Recovery', common: false, hint: 'Backup config and testing' },
        ]},
      { id: 'change', title: 'Change Management', description: 'How changes are controlled',
        items: [
          { id: 'change_log', title: 'Change Log / Deployments', common: true, hint: 'Record of recent changes' },
          { id: 'change_policy', title: 'Change Management Policy', common: true, hint: 'Change control requirements' },
          { id: 'code_review', title: 'Code Review Evidence', common: true, hint: 'PR approvals, branch protection' },
          { id: 'change_approval', title: 'Change Approval Process', common: false, hint: 'How changes are approved' },
          { id: 'emergency_change', title: 'Emergency Change Process', common: false, hint: 'How urgent changes work' },
        ]},
      { id: 'vendor', title: 'Vendor Management', description: 'How third-party risks are managed',
        items: [
          { id: 'vendor_list', title: 'Vendor Inventory', common: true, hint: 'List with risk tiers' },
          { id: 'vendor_policy', title: 'Vendor Management Policy', common: true, hint: 'Policy for vendor evaluation' },
          { id: 'vendor_assessments', title: 'Vendor Assessments', common: false, hint: 'Sample security questionnaires' },
          { id: 'critical_vendors', title: 'Critical Vendors List', common: false, hint: 'Cloud providers, key dependencies' },
        ]},
    ]
  },
  ISO27001: {
    label: 'ISO 27001', description: 'Information Security Management System', defaultOn: false,
    controlGroups: [
      { id: 'isms', title: 'ISMS Documentation', description: 'Core ISMS documents',
        items: [
          { id: 'scope', title: 'ISMS Scope', common: true, hint: 'Boundaries of ISMS' },
          { id: 'policy', title: 'ISMS Policy', common: true, hint: 'Top-level security policy' },
          { id: 'soa', title: 'Statement of Applicability', common: true, hint: 'Which controls apply' },
          { id: 'risk_iso', title: 'Risk Assessment', common: true, hint: 'ISO 27001 risk assessment' },
          { id: 'risk_treatment_iso', title: 'Risk Treatment Plan', common: true, hint: 'How risks are treated' },
          { id: 'internal_audit', title: 'Internal Audit Results', common: true, hint: 'Recent ISMS audit' },
          { id: 'mgmt_review', title: 'Management Review', common: true, hint: 'Management review minutes' },
        ]},
      { id: 'annex', title: 'Annex A Controls', description: 'Evidence for applicable controls',
        items: [
          { id: 'asset_inventory', title: 'Asset Inventory', common: true, hint: 'Information assets list' },
          { id: 'access_iso', title: 'Access Control', common: true, hint: 'Access control implementation' },
          { id: 'crypto', title: 'Cryptography', common: false, hint: 'Encryption controls' },
          { id: 'physical', title: 'Physical Security', common: false, hint: 'Physical access controls' },
          { id: 'supplier', title: 'Supplier Security', common: false, hint: 'Third-party management' },
        ]},
    ]
  },
  HIPAA: {
    label: 'HIPAA', description: 'Health Insurance Portability and Accountability Act', defaultOn: false,
    controlGroups: [
      { id: 'admin', title: 'Administrative Safeguards', description: 'Administrative controls for PHI',
        items: [
          { id: 'risk_hipaa', title: 'Security Risk Analysis', common: true, hint: 'HIPAA risk analysis' },
          { id: 'policies_hipaa', title: 'HIPAA Policies', common: true, hint: 'Security policies' },
          { id: 'training_hipaa', title: 'Workforce Training', common: true, hint: 'HIPAA training records' },
          { id: 'sanctions', title: 'Sanction Policy', common: false, hint: 'Violation consequences' },
        ]},
      { id: 'technical', title: 'Technical Safeguards', description: 'Technical controls for PHI',
        items: [
          { id: 'access_hipaa', title: 'Access Controls', common: true, hint: 'PHI access controls' },
          { id: 'audit_hipaa', title: 'Audit Controls', common: true, hint: 'PHI access logging' },
          { id: 'integrity', title: 'Integrity Controls', common: false, hint: 'PHI integrity mechanisms' },
          { id: 'transmission', title: 'Transmission Security', common: false, hint: 'PHI encryption in transit' },
        ]},
      { id: 'ba', title: 'Business Associates', description: 'BA agreements',
        items: [
          { id: 'baa_list', title: 'BAA Inventory', common: true, hint: 'List of BAAs' },
          { id: 'baa_samples', title: 'Sample BAAs', common: false, hint: 'Executed BAA examples' },
        ]},
    ]
  },
  GDPR: {
    label: 'GDPR', description: 'General Data Protection Regulation', defaultOn: false,
    controlGroups: [
      { id: 'core', title: 'Core Requirements', description: 'Fundamental GDPR compliance',
        items: [
          { id: 'ropa', title: 'Record of Processing Activities', common: true, hint: 'Article 30 records' },
          { id: 'privacy_notice', title: 'Privacy Notice', common: true, hint: 'Public privacy policy' },
          { id: 'lawful_basis', title: 'Lawful Basis Documentation', common: true, hint: 'Legal basis per activity' },
          { id: 'dpia', title: 'Data Protection Impact Assessments', common: false, hint: 'DPIAs for high-risk processing' },
        ]},
      { id: 'rights', title: 'Data Subject Rights', description: 'Handling data subject requests',
        items: [
          { id: 'dsar', title: 'DSAR Process', common: true, hint: 'How requests are handled' },
          { id: 'consent', title: 'Consent Records', common: false, hint: 'Consent mechanisms' },
        ]},
      { id: 'processors', title: 'Processors & Transfers', description: 'Third parties and transfers',
        items: [
          { id: 'dpa', title: 'Data Processing Agreements', common: true, hint: 'DPAs with processors' },
          { id: 'transfers', title: 'Transfer Mechanisms', common: false, hint: 'SCCs, adequacy, etc.' },
        ]},
    ]
  }
};

let composerState = {};
let customFrameworks = [];
let state = { 
  role: '', 
  code: '', 
  codeValid: false, 
  codeCredits: 0, 
  selectedTier: null, 
  paymentVisible: false,
  isCheckoutReturn: false
};

const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
const esc = s => String(s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');

// ==================== LOCAL STORAGE ====================

function saveFormState() {
  try {
    const data = {
      role: $('#roleSelect')?.value || '',
      auditorEmail: $('#auditorEmail')?.value || '',
      clientCompany: $('#clientCompany')?.value || '',
      clientEmail: $('#clientEmail')?.value || '',
      deadlineHours: $('#deadlineSelect')?.value || '120',
      globalInstructions: $('#globalInstructions')?.value || '',
      appliedCode: state.code || '',
      composerState: composerState,
      customFrameworks: customFrameworks,
      savedAt: Date.now()
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  } catch (e) { console.warn('Could not save form state:', e); }
}

function loadFormState() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return null;
    const data = JSON.parse(raw);
    if (data.savedAt && (Date.now() - data.savedAt) > 24 * 60 * 60 * 1000) {
      localStorage.removeItem(STORAGE_KEY);
      return null;
    }
    return data;
  } catch (e) { return null; }
}

function restoreFormState(data) {
  if (!data) return false;
  if (data.role) $('#roleSelect').value = data.role;
  if (data.auditorEmail) $('#auditorEmail').value = data.auditorEmail;
  if (data.clientCompany) $('#clientCompany').value = data.clientCompany;
  if (data.clientEmail) $('#clientEmail').value = data.clientEmail;
  if (data.deadlineHours) $('#deadlineSelect').value = data.deadlineHours;
  if (data.appliedCode) { 
    state.code = data.appliedCode; 
    if ($('#auditorCode')) $('#auditorCode').value = data.appliedCode; 
  }
  if (data.composerState && Object.keys(data.composerState).length) composerState = data.composerState;
  if (data.customFrameworks && data.customFrameworks.length) customFrameworks = data.customFrameworks;
  return true;
}

function clearFormState() { 
  try { localStorage.removeItem(STORAGE_KEY); } catch (e) {} 
}

function setupAutoSave() {
  ['roleSelect', 'auditorEmail', 'clientCompany', 'clientEmail', 'deadlineSelect'].forEach(id => {
    const el = $(`#${id}`);
    if (el) { 
      el.addEventListener('change', saveFormState); 
      el.addEventListener('input', saveFormState); 
    }
  });
}

// ==================== DEADLINE LOGIC (SIMPLIFIED) ====================

function calculateDeadline() {
  const hours = parseInt($('#deadlineSelect')?.value || '120', 10);
  const deadline = new Date();
  deadline.setTime(deadline.getTime() + hours * 60 * 60 * 1000);
  return deadline;
}

// ==================== FRAMEWORK HELPERS ====================

function getAllFrameworks() {
  const all = { ...FRAMEWORK_LIBRARY };
  customFrameworks.forEach(f => { all[f.id] = f; });
  return all;
}

function initComposerState() {
  composerState = {};
  const allFw = getAllFrameworks();
  for (const [fwKey, fw] of Object.entries(allFw)) {
    composerState[fwKey] = { enabled: fw.defaultOn || false, groups: {} };
    for (const g of (fw.controlGroups || [])) {
      composerState[fwKey].groups[g.id] = { expanded: false, showMore: false, excluded: false, items: {} };
      for (const item of (g.items || [])) {
        composerState[fwKey].groups[g.id].items[item.id] = { included: item.common, instructions: '' };
      }
    }
  }
}

// ==================== COMPOSER RENDERING ====================

function renderComposer() {
  const c = $('#composer');
  if (!c) return;
  const allFw = getAllFrameworks();
  let html = '<div class="framework-selector">';
  for (const [fwKey, fw] of Object.entries(allFw)) {
    const on = composerState[fwKey]?.enabled;
    html += `<label class="framework-tag ${on ? 'selected' : ''}"><input type="checkbox" ${on ? 'checked' : ''} data-fw-toggle="${esc(fwKey)}">${on ? '✓' : ''} ${esc(fw.label)}</label>`;
  }
  html += '<button type="button" class="framework-tag add-btn" id="addFwChip">+ Add framework</button></div>';
  for (const [fwKey, fw] of Object.entries(allFw)) {
    if (!composerState[fwKey]?.enabled) continue;
    html += renderFwBody(fwKey, fw);
  }
  const savedGlobalInstr = $('#globalInstructions')?.value || '';
  html += `<div class="global-instructions"><label class="form-label">Overall instructions for client</label><textarea class="form-textarea" id="globalInstructions" placeholder="Example: Please provide evidence covering Jan–Dec 2025. Screenshots acceptable. Redact any secrets or credentials.">${esc(savedGlobalInstr)}</textarea><p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 6px;">Shown prominently to your client above the checklist.</p></div>`;
  c.innerHTML = html;
  wireComposer();
  const gi = $('#globalInstructions');
  if (gi) gi.addEventListener('input', saveFormState);
}

function renderFwBody(fwKey, fw) {
  let html = `<div style="margin-top: 16px; margin-bottom: 8px;"><strong>${esc(fw.label)}</strong>${fw.description ? ` <span style="color: var(--text-muted);">— ${esc(fw.description)}</span>` : ''}</div>`;
  for (const g of (fw.controlGroups || [])) html += renderGroup(fwKey, g);
  html += `<button type="button" class="btn btn-sm btn-outline" style="width: 100%; margin-top: 8px; border-style: dashed;" data-add-group-btn="${esc(fwKey)}">+ Add control group</button>`;
  return html;
}

function renderGroup(fwKey, g) {
  const gs = composerState[fwKey]?.groups?.[g.id];
  const exp = gs?.expanded, more = gs?.showMore, excluded = gs?.excluded;
  const common = (g.items || []).filter(i => i.common), extra = (g.items || []).filter(i => !i.common);
  const includedCount = (g.items || []).filter(i => gs?.items?.[i.id]?.included && !excluded).length;
  const totalCount = (g.items || []).length;
  let html = `<div class="control-group ${excluded ? 'excluded' : ''}" data-fw="${esc(fwKey)}" data-group="${esc(g.id)}"><div class="cg-header"><span class="cg-title">${esc(g.title)}</span><div class="cg-status">${excluded ? `<span style="color: var(--text-muted); font-size: 0.8rem;">Excluded</span><button type="button" class="cg-include" data-include-group="${esc(fwKey)}-${esc(g.id)}" title="Include">+</button>` : `<span class="cg-count">${includedCount}/${totalCount}</span><button type="button" class="cg-exclude" data-exclude-group="${esc(fwKey)}-${esc(g.id)}" title="Exclude">×</button>`}<span class="cg-toggle">${exp ? '▼' : '▶'}</span></div></div><div class="cg-body ${exp ? 'open' : ''}">`;
  if (excluded) {
    html += `<p style="color: var(--text-muted); text-align: center; padding: 12px;">This control group is excluded from the request.</p>`;
  } else {
    if (g.description) html += `<p class="cg-description">${esc(g.description)}</p>`;
    for (const item of common) html += renderItem(fwKey, g.id, item, gs);
    if (extra.length) {
      html += `<div class="extra-items" style="display: ${more ? 'block' : 'none'};">`;
      for (const item of extra) html += renderItem(fwKey, g.id, item, gs);
      html += '</div>';
      html += `<div class="more-toggle" data-fw="${esc(fwKey)}" data-group="${esc(g.id)}">${more ? '− Show fewer options' : `+ Show ${extra.length} more options`}</div>`;
    }
    html += `<div class="add-custom-section"><h4>Add custom request to "${esc(g.title)}"</h4><div class="custom-form"><input class="form-input" placeholder="e.g., Network Diagram, Encryption Key Rotation Log" data-custom-name="${esc(fwKey)}-${esc(g.id)}"><textarea class="form-textarea" placeholder="Instructions for client (describe what you need, date ranges, format...)" data-custom-instr="${esc(fwKey)}-${esc(g.id)}" style="min-height: 50px;"></textarea><button type="button" class="btn btn-sm btn-outline" data-add-item="${esc(fwKey)}" data-group="${esc(g.id)}">+ Add request</button></div></div>`;
  }
  html += '</div></div>';
  return html;
}

function renderItem(fwKey, gid, item, gs) {
  const st = gs?.items?.[item.id];
  const inc = st?.included ?? item.common;
  const instr = st?.instructions || '';
  return `<div class="evidence-item ${inc ? 'included' : ''}" data-fw="${esc(fwKey)}" data-group="${esc(gid)}" data-item="${esc(item.id)}"><input type="checkbox" ${inc ? 'checked' : ''}><div class="ei-content"><div class="ei-title">${esc(item.title)}</div>${item.hint ? `<div class="ei-hint">${esc(item.hint)}</div>` : ''}<div class="ei-instr"><label>Instructions for client (optional)</label><textarea placeholder="e.g., Please include date range, reviewer sign-off, specific format..." data-item-instr="${esc(fwKey)}-${esc(gid)}-${esc(item.id)}">${esc(instr)}</textarea></div></div></div>`;
}

function wireComposer() {
  $$('[data-fw-toggle]').forEach(cb => {
    cb.addEventListener('change', e => {
      const k = e.target.dataset.fwToggle;
      if (!composerState[k]) composerState[k] = { enabled: false, groups: {} };
      composerState[k].enabled = e.target.checked;
      const allFw = getAllFrameworks();
      const fw = allFw[k];
      if (fw && composerState[k].enabled) {
        for (const g of (fw.controlGroups || [])) {
          if (!composerState[k].groups[g.id]) {
            composerState[k].groups[g.id] = { expanded: false, showMore: false, excluded: false, items: {} };
            for (const item of (g.items || [])) composerState[k].groups[g.id].items[item.id] = { included: item.common, instructions: '' };
          }
        }
      }
      renderComposer();
      saveFormState();
    });
  });
  $$('.cg-header').forEach(h => {
    h.addEventListener('click', e => {
      if (e.target.closest('.cg-exclude') || e.target.closest('.cg-include')) return;
      const g = h.closest('.control-group');
      const fk = g.dataset.fw, gid = g.dataset.group;
      composerState[fk].groups[gid].expanded = !composerState[fk].groups[gid].expanded;
      renderComposer();
    });
  });
  $$('[data-exclude-group]').forEach(btn => {
    btn.addEventListener('click', e => { e.stopPropagation(); const [fk, gid] = btn.dataset.excludeGroup.split('-'); composerState[fk].groups[gid].excluded = true; renderComposer(); saveFormState(); });
  });
  $$('[data-include-group]').forEach(btn => {
    btn.addEventListener('click', e => { e.stopPropagation(); const [fk, gid] = btn.dataset.includeGroup.split('-'); composerState[fk].groups[gid].excluded = false; renderComposer(); saveFormState(); });
  });
  $$('.more-toggle').forEach(t => {
    t.addEventListener('click', e => { e.stopPropagation(); const fk = t.dataset.fw, gid = t.dataset.group; composerState[fk].groups[gid].showMore = !composerState[fk].groups[gid].showMore; renderComposer(); });
  });
  $$('.evidence-item input[type="checkbox"]').forEach(cb => {
    cb.addEventListener('change', e => { const el = e.target.closest('.evidence-item'); const { fw, group, item } = el.dataset; composerState[fw].groups[group].items[item].included = e.target.checked; renderComposer(); saveFormState(); });
  });
  $$('[data-item-instr]').forEach(ta => {
    ta.addEventListener('input', e => { const parts = ta.dataset.itemInstr.split('-'); const [fw, group] = [parts[0], parts[1]]; const item = parts.slice(2).join('-'); if (composerState[fw]?.groups?.[group]?.items?.[item]) composerState[fw].groups[group].items[item].instructions = e.target.value; saveFormState(); });
  });
  $$('[data-add-item]').forEach(btn => {
    btn.addEventListener('click', () => {
      const fk = btn.dataset.addItem, gid = btn.dataset.group;
      const nameInput = document.querySelector(`[data-custom-name="${fk}-${gid}"]`);
      const instrInput = document.querySelector(`[data-custom-instr="${fk}-${gid}"]`);
      const title = (nameInput?.value || '').trim(), instructions = (instrInput?.value || '').trim();
      if (!title) { alert('Please enter a request name.'); return; }
      const cid = 'c_' + Math.random().toString(36).slice(2, 8);
      const allFw = getAllFrameworks();
      const fw = allFw[fk], grp = fw?.controlGroups?.find(g => g.id === gid);
      if (grp) { grp.items.push({ id: cid, title, common: true, hint: '' }); composerState[fk].groups[gid].items[cid] = { included: true, instructions }; }
      nameInput.value = ''; instrInput.value = '';
      renderComposer(); saveFormState();
    });
  });
  $('#addFwChip')?.addEventListener('click', () => { $('#addFwModal').classList.remove('hidden'); });
  $$('[data-add-group-btn]').forEach(btn => {
    btn.addEventListener('click', () => { $('#customGroupFwKey').value = btn.dataset.addGroupBtn; $('#addGroupModal').classList.remove('hidden'); });
  });
}

function getPayload() {
  const result = [];
  const allFw = getAllFrameworks();
  for (const [fk, fs] of Object.entries(composerState)) {
    if (!fs.enabled) continue;
    const fw = allFw[fk];
    if (!fw) continue;
    for (const g of (fw.controlGroups || [])) {
      const gs = fs.groups?.[g.id];
      if (!gs || gs.excluded) continue;
      for (const item of (g.items || [])) {
        const is = gs.items?.[item.id];
        if (!is?.included) continue;
        result.push({ id: item.id, framework: fw.label || fk, group: g.title, title: item.title, instructions: is.instructions || '' });
      }
    }
  }
  return result;
}

// ==================== CODE VALIDATION ====================

async function validateCode(code) {
  if (!code) return { valid: false, error: 'No code entered' };
  
  try {
    const res = await fetch(`${API}/check-code?code=${encodeURIComponent(code)}`);
    const data = await res.json();
    
    if (data.ok && data.remaining > 0) {
      return { 
        valid: true, 
        credits: data.remaining,
        message: data.remaining >= 9999 ? 'Unlimited credits' : `${data.remaining} credit${data.remaining !== 1 ? 's' : ''} remaining`
      };
    } else if (data.remaining === 0) {
      return { valid: false, error: 'No credits remaining on this code' };
    } else {
      return { valid: false, error: 'Invalid code' };
    }
  } catch (e) {
    return { valid: false, error: 'Error checking code' };
  }
}

function updateCodeUI(result) {
  const codeInput = $('#auditorCode');
  const codeStatus = $('#codeStatus');
  
  if (!codeInput || !codeStatus) return;
  
  if (result.valid) {
    codeInput.classList.remove('invalid');
    codeInput.classList.add('valid');
    codeStatus.className = 'code-status valid';
    codeStatus.textContent = `✓ Valid — ${result.message}`;
    state.codeValid = true;
    state.codeCredits = result.credits;
  } else if (result.error) {
    codeInput.classList.remove('valid');
    codeInput.classList.add('invalid');
    codeStatus.className = 'code-status invalid';
    codeStatus.textContent = `✗ ${result.error}`;
    state.codeValid = false;
  } else {
    codeInput.classList.remove('valid', 'invalid');
    codeStatus.className = 'code-status';
    codeStatus.textContent = '';
    state.codeValid = false;
  }
}

// ==================== CHECKOUT RETURN ====================

async function checkCheckoutReturn() {
  const url = new URL(location.href);
  const sessionId = url.searchParams.get('session_id');
  if (!sessionId) return false;
  
  state.isCheckoutReturn = true;
  
  // Clear URL
  url.searchParams.delete('session_id');
  window.history.replaceState({}, '', url.toString());
  
  // Restore saved form state
  const savedState = loadFormState();
  if (savedState) {
    restoreFormState(savedState);
    if (savedState.role === 'auditor') {
      handleRoleChange('auditor');
    }
  } else {
    $('#roleSelect').value = 'auditor';
    handleRoleChange('auditor');
  }
  
  // Show payment section (but hide purchase options)
  showPaymentSection();
  $('#purchaseSection').classList.add('hidden');
  
  // Show success banner
  const successBanner = $('#successBanner');
  const successCodeDisplay = $('#successCodeDisplay');
  successBanner.classList.add('visible');
  successCodeDisplay.textContent = 'Loading...';
  
  const codeInput = $('#auditorCode');
  const codeStatus = $('#codeStatus');
  codeInput.value = '';
  codeInput.placeholder = 'Loading...';
  codeStatus.className = 'code-status checking';
  codeStatus.innerHTML = '<span class="spinner"></span> Retrieving your code...';
  
  // Aggressive polling - keep trying every second for 90 seconds
  let code = null;
  let creditsText = '';
  
  for (let attempt = 0; attempt < 90; attempt++) {
    try {
      const res = await fetch(`${API}/checkout/session?session_id=${sessionId}`);
      const data = await res.json();
      
      console.log(`Attempt ${attempt + 1}:`, data);
      
      if (data.ok && data.code) {
        // SUCCESS! Got the code
        code = data.code;
        state.code = code;
        state.codeValid = true;
        state.codeCredits = data.credits;
        creditsText = data.creditsDisplay || `${data.credits} credit${data.credits !== 1 ? 's' : ''} remaining`;
        break;
      }
      
      // Keep trying regardless of response - webhook might not have fired yet
      codeStatus.innerHTML = `<span class="spinner"></span> Retrieving your code... (${attempt + 1}s)`;
      
    } catch (e) {
      console.error('Checkout check error:', e);
    }
    
    await new Promise(r => setTimeout(r, 1000));
  }
  
  if (code) {
    // Success - show the code
    successCodeDisplay.textContent = code;
    codeInput.value = code;
    codeInput.placeholder = 'ENTER CODE';
    codeInput.classList.add('valid');
    codeStatus.className = 'code-status valid';
    codeStatus.textContent = `✓ Valid — ${creditsText}`;
    saveFormState();
  } else {
    // Fallback - tell them to check email
    successCodeDisplay.textContent = 'Check your email';
    successBanner.querySelector('p:last-of-type').textContent = 'Your code should arrive shortly. Enter it below when you receive it.';
    codeInput.value = '';
    codeInput.placeholder = 'ENTER CODE';
    codeStatus.className = 'code-status';
    codeStatus.textContent = 'Enter the code from your email';
  }
  
  updateMainButton();
  return true;
}

// ==================== UI STATE ====================

function handleRoleChange(role) {
  state.role = role;
  $('#auditorFlow').style.display = role === 'auditor' ? 'block' : 'none';
  $('#clientFlow').style.display = role === 'client' ? 'block' : 'none';
  if (role === 'auditor') { 
    if (Object.keys(composerState).length === 0) initComposerState(); 
    renderComposer();
  }
}

function showPaymentSection() {
  state.paymentVisible = true;
  $('#paymentSection').classList.add('visible');
  updateMainButton();
}

function updateMainButton() {
  const btn = $('#mainActionBtn');
  if (!btn) return;
  
  if (!state.paymentVisible) {
    // Stage 1: Continue button (blue)
    btn.textContent = 'Continue';
    btn.className = 'btn btn-primary btn-full';
    btn.disabled = false;
  } else {
    // Stage 2: Always show Send button (green, always enabled)
    btn.textContent = 'Send Evidence Request';
    btn.className = 'btn btn-accent btn-full';
    btn.disabled = false; // ALWAYS ENABLED - we validate on click
  }
}

function selectTier(tier) {
  $$('.pricing-card').forEach(card => { 
    card.classList.toggle('selected', card.dataset.tier === tier); 
  });
  state.selectedTier = tier;
  const buyBtn = $('#buyCreditsBtn');
  if (tier) { 
    const prices = { single: '$59', pack5: '$249', pack15: '$499', pack50: '$1,249' }; 
    buyBtn.disabled = false; 
    buyBtn.textContent = `Buy Credits — ${prices[tier]}`;
    // ADD THIS: Highlight the button
    buyBtn.className = 'btn btn-accent btn-full';
  } else { 
    buyBtn.disabled = true; 
    buyBtn.textContent = 'Select a plan to purchase';
    buyBtn.className = 'btn btn-outline btn-full';
  }
}
// ==================== MAIN ACTIONS ====================

async function handleMainAction() {
  const btn = $('#mainActionBtn');
  
  if (!state.paymentVisible) {
    // STAGE 1: Validate form and show payment section
    const email = ($('#auditorEmail')?.value || '').trim();
    const clientEmail = ($('#clientEmail')?.value || '').trim();
    const company = ($('#clientCompany')?.value || '').trim();
    
    if (!email || !email.includes('@')) {
      alert('Please enter your email address.');
      return;
    }
    if (!company) {
      alert('Please enter the client company name.');
      return;
    }
    if (!clientEmail || !clientEmail.includes('@')) {
      alert('Please enter the client email address.');
      return;
    }
    
    const evidence = getPayload();
    if (evidence.length === 0) {
      alert('Please select at least one evidence item to request.');
      return;
    }
    
    saveFormState();
    showPaymentSection();
    $('#paymentSection').scrollIntoView({ behavior: 'smooth', block: 'center' });
    
  } else {
    // STAGE 2: Validate code on click, then send if valid
    const code = ($('#auditorCode')?.value || '').trim().toUpperCase();
    
    if (!code) {
      alert('Please enter your credit code.');
      $('#auditorCode').focus();
      return;
    }
    
    // If not already validated, validate now
    if (!state.codeValid || state.code !== code) {
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> Checking code...';
      
      const result = await validateCode(code);
      updateCodeUI(result);
      
      if (!result.valid) {
        btn.disabled = false;
        btn.textContent = 'Send Evidence Request';
        alert(result.error || 'Invalid code. Please try again.');
        return;
      }
      
      state.code = code;
      saveFormState();
    }
    
    // Code is valid - send the request
    await sendRequest();
  }
}

async function handleCheckout() {
  if (!state.selectedTier) return;
  
  const buyBtn = $('#buyCreditsBtn');
  buyBtn.disabled = true;
  buyBtn.innerHTML = '<span class="spinner"></span> Processing...';
  
  saveFormState();
  
  try {
    const res = await fetch(`${API}/checkout`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        tier: state.selectedTier,
        email: $('#auditorEmail').value,
        successUrl: window.location.origin + window.location.pathname + '?session_id={CHECKOUT_SESSION_ID}',
        cancelUrl: window.location.href
      })
    });
    
    const data = await res.json();
    
    if (data.ok && data.url) {
      window.location.href = data.url;
    } else {
      alert('Error starting checkout: ' + (data.error || 'Unknown error'));
      buyBtn.disabled = false;
      buyBtn.textContent = 'Buy Credits';
    }
  } catch (e) {
    alert('Error: ' + e.message);
    buyBtn.disabled = false;
    buyBtn.textContent = 'Buy Credits';
  }
}

async function sendRequest() {
  const btn = $('#mainActionBtn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Sending...';
  
  const deadline = calculateDeadline();
  const frameworks = Object.entries(composerState)
    .filter(([_, s]) => s.enabled)
    .map(([k]) => { 
      const allFw = getAllFrameworks(); 
      return allFw[k]?.label || k; 
    });
  const requestedEvidence = getPayload();
  
  try {
    const res = await fetch(`${API}/request`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        auditorEmail: $('#auditorEmail').value,
        clientEmail: $('#clientEmail').value,
        company: $('#clientCompany').value,
        frameworks: frameworks,
        deadlineISO: deadline.toISOString(),
        auditorCode: state.code,
        globalInstructions: $('#globalInstructions')?.value || '',
        requestedEvidence: requestedEvidence
      })
    });
    
    const data = await res.json();
    
    if (data.ok) {
      clearFormState();
      alert('Success! Evidence request sent to ' + $('#clientEmail').value + '\n\nClient link: ' + (data.magicLink || ''));
      window.location.reload();
    } else {
      alert('Error: ' + (data.error || 'Unknown error'));
      btn.disabled = false;
      btn.textContent = 'Send Evidence Request';
    }
  } catch (e) {
    alert('Error: ' + e.message);
    btn.disabled = false;
    btn.textContent = 'Send Evidence Request';
  }
}

// ==================== MODALS ====================

function setupModals() {
  $('#cancelFwBtn')?.addEventListener('click', () => { 
    $('#addFwModal').classList.add('hidden'); 
    $('#customFwName').value = ''; 
    $('#customFwDesc').value = ''; 
  });
  
  $('#saveFwBtn')?.addEventListener('click', () => {
    const name = ($('#customFwName')?.value || '').trim();
    const desc = ($('#customFwDesc')?.value || '').trim();
    if (!name) return;
    const id = 'cf_' + Math.random().toString(36).slice(2, 8);
    customFrameworks.push({ id, label: name, description: desc || 'Custom framework', defaultOn: false, controlGroups: [] });
    composerState[id] = { enabled: true, groups: {} };
    $('#addFwModal').classList.add('hidden');
    $('#customFwName').value = '';
    $('#customFwDesc').value = '';
    renderComposer();
    saveFormState();
  });
  
  $('#cancelGroupBtn')?.addEventListener('click', () => { 
    $('#addGroupModal').classList.add('hidden'); 
    $('#customGroupName').value = ''; 
    $('#customGroupDesc').value = ''; 
    $('#customGroupFwKey').value = ''; 
  });
  
  $('#saveGroupBtn')?.addEventListener('click', () => {
    const name = ($('#customGroupName')?.value || '').trim();
    const desc = ($('#customGroupDesc')?.value || '').trim();
    const fwKey = $('#customGroupFwKey')?.value;
    if (!name || !fwKey) return;
    const gid = 'g_' + Math.random().toString(36).slice(2, 8);
    const allFw = getAllFrameworks();
    const fw = allFw[fwKey];
    if (fw) {
      fw.controlGroups.push({ id: gid, title: name, description: desc, items: [] });
      composerState[fwKey].groups[gid] = { expanded: true, showMore: false, excluded: false, items: {} };
    }
    $('#addGroupModal').classList.add('hidden');
    $('#customGroupName').value = '';
    $('#customGroupDesc').value = '';
    $('#customGroupFwKey').value = '';
    renderComposer();
    saveFormState();
  });
}

// ==================== INIT ====================

async function init() {
  $('#year').textContent = new Date().getFullYear();
  
  initComposerState();
  
  // Check for checkout return FIRST
  const isCheckoutReturn = await checkCheckoutReturn();
  
  // ALWAYS set up all event listeners
  setupAutoSave();
  setupModals();
  
  // Restore form state if not returning from checkout
  if (!isCheckoutReturn) {
    const savedState = loadFormState();
    if (savedState) {
      restoreFormState(savedState);
      if (savedState.role) {
        handleRoleChange(savedState.role);
      }
    }
  }
  
  // Event listeners
  $('#roleSelect').addEventListener('change', e => {
    handleRoleChange(e.target.value);
    saveFormState();
  });
  
  $('#mainActionBtn').addEventListener('click', handleMainAction);
  
  $$('.pricing-card').forEach(card => {
    card.addEventListener('click', () => selectTier(card.dataset.tier));
  });
  
  $('#buyCreditsBtn').addEventListener('click', handleCheckout);
  
  $('#getStartedLink').addEventListener('click', e => {
    e.preventDefault();
    $('#roleSelect').scrollIntoView({ behavior: 'smooth' });
    $('#roleSelect').focus();
  });
  
  updateMainButton();
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
